(this.webpackJsonppixlingworld=this.webpackJsonppixlingworld||[]).push([[3],{314:function(t,e,n){},341:function(t,e,n){},342:function(t,e,n){},343:function(t,e,n){},353:function(t,e,n){},362:function(t,e,n){},363:function(t,e,n){},364:function(t,e,n){},365:function(t,e,n){},366:function(t,e,n){},367:function(t,e,n){},368:function(t,e,n){},369:function(t,e,n){},370:function(t,e,n){},371:function(t,e,n){},373:function(t,e,n){},374:function(t,e,n){},548:function(t,e,n){},549:function(t,e,n){},550:function(t,e,n){},551:function(t,e,n){},633:function(t,e,n){},66:function(t,e,n){"use strict";n.r(e),n.d(e,"GymState",(function(){return rd})),n.d(e,"GymStateContext",(function(){return od})),n.d(e,"useGymState",(function(){return sd})),n.d(e,"useGymStateSelect",(function(){return cd})),n.d(e,"GymAppInner",(function(){return hd})),n.d(e,"default",(function(){return fd}));var a={};n.r(a),n.d(a,"Vector2Typedef",(function(){return gc})),n.d(a,"create",(function(){return yc})),n.d(a,"zero",(function(){return bc})),n.d(a,"random",(function(){return wc})),n.d(a,"random2",(function(){return Cc})),n.d(a,"randomSeedable",(function(){return xc})),n.d(a,"randomSeedable2",(function(){return Ac})),n.d(a,"fromPolarCoordinates",(function(){return Oc})),n.d(a,"length2",(function(){return jc})),n.d(a,"length",(function(){return Sc})),n.d(a,"distance",(function(){return kc})),n.d(a,"cross",(function(){return Ic})),n.d(a,"dot",(function(){return Ec})),n.d(a,"normalize",(function(){return Tc})),n.d(a,"round",(function(){return Rc})),n.d(a,"floor",(function(){return Dc})),n.d(a,"ceil",(function(){return Pc})),n.d(a,"fract",(function(){return Fc})),n.d(a,"add",(function(){return Bc})),n.d(a,"inv",(function(){return Mc})),n.d(a,"sub",(function(){return zc})),n.d(a,"mul",(function(){return Nc})),n.d(a,"div",(function(){return Gc})),n.d(a,"atan2",(function(){return Hc})),n.d(a,"mod",(function(){return Lc})),n.d(a,"clamp",(function(){return Uc})),n.d(a,"mix",(function(){return Vc})),n.d(a,"lerp",(function(){return Qc})),n.d(a,"perpendicular",(function(){return qc})),n.d(a,"isEqual",(function(){return Wc})),n.d(a,"interpolate",(function(){return Yc})),n.d(a,"interpolateClamped",(function(){return Xc})),n.d(a,"toGlVec2",(function(){return Kc})),n.d(a,"fromGlVec2",(function(){return Jc})),n.d(a,"rotate2d",(function(){return Zc})),n.d(a,"rotate45deg",(function(){return _c}));var i={};n.r(i),n.d(i,"mix",(function(){return wl})),n.d(i,"distance",(function(){return Cl})),n.d(i,"isEqual",(function(){return xl}));var r=n(69),o=n(75),s=n.n(o),c=n(76),u=n(72),l=n(22),h=n(21),f=n(14),d=n.n(f),m=(n(314),n(70)),p=n(23),v=n(85),g=n.n(v),y=n(78),b=n(74),w=n(93);function C(t){return{x:t.x,y:t.y}}function x(t){var e=t.x,n=t.y,a=t.z,i=t.w;return w.f.fromValues(e,n,a,i)}function A(t){return{x:t[0],y:t[1],z:t[2],w:t[3]}}var O=s.a.mark(j);function j(t,e){var n,a;return s.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:n=0;case 1:if(!(n<t)){i.next=8;break}return a=n+e>t?t-n:e,i.next=5,{l:n,count:a};case 5:n+=e,i.next=1;break;case 8:case"end":return i.stop()}}),O)}var S=function(t,e){return"\n".concat(e," interpolate(").concat(t," x, ").concat(t," x0, ").concat(t," x1, ").concat(e," y0, ").concat(e," y1) {\n  ").concat(t," p = (x - x0) / (x1 - x0);\n  return mix(y0, y1, p);\n}\n")},k=function(t,e){return"\n".concat(e," interpolateClamped(").concat(t," x, ").concat(t," x0, ").concat(t," x1, ").concat(e," y0, ").concat(e," y1) {\n  ").concat(t," p = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\n  return mix(y0, y1, p);\n}\n")};"\n".concat(S("float","float"),"\n").concat(S("float","vec3"),"\n").concat(S("vec2","vec2"),"\n").concat(S("vec3","vec3"),"\n").concat(S("vec4","vec4"),"\n\n").concat(k("float","float"),"\n").concat(k("float","vec2"),"\n").concat(k("float","vec3"),"\n").concat(k("vec2","vec2"),"\n").concat(k("vec3","vec3"),"\n").concat(k("vec4","vec4"),"\n");var I="#version 300 es\nprecision highp float;\nprecision highp int;\nprecision highp sampler2D;\nprecision highp sampler2DArray;\nprecision highp isampler2D;\nprecision highp isampler2DArray;\nprecision highp usampler2D;\nprecision highp usampler2DArray;\n",E=["#define cellPos ivec2(gl_FragCoord.xy)","#define cellPos3(l) ivec3(gl_FragCoord.xy, l)"].join("\n"),T=I+"\n".concat("\n#define PI 3.1415926535897932384626433832795\n","\n").concat(E,"\n");function R(t){return v.isNaN(t)?"0.0":t===Math.floor(t)?t+".0":""+t}function D(t){return"vec2(".concat(R(t.x),", ").concat(R(t.y),")")}function P(t){return"vec3(".concat(R(t.x),", ").concat(R(t.y),", ").concat(R(t.z),")")}function F(t,e){for(var n in t=t)if(t[n]===e)return n;return"Unknown constant: ".concat(e)}function B(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.getError,a=n.apply(t);a!==t.NO_ERROR&&console.error("Gl error ".concat(e,": ").concat(a," ").concat(F(t,a)))}function M(t){var e=[];return t.getExtension("EXT_color_buffer_float")||e.push("EXT_color_buffer_float"),t.getExtension("OES_texture_float_linear")||e.push("OES_texture_float_linear"),e}function z(t){return new Promise((function(e){var n=new Image;n.src=t,n.addEventListener("load",(function(){return e(n)}))}))}function N(t){return new Promise((function(e){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){e(n.response)},n.send()}))}var G=n(84),H=[];function L(t,e){return{x:void 0!==e.x?e.x:0,y:void 0!==e.y?e.y:0,width:void 0!==e.width?e.width:t.size.width,height:void 0!==e.height?e.height:t.size.height}}for(var U=function t(){Object(l.a)(this,t),this.checkPeriod=16,this.maxNPeriods=4e3},V=function(){function t(e){var n=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(l.a)(this,t),this.textureSlicing=e,this.config=a,this.texture=this.textureSlicing.texture,this.gls=this.texture.gls,this.batches=void 0,this.fbs=void 0,this.format=void 0,this.type=void 0,this.packAlignment=void 0,this.img=void 0,this.imgOutBuffer=void 0;var i=e.texture,r=e.layers||[0],o=i.gls.gl;if(i.internalFormat===o.R32F)this.format=o.RGBA,this.type=o.FLOAT,this.packAlignment=4;else if(i.internalFormat===o.RGBA32F)this.format=o.RGBA,this.type=o.FLOAT,this.packAlignment=4;else if(i.internalFormat===o.R32I)this.format=o.RGBA_INTEGER,this.type=o.INT,this.packAlignment=4;else if(i.internalFormat===o.RGBA32I)this.format=o.RGBA_INTEGER,this.type=o.INT,this.packAlignment=4;else if(i.internalFormat===o.R8UI)this.format=o.RED_INTEGER,this.type=o.UNSIGNED_BYTE,this.packAlignment=1;else{if(i.internalFormat!==o.RGBA8UI)throw new Error("Not implemented yet");this.format=o.RGBA_INTEGER,this.type=o.UNSIGNED_BYTE,this.packAlignment=4}this.batches=Array.from(j(r.length,this.gls.maxColorAttachements)),this.fbs=this.batches.map((function(){return n.gls.gl.createFramebuffer()}));for(var s=0;s<this.fbs.length;s++){this.texture.gls.framebuffer=this.fbs[s];for(var c=this.batches[s],u=0;u<c.count;u++)if(this.texture.is2dArray){var h=r[c.l+u];if(h<0||h>=this.texture.depth)throw new Error("Layer out of range");o.framebufferTextureLayer(o.READ_FRAMEBUFFER,o.COLOR_ATTACHMENT0+u,this.texture.texture,0,h)}else o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0+u,o.TEXTURE_2D,this.texture.texture,0)}}return Object(p.a)(t,[{key:"destroy",value:function(){var t,e=Object(m.a)(this.fbs);try{for(e.s();!(t=e.n()).done;){var n=t.value;this.gls.gl.deleteFramebuffer(n)}}catch(Nt){e.e(Nt)}finally{e.f()}}},{key:"createImgBuffer",value:function(t){var e=this.gls.gl;if(this.texture.internalFormat===e.R32F)this.img=et.zeroesF32({width:t.width,height:t.height,depth:this.textureSlicing.count},4),this.imgOutBuffer=et.zeroesF32({width:t.width,height:t.height,depth:this.textureSlicing.count},1);else if(this.texture.internalFormat===e.RGBA32F)this.img=et.zeroesF32({width:t.width,height:t.height,depth:this.textureSlicing.count},4);else if(this.texture.internalFormat===e.R32I)this.img=et.zeroesI32({width:t.width,height:t.height,depth:this.textureSlicing.count},4),this.imgOutBuffer=et.zeroesI32({width:t.width,height:t.height,depth:this.textureSlicing.count},1);else if(this.texture.internalFormat===e.RGBA32I)this.img=et.zeroesI32({width:t.width,height:t.height,depth:this.textureSlicing.count},4);else if(this.texture.internalFormat===e.R8UI)this.img=et.zeroesU8({width:t.width,height:t.height,depth:this.textureSlicing.count},1);else{if(this.texture.internalFormat!==e.RGBA8UI)throw new Error("Not implemented yet");this.img=et.zeroesU8({width:t.width,height:t.height,depth:this.textureSlicing.count},4)}}},{key:"readAndDestroy",value:function(t,e,n){var a=this;if("poll"===t)return this.read("poll",e,n).then((function(t){return a.destroy(),t}));if("background"===t){var i=this.read("background",e);return function(){var t=i();return a.destroy(),t}}var r=this.read("block",e);return this.destroy(),r}},{key:"read",value:function(t,e){var n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new U,i=this.texture.gls.gl,r=L(this.texture,e);this.config.reuseBuffer&&this.img&&this.img.size.width===r.width&&this.img.size.height===r.height||this.createImgBuffer(r);var o,s=this.img,c=this.imgOutBuffer;"block"!==t&&(o=i.createBuffer(),i.bindBuffer(i.PIXEL_PACK_BUFFER,o),i.bufferData(i.PIXEL_PACK_BUFFER,s.sizeInBytes,i.STREAM_READ)),i.pixelStorei(i.PACK_ALIGNMENT,this.packAlignment);for(var u,l=s.sizeInBytes/s.size.depth,h=0;h<this.batches.length;h++){this.texture.gls.framebuffer=this.fbs[h];for(var f=this.batches[h],d=0;d<f.count;d++){i.readBuffer(i.COLOR_ATTACHMENT0+d);var m=f.l+d;"block"!==t?i.readPixels(r.x,r.y,r.width,r.height,this.format,this.type,m*l):i.readPixels(r.x,r.y,r.width,r.height,this.format,this.type,s.data,m*l/s.channelSize)}}"block"!==t&&(u=i.fenceSync(i.SYNC_GPU_COMMANDS_COMPLETE,0));var p=this.texture.internalFormat,v=function(){var t=n.gls.gl;if(p===t.R32F||p===t.R32I){for(var e=c,a=0;a<e.data.length;a++)e.data[a]=s.data[4*a];return e}return s};if("poll"===t||"background"===t){i.bindBuffer(i.PIXEL_PACK_BUFFER,null);var g=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=i.clientWaitSync(u,0,t);return e===i.ALREADY_SIGNALED||e===i.CONDITION_SATISFIED?(i.bindBuffer(i.PIXEL_PACK_BUFFER,o),i.getBufferSubData(i.PIXEL_PACK_BUFFER,0,s.data),i.bindBuffer(i.PIXEL_PACK_BUFFER,null),i.deleteSync(u),v()):null};return"background"===t?g:new Promise((function(t,e){var r={n:0},o=window.setInterval((function(){r.n++;var s=r.n>=a.maxNPeriods;if(s&&console.warn("Reached max check periods (".concat(a.maxNPeriods,") while trying to read texture (").concat(n.texture.name,")")),n.gls.contextLost)return console.warn("Silently failing texture read due to context lost"),void window.clearInterval(o);var c=g(s?i.MAX_CLIENT_WAIT_TIMEOUT_WEBGL:0);c?(t(c),window.clearInterval(o)):s&&(window.clearInterval(o),e("Texture read timeout"))}),a.checkPeriod)}))}return v()}}]),t}(),Q=function(){var t=Object(c.a)(s.a.mark((function t(e,n,a){var i,r,o,c;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=n.toGl(e),r="".concat(a?"async":"sync"," ").concat(F(e.gl,i.internalFormat)," ").concat(i.is2dArray?"2darray":"2d"," depth=").concat(n.size.depth),console.log("Testing image read: ".concat(r,"...")),o=i.sliceRange(0,n.size.depth),!a){t.next=10;break}return t.next=7,et.readTextureAsync(o);case 7:t.t0=t.sent,t.next=11;break;case 10:t.t0=et.readTextureSync(o);case 11:if(c=t.t0,g.a.isEqual(n.data,c.data)){t.next=18;break}throw console.log("Original"),n.dump(),console.log("Downloaded"),c.dump(),new Error("Image reads differ for ".concat(r));case 18:case"end":return t.stop()}}),t)})));return function(e,n,a){return t.apply(this,arguments)}}(),q=0,W=[1,3,11];q<W.length;q++)for(var Y=W[q],X=function(){for(var t=J[K],e={width:3,height:3,depth:Y},n=function(){var n=i[a];H.push({name:"TextureReader depth=".concat(Y," channels=").concat(t," async=").concat(n," f32"),test:function(a){return Q(a,et.zeroesF32(e,t).randomize(),n)}}),H.push({name:"TextureReader depth=".concat(Y," channels=").concat(t," async=").concat(n," i32"),test:function(a){return Q(a,et.zeroesI32(e,t).randomize(0,6e3),n)}}),H.push({name:"TextureReader depth=".concat(Y," channels=").concat(t," async=").concat(n," u8"),test:function(a){return Q(a,et.zeroesU8(e,t).randomize(0,255),n)}})},a=0,i=[!0,!1];a<i.length;a++)n()},K=0,J=[1,4];K<J.length;K++)X();var Z=n(728),_=n(99);function $(t,e,n,a,i,r){return((i*t.height+a)*t.width+n)*e+r}function tt(t,e,n){var a=n%e;return function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return 1===e.length?"number"===typeof e[0]?{x:e[0],y:e[0],z:e[0],w:e[0]}:Object(r.a)({},e[0]):2===e.length?"number"===typeof e[0]?{x:e[0],y:e[1].x,z:e[1].y,w:e[1].z}:"number"===typeof e[1]?Object(r.a)(Object(r.a)({},e[0]),{},{w:e[1]}):Object(r.a)(Object(r.a)({},e[0]),{},{z:e[1].x,w:e[1].y}):3===e.length?"object"===typeof e[0]?{x:e[0].x,y:e[0].y,z:e[1],w:e[2]}:"object"===e[1]?{x:e[0],y:e[1].x,z:e[1].y,w:e[2]}:{x:e[0],y:e[1],z:e[2].x,w:e[2].y}:{x:e[0],y:e[1],z:e[2],w:e[3]}}((n=Math.floor(n/e))%t.width,(n=Math.floor(n/t.width))%t.height,n=Math.floor(n/t.height),a)}var et=function(){function t(e,n,a){Object(l.a)(this,t),this.data=e,this.size=n,this.channels=a}return Object(p.a)(t,[{key:"fill",value:function(t){return this.data.fill(t),this}},{key:"randomize",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new b.c,a=0;a<this.data.length;a++)this.data[a]=t+n.random()*(e-t);return this}},{key:"toGl",value:function(t,e){var n;if(!(n=!0===e||void 0===e&&this.size.depth>1?new ut(t,this.defaultTextureFormat(t),this.size,this.size.depth):new ut(t,this.defaultTextureFormat(t),this.size)))throw new Error("Failed to create texture");return n.init(this.data),n}},{key:"toGlDoubleBuffered",value:function(t,e){return new lt(this.toGl(t,e),this.toGl(t,e))}},{key:"defaultTextureFormat",value:function(t){if(1===this.channels){if(this.data instanceof Float32Array)return t.gl.R32F;if(this.data instanceof Int32Array)return t.gl.R32I;if(this.data instanceof Uint8Array)return t.gl.R8UI}else if(2===this.channels){if(this.data instanceof Float32Array)return t.gl.RG32F;if(this.data instanceof Int32Array)return t.gl.RG32I;if(this.data instanceof Uint8Array)return t.gl.RG8UI}else if(3===this.channels){if(this.data instanceof Float32Array)return t.gl.RGB32F;if(this.data instanceof Int32Array)return t.gl.RGB32I;if(this.data instanceof Uint8Array)return t.gl.RGB8UI}else if(4===this.channels){if(this.data instanceof Float32Array)return t.gl.RGBA32F;if(this.data instanceof Int32Array)return t.gl.RGBA32I;if(this.data instanceof Uint8Array)return t.gl.RGBA8UI}throw new Error("Not implemented yet")}},{key:"safeIndex",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=Object(y.g)(t.x,this.size.width),a=Object(y.g)(t.y,this.size.height);return this.index(n,a,t.z,e)}},{key:"index",value:function(t,e,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return $(this.size,this.channels,t,e,n,a)}},{key:"safeRead",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.data[this.safeIndex(t,e)]}},{key:"read",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return this.data[this.index(t,e,n,a)]}},{key:"write",value:function(t,e,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.data[this.index(e,n,a,i)]=t}},{key:"readPixel",value:function(t){var e=t.x,n=t.y,a=t.z,i=void 0===a?0:a,r=this.index(e,n,i,0);return 1===this.channels?{x:this.data[r],y:0,z:0,w:0}:2===this.channels?{x:this.data[r],y:this.data[r+1],z:0,w:0}:3===this.channels?{x:this.data[r],y:this.data[r+1],z:this.data[r+2],w:0}:{x:this.data[r],y:this.data[r+1],z:this.data[r+2],w:this.data[r+3]}}},{key:"readPixelAsArray",value:function(t){return[(e=this.readPixel(t)).x,e.y,e.z,e.w];var e}},{key:"fillLayer",value:function(t,e){for(var n=0;n<this.size.height;n++)for(var a=0;a<this.size.width;a++)this.write(e,a,n,t)}},{key:"readLayer",value:function(t){return this.data.slice(t*this.size.width*this.size.height,(t+1)*this.size.width*this.size.height)}},{key:"reduceLayer",value:function(t,e,n,a){for(var i=void 0!==a?a:this.read(0,0,t),r=0;r<this.size.height;r++)for(var o=0;o<this.size.width;o++)void 0===a&&0===o&&0===r||(i=n(i,this.read(o,r,t,e)));return i}},{key:"reduce",value:function(e,n){for(var a=t.zeroes(this.DataConstructor,{width:1,height:1,depth:this.size.depth},this.channels),i=0;i<this.size.depth;i++)for(var r=0;r<this.channels;r++){for(var o=null!==n&&void 0!==n?n:0,s=0;s<this.size.height;s++)for(var c=0;c<this.size.height;c++)o=e(o,this.read(c,s,i,r));a.write(o,0,0,i,r)}return a}},{key:"map",value:function(e){var n=this;return new t(this.data.map((function(t,a){return e(t,tt(n.size,n.channels,a))})),Object(r.a)({},this.size),this.channels)}},{key:"copyXY",value:function(t,e){for(var n=0;n<this.size.depth;n++)this.data[this.safeIndex({x:e.x,y:e.y,z:n})]=this.data[this.safeIndex({x:t.x,y:t.y,z:n})]}},{key:"positionsXY",value:s.a.mark((function t(){var e,n;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=0;case 1:if(!(e<this.size.height)){t.next=12;break}n=0;case 3:if(!(n<this.size.width)){t.next=9;break}return t.next=6,{x:n,y:e};case 6:n++,t.next=3;break;case 9:e++,t.next=1;break;case 12:case"end":return t.stop()}}),t,this)}))},{key:"select",value:function(t){return new nt(this,t,new Array(this.size.depth).fill(0).map((function(t,e){return e})))}},{key:"slice",value:function(t){return new nt(this,{x:0,y:0,width:this.size.width,height:this.size.height},t)}},{key:"sliceRange",value:function(t,e){return this.slice(new Array(e).fill(0).map((function(e,n){return t+n})))}},{key:"sliceAll",value:function(){return this.sliceRange(0,this.size.depth)}},{key:"dump",value:function(){for(var t=0;t<this.size.depth;t++)for(var e=0;e<this.channels;e++){console.log("Layer: ".concat(t,", Channel: ").concat(e));for(var n=[],a=0;a<this.size.height;a++){for(var i=[],r=0;r<this.size.width;r++)i.push(this.read(r,a,t,e));n.push(i)}console.table(n)}}},{key:"dumpImage",value:function(){var t=document.createElement("canvas");t.width=this.size.width,t.height=this.size.height;for(var e=t.getContext("2d"),n="font-size: 1px; padding: "+Math.floor(t.height/2)+"px "+Math.floor(t.width/2)+"px; line-height: 0px;",a=0;a<this.size.depth;a++)for(var i=0;i<this.channels;i++){console.log("Layer: ".concat(a,", Channel: ").concat(i)),e.clearRect(0,0,t.width,t.height);for(var r=0;r<this.size.height;r++)for(var o=0;o<this.size.width;o++)e.fillStyle="hsl(0, 0%, ".concat(100*this.read(o,r,a,i),"%)"),e.fillRect(o,r,1,1);var s=t.toDataURL();console.log("%c+","".concat(n," background:url(").concat(s,") no-repeat; background-size: ").concat(t.width,"px ").concat(t.height,"px"))}}},{key:"channelSize",get:function(){return this.data instanceof Float32Array||this.data instanceof Int32Array?4:1}},{key:"sizeInBytes",get:function(){return this.data.length*this.channelSize}},{key:"DataConstructor",get:function(){return this.data.constructor}}],[{key:"zeroes",value:function(e,n,a){return new t(new e(n.width*n.height*n.depth*a),n,a)}},{key:"zeroesF32",value:function(e,n){return t.zeroes(Float32Array,e,n)}},{key:"zeroesI32",value:function(e,n){return t.zeroes(Int32Array,e,n)}},{key:"zeroesU8",value:function(e,n){return t.zeroes(Uint8Array,e,n)}},{key:"fromEXRBuffer",value:function(e){var n=t.exrLoader.parse(e);return new t(n.data,{width:n.width,height:n.height,depth:1},function(t){switch(t){case _.a:return 1;case _.kb:return 3;case _.hb:return 4;case _.K:return 1;case _.J:return 2;case _.jb:return 4;case _.k:return 1;case _.l:return 2;case _.ob:case _.pb:return 1;case _.mb:case _.nb:return 2;case _.lb:return 3;case _.ib:return 4;default:throw new Error("Unrecognized THREE pixel format: ".concat(t))}}(n.format))}},{key:"fromEXRUrl",value:function(){var e=Object(c.a)(s.a.mark((function e(n){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,N(n);case 3:return e.t1=e.sent,e.abrupt("return",e.t0.fromEXRBuffer.call(e.t0,e.t1));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"readTextureAsync",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a,i=arguments;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},a=i.length>2&&void 0!==i[2]?i[2]:new U,t.abrupt("return",new V(e).readAndDestroy("poll",n,a));case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()},{key:"readTextureSync",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new V(t).readAndDestroy("block",e)}}]),t}();et.exrLoader=new Z.a;var nt=function(){function t(e,n,a){Object(l.a)(this,t),this.image=e,this.rect=n,this.layers=a}return Object(p.a)(t,[{key:"select",value:function(e){return new t(this.image,e,this.layers)}},{key:"slice",value:function(e){var n=this;return new t(this.image,this.rect,e.map((function(t){return n.layers[t]})))}},{key:"sliceRange",value:function(t,e){return this.slice(new Array(e).fill(0).map((function(e,n){return t+n})))}},{key:"index",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return this.image.index(this.rect.x+t,this.rect.y+e,this.layers[n],a)}},{key:"read",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return this.image.read(this.rect.x+t,this.rect.y+e,this.layers[n],a)}},{key:"write",value:function(t,e,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.image.write(t,this.rect.x+e,this.rect.y+n,this.layers[a],i)}},{key:"toArray",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new this.image.DataConstructor(this.rect.width*this.rect.height*this.layers.length*this.image.channels),e=0,n=this.rect.width*this.image.channels,a=0;a<this.layers.length;a++)for(var i=0;i<this.rect.height;i++){var r=this.index(0,i,a,0);t.set(this.image.data.subarray(r,r+n),e),e+=n}return t}},{key:"toImage",value:function(){return new et(this.toArray(),{width:this.rect.width,height:this.rect.height,depth:this.layers.length},this.image.channels)}}]),t}(),at=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.destroyed=!1,this.buffer=this.gls.gl.createFramebuffer(),this.cachedTexture=null,this.cachedLayers=[],this.cachedOutputCount=0}return Object(p.a)(t,[{key:"destroy",value:function(){this.gls.gl.deleteFramebuffer(this.buffer),this.buffer=null,this.destroyed=!0}},{key:"bind",value:function(){if(this.destroyed)throw new Error("Trying to bind destroyed buffer");this.gls.framebuffer=this.buffer}},{key:"setOutputCount",value:function(t){if(t!==this.cachedOutputCount){if(t>this.gls.maxColorAttachements)throw new Error("Outputs can't be larger than maxColorAttachements (".concat(this.gls.maxColorAttachements,")"));var e=this.gls.gl;if(e.drawBuffers(new Array(t).fill(0).map((function(t,n){return e.COLOR_ATTACHMENT0+n}))),this.cachedOutputCount>t)for(var n=t;n<this.cachedOutputCount;n++)e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n,e.TEXTURE_2D,null,0);this.cachedOutputCount=t}}},{key:"set",value:function(t){var e=t.texture,n=t.layers;this.bind();var a=this.gls.gl;if(e.destroyed||!e.inited)throw new Error("Trying to bind destroyed or uninited texture");if(e.is2dArray){if(void 0===n)throw new Error("Trying to set array texture but no layer defined");this.setOutputCount(n.length);for(var i=0;i<n.length;i++){var r=n[i];if(this.cachedTexture!==e||this.cachedLayers[i]!==r){if(r<0||r>=e.depth)throw new Error("Layer out of range");a.framebufferTextureLayer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+i,e.texture,0,r)}}this.cachedTexture=e,this.cachedLayers=n}else this.setOutputCount(1),this.cachedTexture!==e&&(a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e.texture,0),this.cachedTexture=e)}},{key:"clear",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(this.bind(),!this.cachedTexture)throw new Error("No texture bound to render target");var a=this.gls.gl;if(n&&(this.gls.enable(a.SCISSOR_TEST),a.scissor(n.x,n.y,n.width,n.height)),"float"===this.cachedTexture.formatType)a.clearBufferfv(a.COLOR,e,new Float32Array(t));else if("int"===this.cachedTexture.formatType)a.clearBufferiv(a.COLOR,e,new Int32Array(t));else{if("uint"!==this.cachedTexture.formatType)throw new Error("Not implemented yet");a.clearBufferuiv(a.COLOR,e,new Uint32Array(t))}n&&this.gls.disable(a.SCISSOR_TEST)}}]),t}();function it(t,e){switch(e){case t.RGB:return t.RGB;case t.RGBA:return t.RGBA;case t.R32F:return t.RED;case t.RG32F:return t.RG;case t.RGB32F:return t.RGB;case t.RGBA32F:return t.RGBA;case t.R8UI:return t.RED_INTEGER;case t.RG8UI:return t.RG_INTEGER;case t.RGB8UI:return t.RGB_INTEGER;case t.RGBA8UI:return t.RGBA_INTEGER;case t.R8I:return t.RED_INTEGER;case t.RG8I:return t.RG_INTEGER;case t.RGB8I:return t.RGB_INTEGER;case t.RGBA8I:return t.RGBA_INTEGER;case t.R32I:return t.RED_INTEGER;case t.RG32I:return t.RG_INTEGER;case t.RGB32I:return t.RGB_INTEGER;case t.RGBA32I:return t.RGBA_INTEGER;default:throw new Error("Not implemeted yet")}}function rt(t,e){switch(e){case t.RGB:case t.RGBA:return t.UNSIGNED_BYTE;case t.R32F:case t.RG32F:case t.RGB32F:case t.RGBA32F:return t.FLOAT;case t.R8UI:case t.RG8UI:case t.RGB8UI:case t.RGBA8UI:return t.UNSIGNED_BYTE;case t.R8I:case t.RG8I:case t.RGB8I:case t.RGBA8I:return t.BYTE;case t.R32I:case t.RG32I:case t.RGB32I:case t.RGBA32I:return t.INT;default:throw new Error("Not implemeted yet")}}function ot(t,e){switch(e){case t.R8UI:case t.R8I:return 1;default:return 4}}function st(t,e){switch(e){case t.RGB:return 3;case t.RGBA:case t.R32F:return 4;case t.RG32F:return 8;case t.RGB32F:return 16;case t.RGBA32F:return 32;case t.R8UI:return 1;case t.RG8UI:return 2;case t.RGB8UI:return 3;case t.RGBA8UI:return 4;case t.R8I:return 1;case t.RG8I:return 2;case t.RGB8I:return 3;case t.RGBA8I:case t.R32I:return 4;case t.RG32I:return 8;case t.RGB32I:return 12;case t.RGBA32I:return 16;default:throw new Error("Not implemeted yet")}}function ct(t,e){switch(e){case t.RGB:case t.RGBA:return"float";case t.R32F:case t.RG32F:case t.RGB32F:case t.RGBA32F:return"float";case t.R8UI:case t.RG8UI:case t.RGB8UI:case t.RGBA8UI:return"uint";case t.R8I:case t.RG8I:case t.RGB8I:case t.RGBA8I:return"int";case t.R32I:case t.RG32I:case t.RGB32I:case t.RGBA32I:return"int";default:throw new Error("Not implemeted yet")}}var ut=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.gl.RGBA,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{width:1,height:1},i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:it(e.gl,n),o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:rt(e.gl,n);Object(l.a)(this,t),this.gls=e,this.internalFormat=n,this.size=a,this.depth=i,this.format=r,this.type=o,this.destroyed=!1,this.inited=!1,this.texture=void 0,this.name="",this.isDoubleBuffered=!1,this.unpackAlignment=ot(this.gl,this.internalFormat),this.formatType=ct(this.gl,this.internalFormat),this.pixelBytes=st(this.gl,this.internalFormat),this.validateSize();var s=e.gl.createTexture();if(!s)throw new Error("Failed to create texture");this.texture=s,t.nAliveTextures++}return Object(p.a)(t,[{key:"destroy",value:function(){if(this.destroyed)throw new Error("Already destroyed");this.gl.deleteTexture(this.texture),this.destroyed=!0,t.nAliveTextures--}},{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=this.gl;if(null!==t){var n="float"===this.formatType&&t instanceof Float32Array||"int"===this.formatType&&t instanceof Int32Array||"uint"===this.formatType&&t instanceof Uint32Array||"uint"===this.formatType&&t instanceof Uint8Array;if(!n)throw new Error("Texture format ".concat(this.formatType," but data is ").concat(t.constructor.name))}return e.activeTexture(e.TEXTURE31),void 0!==this.depth?(e.bindTexture(e.TEXTURE_2D_ARRAY,this.texture),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment),e.texImage3D(e.TEXTURE_2D_ARRAY,0,this.internalFormat,this.size.width,this.size.height,this.depth,0,this.format,this.type,t)):(e.bindTexture(e.TEXTURE_2D,this.texture),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment),e.texImage2D(e.TEXTURE_2D,0,this.internalFormat,this.size.width,this.size.height,0,this.format,this.type,t)),this.inited=!0,this}},{key:"loadImage",value:function(t){if(t instanceof et)this.size=Object(r.a)({},t.size),this.init(t.data);else{var e=this.gls.gl;e.activeTexture(e.TEXTURE31),e.bindTexture(e.TEXTURE_2D,this.texture),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment),e.texImage2D(e.TEXTURE_2D,0,this.internalFormat,this.format,this.type,t),this.size={width:t.width,height:t.height},this.inited=!0}}},{key:"generateMipmap",value:function(){var t=this.gls.gl;t.activeTexture(t.TEXTURE31),t.bindTexture(t.TEXTURE_2D,this.texture),t.generateMipmap(t.TEXTURE_2D)}},{key:"validateSize",value:function(){if(this.size.width<0||this.size.height<0||!Number.isInteger(this.size.width)||!Number.isInteger(this.size.height))throw new Error("Invalid texture size (".concat(this.size.width,", ").concat(this.size.height,")"));if(void 0!==this.depth&&(this.depth<1||!Number.isInteger(this.depth)))throw new Error("Invalid texture depth (".concat(this.depth,")"));if(this.size.width>this.gls.maxTextureSize||this.size.height>this.gls.maxTextureSize)throw new Error("Texture (".concat(this.size.width,"x").concat(this.size.height,") larger than max texture size (").concat(this.gls.maxTextureSize,")"));0!==this.size.width&&0!==this.size.height||console.warn("Texture with 0 size created: ".concat(this.size.width," x ").concat(this.size.height))}},{key:"slice",value:function(t){return new ht(this,{x:0,y:0,width:this.size.width,height:this.size.height},t)}},{key:"sliceRange",value:function(t,e){return this.slice(new Array(e).fill(0).map((function(e,n){return t+n})))}},{key:"sliceAll",value:function(){return this.sliceRange(0,this.depth||1)}},{key:"clear",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0,0],e=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;if(void 0===this.depth&&e)throw new Error("This is not a multilayer texture");var a,i=new at(this.gls),r=void 0===this.depth?[0]:void 0!==e?e:new Array(this.depth).fill(0).map((function(t,e){return e})),o=Object(m.a)(r);try{for(o.s();!(a=o.n()).done;){var s=a.value;i.set(this.slice([s])),i.clear(t,0,n)}}catch(Nt){o.e(Nt)}finally{o.f()}i.destroy()}},{key:"readSync",value:function(t){return et.readTextureSync(this.sliceAll(),t)}},{key:"readAsync",value:function(t,e){return et.readTextureAsync(this.sliceAll(),t,e)}},{key:"gl",get:function(){return this.gls.gl}},{key:"internalFormatName",get:function(){return F(this.gl,this.internalFormat)}},{key:"formatName",get:function(){return F(this.gl,this.format)}},{key:"typeName",get:function(){return F(this.gl,this.type)}},{key:"is2dArray",get:function(){return void 0!==this.depth}},{key:"pixelSizeInBytes",get:function(){return(void 0!==this.depth?this.depth:1)*this.pixelBytes}},{key:"sizeInBytes",get:function(){return this.size.width*this.size.height*this.pixelSizeInBytes}},{key:"size3",get:function(){return Object(r.a)(Object(r.a)({},this.size),{},{depth:this.depth||1})}},{key:"pixelSizeOnGPU",get:function(){return this.pixelSizeInBytes}},{key:"sizeOnGPU",get:function(){return this.sizeInBytes}},{key:"channels",get:function(){return function(t,e){switch(e){case t.RGB:return 3;case t.RGBA:return 4;case t.R32F:return 1;case t.RG32F:return 2;case t.RGB32F:return 3;case t.RGBA32F:return 4;case t.R8UI:return 1;case t.RG8UI:return 2;case t.RGB8UI:return 3;case t.RGBA8UI:return 4;case t.R8I:return 1;case t.RG8I:return 2;case t.RGB8I:return 3;case t.RGBA8I:return 4;case t.R32I:return 1;case t.RG32I:return 2;case t.RGB32I:return 3;case t.RGBA32I:return 4;default:throw new Error("Not implemeted yet")}}(this.gl,this.internalFormat)}}],[{key:"create",value:function(e,n,a,i,r,o){return new t(e,n,a,i,r,o)}},{key:"fromImage",value:function(e,n){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=new t(e);return i.loadImage(n),a&&i.generateMipmap(),i}}]),t}();ut.nAliveTextures=0;var lt=function(){function t(e,n){Object(l.a)(this,t),this.texture0=e,this.texture1=n,this.swapped=!1,this.isDoubleBuffered=!0,this.selfName=void 0}return Object(p.a)(t,[{key:"destroy",value:function(){this.front.destroy(),this.back.destroy()}},{key:"swap",value:function(){this.swapped=!this.swapped}},{key:"resetSwap",value:function(){this.swapped=!1}},{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return this.front.init(t),this.back.init(t),this}},{key:"slice",value:function(t){return new ft(this,{x:0,y:0,width:this.size.width,height:this.size.height},t)}},{key:"sliceRange",value:function(t,e){return this.slice(new Array(e).fill(0).map((function(e,n){return t+n})))}},{key:"sliceAll",value:function(){return this.sliceRange(0,this.depth||1)}},{key:"clear",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0,0],e=arguments.length>1?arguments[1]:void 0;this.front.clear(t,e),this.back.clear(t,e)}},{key:"readSync",value:function(t){return this.front.readSync(t)}},{key:"readAsync",value:function(t,e){return this.front.readAsync(t,e)}},{key:"destroyed",get:function(){return this.front.destroyed}},{key:"inited",get:function(){return this.front.inited}},{key:"back",get:function(){return this.swapped?this.texture1:this.texture0}},{key:"write",get:function(){return this.back}},{key:"front",get:function(){return this.swapped?this.texture0:this.texture1}},{key:"read",get:function(){return this.front}},{key:"texture",get:function(){return this.front.texture}},{key:"gls",get:function(){return this.texture0.gls}},{key:"gl",get:function(){return this.texture0.gl}},{key:"name",get:function(){return this.selfName},set:function(t){this.selfName=t,this.texture0.name=t+"_0",this.texture1.name=t+"_1"}},{key:"internalFormat",get:function(){return this.front.internalFormat}},{key:"size",get:function(){return this.front.size}},{key:"depth",get:function(){return this.front.depth}},{key:"channels",get:function(){return this.front.channels}},{key:"is2dArray",get:function(){return this.front.is2dArray}},{key:"formatType",get:function(){return this.front.formatType}},{key:"pixelSizeInBytes",get:function(){return this.front.pixelSizeInBytes}},{key:"sizeInBytes",get:function(){return this.front.sizeInBytes}},{key:"pixelSizeOnGPU",get:function(){return 2*this.front.pixelSizeInBytes}},{key:"sizeOnGPU",get:function(){return 2*this.sizeInBytes}}],[{key:"create",value:function(e,n,a,i,r,o){return new t(new ut(e,n,a,i,r,o),new ut(e,n,a,i,r,o))}}]),t}(),ht=function(){function t(e,n,a){if(Object(l.a)(this,t),this.texture=e,this.rect=n,this.layers=a,e.is2dArray&&void 0===a)throw new Error("2d array must have layers");if(!e.is2dArray&&1!==a.length)throw new Error("2d textures must have one layer")}return Object(p.a)(t,[{key:"readSync",value:function(){return et.readTextureSync(this,this.rect)}},{key:"readAsync",value:function(t){return et.readTextureAsync(this,this.rect,t)}},{key:"clear",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0,0];this.texture.clear(t,this.layers,this.rect)}},{key:"upload",value:function(t){var e=this.texture.gl;e.activeTexture(e.TEXTURE31);var n=e.createBuffer();if(e.bindBuffer(e.PIXEL_UNPACK_BUFFER,n),e.bufferData(e.PIXEL_UNPACK_BUFFER,t,e.STREAM_DRAW),this.texture.is2dArray){if(this.layers[0]+this.layers.length-1!==this.layers[this.layers.length-1])throw new Error("Can only upload to a continuous range of layers (3, 4, 5, 6 for instance). Found: ".concat(JSON.stringify(this.layers)));e.bindTexture(e.TEXTURE_2D_ARRAY,this.texture.texture),e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,this.rect.x,this.rect.y,this.layers[0],this.rect.width,this.rect.height,this.layers.length,this.texture.format,this.texture.type,0)}else e.bindTexture(e.TEXTURE_2D,this.texture.texture),e.texSubImage2D(e.TEXTURE_2D,0,this.rect.x,this.rect.y,this.rect.width,this.rect.height,this.texture.format,this.texture.type,0);e.bindBuffer(e.PIXEL_UNPACK_BUFFER,null),e.deleteBuffer(n)}},{key:"selectAbsolute",value:function(e){return new t(this.texture,e,this.layers)}},{key:"selectRelative",value:function(e){return new t(this.texture,Object(r.a)(Object(r.a)({},e),{},{x:this.rect.x+e.x,y:this.rect.y+e.y}),this.layers)}},{key:"selectAll",value:function(){return new t(this.texture,Object(r.a)({x:0,y:0},this.texture.size),this.layers)}},{key:"slice",value:function(e){var n=this;return new t(this.texture,this.rect,e.map((function(t){return n.layers[t]})))}},{key:"sliceRange",value:function(t,e){return this.slice(new Array(e).fill(0).map((function(e,n){return t+n})))}},{key:"count",get:function(){return this.layers.length}}]),t}(),ft=function(){function t(e,n,a){if(Object(l.a)(this,t),this.texture=e,this.rect=n,this.layers=a,e.is2dArray&&void 0===a)throw new Error("2d array must have layers");if(!e.is2dArray&&1!==a.length)throw new Error("2d texture must have one slice")}return Object(p.a)(t,[{key:"readSync",value:function(){return this.front.readSync()}},{key:"readAsync",value:function(t){return this.front.readAsync(t)}},{key:"clear",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0,0];this.front.clear(t),this.back.clear(t)}},{key:"upload",value:function(t){this.front.upload(t),this.back.upload(t)}},{key:"selectAbsolute",value:function(e){return new t(this.texture,e,this.layers)}},{key:"selectRelative",value:function(e){return new t(this.texture,Object(r.a)(Object(r.a)({},e),{},{x:this.rect.x+e.x,y:this.rect.y+e.y}),this.layers)}},{key:"selectAll",value:function(){return new t(this.texture,Object(r.a)({x:0,y:0},this.texture.size),this.layers)}},{key:"slice",value:function(e){var n=this;return new t(this.texture,this.rect,e.map((function(t){return n.layers[t]})))}},{key:"sliceRange",value:function(t,e){return this.slice(new Array(e).fill(0).map((function(e,n){return t+n})))}},{key:"count",get:function(){return this.layers.length}},{key:"back",get:function(){return new ht(this.texture.back,this.rect,this.layers)}},{key:"front",get:function(){return new ht(this.texture.front,this.rect,this.layers)}},{key:"texture0",get:function(){return new ht(this.texture.texture0,this.rect,this.layers)}},{key:"texture1",get:function(){return new ht(this.texture.texture1,this.rect,this.layers)}}]),t}();function dt(t){var e,n=Object(m.a)(v.values(t));try{for(n.s();!(e=n.n()).done;){var a=e.value;if(Array.isArray(a)){var i,r=Object(m.a)(a);try{for(r.s();!(i=r.n()).done;){i.value.destroy()}}catch(Nt){r.e(Nt)}finally{r.f()}}else a&&a.destroy()}}catch(Nt){n.e(Nt)}finally{n.f()}}var mt=n(79);function pt(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return{def:"uniform",type:t,value:e,required:n}}function vt(t,e,n){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return{def:"uniformArray",type:t,size:e,value:n,required:a}}function gt(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return{def:"in",type:t,flat:e}}function yt(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return{def:"out",type:t,flat:e}}function bt(t,e){return{def:"const",type:t,value:e}}function wt(t){return{def:"struct",members:t}}function Ct(t,e,n){return{def:"func",returnType:t,args:e,body:n}}function xt(t){return{def:"overloadedfunc",funcs:t}}function At(){var t,e,n="";2===arguments.length?(e=arguments.length<=0?void 0:arguments[0],t=arguments.length<=1?void 0:arguments[1]):(n=arguments.length<=0?void 0:arguments[0],e=arguments.length<=1?void 0:arguments[1],t=arguments.length<=2?void 0:arguments[2]);for(var a={dependencies:e},i=function(){var e=o[r],i=t[e];if(i.name=n?"".concat(n,"_").concat(e):e,i.toString=function(){return i.name},"func"===i.def){var s=n?n+"_":"";i.body=i.body.split("Self.").join(s),i.returnType=i.returnType.split("Self.").join(s)}a[e]=i},r=0,o=Object.keys(t);r<o.length;r++)i();return a}function Ot(t){for(var e={},n=0,a=Object.keys(t);n<a.length;n++){var i=a[n];"dependencies"!==i&&(e[t[i].name]=t[i])}return Object.assign.apply(Object,[{}].concat([].concat(Object(mt.a)(t.dependencies.map((function(t){return Ot(t)}))),[e])))}var jt=function(){function t(e){Object(l.a)(this,t),this.shaderModule=e,this.uniforms=[],this.source=void 0,this.source=I+"\n";for(var n=Ot(e),a=0,i=Object.keys(n);a<i.length;a++){var r=n[i[a]];this.source+=St(r.name,r)+"\n\n","uniform"!==r.def&&"uniformArray"!==r.def||r.value&&this.uniforms.push({name:r.name,type:r.type,getValue:r.value,value:null,required:r.required})}}return Object(p.a)(t,[{key:"updateUniformValues",value:function(t){var e,n=Object(m.a)(this.uniforms);try{for(n.s();!(e=n.n()).done;){var a=e.value;a.value=a.getValue(t)}}catch(Nt){n.e(Nt)}finally{n.f()}}},{key:"writeUniforms",value:function(t){var e,n=Object(m.a)(this.uniforms);try{for(n.s();!(e=n.n()).done;){var a,i=e.value;t.setUniform(i.name,i.type,i.value,null!==(a=i.required)&&void 0!==a&&a)}}catch(Nt){n.e(Nt)}finally{n.f()}}}]),t}();function St(t,e){switch(e.def){case"in":case"out":return"".concat(e.flat?"flat":""," ").concat(e.def," ").concat(e.type," ").concat(t,";");case"uniform":return"".concat(e.def," ").concat(e.type," ").concat(t,";");case"uniformArray":return"uniform ".concat(e.type.slice(0,e.type.length-2)," ").concat(t,"[").concat(e.size,"];");case"const":return"const ".concat(e.type," ").concat(t," = ").concat(e.value,";");case"struct":return"struct ".concat(t," {\n").concat(Object.keys(e.members).map((function(t){return"  ".concat(e.members[t]," ").concat(t,";")})).join("\n"),"\n};");case"func":return"".concat(e.returnType," ").concat(t,"(").concat(e.args.map((function(t){return t.join(" ")})).join(", "),") {").concat(e.body,"}");case"overloadedfunc":return e.funcs.map((function(e){return St(t,e)})).join("\n")}}var kt=function(){function t(e,n){Object(l.a)(this,t),this.gls=e,this.target=n,this.buffer=this.gls.gl.createBuffer(),this.size=0}return Object(p.a)(t,[{key:"destroy",value:function(){this.gls.gl.deleteBuffer(this.buffer),this.buffer=null}},{key:"setData",value:function(t){return this.gls.gl.bindBuffer(this.target,this.buffer),this.gls.gl.bufferData(this.target,t,this.gls.gl.STATIC_DRAW),this.size=t.length,this}},{key:"bind",value:function(){this.gls.gl.bindBuffer(this.target,this.buffer)}}],[{key:"arrayBuffer",value:function(e){return new t(e,e.gl.ARRAY_BUFFER)}},{key:"elementArrayBuffer",value:function(e){return new t(e,e.gl.ELEMENT_ARRAY_BUFFER)}}]),t}(),It=At("Vertex",[],{position:gt("vec3"),normal:gt("vec3"),texcoord:gt("vec2"),skinWeight:gt("vec4"),skinIndex:gt("vec4")}),Et=function(){function t(e,n,a,i){Object(l.a)(this,t),this.gls=e,this.attributes=n,this.buffers=a,this.index=i}return Object(p.a)(t,[{key:"destroy",value:function(){var t,e=Object(m.a)(this.buffers);try{for(e.s();!(t=e.n()).done;){t.value.destroy()}}catch(Nt){e.e(Nt)}finally{e.f()}this.index&&this.index.destroy()}},{key:"bindAttrib",value:function(t,e){e.buffer.bind(),this.gls.gl.vertexAttribPointer(t,e.itemSize,e.type,e.normalized,e.stride,e.offset)}},{key:"bind",value:function(t){this.index&&this.index.bind();var e=t.getAttribute(""+It.position),n=t.getAttribute(""+It.normal),a=t.getAttribute(""+It.texcoord),i=t.getAttribute(""+It.skinWeight),r=t.getAttribute(""+It.skinIndex);this.gls.enabledVertexAttribArray=[e,n,a,i,r].filter((function(t){return-1!==t})),e>=0&&this.bindAttrib(e,this.attributes.position),n>=0&&this.bindAttrib(n,this.attributes.normal),a>=0&&this.bindAttrib(a,this.attributes.texcoord),i>=0&&this.bindAttrib(i,this.attributes.skinWeight),r>=0&&this.bindAttrib(r,this.attributes.skinIndex)}}],[{key:"createSimple3dTriangleStrip",value:function(e,n){var a={};return a.position={buffer:n.position,itemSize:3,type:e.gl.FLOAT,normalized:!1,stride:0,offset:0},n.normal&&(a.normal={buffer:n.normal,itemSize:3,type:e.gl.FLOAT,normalized:!1,stride:0,offset:0}),n.texcoord&&(a.texcoord={buffer:n.texcoord,itemSize:2,type:e.gl.FLOAT,normalized:!1,stride:0,offset:0}),new t(e,a,[n.position])}},{key:"create3dIndexed",value:function(e,n,a){return new t(e,{position:{buffer:n.position,itemSize:3,type:e.gl.FLOAT,normalized:!1,stride:0,offset:0},normal:{buffer:n.normal,itemSize:3,type:e.gl.FLOAT,normalized:!1,stride:0,offset:0},texcoord:{buffer:n.texcoord,itemSize:2,type:e.gl.FLOAT,normalized:!1,stride:0,offset:0}},[n.position,n.normal,n.texcoord],a)}},{key:"fromThree",value:function(e,n){for(var a={},i=[],r=function(){var t=s[o],r=n.attributes[t];if(r instanceof _.f){var c=kt.arrayBuffer(e).setData(r.array);i.push([r.array,c]),a[t]={buffer:c,itemSize:r.itemSize,type:e.gl.FLOAT,normalized:!1,stride:0,offset:0}}else if(r instanceof _.u){var u=i.find((function(t){return t[0]===r.data.array}));if(!u){var l=kt.arrayBuffer(e).setData(r.data.array);u=[r.data.array,l],i.push(u)}var h=r.data.array.BYTES_PER_ELEMENT;a[t]={buffer:u[1],itemSize:r.itemSize,type:Tt(e.gl,r.data.array),normalized:r.normalized,stride:r.data.stride*h,offset:r.offset*h}}},o=0,s=Object.keys(n.attributes);o<s.length;o++)r();return new t(e,a,i.map((function(t){return t[1]})),n.index?kt.elementArrayBuffer(e).setData(n.index.array):void 0)}}]),t}();function Tt(t,e){if(e instanceof Float32Array)return t.FLOAT;if(e instanceof Uint16Array)return t.UNSIGNED_SHORT;if(e instanceof Int16Array)return t.SHORT;if(e instanceof Uint32Array)return t.UNSIGNED_INT;if(e instanceof Int32Array)return t.INT;if(e instanceof Int8Array)return t.BYTE;if(e instanceof Uint8Array)return t.UNSIGNED_BYTE;throw new Error("Unsupported buffer type")}function Rt(t){for(var e=-1,n=-1,a=-1,i=1,r=1,o=1,s=[e,n,a,i,n,a,e,r,a,i,r,a,e,n,o,e,r,o,i,n,o,i,r,o,e,n,a,e,r,a,e,n,o,e,r,o,i,r,a,i,n,a,i,r,o,i,n,o,i,n,a,e,n,a,i,n,o,e,n,o,e,r,a,i,r,a,e,r,o,i,r,o],c=[],u=0;u<6;u++)c.push(4*u+0),c.push(4*u+2),c.push(4*u+1),c.push(4*u+1),c.push(4*u+2),c.push(4*u+3);return Et.create3dIndexed(t,{position:kt.arrayBuffer(t).setData(new Float32Array(s)),normal:kt.arrayBuffer(t).setData(new Float32Array([0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0])),texcoord:kt.arrayBuffer(t).setData(new Float32Array([0,0,0,1,1,0,1,1,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0]))},kt.elementArrayBuffer(t).setData(new Uint16Array(c)))}var Dt=n(5),Pt=n(82),Ft=n(83),Bt=n(192);function Mt(t){return{result:"ok",value:t}}function zt(t){return"ok"===t.result}function Nt(t){return{result:"err",error:t}}function Gt(t){return"err"===t.result}Error;function Ht(t){return t.split("\n").map((function(t,e){return e+1+": "+t})).join("\n")}function Lt(t,e,n){var a=t.createShader("vertex"===e?t.VERTEX_SHADER:t.FRAGMENT_SHADER);return a?(t.shaderSource(a,n),t.compileShader(a),t.getShaderParameter(a,t.COMPILE_STATUS)?Mt(a):Nt({type:"FailedToCompileShader",message:t.getShaderInfoLog(a)||"Unknown error",shaderType:e,shaderSource:n})):(B(t,"Failed to create shader"),Nt({type:"FailedToCreateShader"}))}var Ut=function(){function t(e){Object(l.a)(this,t),this.gl=e,this.shaderCache={},this.errors=[]}return Object(p.a)(t,[{key:"destroy",value:function(){for(var t=0,e=Object.keys(this.shaderCache);t<e.length;t++){var n=e[t],a=this.shaderCache[n].compiled;zt(a)&&this.gl.deleteShader(a.value)}}},{key:"getShader",value:function(t,e){var n=this.shaderCache[e];return n||Gt((n=this.shaderCache[e]={source:e,compiled:Lt(this.gl,t,e)}).compiled)&&this.errors.push(n.compiled.error),n.compiled}},{key:"createProgram",value:function(t,e,n){var a,i=this.getShader("vertex",t),r=this.getShader("fragment",e);return a=Gt(i)?i:Gt(r)?r:function(t,e,n){var a=t.createProgram();if(!a)return Nt({type:"FailedToCreateProgram"});var i,r=Object(m.a)(e);try{for(r.s();!(i=r.n()).done;){var o=i.value;t.attachShader(a,o)}}catch(Nt){r.e(Nt)}finally{r.f()}return t.linkProgram(a),t.getProgramParameter(a,t.LINK_STATUS)?Mt(a):Nt({type:"FailedToLinkProgram",message:t.getProgramInfoLog(a)||"Unknown error",shaderSources:n})}(this.gl,[i.value,r.value],[t,e]),Gt(a)&&n.logErrors&&(this.errors.push(a.error),function(t){switch(console.error((new Error).stack),t.type){case"FailedToCompileShader":console.error(Ht(t.shaderSource)),console.error(t.message),Dt.a(new Error("Could not compile shader. \n\n"+t.message));break;case"FailedToLinkProgram":console.error(Ht(t.shaderSources[0])),console.error(Ht(t.shaderSources[1])),console.error(t.message),Dt.a(new Error("Could not compile WebGL program. \n\n"+t.message));break;default:Dt.a(new Error(t.type))}}(a.error)),a}},{key:"getErrors",value:function(){return this.errors}}]),t}(),Vt="#version 300 es\nin vec3 Vertex_position;\nout vec2 texcoord;\n\nvoid main() {\n  texcoord = (Vertex_position.xy + 1.0) / 2.0;\n  gl_Position = vec4(Vertex_position, 1.0);\n}\n",Qt=function(){function t(e,n){Object(l.a)(this,t),this.texture=e,this.filtering=n}return Object(p.a)(t,[{key:"is2dArray",get:function(){return this.texture.is2dArray}}]),t}();var qt=function(){function t(e,n,a){Object(l.a)(this,t),this.renderer=e,this.glSet=n,this.isEqual=a,this.values={}}return Object(p.a)(t,[{key:"write",value:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!this.isEqual(this.values[t],e)){this.values[t]=e;var a=this.renderer.getUniform(t,n);a&&this.glSet(a,e)}}}]),t}();function Wt(t,e){return t===e}function Yt(t,e){return t===e}var Xt=function(){function t(e,n){var a=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Vt,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=r.logErrors,s=void 0===o||o;Object(l.a)(this,t),this.gls=e,this.fragmentShaderSource=n,this.vertexShaderSource=i,this.shader=void 0,this.program=null,this.error=void 0,this.uniforms={},this.attributes={},this.writers={vec2:new qt(this,(function(t,e){return a.gl.uniform2f(t,e.x,e.y)}),g.a.isEqual),ivec2:new qt(this,(function(t,e){return a.gl.uniform2i(t,e.x,e.y)}),g.a.isEqual),vec3:new qt(this,(function(t,e){return a.gl.uniform3f(t,e.x,e.y,e.z)}),g.a.isEqual),ivec3:new qt(this,(function(t,e){return a.gl.uniform3i(t,e.x,e.y,e.z)}),g.a.isEqual),vec4:new qt(this,(function(t,e){return a.gl.uniform4f(t,e.x,e.y,e.z,e.w)}),g.a.isEqual),ivec4:new qt(this,(function(t,e){return a.gl.uniform4i(t,e.x,e.y,e.z,e.w)}),g.a.isEqual),"vec2[]":new qt(this,(function(t,e){0!==e.length&&a.gl.uniform2fv(t,e instanceof Float32Array?e:g.a.flatMap(e,(function(t){return[t.x,t.y]})))}),Wt),"ivec2[]":new qt(this,(function(t,e){0!==e.length&&a.gl.uniform2iv(t,e instanceof Int32Array?e:g.a.flatMap(e,(function(t){return[t.x,t.y]})))}),Wt),"vec3[]":new qt(this,(function(t,e){0!==e.length&&a.gl.uniform3fv(t,e instanceof Float32Array?e:g.a.flatMap(e,(function(t){return[t.x,t.y,t.z]})))}),Wt),"ivec3[]":new qt(this,(function(t,e){0!==e.length&&a.gl.uniform3iv(t,e instanceof Int32Array?e:g.a.flatMap(e,(function(t){return[t.x,t.y,t.z]})))}),Wt),"vec4[]":new qt(this,(function(t,e){0!==e.length&&a.gl.uniform4fv(t,e instanceof Float32Array?e:g.a.flatMap(e,(function(t){return[t.x,t.y,t.z,t.w]})))}),Wt),"ivec4[]":new qt(this,(function(t,e){0!==e.length&&a.gl.uniform4iv(t,e instanceof Int32Array?e:g.a.flatMap(e,(function(t){return[t.x,t.y,t.z,t.w]})))}),Wt),mat4:new qt(this,(function(t,e){return a.gl.uniformMatrix4fv(t,!1,e)}),(function(t,e){return t===e})),int:new qt(this,(function(t,e){return a.gl.uniform1i(t,e)}),(function(t,e){return t===e})),uint:new qt(this,(function(t,e){return a.gl.uniform1ui(t,e)}),(function(t,e){return t===e})),float:new qt(this,(function(t,e){return a.gl.uniform1f(t,e)}),(function(t,e){return t===e})),bool:new qt(this,(function(t,e){return a.gl.uniform1i(t,e?1:0)}),(function(t,e){return t===e})),"float[]":new qt(this,(function(t,e){0!==e.length&&a.gl.uniform1fv(t,e)}),Yt),"int[]":new qt(this,(function(t,e){0!==e.length&&a.gl.uniform1iv(t,e)}),Yt),"bool[]":new qt(this,(function(t,e){0!==e.length&&a.gl.uniform1iv(t,e.map((function(t){return t?1:0})))}),Yt)},this.textureUnitOffset=0;var c=e.shaderCache.createProgram(i,n,{logErrors:s});Gt(c)?this.error=c.error:this.program=c.value,t.nAlivePrograms++}return Object(p.a)(t,[{key:"destroy",value:function(){this.gl.deleteProgram(this.program),t.nAlivePrograms--}},{key:"getUniform",value:function(t,e){if(!this.program)return null;var n=this.gl,a=this.uniforms[t];if(!a){if(!(a=n.getUniformLocation(this.program,t))&&e)throw console.error("Vertex shader:"),console.error(Ht(this.vertexShaderSource)),console.error("Fragment shader:"),console.error(Ht(this.fragmentShaderSource)),new Error("No such uniform: "+t);this.uniforms[t]=a}return a}},{key:"getAttribute",value:function(t){if(!this.program)return-1;var e=this.attributes[t];return void 0!==e?e:this.attributes[t]=this.gl.getAttribLocation(this.program,t)}},{key:"prepare",value:function(){this.textureUnitOffset=0,this.gls.program=this.program}},{key:"setTexture",value:function(t,e,n,a){if(e){var i=e,r=i instanceof Qt?i.texture:i;if(i.is2dArray!==n)throw new Error('Expected texture "'.concat(t,'" ').concat(n?"to be":"to not be"," 2d array, but it ").concat(i.is2dArray?"is":"is not"," 2d array"));if(!r.inited)throw new Error("Texture has not been initialized");var o=this.textureUnitOffset++;this.gls.setActiveTexture(o,r.isDoubleBuffered?r.front:r);var s=i instanceof Qt?i.filtering:ee.Nearest;this.gls.setSampler(o,s),this.writers.int.write(t,o,a)}else this.writers.int.write(t,-1,a)}},{key:"setTextureArray",value:function(t,e,n,a){var i,r=[],o=Object(m.a)(e);try{for(o.s();!(i=o.n()).done;){var s=i.value,c=s instanceof Qt?s.texture:s;if(s.is2dArray!==n)throw new Error('Expected texture "'.concat(t,'" to ').concat(n?"":"not"," be 2d array, but it ").concat(n?"is":"is not"));if(!c.inited)throw new Error("Texture has not been initialized");var u=this.textureUnitOffset++;this.gls.setActiveTexture(u,c.isDoubleBuffered?c.front:c);var l=s instanceof Qt?s.filtering:ee.Nearest;this.gls.setSampler(u,l),r.push(u)}}catch(Nt){o.e(Nt)}finally{o.f()}this.writers["int[]"].write(t,r,a)}},{key:"setUniform",value:function(t,e,n,a){this.gls.program=this.program;var i="isampler2DArray"===e||"usampler2DArray"===e||"sampler2DArray"===e,r="isampler2D[]"===e||"usampler2D[]"===e||"sampler2D[]"===e,o="isampler2DArray[]"===e||"usampler2DArray[]"===e||"sampler2DArray[]"===e;"isampler2D"===e||"usampler2D"===e||"sampler2D"===e||i?this.setTexture(t,n,i,a):r||o?this.setTextureArray(t,n,o,a):this.writers[e].write(t,n,a)}},{key:"setUniforms",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.textureUnitOffset=n,this.gls.program=this.program;for(var a=0,i=Object.keys(t);a<i.length;a++){var r=i[a],o=t[r];this.setUniform(r,o.type,o.value,-1===e.indexOf(r))}return this.textureUnitOffset}},{key:"gl",get:function(){return this.gls.gl}}]),t}();Xt.nAlivePrograms=0;var Kt=function(){function t(e,n){Object(l.a)(this,t),this.gls=e,this.format=n,this.renderTarget=new at(this.gls),this.pre="int"===this.format?"i":"uint"===this.format?"u":"",this.nLayers=this.gls.maxColorAttachements,this.multi=new Xt(this.gls,T+"\n    out ".concat(this.pre,"vec4 out_values[").concat(this.nLayers,"];\n\n    uniform int layers[").concat(this.nLayers,"];\n    uniform ").concat(this.pre,"sampler2DArray source;\n    uniform ivec2 sourceOffset;\n\n    void main() {\n      ").concat(new Array(this.nLayers).fill(0).map((function(t,e){return"\n          out_values[".concat(e,"] = texelFetch(source, ivec3(cellPos + sourceOffset, layers[").concat(e,"]), 0);\n        ")})).join("\n"),"\n    }\n  ")),this.single=new Xt(this.gls,T+"\n    out ".concat(this.pre,"vec4 out_value;\n\n    uniform ").concat(this.pre,"sampler2D source;\n    uniform ivec2 sourceOffset;\n\n    void main() {\n      out_value = texelFetch(source, cellPos + sourceOffset, 0);\n    }\n  "))}return Object(p.a)(t,[{key:"copy",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"set";this.gls.prepareForComputation(t.rect,"set"===n?void 0:te.Sum);var a={x:e.rect.x-t.rect.x,y:e.rect.y-t.rect.y};if(e.texture.is2dArray){var i,r=Object(m.a)(j(t.layers.length,this.nLayers));try{for(r.s();!(i=r.n()).done;){var o=i.value,s=o.l,c=o.count;this.renderTarget.set(t.sliceRange(s,c)),this.multi.setUniforms({source:{type:"int"===this.format?"isampler2DArray":"uint"===this.format?"usampler2DArray":"sampler2DArray",value:e.texture},layers:{type:"int[]",value:e.layers.slice(s,s+c)},sourceOffset:{type:"ivec2",value:a}}),this.gls.drawQuad(this.multi)}}catch(Nt){r.e(Nt)}finally{r.f()}}else this.renderTarget.set(t),this.single.setUniforms({source:{type:"int"===this.format?"isampler2D":"uint"===this.format?"usampler2D":"sampler2D",value:e.texture},sourceOffset:{type:"ivec2",value:a}}),this.gls.drawQuad(this.single)}},{key:"copyBackToFront",value:function(t){this.copy(t.front,t.back)}}]),t}(),Jt=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.formats={float:new Kt(this.gls,"float"),int:new Kt(this.gls,"int"),uint:new Kt(this.gls,"uint")}}return Object(p.a)(t,[{key:"copy",value:function(t,e,n){this.formats[t.texture.formatType].copy(t,e,n)}},{key:"copyBackToFront",value:function(t){this.formats[t.texture.formatType].copyBackToFront(t)}}]),t}(),Zt=function t(e){Object(l.a)(this,t),this.gl=e,this.maxCombinedTextureImageUnits=this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.framebuffer=void 0,this.program=void 0,this.activeTextures=new Array(this.maxCombinedTextureImageUnits).fill(void 0),this.samplers=new Array(this.maxCombinedTextureImageUnits).fill(void 0),this.viewport={width:0,height:0},this.caps={},this.enabledVertexAttribArray=[]},_t=function(){function t(e,n){var a,i=this;Object(l.a)(this,t),this.canvas=e,this.gl=n,this.current=new Zt(this.gl),this.commonSamplers=new ae(this.gl),this.contextLost=!1,this.shaderCache=new Ut(this.gl),this.meshes={box:Rt(this),quad:(a=this,Et.createSimple3dTriangleStrip(a,{position:kt.arrayBuffer(a).setData(new Float32Array([-1,-1,0,-1,1,0,1,-1,0,1,1,0])),normal:kt.arrayBuffer(a).setData(new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1])),texcoord:kt.arrayBuffer(a).setData(new Float32Array([0,0,0,1,1,0,1,1]))})),sphere:Et.fromThree(this,new _.vb(1,0))},this.textures={},this.samplers={},this.tmpTextures={},this.stats={drawCalls:0},this.maxColorAttachements=this.gl.getParameter(this.gl.MAX_COLOR_ATTACHMENTS),this.maxCombinedTextureImageUnits=this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxTextureSize=this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),this.copyTexture=new Jt(this);var r,o=Object(m.a)(M(n));try{for(o.s();!(r=o.n()).done;){var s=r.value;console.warn("Missing GL extension:",s)}}catch(Nt){o.e(Nt)}finally{o.f()}n.disable(n.BLEND),e.addEventListener("webglcontextlost",(function(){return i.contextLost=!0}))}return Object(p.a)(t,[{key:"destroy",value:function(){for(var t=0,e=Object.keys(this.meshes);t<e.length;t++){var n=e[t];this.meshes[n].destroy()}}},{key:"reset",value:function(){this.current=new Zt(this.gl)}},{key:"getActiveTexture",value:function(t){return this.current.activeTextures[t]}},{key:"setActiveTexture",value:function(t,e){if(this.current.activeTextures[t]!==e){var n=this.gl;n.activeTexture(n.TEXTURE0+t);var a=e&&e.is2dArray?n.TEXTURE_2D_ARRAY:n.TEXTURE_2D,i=e&&e.is2dArray?n.TEXTURE_2D:n.TEXTURE_2D_ARRAY;n.bindTexture(a,e?e.texture:null),n.bindTexture(i,null),this.current.activeTextures[t]=e}}},{key:"getSampler",value:function(t){return this.current.samplers[t]}},{key:"setSampler",value:function(t,e){this.current.samplers[t]!==e&&(this.gl.bindSampler(t,this.commonSamplers.getSampler(e)),this.current.samplers[t]=e)}},{key:"getCap",value:function(t){return!!this.current.caps[t]}},{key:"setCap",value:function(t,e){this.current.caps[t]!==e&&(e?this.gl.enable(t):this.gl.disable(t),this.current.caps[t]=e)}},{key:"enable",value:function(t){this.setCap(t,!0)}},{key:"disable",value:function(t){this.setCap(t,!1)}},{key:"blendFunc",value:function(t,e){this.gl.blendFunc(t,e)}},{key:"blendFuncSeparate",value:function(t,e,n,a){this.gl.blendFuncSeparate(t,e,n,a)}},{key:"blendEquation",value:function(t){this.gl.blendEquation(t)}},{key:"depthFunc",value:function(t){this.gl.depthFunc(t)}},{key:"cullFace",value:function(t){this.gl.cullFace(t)}},{key:"polygonOffset",value:function(t,e){this.gl.polygonOffset(t,e)}},{key:"depthMask",value:function(t){this.gl.depthMask(t)}},{key:"draw",value:function(t,e,n){this.program=t.program,e.bind(t);var a=this.gl;if(e.index)void 0!==n?a.drawElementsInstanced(a.TRIANGLES,e.index.size,a.UNSIGNED_SHORT,0,n):a.drawElements(a.TRIANGLES,e.index.size,a.UNSIGNED_SHORT,0);else{var i=e.attributes.position.buffer.size/e.attributes.position.itemSize;void 0!==n?a.drawArraysInstanced(a.TRIANGLE_STRIP,0,i,n):a.drawArrays(a.TRIANGLE_STRIP,0,i)}this.stats.drawCalls++}},{key:"drawQuad",value:function(t,e){this.draw(t,this.meshes.quad,e)}},{key:"getMesh",value:function(t){if(this.meshes[t])return this.meshes[t];var e=ne[t];return e?this.meshes[t]=e(this):void 0}},{key:"getTmpTexture",value:function(t,e,n){var a=this.tmpTextures[t];if(!a||a.size.width<e.width||a.size.height<e.height||a.depth<n){a&&a.destroy();for(var i=a?{width:a.size.width,height:a.size.height}:{width:1,height:1},r=a?a.depth:1;i.width<e.width;)i.width*=2;for(;i.height<e.height;)i.height*=2;for(;r<n;)r*=2;this.tmpTextures[t]=a=new ut(this,t,i,r).init()}return a}},{key:"getTmpTextureSlice",value:function(t,e,n){return this.getTmpTexture(t,e,n).sliceRange(0,n).selectAbsolute({x:0,y:0,width:e.width,height:e.height})}},{key:"getCopyLayers",value:function(){return this.copyTexture}},{key:"getCopyTexture",value:function(){return this.copyTexture}},{key:"prepareForComputation",value:function(t,e){this.viewport=t,e?(this.enable(this.gl.BLEND),this.blendEquation(e.equation),this.blendFunc(e.sfactor,e.dfactor)):this.disable(this.gl.BLEND),this.disable(this.gl.CULL_FACE),this.disable(this.gl.DEPTH_TEST)}},{key:"framebuffer",get:function(){return this.current.framebuffer||null},set:function(t){this.current.framebuffer!==t&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.current.framebuffer=t)}},{key:"program",get:function(){return this.current.program||null},set:function(t){this.current.program!==t&&(this.gl.useProgram(t),this.current.program=t)}},{key:"enabledVertexAttribArray",get:function(){return this.current.enabledVertexAttribArray},set:function(t){var e,n=Object(m.a)(this.current.enabledVertexAttribArray);try{for(n.s();!(e=n.n()).done;){var a=e.value;-1===t.indexOf(a)&&this.gl.disableVertexAttribArray(a)}}catch(Nt){n.e(Nt)}finally{n.f()}var i,r=Object(m.a)(t);try{for(r.s();!(i=r.n()).done;){var o=i.value;-1===this.current.enabledVertexAttribArray.indexOf(o)&&this.gl.enableVertexAttribArray(o)}}catch(Nt){r.e(Nt)}finally{r.f()}this.current.enabledVertexAttribArray=t}},{key:"viewport",get:function(){return this.current.viewport},set:function(t){this.gl.viewport(void 0!==t.x?t.x:0,void 0!==t.y?t.y:0,t.width,t.height),this.current.viewport=t}}]),t}();var $t=document.createElement("canvas").getContext("webgl2")||{},te=function t(e,n,a){Object(l.a)(this,t),this.sfactor=e,this.dfactor=n,this.equation=a};te.Sum=new te($t.ONE,$t.ONE,$t.FUNC_ADD),te.Alpha=new te($t.SRC_ALPHA,$t.ONE_MINUS_SRC_ALPHA,$t.FUNC_ADD);var ee,ne={};!function(t){t[t.Nearest=0]="Nearest",t[t.Linear=1]="Linear",t[t.MipMap=2]="MipMap",t[t.LinearMipMap=3]="LinearMipMap"}(ee||(ee={}));var ae=function(){function t(e){if(Object(l.a)(this,t),this.gl=e,this.nearestSampler=this.gl.createSampler(),this.linearSampler=this.gl.createSampler(),this.mipmapSampler=this.gl.createSampler(),this.linearMipmapSampler=this.gl.createSampler(),!this.nearestSampler||!this.linearSampler||!this.mipmapSampler||!this.linearMipmapSampler)throw new Error("Failed to create sampler");e.samplerParameteri(this.nearestSampler,e.TEXTURE_MIN_FILTER,e.NEAREST),e.samplerParameteri(this.nearestSampler,e.TEXTURE_MAG_FILTER,e.NEAREST),e.samplerParameteri(this.nearestSampler,e.TEXTURE_WRAP_S,e.REPEAT),e.samplerParameteri(this.nearestSampler,e.TEXTURE_WRAP_T,e.REPEAT),e.samplerParameteri(this.linearSampler,e.TEXTURE_MIN_FILTER,e.LINEAR),e.samplerParameteri(this.linearSampler,e.TEXTURE_MAG_FILTER,e.LINEAR),e.samplerParameteri(this.linearSampler,e.TEXTURE_WRAP_S,e.REPEAT),e.samplerParameteri(this.linearSampler,e.TEXTURE_WRAP_T,e.REPEAT),e.samplerParameteri(this.mipmapSampler,e.TEXTURE_MIN_FILTER,e.NEAREST_MIPMAP_LINEAR),e.samplerParameteri(this.mipmapSampler,e.TEXTURE_MAG_FILTER,e.LINEAR),e.samplerParameteri(this.mipmapSampler,e.TEXTURE_WRAP_S,e.REPEAT),e.samplerParameteri(this.mipmapSampler,e.TEXTURE_WRAP_T,e.REPEAT),e.samplerParameteri(this.linearMipmapSampler,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.samplerParameteri(this.linearMipmapSampler,e.TEXTURE_MAG_FILTER,e.LINEAR),e.samplerParameteri(this.linearMipmapSampler,e.TEXTURE_WRAP_S,e.REPEAT),e.samplerParameteri(this.linearMipmapSampler,e.TEXTURE_WRAP_T,e.REPEAT)}return Object(p.a)(t,[{key:"destroy",value:function(){this.gl.deleteSampler(this.nearestSampler),this.gl.deleteSampler(this.linearSampler),this.gl.deleteSampler(this.mipmapSampler),this.gl.deleteSampler(this.linearMipmapSampler)}},{key:"getSampler",value:function(t){return t===ee.Nearest?this.nearestSampler:t===ee.MipMap?this.mipmapSampler:t===ee.LinearMipMap?this.linearMipmapSampler:this.linearSampler}},{key:"setupTextureFiltering",value:function(t,e,n){var a=this.gl;a.texParameteri(e,a.TEXTURE_MIN_FILTER,n===ee.Linear?a.LINEAR:n===ee.MipMap?a.NEAREST_MIPMAP_LINEAR:n===ee.LinearMipMap?a.LINEAR_MIPMAP_LINEAR:a.NEAREST),a.texParameteri(e,a.TEXTURE_MAG_FILTER,n===ee.Linear||n===ee.MipMap?a.LINEAR:a.NEAREST),a.texParameteri(e,a.TEXTURE_WRAP_S,a.REPEAT),a.texParameteri(e,a.TEXTURE_WRAP_T,a.REPEAT),a.bindSampler(t,this.getSampler(n))}}]),t}();function ie(t){var e,n,a;return"float"===t.buffer.format?Je(t.format)*(null!==(e=t.depth)&&void 0!==e?e:1):"mat4"===t.format?4*(null!==(n=t.depth)&&void 0!==n?n:1):null!==(a=t.depth)&&void 0!==a?a:1}var re=function(){function t(e,n){Object(l.a)(this,t),this.gls=e,this.def=n,this.dataRowToArchetype=new Int32Array(0),this.archetypeToDataRowOffset=new Int32Array(0),this.size={width:_e.ChunkSize,height:1,depth:1},this.texture=ut.create(this.gls,se(this.def.format),this.size,this.size.depth).init(),this.components={},this.archetypes=[],this.copy=this.gls.getCopyTexture()}return Object(p.a)(t,[{key:"destroy",value:function(){this.texture.destroy()}},{key:"removeAllEntities",value:function(){this.dataRowToArchetype=new Int32Array(0),this.archetypeToDataRowOffset=new Int32Array(0),this.size={width:_e.ChunkSize,height:1,depth:1}}},{key:"enuserComponentAllocated",value:function(t){if(!this.components[t.name]){var e=0===Object.keys(this.components).length?0:this.size.depth;this.components[t.name]={layerOffset:e};var n=e+ie(t);if(this.size.depth=n,this.texture.depth<n){var a=this.texture.depth,i=this.gls.getTmpTextureSlice(se(this.def.format),this.texture.size,n);i.clear([0,0,0,0]),this.copy.copy(i.sliceRange(0,a),this.texture.sliceAll()),this.texture.destroy(),this.texture=ut.create(this.gls,se(this.def.format),this.texture.size,n).init(),this.copy.copy(this.texture.sliceAll(),i)}}}},{key:"setArchetypeChunks",value:function(t,e){var n=this.archetypes[t.index]||{archetypeIndex:t.index,dataRowOffset:-1e3,chunks:0};if(n.chunks!==e){this.archetypes[t.index]=n;var a=e-n.chunks,i=this.dataRowToArchetype.length,r=i+a,o=this.gls.getTmpTextureSlice(se(this.def.format),{width:this.size.width,height:r},this.size.depth);o.clear([0,0,0,0]),n.dataRowOffset<0&&(n.dataRowOffset=i);var s=this.texture.sliceAll().selectAbsolute({x:0,y:0,width:this.size.width,height:n.dataRowOffset+n.chunks}),c=o.selectAbsolute({x:0,y:0,width:this.size.width,height:n.dataRowOffset+n.chunks}),u=this.texture.sliceAll().selectAbsolute({x:0,y:n.dataRowOffset+n.chunks,width:this.size.width,height:i-(n.dataRowOffset+n.chunks)}),l=o.selectAbsolute({x:0,y:n.dataRowOffset+e,width:this.size.width,height:u.rect.height});this.copy.copy(c,s),u.rect.height>0&&this.copy.copy(l,u),this.texture.size.height<o.rect.height&&(this.texture.destroy(),this.texture=ut.create(this.gls,se(this.def.format),{width:o.rect.width,height:o.rect.height},this.texture.depth).init()),this.copy.copy(this.texture.sliceAll(),o),this.size.height=o.rect.height,n.chunks=e;for(var h=n.archetypeIndex+1;h<this.archetypes.length;h++){var f=this.archetypes[h];f&&f.dataRowOffset>=0&&(f.dataRowOffset+=a)}this.dataRowToArchetype=new Int32Array(this.size.height).fill(-1);var d,p=Object(m.a)(this.archetypes);try{for(p.s();!(d=p.n()).done;){var v=d.value;if(v&&v.dataRowOffset>=0)for(var g=0;g<v.chunks;g++)this.dataRowToArchetype[v.dataRowOffset+g]=v.archetypeIndex}}catch(Nt){p.e(Nt)}finally{p.f()}this.archetypeToDataRowOffset=new Int32Array(this.archetypes.map((function(t){return t?t.dataRowOffset:-1e3})))}}},{key:"dataCell",value:function(t){var e=tn(t),n=e.chunkIndex,a=e.entityIndex,i=e.archIndex,r=this.archetypes[i];if(r)return{x:a,y:n+r.dataRowOffset}}},{key:"getArchetypeComponentDataSlice",value:function(t,e){var n=this.archetypes[e.index];return this.texture.sliceRange(this.components[t.name].layerOffset,ie(t)).selectAbsolute({x:0,y:n.dataRowOffset,width:e.chunks.reduce((function(t,e){return Math.max(t,e.entities)}),0),height:e.chunks.length})}},{key:"getArchetypeComponentData",value:function(t,e){var n=this.getArchetypeComponentDataSlice(t,e).readSync();return Object(v.flatMap)(e.chunks,(function(e,a){var i=n.select({x:0,y:a,width:e.entities,height:1});return oe(t,i.toImage())}))}},{key:"getRangeComponentDataSlices",value:s.a.mark((function t(e,n){var a,i,r,o,c,u,l,h,f,d,p,v;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==n.count){t.next=2;break}return t.abrupt("return");case 2:if(a=this.archetypes[n.archetypeIndex],i=this.texture.sliceRange(this.components[e.name].layerOffset,ie(e)).selectAbsolute({x:0,y:a.dataRowOffset,width:_e.ChunkSize,height:1}),0===(r=tn({x:n.startIndex,y:n.archetypeIndex})).entityIndex){t.next=29;break}return o=Math.min(_e.ChunkSize,r.entityIndex+n.count),c=o-r.entityIndex,t.next=10,i.selectRelative({x:r.entityIndex,y:0,width:c,height:1});case 10:u=Object(m.a)(this.getRangeComponentDataSlices(e,new on(n.archetypeIndex,n.startIndex+c,n.count-c))),t.prev=11,u.s();case 13:if((l=u.n()).done){t.next=19;break}return h=l.value,t.next=17,h;case 17:t.next=13;break;case 19:t.next=24;break;case 21:t.prev=21,t.t0=t.catch(11),u.e(t.t0);case 24:return t.prev=24,u.f(),t.finish(24);case 27:t.next=54;break;case 29:if(0===(f=tn({x:n.startIndex+n.count-1,y:n.archetypeIndex})).entityIndex){t.next=52;break}d=Object(m.a)(this.getRangeComponentDataSlices(e,new on(n.archetypeIndex,n.startIndex,n.count-(f.entityIndex+1)))),t.prev=32,d.s();case 34:if((p=d.n()).done){t.next=40;break}return v=p.value,t.next=38,v;case 38:t.next=34;break;case 40:t.next=45;break;case 42:t.prev=42,t.t1=t.catch(32),d.e(t.t1);case 45:return t.prev=45,d.f(),t.finish(45);case 48:return t.next=50,i.selectRelative({x:0,y:f.chunkIndex,width:f.entityIndex+1,height:1});case 50:t.next=54;break;case 52:return t.next=54,i.selectRelative({x:0,y:r.chunkIndex,width:_e.ChunkSize,height:f.chunkIndex-r.chunkIndex});case 54:case"end":return t.stop()}}),t,this,[[11,21,24,27],[32,42,45,48]])}))},{key:"getEntityComponentDataSlice",value:function(t,e){var n=this.dataCell(e);if(n){var a=Object(r.a)(Object(r.a)({},n),{},{width:1,height:1}),i=this.components[t.name];return this.texture.sliceRange(i.layerOffset,ie(t)).selectAbsolute(a)}}},{key:"setComponentData",value:function(t,e,n){if(e instanceof on)1===e.count?this.setComponentData(t,{x:e.startIndex,y:e.archetypeIndex},n):this.setRangeComponentData(t,e,n);else{var a=this.getEntityComponentDataSlice(t,e);if(!a)throw new Error("No data cell for entity ".concat(JSON.stringify(e)));n.length>a.layers.length&&console.warn("GpuBuffer.setComponentData: More data provided (".concat(n.length,') than fits the target component "').concat(t.name,'" (').concat(a.layers.length,"). The data uploaded will be truncated."));for(var i=0;i<n.length&&i<a.layers.length;i++)a.slice([i]).upload(n[i])}}},{key:"setRangeComponentData",value:function(t,e,n){var a,i=Object(m.a)(this.getRangeComponentDataSlices(t,e));try{for(i.s();!(a=i.n()).done;){var r=a.value;if(!r)throw new Error("No data for range ".concat(JSON.stringify(e)));n.length>r.layers.length&&console.warn("GpuBuffer.setChunksComponentData: More data provided (".concat(n.length,') than fits the target component "').concat(t.name,'" (').concat(r.layers.length,"). The data uploaded will be truncated."));for(var o=0;o<r.layers.length;o++){var s=n[o];1===s.length&&(s=[s[0],s[0],s[0],s[0]]),r.slice([o]).clear(s)}}}catch(Nt){i.e(Nt)}finally{i.f()}}},{key:"getComponentData",value:function(t,e,n,a){var i=this.getEntityComponentDataSlice(t,e);if(!i)return n?Promise.resolve(void 0):void 0;var r=function(e){return oe(t,e)};if(n){var o=i.readAsync();return a?o:o.then(r)}var s=i.readSync();return a?s:r(s)}},{key:"sizeVec2",get:function(){return{x:this.size.width,y:this.size.height}}}]),t}();function oe(t,e){if("float"===t.buffer.format)return Array.from(e.data);for(var n=[],a=0;a<ie(t);a++)n.push(e.readPixel({x:0,y:0,z:a}));return n}function se(t){switch(t){case"float":return $t.R32F;case"vec4":return $t.RGBA32F}}var ce=function(){function t(e,n,a){var i=this;Object(l.a)(this,t),this.gls=e,this.reduceGlsl=n,this.reduceJs=a,this.renderTarget=new at(this.gls),this.computation=new Xt(this.gls,T+"\n    in vec2 texcoord;\n    out vec4 out_values[".concat(this.gls.maxColorAttachements,"];\n    uniform sampler2DArray source;\n\n    uniform int inputLayers[").concat(this.gls.maxColorAttachements,"];\n\n    void main() {\n      ").concat(new Array(this.gls.maxColorAttachements).fill(0).map((function(t,e){return"{\n        int inputLayer = inputLayers[".concat(e,"];\n        vec4 a = texelFetch(source, ivec3(cellPos * 2 + ivec2(0, 0), inputLayer), 0);\n        vec4 b = texelFetch(source, ivec3(cellPos * 2 + ivec2(1, 0), inputLayer), 0);\n        vec4 c = texelFetch(source, ivec3(cellPos * 2 + ivec2(0, 1), inputLayer), 0);\n        vec4 d = texelFetch(source, ivec3(cellPos * 2 + ivec2(1, 1), inputLayer), 0);\n        out_values[").concat(e,"] = ").concat(i.reduceGlsl(i.reduceGlsl("a","b"),i.reduceGlsl("c","d")),";\n      }")})).join("\n"),"\n    }\n  "))}return Object(p.a)(t,[{key:"destroy",value:function(){this.renderTarget.destroy(),this.computation.destroy()}},{key:"reduceGl",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,n=Math.max(t.rect.width,t.rect.height);for(this.gls.disable(this.gls.gl.BLEND),this.gls.disable(this.gls.gl.CULL_FACE),this.gls.disable(this.gls.gl.DEPTH_TEST);n>e;){if(n/=2,t.rect.width<n||t.rect.height<n)throw new Error("Texture too small. Expected at least (".concat(n,", ").concat(n,"), but is (").concat(t.rect.width,", ").concat(t.rect.height,")"));this.renderTarget.set(t.back),this.gls.viewport={x:0,y:0,width:n,height:n},this.computation.setUniforms({inputLayers:{type:"int[]",value:t.layers},source:{type:"sampler2DArray",value:t.front.texture}}),this.gls.drawQuad(this.computation),t.texture.swap()}}},{key:"reduceSync",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8;return this.reduceGl(t,e),t.front.selectAbsolute({x:0,y:0,width:e,height:e}).readSync().reduce(this.reduceJs)}},{key:"reduceAsync",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a,i=arguments;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:8,a=i.length>2?i[2]:void 0,this.reduceGl(e,n),t.next=5,e.front.selectAbsolute({x:0,y:0,width:n,height:n}).readAsync(a);case 5:return t.abrupt("return",t.sent.reduce(this.reduceJs));case 6:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()}],[{key:"reduceSum",value:function(e){return new t(e,(function(t,e){return"".concat(t," + ").concat(e)}),(function(t,e){return t+e}))}},{key:"reduceMax",value:function(e){return new t(e,(function(t,e){return"max(".concat(t,", ").concat(e,")")}),(function(t,e){return Math.max(t,e)}))}},{key:"reduceMin",value:function(e){return new t(e,(function(t,e){return"min(".concat(t,", ").concat(e,")")}),(function(t,e){return Math.min(t,e)}))}}]),t}();var ue=At([],{PI:bt("float",R(Math.PI))}),le=At([],{rand:Ct("float",[["vec2","co"]],"\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n  ")}),he=At("RandomUtil",[le],{choiceBool:Ct("bool",[["float","distribution"],["float","random"]],"\n    return random < distribution;\n  "),randomSeed:pt("float",(function(t){return t.data.randomSeed})),entityStaticRandom:Ct("float",[["ivec2","entityCell"],["float","seed1"],["float","seed2"]],"\n    return ".concat(le.rand,"(vec2(seed1, seed2) + vec2(entityCell) / vec2(1024) );\n  ")),entityRandom:Ct("float",[["ivec2","entityCell"],["float","seed1"],["float","seed2"]],"\n    return Self.entityStaticRandom(entityCell, seed1, seed2 + Self.randomSeed);\n  ")}),fe=At("RandomBoxMuller",[le,ue],{sample:Ct("float",[["vec2","seed1"],["vec2","seed2"]],"\n    float u;\n    float v;\n    while ((u = ".concat(le.rand,"(seed1)) == 0.) {\n      seed1 += 0.01;\n    }\n    while ((v = ").concat(le.rand,"(seed2)) == 0.) {\n      seed2 += 0.01;\n    }\n    return sqrt(-2.0 * log(u)) * cos(2.0 * ").concat(ue.PI," * v);\n  "))});function de(t,e){return Ct(e,[[t,"x"],[t,"x0"],[t,"x1"],[e,"y0"],[e,"y1"]],"\n    ".concat(t," p = (x - x0) / (x1 - x0);\n    return mix(y0, y1, p);\n  "))}function me(t,e){return Ct(e,[[t,"x"],[t,"x0"],[t,"x1"],[e,"y0"],[e,"y1"]],"\n    ".concat(t," p = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\n    return mix(y0, y1, p);\n  "))}var pe=At([],{interpolate:xt([de("float","float"),de("float","vec3"),de("vec2","vec2"),de("vec3","vec3"),de("vec4","vec4")]),interpolateClamped:xt([me("float","float"),me("float","vec3"),me("vec2","vec2"),me("vec3","vec3"),me("vec4","vec4")])}),ve=At("Matrix",[],{translate:xt([Ct("mat4",[["vec3","position"]],"\n      return mat4(\n        1, 0, 0, 0,\n        0, 1, 0, 0,\n        0, 0, 1, 0,\n        position.x, position.y, position.z, 1\n      );\n    "),Ct("mat4",[["vec2","position"]],"\n      return mat4(\n        1, 0, 0, 0,\n        0, 1, 0, 0,\n        0, 0, 1, 0,\n        position.x, position.y, 0, 1\n      );\n    ")]),scale:xt([Ct("mat4",[["vec3","scale"]],"\n      return mat4(\n        scale.x, 0, 0, 0,\n        0, scale.y, 0, 0,\n        0, 0, scale.z, 0,\n        0, 0, 0, 1\n      );\n    ")]),translateScale:xt([Ct("mat4",[["vec3","position"],["vec3","scale"]],"\n      return mat4(\n        scale.x, 0, 0, 0,\n        0, scale.y, 0, 0,\n        0, 0, scale.z, 0,\n        position.x, position.y, position.z, 1\n      );\n    "),Ct("mat4",[["vec2","position"],["vec3","scale"]],"\n      return mat4(\n        scale.x, 0, 0, 0,\n        0, scale.y, 0, 0,\n        0, 0, 1, 0,\n        position.x, position.y, 0, 1\n      );\n    ")]),rotateTranslateScale:Ct("mat4",[["vec4","quaternion"],["vec3","position"],["vec3","scale"]],"\n    // Quaternion math\n    float x = quaternion[0];\n    float y = quaternion[1];\n    float z = quaternion[2];\n    float w = quaternion[3];\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = scale[0];\n    float sy = scale[1];\n    float sz = scale[2];\n\n    return mat4(\n      (1.0 - (yy + zz)) * sx,\n      (xy + wz) * sx,\n      (xz - wy) * sx,\n      0.0,\n      (xy - wz) * sy,\n      (1.0 - (xx + zz)) * sy,\n      (yz + wx) * sy,\n      0.0,\n      (xz + wy) * sz,\n      (yz - wx) * sz,\n      (1.0 - (xx + yy)) * sz,\n      0.0,\n      position[0],\n      position[1],\n      position[2],\n      1.0\n    );\n  "),rotateX:Ct("mat4",[["float","rad"]],"\n    float c = cos(rad);\n    float s = sin(rad);\n    return mat4(\n        1, 0, 0, 0,\n        0, c, s, 0,\n        0, -s, c, 0,\n        0, 0, 0, 1\n    );\n  "),rotateY:Ct("mat4",[["float","rad"]],"\n    float c = cos(rad);\n    float s = sin(rad);\n    return mat4(\n        c, 0, -s, 0,\n        0, 1, 0, 0,\n        s, 0, c, 0,\n        0, 0, 0, 1\n    );\n  "),rotateZ:Ct("mat4",[["float","rad"]],"\n    float c = cos(rad);\n    float s = sin(rad);\n    return mat4(\n        c, s, 0, 0,\n        -s, c, 0, 0,\n        0, 0, 1, 0,\n        0, 0, 0, 1\n    );\n  "),forwardRightUp:xt([Ct("mat4",[["vec3","forward"],["vec3","right"],["vec3","up"]],"\n      return mat4(\n        forward.x, forward.y, forward.z, 0,\n        right.x, right.y, right.z, 0,\n        up.x, up.y, up.z, 0,\n        0, 0, 0, 1\n      );\n    ")]),toBillboard:Ct("mat4",[["mat4","modelView"]],"\n    modelView[0][0] = 1.0;\n    modelView[0][1] = 0.0;\n    modelView[0][2] = 0.0;\n\n    modelView[1][0] = 0.0;\n    modelView[1][1] = 1.0;\n    modelView[1][2] = 0.0;\n\n    modelView[2][0] = 0.0;\n    modelView[2][1] = 0.0;\n    modelView[2][2] = 1.0;\n    return modelView;\n  "),transformPoint:Ct("vec3",[["mat4","transform"],["vec3","point"]],"\n    vec4 p = transform * vec4(point, 1);\n    return p.xyz / p.w;\n  ")}),ge=At([ve],{rectSpaceToClipSpace:Ct("mat4",[["ivec2","rectSize"]],"\n    return ".concat(ve.translateScale,"(\n      vec3(-1, -1, 0),\n      vec3(2) / vec3(rectSize, 1)\n    );\n  ")),cellArrowTransform:Ct("mat4",[["ivec2","rectSize"],["ivec2","cell"]],"\n    return Self.rectSpaceToClipSpace(rectSize) *\n      ".concat(ve.translateScale,"(\n        vec3(cell, 0) + vec3(0.5, 0.5, 0),\n        vec3(0.5, 0.5, 1)\n      );\n  "))}),ye=At([],{isnanPolyfill:Ct("bool",[["float","val"]],"\n    return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;\n  "),withoutNaNInf:xt([Ct("float",[["float","v"]],"\n      return (isnanPolyfill(v) || isinf(v) || isnan(v)) ? 0.0 : v;\n    "),Ct("vec2",[["vec2","v"]],"\n      return vec2(withoutNaNInf(v.x), withoutNaNInf(v.y));\n    "),Ct("vec3",[["vec3","v"]],"\n      return vec3(withoutNaNInf(v.x), withoutNaNInf(v.y), withoutNaNInf(v.z));\n    "),Ct("vec4",[["vec4","v"]],"\n      return vec4(withoutNaNInf(v.x), withoutNaNInf(v.y), withoutNaNInf(v.z), withoutNaNInf(v.w));\n    ")])}),be=function(t){return At("ArrayMax".concat(t),[],{max:Ct("int",[["float[".concat(t,"]"),"values"]],"\n    float maxV = values[0];\n    int maxI = 0;\n    for (int i=1; i < ".concat(t,"; i++) {\n      if (values[i] > maxV) {\n        maxV = values[i];\n        maxI = i;\n      }\n    }\n    return maxI;\n  "))})},we=At("Spatial",[],{forward:Ct("vec2",[["float","angle"]],"\n    return vec2(cos(angle), sin(angle));\n  "),isInFront:Ct("bool",[["vec2","selfPosition"],["vec2","selfForward"],["vec2","otherPosition"]],"\n    vec2 delta = otherPosition - selfPosition;\n    return dot(selfForward, delta) > 0.0;\n  "),angleBetweenVec3s:Ct("float",[["vec3","a"],["vec3","b"],["vec3","planeNormal"]],"\n    // From: https://stackoverflow.com/questions/5188561/signed-angle-between-two-3d-vectors-with-same-origin-within-the-same-plane\n    // Assumes a, b and planeNormal are normalized\n    if (dot(planeNormal, cross(a, b)) < 0.0) {\n      return -acos(dot(a, b));\n    } else {\n      return acos(dot(a, b));\n    }\n  "),angleBetweenVec2s:Ct("float",[["vec2","a"],["vec2","b"]],"\n    return Self.angleBetweenVec3s(vec3(a, 0), vec3(b, 0), vec3(0, 0, 1));\n  "),angleToPosition:Ct("float",[["vec2","selfPosition"],["vec2","selfForward"],["vec2","otherPosition"]],"\n    vec2 delta = otherPosition - selfPosition;\n    if (length(delta) == 0.0) {\n      return 0.0;\n    } else {\n      return Self.angleBetweenVec2s(\n        selfForward,\n        normalize(delta)\n      );\n    }\n  "),relativeRotationTo:Ct("float",[["vec2","selfForward"],["vec2","otherForward"]],"\n    return Self.angleBetweenVec2s(selfForward, otherForward);\n  "),facingUs:Ct("float",[["vec2","selfPosition"],["vec2","otherPosition"],["vec2","otherForward"]],"\n    vec2 delta = otherPosition - selfPosition;\n    return -dot(\n      otherForward,\n      normalize(delta)\n    );\n  ")}),Ce=At([],{perpendicular:Ct("vec2",[["vec2","v"]],"\n    return vec2(v.y, -v.x);\n  ")}),xe=At([ue],{shortestAngleDist:Ct("float",[["float","a0"],["float","a1"]],"\n    float max = ".concat(ue.PI," * 2.0;\n    float da = mod((a1 - a0), max);\n    return mod(2.0 * da, max) - da;\n  ")),angleLerp:Ct("float",[["float","a0"],["float","a1"],["float","t"]],"\n    return a0 + shortestAngleDist(a0, a1) * t;\n  ")});function Ae(t){switch(t){case"float":case"int":case"bool":return".x";case"ivec2":case"vec2":return".xy";case"vec3":case"ivec3":return".xyz";case"vec4":case"ivec4":case"mat4":return""}}function Oe(t){var e=function(t){return At(t.name,[ge],{archetypeDataRowOffset:vt("int[]",_e.MaxArchetypes,(function(e){return e.ecs.gpuBuffers[t.name].archetypeToDataRowOffset}),!1),sampler:pt("sampler2DArray",(function(e){return e.ecs.gpuBuffers[t.name].texture})),dataCell:Ct("ivec2",[["ivec2","entityCell"]],"\n      const int chunkSize = ".concat(_e.ChunkSize,";\n      return ivec2(\n        entityCell.x % chunkSize,\n        entityCell.x / chunkSize + Self.archetypeDataRowOffset[entityCell.y]\n      );\n    ")),get:Ct(t.format,[["ivec2","entityCell"],["int","componentLayer"]],"\n      return texelFetch(Self.sampler, ivec3(\n        Self.dataCell(entityCell),\n        componentLayer\n      ), 0)".concat("float"===t.format?".x":"",";\n    ")),size:pt("ivec2",(function(e){return e.ecs.gpuBuffers[t.name].sizeVec2})),dataArrow:Ct("mat4",[["ivec2","entityCell"]],"\n      return ".concat(ge.cellArrowTransform,"(Self.size, Self.dataCell(entityCell));\n    "))})}(t.buffer),n=pt("int",(function(e){var n,a;return null!==(n=null===(a=e.ecs.gpuComponentInfo(t))||void 0===a?void 0:a.layerOffset)&&void 0!==n?n:1e4})),a=[["ivec2","entityCell"]];void 0!==t.depth&&(a=[].concat(Object(mt.a)(a),[["int","layer"]]));var i=Ct("mat4",[["ivec2","entityCell"]],"\n    return ".concat(e.dataArrow,"(entityCell);\n  "));switch(t.buffer.format){case"float":return At(t.name,[e],{layerOffset:n,value:Ct(t.format,a,"\n        return ".concat(t.format,"(\n          ").concat(new Array(Je(t.format)).fill(0).map((function(n,a){return"".concat(e.get,"(entityCell, Self.layerOffset ").concat(void 0===t.depth?"":"+ layer * ".concat(Je(t.format))," + ").concat(a,")")})).join(",\n"),"\n        );\n      ")),dataArrow:i});case"vec4":return"mat4"===t.format?At(t.name,[e],{layerOffset:n,value:Ct(t.format,a,"\n            return mat4(\n              ".concat(new Array(4).fill(0).map((function(n,a){return"".concat(e.get,"(entityCell, Self.layerOffset ").concat(void 0===t.depth?"":"+ layer * 4"," + ").concat(a,")")})).join(",\n"),"\n            );\n          ")),dataArrow:i}):At(t.name,[e],{layerOffset:n,value:Ct(t.format,a,"\n            return ".concat(t.format,"(").concat(e.get,"(entityCell, Self.layerOffset ").concat(void 0===t.depth?"":"+ layer",")").concat(Ae(t.format),");\n          ")),dataArrow:i})}}function je(t){return At(t.name+"HasComponent",[],{componentId:pt("int",(function(e){return e.ecs.components[t.name].index})),archetypeHasComponentTexture:pt("usampler2D",(function(t){return t.ecs.archetypeHasComponentTexture})),value:Ct("bool",[["ivec2","entityCell"]],"\n      return bool(texelFetch(Self.archetypeHasComponentTexture, ivec2(Self.componentId, entityCell.y), 0).x);\n    ")})}function Se(t){var e,n=Je(t.format),a=null!==(e=t.depth)&&void 0!==e?e:1,i=[["".concat(t.format).concat(void 0===t.depth?"":"[".concat(t.depth,"]")),"data"]];switch(t.buffer.format){case"float":return At(t.name+"Writer",[],{write:Ct("void",i,"\n        ".concat(new Array(a).fill(0).map((function(e,a){return new Array(n).fill(0).map((function(e,i){return"outValues[".concat(t.name,"_outOffset + ").concat(a*n," + ").concat(i,"] = vec4(data").concat(void 0===t.depth?"":"[".concat(a,"]")).concat(1===n?"":"[".concat(i,"]"),");")})).join("\n")})).join("\n"),"\n      "))});case"vec4":var r=Math.ceil(n/4);return At(t.name+"Writer",[],{write:Ct("void",i,"\n          ".concat(new Array(a).fill(0).map((function(e,n){return new Array(r).fill(0).map((function(e,a){return"outValues[".concat(t.name,"_outOffset + ").concat(n*r," + ").concat(a,"] = ").concat(function(t,e,n){switch(t){case"float":case"int":case"bool":return"vec4(".concat(e,")");case"ivec2":case"vec2":return"vec4(".concat(e,", 0, 0)");case"vec3":case"ivec3":return"vec4(".concat(e,", 0)");case"vec4":case"ivec4":return e;case"mat4":return"data[".concat(n,"]")}}(t.format,"data"+(void 0===t.depth?"":"[".concat(n,"]")),a),";")})).join("\n")})).join("\n"),"\n        "))})}}var ke=function(){function t(e,n,a,i){Object(l.a)(this,t),this.gls=e,this.archetypes=n,this.component=a,this.map=i,this.reader=Oe(this.component),this.writer=Se(this.component),this.isReading=2===this.map.map.args.length,this.updateMulti=new Ie(this.gls,this.archetypes,[this.component],At([this.map,this.writer].concat(Object(mt.a)(this.isReading?[this.reader]:[])),{update:Ct("void",[["ivec2","entityCell"]],"\n      ".concat(this.writer.write,"(").concat(this.map.map,"(entityCell").concat(this.isReading?", ".concat(this.reader.value,"(entityCell)"):"","));\n    "))}),"set")}return Object(p.a)(t,[{key:"run",value:function(t){this.updateMulti.run(t)}}]),t}(),Ie=function(){function t(e,n,a,i,o){var s=this;Object(l.a)(this,t),this.gls=e,this.archetypes=n,this.components=a,this.update=i,this.updateType=o,this.arrows="ivec2"===this.update.update.returnType,this.renderTarget=new at(this.gls),this.componentDepths=this.components.map((function(t){return ie(t)})),this.componentOffsets=this.components.reduce((function(t,e){return[].concat(Object(mt.a)(t),[t[t.length-1]+ie(e)])}),[0]),this.componentsTotalDepth=this.componentOffsets[this.componentOffsets.length-1],this.outDepth=this.componentsTotalDepth+(this.arrows?1:0),this.writeShaderPrep=At([],Object(r.a)({outValues:yt("vec4[".concat(this.outDepth,"]"))},this.components.reduce((function(t,e,n){return Object(r.a)(Object(r.a)({},t),{},Object(G.a)({},"".concat(e.name,"_outOffset"),bt("int",""+s.componentOffsets[n])))}),{}))),this.shader=new jt(At([this.writeShaderPrep,this.update],{outArchetype:pt("int"),outYOffset:pt("int"),main:Ct("void",[],"\n      ivec2 outDataCell = ivec2(gl_FragCoord) - ivec2(0, outYOffset);\n      ivec2 outEntityCell = ivec2(\n        outDataCell.y * ".concat(_e.ChunkSize," + outDataCell.x,\n        outArchetype\n      );\n      ").concat(this.arrows?"\n        ivec2 targetEntityCell = ".concat(this.update.update,"(outEntityCell);\n        outValues[").concat(this.outDepth-1,"] = vec4(targetEntityCell, 0, 0);\n      "):"\n        ".concat(this.update.update,"(outEntityCell);\n      "),"\n    "))})),this.program=new Xt(this.gls,this.shader.source),this.copyArrows=this.arrows?new Ee(this.gls,this.componentsTotalDepth,"sum"===this.updateType?te.Sum:void 0):void 0}return Object(p.a)(t,[{key:"run",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.shader.updateUniformValues(t);var n=this.archetypes.get(t),a=n.reduce((function(t,e){return t+e.chunks.length}),0),i=this.gls.getTmpTexture($t.RGBA32F,{width:_e.ChunkSize,height:a},this.outDepth),r=0;this.program.prepare(),this.shader.writeUniforms(this.program);var o,s=Object(m.a)(n);try{for(s.s();!(o=s.n()).done;){var c=o.value,u=c.chunks.reduce((function(t,e){return Math.max(t,e.entities)}),0),l=i.sliceRange(0,this.outDepth).selectAbsolute({x:0,y:r,width:u,height:c.chunks.length});this.program.setUniform("outArchetype","int",c.index),this.program.setUniform("outYOffset","int",r);var h,f=Object(m.a)(e);try{for(f.s();!(h=f.n()).done;){var d=h.value;this.program.setUniform(d.name,d.type,d.value)}}catch(Nt){f.e(Nt)}finally{f.f()}this.renderTarget.set(l),this.gls.prepareForComputation(l.rect),this.gls.drawQuad(this.program),r+=c.chunks.length}}catch(Nt){s.e(Nt)}finally{s.f()}for(var p=0;p<this.components.length;p++){var v=t.ecs.gpuComponentInfo(this.components[p]);if(v){r=0;for(var g=0;g<n.length;g++){var y=n[g],b=y.chunks.reduce((function(t,e){return Math.max(t,e.entities)}),0),w=i.sliceRange(0,this.outDepth).selectAbsolute({x:0,y:r,width:b,height:y.chunks.length});r+=y.chunks.length;var C=w.sliceRange(this.componentOffsets[p],this.componentDepths[p]);if(this.copyArrows)this.copyArrows.run(C,v.slice,v.buffer);else{for(var x=v.slice.selectAbsolute({x:0,y:v.buffer.archetypes[y.index].dataRowOffset,width:b,height:y.chunks.length});g+1<n.length;){var A=n[g+1];if(x.rect.y+x.rect.height!==v.buffer.archetypes[A.index].dataRowOffset)break;x.rect.height+=A.chunks.length,w.rect.height+=A.chunks.length;var O=A.chunks.reduce((function(t,e){return Math.max(t,e.entities)}),0);x.rect.width=Math.max(x.rect.width,O),g++,r+=A.chunks.length}this.gls.getCopyTexture().copy(x,C,this.updateType)}}}}}}]),t}(),Ee=function(){function t(e,n,a){Object(l.a)(this,t),this.gls=e,this.valuesDepth=n,this.blendMode=a,this.vertexShader=new jt(At([It,ge],{targetArchetypeDataRowOffset:vt("int[]",_e.MaxArchetypes),targetDataCell:Ct("ivec2",[["ivec2","entityCell"]],"\n      const int chunkSize = ".concat(_e.ChunkSize,";\n      return ivec2(\n        entityCell.x % chunkSize,\n        entityCell.x / chunkSize + Self.targetArchetypeDataRowOffset[entityCell.y]\n      );\n    ")),targetSize:pt("ivec2"),sourceDataCell:yt("ivec2",!0),source:pt("sampler2DArray"),sourceOffset:pt("ivec2"),main:Ct("void",[],"\n      sourceDataCell = ivec2(\n        gl_InstanceID % ".concat(_e.ChunkSize,",\n        gl_InstanceID / ").concat(_e.ChunkSize,"\n      ) + sourceOffset;\n      ivec2 targetEntityCell = ivec2(texelFetch(source, ivec3(sourceDataCell, ").concat(this.valuesDepth,"), 0).xy);\n      if (targetEntityCell.x < 0) {\n        gl_Position = vec4(-1);\n        return;\n      }\n      mat4 arrow = ").concat(ge.cellArrowTransform,"(Self.targetSize, Self.targetDataCell(targetEntityCell));\n      gl_Position = arrow * vec4(").concat(It.position,", 1);\n    "))})),this.fragmentShader=new jt(At([],{source:pt("sampler2DArray"),sourceDataCell:gt("ivec2",!0),outValues:yt("vec4[8]"),sourceLayerOffset:pt("int"),sourceCount:pt("int"),main:Ct("void",[],"\n      vec4 values[8];\n      for (int i=0; i < sourceCount; i++) {\n        values[i] = texelFetch(source, ivec3(sourceDataCell, sourceLayerOffset + i), 0);\n      }\n      outValues = values;\n    ")})),this.program=new Xt(this.gls,this.fragmentShader.source,this.vertexShader.source),this.renderTarget=new at(this.gls)}return Object(p.a)(t,[{key:"run",value:function(t,e,n){this.program.prepare(),this.program.setUniform("targetArchetypeDataRowOffset","int[]",n.archetypeToDataRowOffset),this.program.setUniform("targetSize","ivec2",n.sizeVec2),this.program.setUniform("source","sampler2DArray",t.texture),this.program.setUniform("sourceOffset","ivec2",t.rect),this.program.setUniform("sourceLayerOffset","int",t.layers[0]),this.program.setUniform("sourceCount","int",t.layers.length),this.renderTarget.set(e),this.gls.prepareForComputation(e.rect,this.blendMode),this.gls.drawQuad(this.program,t.rect.width*t.rect.height)}}]),t}(),Te=function(){function t(){Object(l.a)(this,t),this.value=void 0,this.disposeValue=void 0,this.deps=[]}return Object(p.a)(t,[{key:"get",value:function(t,e,n){if(void 0===this.value)return this.value=t();for(var a=0;a<e.length;a++)if(this.deps[a]!==e[a])return this.deps=e,this.disposeValue&&this.disposeValue(this.value),this.disposeValue=n,this.value=t();return this.value}},{key:"destroy",value:function(){this.disposeValue&&void 0!==this.value&&this.disposeValue(this.value),this.value=void 0}}]),t}(),Re=function(){function t(e){Object(l.a)(this,t),this.requiredComponents=e,this.cache=new Te}return Object(p.a)(t,[{key:"destroy",value:function(){}},{key:"get",value:function(t){var e=this;return this.cache.get((function(){return t.ecs.getMatchingArchetypes(e.requiredComponents)}),[t.ecs.archetypes])}},{key:"entityBlocks",value:function(){return new Pe(this)}},{key:"gpuComponentBlocks",value:function(t){return new Fe(this,t)}},{key:"updateGpu",value:function(t,e,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"set";return new Ie(t,this,e,n,a)}},{key:"mapGpu",value:function(t,e,n){return new ke(t,this,e,n)}}]),t}(),De=function(){function t(e){Object(l.a)(this,t),this.archetypeIndex=e}return Object(p.a)(t,[{key:"destroy",value:function(){}},{key:"get",value:function(t){var e=t.ecs.archetypes[this.archetypeIndex];return e?[e]:[]}},{key:"entities",value:function(){return new Ge(this)}},{key:"entityBlocks",value:function(){return new Pe(this)}},{key:"gpuComponentBlocks",value:function(t){return new Fe(this,t)}}]),t}(),Pe=function(){function t(e){Object(l.a)(this,t),this.archetypes=e,this.cache=new Te}return Object(p.a)(t,[{key:"destroy",value:function(){this.archetypes.destroy()}},{key:"get",value:function(t){var e=this.archetypes.get(t);return this.cache.get((function(){var t,n=[],a=Object(m.a)(e);try{for(a.s();!(t=a.n()).done;){var i=t.value;n.push(new sn(i.index,i.chunks.reduce((function(t,e){return t+e.entities}),0)))}}catch(Nt){a.e(Nt)}finally{a.f()}return n}),[e,t.ecs.formVersion])}}]),t}(),Fe=function(){function t(e,n){Object(l.a)(this,t),this.archetypes=e,this.component=n,this.cache=new Te}return Object(p.a)(t,[{key:"destroy",value:function(){this.archetypes.destroy()}},{key:"get",value:function(t){var e=this,n=this.archetypes.get(t);return this.cache.get((function(){var a,i=t.ecs.gpuBuffers[e.component.buffer.name],r=[],o=Object(m.a)(n);try{for(o.s();!(a=o.n()).done;){var s=a.value,c=i.archetypes[s.index];r.push(new rn(i.getArchetypeComponentDataSlice(e.component,s),s,c.dataRowOffset))}}catch(Nt){o.e(Nt)}finally{o.f()}return r}),[n,t.ecs.formVersion])}},{key:"uploadFrom",value:function(t){return new Be(this,t)}}]),t}(),Be=function(){function t(e,n){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Object(l.a)(this,t),this.blocks=e,this.fromComponent=n,this.alwaysUpload=a,this.contentVersions={},this.prevBlocks=[]}return Object(p.a)(t,[{key:"destroy",value:function(){this.blocks.destroy()}},{key:"run",value:function(t){var e=this.blocks.get(t);this.prevBlocks!==e&&(this.prevBlocks=e,this.contentVersions={});var n,a=Object(m.a)(e);try{for(a.s();!(n=a.n()).done;)for(var i=n.value,r=0;r<i.archetype.chunks.length;r++){var o=i.archetype.chunks[r].cpuComponent[this.fromComponent.name],s=i.archetype.index+"_"+r;(o.contentVersion!==this.contentVersions[s]||this.alwaysUpload)&&(this.contentVersions[s]=o.contentVersion,i.slices.selectRelative({x:0,y:r,width:i.slices.rect.width,height:1}).upload(o.data))}}catch(Nt){a.e(Nt)}finally{a.f()}}}]),t}(),Me=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];Object(l.a)(this,t),this.requiredComponents=e,this.filters=[],this.cachedArchetypes=new Te,this.cachedEntities=new Te}return Object(p.a)(t,[{key:"destroy",value:function(){}},{key:"filterValue",value:function(t,e,n){return this.filters.push({component:t,filter:e,cacheKeys:n,entities:new Te}),this}},{key:"get",value:function(t){var e,n=this,a=this.cachedArchetypes.get((function(){return t.ecs.getMatchingArchetypes([].concat(Object(mt.a)(n.requiredComponents),Object(mt.a)(n.filters.map((function(t){return t.component})))))}),[t.ecs.archetypes].concat(Object(mt.a)(this.requiredComponents))),i=this.cachedEntities.get((function(){return t.ecs.getEntityRefsForArchetypes(a)}),[a,t.ecs.formVersion]),r=Object(m.a)(this.filters);try{var o=function(){var n,r=e.value,o=[i].concat(Object(mt.a)(r.cacheKeys(t))),s=Object(m.a)(a);try{for(s.s();!(n=s.n()).done;)for(var c=n.value,u=0;u<c.chunks.length;u++){var l=c.chunks[u],h="cpu"===r.component.type?l.cpuComponent[r.component.name]:l.objComponent[r.component.name];o.push(h.contentVersion)}}catch(Nt){s.e(Nt)}finally{s.f()}var f=r.entities.get((function(){return i.filter((function(e){var n=t.ecs.getComponentData(r.component,e);return r.filter(n,t)}))}),o);i=f};for(r.s();!(e=r.n()).done;)o()}catch(Nt){r.e(Nt)}finally{r.f()}return i}},{key:"updateCpu",value:function(t,e){return new ze(this,t,e)}},{key:"transform",value:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}((function(t){return new He(this,t)}))},{key:"toGpu",value:function(t){return new Le(this,t)}},{key:"lookupTable",value:function(t,e){return new Ye(this,t,e)}},{key:"render",value:function(t,e){return new Ne(this,t,e)}}]),t}(),ze=function(){function t(e,n,a){Object(l.a)(this,t),this.entities=e,this.update=n,this.dependencyKeys=a,this.deps=[]}return Object(p.a)(t,[{key:"destroy",value:function(){this.entities.destroy()}},{key:"run",value:function(t){for(var e=this.entities.get(t),n=[e].concat(Object(mt.a)(this.dependencyKeys(t))),a=0;a<n.length;a++)if(this.deps[a]!==n[a])return this.deps=n,void this.update(t,e)}}]),t}(),Ne=function(){function t(e,n,a){Object(l.a)(this,t),this.entities=e,this.gls=n,this.props=a,this.maxEntities=128,this.vertexShader=new jt(At([this.props.vertexShader],{entities:vt("ivec2[]",this.maxEntities),main:Ct("void",[],"\n      ".concat(this.props.vertexShader.shader,"(Self.entities[gl_InstanceID]);\n    "))})),this.fragmentShader=new jt(this.props.fragmentShader),this.program=new Xt(this.gls,this.fragmentShader.source,this.vertexShader.source)}return Object(p.a)(t,[{key:"destroy",value:function(){this.entities.destroy(),this.program.destroy()}},{key:"run",value:function(t){var e=this.entities.get(t);if(0!==e.length){if(e.length>=this.maxEntities)throw new Error("Max entities reached");this.vertexShader.updateUniformValues(t),this.fragmentShader.updateUniformValues(t),this.program.prepare(),this.vertexShader.writeUniforms(this.program),this.fragmentShader.writeUniforms(this.program),this.program.setUniform("entities","ivec2[]",e);var n=this.gls.getMesh(this.props.mesh);if(!n)throw new Error("No such mesh: ".concat(this.props.mesh));this.gls.draw(this.program,n,e.length)}}}]),t}(),Ge=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(t){var a;return Object(l.a)(this,n),(a=e.call(this)).archetypes=t,a.cache=new Te,a}return Object(p.a)(n,[{key:"destroy",value:function(){this.archetypes.destroy()}},{key:"get",value:function(t){var e=this.archetypes.get(t);return this.cache.get((function(){return t.ecs.getEntityRefsForArchetypes(e)}),[e,t.ecs.formVersion])}}]),n}(Me),He=function(){function t(e,n){Object(l.a)(this,t),this.entities=e,this.transform=n,this.cache=new Te}return Object(p.a)(t,[{key:"destroy",value:function(){this.entities.destroy()}},{key:"get",value:function(t){var e=this,n=this.entities.get(t);return this.cache.get((function(){return e.transform(t,n)}),[n])}}]),t}(),Le=function(){function t(e,n){Object(l.a)(this,t),this.entities=e,this.gls=n,this.cache=new Te,this.chunkWidth=128}return Object(p.a)(t,[{key:"destroy",value:function(){this.entities.destroy(),this.cache.destroy()}},{key:"get",value:function(t){var e=this,n=this.entities.get(t);return this.cache.get((function(){var t;if(0!==n.length){for(var a=et.zeroesI32({width:Math.min(n.length,e.chunkWidth),height:Math.ceil(n.length/e.chunkWidth),depth:1},2),i=0;i<n.length;i++)a.write(n[i].x,i%e.chunkWidth,Math.floor(i/e.chunkWidth),0,0),a.write(n[i].y,i%e.chunkWidth,Math.floor(i/e.chunkWidth),0,1);t=new ut(e.gls,e.gls.gl.RG32I,a.size,void 0).init(a.data)}else t=new ut(e.gls,e.gls.gl.RG32I,{width:1,height:1}).init();return{entityList:n,entityListTexture:t}}),[n],(function(t){return t.entityListTexture.destroy()}))}},{key:"map",value:function(t){function e(e,n){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}((function(t,e){return new Ue(this,this.gls,t,e)}))},{key:"mapToTemp",value:function(t){return new Ve(this,this.gls,t)}}]),t}(),Ue=function(){function t(e,n,a,i){Object(l.a)(this,t),this.entities=e,this.gls=n,this.map=a,this.output=i,this.renderTarget=new at(this.gls),this.shader=new jt(At([this.map],{entityList:pt("isampler2D"),outValue:yt(this.map.map.returnType),main:Ct("void",[],"\n      ivec2 outEntityCell = texelFetch(entityList, ivec2(gl_FragCoord), 0).xy;\n      outValue = ".concat(this.map.map,"(outEntityCell);\n    "))})),this.program=new Xt(this.gls,this.shader.source)}return Object(p.a)(t,[{key:"destroy",value:function(){this.entities.destroy(),this.renderTarget.destroy(),this.program.destroy()}},{key:"get",value:function(t){var e=this.entities.get(t),n=e.entityList,a=e.entityListTexture,i=this.output(t,a.size);return this.shader.updateUniformValues(t),this.program.prepare(),this.shader.writeUniforms(this.program),this.renderTarget.set(i instanceof ht?i:i.back),this.gls.prepareForComputation(i.rect),this.program.setUniform("entityList","isampler2D",a),this.gls.drawQuad(this.program),i instanceof ft&&this.gls.getCopyTexture().copyBackToFront(i),{entityList:n,values:i instanceof ft?i.front:i}}},{key:"toCpuQueuing",value:function(t){return new qe(this,t)}},{key:"toCpuSync",value:function(){return new Qe(this)}},{key:"reduceSum",value:function(){return new We(this,this.gls)}}]),t}(),Ve=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(t,a,i){var r;return Object(l.a)(this,n),(r=e.call(this,t,a,i,(function(t,e){var n,a=null!==(n=function(t){var e=t.indexOf("[");if(-1!==e)return Number.parseInt(t.slice(e+1,t.length-1))}(i.map.returnType))&&void 0!==n?n:1;return(r.tmp.size.width<e.width||r.tmp.size.height<e.height||r.tmp.depth<a)&&(r.tmp.destroy(),r.tmp=ut.create(r.gls,r.gls.gl.RGBA32F,e,a).init()),r.tmp.sliceAll().clear(),r.tmp.sliceRange(0,a)}))).tmp=ut.create(r.gls,r.gls.gl.RGBA32F,{width:1,height:1},1).init(),r}return Object(p.a)(n,[{key:"destroy",value:function(){this.entities.destroy(),this.tmp.destroy()}}]),n}(Ue),Qe=function(){function t(e){Object(l.a)(this,t),this.query=e}return Object(p.a)(t,[{key:"destroy",value:function(){this.query.destroy()}},{key:"get",value:function(t){var e=this.query.get(t),n=e.values.readSync();return e.entityList.map((function(t,a){return{entityCell:t,value:new Array(n.size.depth).fill(0).map((function(t,i){return n.readPixel({x:a%e.values.rect.width,y:Math.floor(a/e.values.rect.width),z:i})}))}}))}}]),t}(),qe=function(){function t(e,n){Object(l.a)(this,t),this.query=e,this.queueCashKey=n,this.resultReader=new Te,this.resultQueue=new Te}return Object(p.a)(t,[{key:"destroy",value:function(){this.query.destroy(),this.resultReader.destroy()}},{key:"queueRead",value:function(t){var e=this.query.get(t),n=this.resultReader.get((function(){return new V(e.values)}),[e.values],(function(t){return t.destroy()})).read("background",e.values.rect),a=this.resultQueue.get((function(){return[]}),[t,e.entityList,this.queueCashKey(t)]);return a.push((function(){var t=n();if(t)return e.entityList.map((function(n,a){return{entityCell:n,value:new Array(t.size.depth).fill(0).map((function(n,i){return t.readPixel({x:a%e.values.rect.width,y:Math.floor(a/e.values.rect.width),z:i})}))}}))})),function(){for(var t=[];a.length>0;){var e=a[0]();if(!e)return t;a.shift(),t.push(e)}return t}}}]),t}(),We=function(){function t(e,n){Object(l.a)(this,t),this.query=e,this.gls=n,this.reduce=ce.reduceSum(this.gls),this.tmp=lt.create(this.gls,$t.RGBA32F,{width:1,height:1},1).init()}return Object(p.a)(t,[{key:"destroy",value:function(){this.query.destroy(),this.reduce.destroy(),this.tmp.destroy()}},{key:"get",value:function(t){var e=this.query.get(t),n=Object(y.j)(e.values.rect);(this.tmp.size.width<n.width||this.tmp.size.height<n.height||this.tmp.depth<e.values.layers.length)&&(this.tmp.destroy(),this.tmp=lt.create(this.gls,$t.RGBA32F,n,e.values.layers.length).init()),this.tmp.clear();var a=this.tmp.sliceAll().selectAbsolute(Object(r.a)({x:0,y:0},n));return this.gls.getCopyTexture().copy(a.selectAbsolute(e.values.rect).front,e.values),this.reduce.reduceSync(a)}}]),t}(),Ye=function(){function t(e,n,a){Object(l.a)(this,t),this.entities=e,this.indexWidth=n,this.index=a,this.cache=new Te}return Object(p.a)(t,[{key:"destroy",value:function(){this.entities.destroy()}},{key:"get",value:function(t){var e=this,n=this.entities.get(t);return this.cache.get((function(){var a,i={width:e.indexWidth,rows:[]},r=Object(m.a)(n);try{for(r.s();!(a=r.n()).done;){var o=a.value,s=e.index(t,o),c=s.row,u=s.column;i.rows[c]||(i.rows[c]={entities:new Array(e.indexWidth).fill(0).map((function(){return{x:-1,y:-1}}))}),i.rows[c].entities[u]=o}}catch(Nt){r.e(Nt)}finally{r.f()}return i}),[n])}},{key:"toGpu",value:function(t){return new Ke(this,t)}}]),t}(),Xe=At("GpuIndex",[],{entityCell:Ct("ivec2",[["isampler2D","index"],["int","row"],["int","i"]],"\n    return texelFetch(index, ivec2(i, row), 0).xy;\n  ")}),Ke=function(){function t(e,n){Object(l.a)(this,t),this.indexQuery=e,this.gls=n,this.buffer=new ut(this.gls,$t.RG32I,{width:1,height:1}).init(),this.cache=new Te}return Object(p.a)(t,[{key:"destroy",value:function(){this.indexQuery.destroy(),this.buffer.destroy(),this.cache.destroy()}},{key:"get",value:function(t){var e=this,n=this.indexQuery.get(t);return this.cache.get((function(){var t=et.zeroesI32({width:n.width,height:Math.max(1,n.rows.length),depth:1},2);t.fill(-1);for(var a=0;a<n.rows.length;a++)if(n.rows[a])for(var i=0;i<n.rows[a].entities.length;i++){var r=n.rows[a].entities[i];t.write(r.x,i,a,0,0),t.write(r.y,i,a,0,1)}return(e.buffer.size.width<t.size.width||e.buffer.size.height<t.size.height)&&(e.buffer.destroy(),e.buffer=new ut(e.gls,$t.RG32I,t.size).init()),e.buffer.init(t.data),e.buffer}),[n])}}]),t}();function Je(t){switch(t){case"float":case"int":case"bool":return 1;case"vec2":case"ivec2":return 2;case"vec3":case"ivec3":return 3;case"vec4":case"ivec4":return 4;case"mat4":return 16}}function Ze(t){var e=Je(t.format);return void 0!==t.stride?Math.ceil(e/t.stride)*t.stride:e}var _e,$e=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object(l.a)(this,t),this.data=e}return Object(p.a)(t,[{key:"setComponent",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new t(Object(r.a)(Object(r.a)({},this.data),{},Object(G.a)({},e.name,{component:e,data:n})))}},{key:"setComponents",value:function(t,e){var n,a=this,i=Object(m.a)(t);try{for(i.s();!(n=i.n()).done;){var r=n.value;a=(r.type,a.setComponent(r,e))}}catch(Nt){i.e(Nt)}finally{i.f()}return a}},{key:"removeComponent",value:function(e){var n=Object(r.a)({},this.data);return delete n[e.name],new t(n)}},{key:"hasComponent",value:function(t){return!!this.data[t.name]}}]),t}();function tn(t){var e=t.x%_e.ChunkSize;return{chunkIndex:Math.floor(t.x/_e.ChunkSize),entityIndex:e,archIndex:t.y}}function en(t,e,n){return{x:e*_e.ChunkSize+n,y:t}}!function(t){t[t.MaxArchetypes=64]="MaxArchetypes",t[t.ChunkSize=128]="ChunkSize"}(_e||(_e={}));var nn=function(){function t(e,n){Object(l.a)(this,t),this.index=e,this.components=n,this.chunks=[]}return Object(p.a)(t,[{key:"entitiesCount",get:function(){return this.chunks.reduce((function(t,e){return t+e.entities}),0)}}]),t}(),an=function(){function t(e,n){Object(l.a)(this,t),this.archetype=e,this.archetypeDataRowOffset=n}return Object(p.a)(t,[{key:"writeUniforms",value:function(t){t.setUniform("outArchetype","int",this.archetype.index),t.setUniform("outArchetypeDataRowOffset","int",this.archetypeDataRowOffset)}},{key:"uniforms",get:function(){return{outArchetype:{type:"int",value:this.archetype.index},outArchetypeDataRowOffset:{type:"int",value:this.archetypeDataRowOffset}}}},{key:"entitiesCount",get:function(){return this.archetype.entitiesCount}}]),t}();an.SM=At([],{outArchetype:pt("int"),outArchetypeDataRowOffset:pt("int"),getOutEntityCell:Ct("ivec2",[],"\n      ivec2 outDataCell = ivec2(gl_FragCoord);\n      return ivec2(\n        (outDataCell.y - outArchetypeDataRowOffset) * ".concat(_e.ChunkSize," + outDataCell.x,\n        outArchetype\n      );\n    "))});var rn=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(t,a,i){var r;return Object(l.a)(this,n),(r=e.call(this,a,i)).slices=t,r}return n}(an),on=function(){function t(e,n,a){Object(l.a)(this,t),this.archetypeIndex=e,this.startIndex=n,this.count=a}return Object(p.a)(t,[{key:"getIndex",value:function(t){return{x:this.startIndex+t,y:this.archetypeIndex}}},{key:"entities",value:s.a.mark((function t(){var e;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=0;case 1:if(!(e<this.count)){t.next=7;break}return t.next=4,this.getIndex(e);case 4:e++,t.next=1;break;case 7:case"end":return t.stop()}}),t,this)}))}],[{key:"fromEntity",value:function(e){return new t(e.y,e.x,1)}}]),t}(),sn=function(){function t(e,n){Object(l.a)(this,t),this.archetype=e,this.count=n}return Object(p.a)(t,[{key:"writeUniforms",value:function(t){t.setUniform("outArchetype","int",this.archetype)}},{key:"uniforms",get:function(){return{outArchetype:{type:"int",value:this.archetype}}}},{key:"firstEntityCell",get:function(){return{x:0,y:this.archetype}}}]),t}();sn.SM=At([],{outArchetype:pt("int"),getOutEntityCell:Ct("ivec2",[],"\n      return ivec2(\n        gl_InstanceID,\n        outArchetype\n      );\n    ")});var cn=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.gpuBuffers={},this.gpuComponentInfos={},this.components=new Proxy({},{get:function(t,e){return e in t?t[e]:{archetypeHasComponent:[],index:-1}}}),this.formVersion=0,this.chunkSize=_e.ChunkSize,this.archetypeHasComponentTexture=ut.create(this.gls,this.gls.gl.R8UI,{width:1,height:1}).init(),this.archetypes=[],this.archetypesByKey={};for(var n=0,a=Object.keys(t.registeredGpuBuffers);n<a.length;n++){var i=a[n],r=t.registeredGpuBuffers[i];this.gpuBuffers[r.name]=new re(this.gls,r)}}return Object(p.a)(t,[{key:"destroy",value:function(){for(var t=0,e=Object.keys(this.gpuBuffers);t<e.length;t++){var n=e[t];this.gpuBuffers[n].destroy()}this.archetypeHasComponentTexture.destroy()}},{key:"reset",value:function(){throw new Error("This is not working yet")}},{key:"createEntities",value:function(t){var e,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=Object.keys(t.data).map((function(e){return t.data[e]})),i=a.map((function(t){return t.component})),r=this.getOrCreateArchetype(i),o=this.allocateEntities(r,n),s=Object(m.a)(a);try{for(s.s();!(e=s.n()).done;){var c=e.value,u=c.component,l=c.data;("obj"===u.type||"gpu"===u.type&&void 0!==l&&null!==l||"cpu"===u.type&&void 0!==l&&null!==l)&&this.setComponentData(u,o,l)}}catch(Nt){s.e(Nt)}finally{s.f()}return this.formVersion++,o}},{key:"allocateEntities",value:function(t,e){var n,a=t.chunks[t.chunks.length-1],i=e;if(a&&a.entities<this.chunkSize){n=en(t.index,a.index,a.entities);var r=this.chunkSize-a.entities,o=Math.min(e,r);a.entities+=o,i-=o}if(i>0){var s=Math.ceil(i/this.chunkSize),c=this.createArchetypeChunks(t,s);n||(n=en(t.index,c[0].index,0));for(var u=0;u<c.length-1;u++)c[u].entities=this.chunkSize,i-=this.chunkSize;c[c.length-1].entities=i}return new on(t.index,n.x,e)}},{key:"getOrCreateArchetype",value:function(t){var e=t.map((function(t){return t.name})).join("_"),n=this.archetypesByKey[e];return n||this.createArchetype(e,t)}},{key:"createArchetype",value:function(t,e){this.archetypes.length>=_e.MaxArchetypes&&console.warn("[ECS] Exceeded max number of archetypes!");var n=this.archetypes.length,a=new nn(n,e);this.archetypes=[].concat(Object(mt.a)(this.archetypes),[a]),this.archetypesByKey[t]=a;var i,r=Object(m.a)(a.components);try{for(r.s();!(i=r.n()).done;){var o=i.value;o.name in this.components||(this.components[o.name]={archetypeHasComponent:[],component:o,index:Object.keys(this.components).length}),this.components[o.name].archetypeHasComponent[a.index]=!0,"gpu"===o.type&&(this.gpuComponentInfos[o.name]=new un(this,o),this.gpuBuffers[o.buffer.name].enuserComponentAllocated(o))}}catch(Nt){r.e(Nt)}finally{r.f()}return this.createArchetypeHasComponentTexture(),a}},{key:"createArchetypeChunks",value:function(t,e){for(var n=[],a=0;a<e;a++){var i={arch:t,index:t.chunks.length,entities:0,objComponent:{},cpuComponent:{}};t.chunks.push(i),n.push(i);var r,o=Object(m.a)(t.components);try{for(o.s();!(r=o.n()).done;){var s=r.value;if("obj"===s.type&&(i.objComponent[s.name]={data:[],contentVersion:0}),"cpu"===s.type){var c=Ze(s);i.cpuComponent[s.name]={data:new Float32Array(c*this.chunkSize),contentVersion:0}}}}catch(Nt){o.e(Nt)}finally{o.f()}}var u,l=Object(m.a)(t.components);try{for(l.s();!(u=l.n()).done;){var h=u.value;"gpu"===h.type&&this.gpuBuffers[h.buffer.name].setArchetypeChunks(t,t.chunks.length)}}catch(Nt){l.e(Nt)}finally{l.f()}return n}},{key:"getCpuComponentDataView",value:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=tn(e),i=a.chunkIndex,r=a.entityIndex,o=a.archIndex,s=this.archetypes[o].chunks[i],c=Ze(t),u=s.cpuComponent[t.name],l=u.data;if(!l)return null;n&&u.contentVersion++;var h=r*c;return l.subarray(h,h+c)}},{key:"setComponentData",value:function(t,e,n){if("gpu"===t.type&&this.gpuBuffers[t.buffer.name].setComponentData(t,e,function(t,e){var n="vec4"===t?4:1;if(e instanceof Float32Array){for(var a=[],i=0;i<e.length/n;i++)a.push(e.subarray(i*n,(i+1)*n));return a}return e.map((function(t){if(t instanceof Float32Array){if(t.length<n){var e=new Float32Array(n).fill(0);return e.set(t),e}return t}return"number"===typeof t?new Float32Array([t]):new Float32Array([t.x,t.y,t.z,t.w])}))}(t.buffer.format,n)),"cpu"===t.type)if(e instanceof on)for(var a=0;a<e.count;a++)this.setComponentData(t,{x:e.startIndex+a,y:e.archetypeIndex},n);else{var i=this.getCpuComponentDataView(t,e);if(!i)throw new Error("[ECS.setComponentData] Entity (".concat(JSON.stringify(e),") doesn't have component ").concat(t.name,"."));i.set(n)}if("obj"===t.type)if(e instanceof on)for(var r=0;r<e.count;r++)this.setComponentData(t,{x:e.startIndex+r,y:e.archetypeIndex},n);else{var o=tn(e),s=o.chunkIndex,c=o.entityIndex,u=o.archIndex,l=this.archetypes[u].chunks[s].objComponent[t.name];l.data[c]=n,l.contentVersion++}}},{key:"setComponentsData",value:function(t,e,n){var a,i=Object(m.a)(t);try{for(i.s();!(a=i.n()).done;){var r=a.value;r.type,this.setComponentData(r,e,n)}}catch(Nt){i.e(Nt)}finally{i.f()}}},{key:"getComponentData",value:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if("string"===typeof t){var a=this.components[t].component;if(!a)throw new Error("Component doesn't exist in this ecs");if("token"===a.type)throw new Error("Cannot get component data for token component");t=a}if("obj"===t.type){var i,r=tn(e),o=r.archIndex,s=r.chunkIndex,c=r.entityIndex,u=this.archetypes[o];return null===(i=u.chunks[s].objComponent[t.name])||void 0===i?void 0:i.data[c]}return"cpu"===t.type?this.getCpuComponentDataView(t,e,!1):this.gpuBuffers[t.buffer.name].getComponentData(t,e,n,!1)}},{key:"getComponentDataRaw",value:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.gpuBuffers[t.buffer.name].getComponentData(t,e,n,!0)}},{key:"getEntityGpuComponentBlock",value:function(t,e){var n=this.archetypes[e.y],a=this.gpuBuffers[t.buffer.name],i=a.archetypes[e.y];return new rn(a.getEntityComponentDataSlice(t,e),n,i.dataRowOffset)}},{key:"getComponentByName",value:function(t){return this.components[t].component}},{key:"hasComponent",value:function(t,e){if("string"===typeof t){var n=this.components[t].component;if(!n)throw new Error("Component doesn't exist in this ecs");t=n}var a=tn(e),i=a.archIndex;return this.components[t.name].archetypeHasComponent[i]}},{key:"getAllEntityData",value:function(t){var e=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=this.archetypes[t.y].components;return n?Promise.all(a.map(function(){var n=Object(c.a)(s.a.mark((function n(a){var i;return s.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(i=null,"gpu"!==a.type){n.next=7;break}return n.next=4,e.getComponentData(a,t);case 4:i=n.sent,n.next=8;break;case 7:("obj"===a.type||"cpu"===a.type)&&(i=e.getComponentData(a,t));case 8:return n.abrupt("return",{component:a,data:i});case 9:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}())):a.map((function(n){return{component:n,data:"obj"===n.type||"cpu"===n.type?e.getComponentData(n,t):"gpu"===n.type?e.getComponentData(n,t,!1):null}}))}},{key:"getMatchingArchetypes",value:function(t){var e,n=[],a=Object(m.a)(this.archetypes);try{for(a.s();!(e=a.n()).done;){var i=e.value;this.archetypeMatches(i,t)&&n.push(i)}}catch(Nt){a.e(Nt)}finally{a.f()}return n}},{key:"archetypeMatches",value:function(t,e){for(var n=function(n){if(!t.components.find((function(t){return t.name===e[n].name})))return{v:!1}},a=0;a<e.length;a++){var i=n(a);if("object"===typeof i)return i.v}return!0}},{key:"getEntityRefsForArchetypes",value:function(t){var e=this;return g.a.flatMap(t,(function(t){return e.getEntityRefsForArchetype(t)}))}},{key:"getEntityRefsForArchetype",value:function(t){for(var e=[],n=0;n<t.chunks.length;n++)for(var a=0;a<t.chunks[n].entities;a++)e.push(en(t.index,n,a));return e}},{key:"getEntitiesForGpuComponentBlock",value:s.a.mark((function t(e){var n,a,i,r;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=e.archetype,a=0;case 2:if(!(a<n.chunks.length)){t.next=14;break}i=0;case 4:if(!(i<n.chunks[a].entities)){t.next=11;break}return r=en(n.index,a,i),t.next=8,{entityCell:r,blockCell:{x:i,y:a}};case 8:i++,t.next=4;break;case 11:a++,t.next=2;break;case 14:case"end":return t.stop()}}),t)}))},{key:"createArchetypeHasComponentTexture",value:function(){for(var t=Object.keys(this.components),e=et.zeroesU8({width:t.length,height:this.archetypes.length,depth:1},1),n=0;n<this.archetypes.length;n++){var a,i=this.archetypes[n],r=Object(m.a)(i.components);try{for(r.s();!(a=r.n()).done;){var o=a.value,s=t.indexOf(o.name);e.write(1,s,n)}}catch(Nt){r.e(Nt)}finally{r.f()}}this.archetypeHasComponentTexture.size=e.size,this.archetypeHasComponentTexture.init(e.data)}},{key:"removeAllEntities",value:function(){var t,e=Object(m.a)(this.archetypes);try{for(e.s();!(t=e.n()).done;){var n,a=t.value,i=Object(m.a)(a.chunks);try{for(i.s();!(n=i.n()).done;){n.value.entities=0}}catch(Nt){i.e(Nt)}finally{i.f()}}}catch(Nt){e.e(Nt)}finally{e.f()}for(var r=0,o=Object.keys(this.gpuBuffers);r<o.length;r++){var s=o[r];this.gpuBuffers[s].removeAllEntities()}this.formVersion++}},{key:"dump",value:function(){var t=this;console.log("ECS GpuBuffers:");var e=Object.keys(this.gpuBuffers).map((function(e){return{key:e,size:t.gpuBuffers[e].texture.sizeInBytes/1048576}}));e.sort((function(t,e){return t.size-e.size}));var n,a=Object(m.a)(e);try{for(a.s();!(n=a.n()).done;){var i=n.value;console.log("".concat(i.key,": ").concat(i.size,"mb"))}}catch(Nt){a.e(Nt)}finally{a.f()}}},{key:"dumpJSON",value:function(t){var e=this;return this.archetypes.map((function(n){var a=new De(n.index).entities().get(t);return{archetypeIndex:n.index,components:n.components.map((function(t){return{name:t.name,type:t.type,data:"gpu"===t.type?e.gpuBuffers[t.buffer.name].getArchetypeComponentData(t,n):"token"===t.type?void 0:a.map((function(n){return e.getComponentData(t,n)}))}}))}}))}},{key:"gpuBuffer",value:function(t){return this.gpuBuffers[t.name]}},{key:"gpuComponentInfo",value:function(t){return this.gpuComponentInfos[t.name]}}],[{key:"registerComponent",value:function(t){return t}},{key:"registerGpuBuffer",value:function(t){return this.registeredGpuBuffers[t.name]=t,t}}]),t}();cn.registeredGpuBuffers={};var un=function(){function t(e,n){Object(l.a)(this,t),this.ecs=e,this.component=n}return Object(p.a)(t,[{key:"buffer",get:function(){return this.ecs.gpuBuffers[this.component.buffer.name]}},{key:"bufferComponent",get:function(){return this.buffer.components[this.component.name]}},{key:"layerOffset",get:function(){return this.bufferComponent.layerOffset}},{key:"slice",get:function(){return this.buffer.texture.sliceRange(this.bufferComponent.layerOffset,ie(this.component))}}]),t}(),ln=n(98);function hn(t){var e=Object(u.a)(t,16),n=e[0],a=e[1],i=e[2],r=e[3],o=e[4],s=e[5],c=e[6],l=e[7],h=e[8],f=e[9],d=e[10],m=e[11],p=e[12],v=e[13],g=e[14],y=e[15];return w.b.fromValues(n,a,i,r,o,s,c,l,h,f,d,m,p,v,g,y)}function fn(){return w.b.identity(w.b.create())}function dn(t,e,n){return t[4*e+n]}function mn(t,e){return{x:dn(t,e,0),y:dn(t,e,1),z:dn(t,e,2),w:dn(t,e,3)}}function pn(t){for(var e=[],n=0;n<4;n++)e.push(mn(t,n));return e}function vn(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(2===e.length){var a=e[0],i=e[1];if("object"===typeof i&&void 0!==i.x)return A(w.f.transformMat4(w.f.create(),x(i),a))}for(var r=w.b.clone(e[0]),o=1;o<e.length;o++)w.b.mul(r,r,e[o]);return r}function gn(t){var e=w.b.create();return w.b.rotateZ(e,e,t)}var yn,bn=function t(e){Object(l.a)(this,t),this.buffer=e,cn.registerGpuBuffer(this.buffer)},wn=function t(e){Object(l.a)(this,t),this.name=e,this.component={type:"token",name:this.name},this.hasComponentSM=je(this.component)},Cn=function t(e,n,a,i){Object(l.a)(this,t),this.name=e,this.buffer=n,this.format=a,this.depth=i,this.component={type:"gpu",name:this.name,buffer:this.buffer instanceof bn?this.buffer.buffer:this.buffer,format:this.format,depth:this.depth},this.sm=Oe(this.component),this.writer=Se(this.component),this.hasComponentSM=je(this.component)},xn=function t(e,n,a){Object(l.a)(this,t),this.name=e,this.buffer=n,this.format=a,this.gpuComponent={type:"gpu",name:this.name+"Gpu",buffer:this.buffer instanceof bn?this.buffer.buffer:this.buffer,format:this.format},this.cpuComponent={type:"cpu",name:this.name+"Cpu",format:this.format,stride:"vec4"===this.gpuComponent.buffer.format?4:void 0},this.components=[this.gpuComponent,this.cpuComponent],this.sm=Oe(this.gpuComponent),this.writer=Se(this.gpuComponent),this.hasComponentSM=je(this.gpuComponent)},An=new bn({name:"CommonBuffer",format:"float"}),On=cn.registerComponent({name:"Name",type:"obj"}),jn=(new Cn("Exists",An.buffer,"bool"),new xn("ArenaInstance",An,"int")),Sn=new xn("ArenaMemberIndex",An,"int"),kn=new bn({name:"ArenaBuffer",format:"float"}),In=new xn("Arena",kn,"int"),En=cn.registerComponent({name:"Visible",type:"obj"}),Tn=cn.registerComponent({name:"VisibilityFrom",type:"obj"}),Rn=new bn({name:"TransformBuffer",format:"vec4"}),Dn=new xn("Position",Rn,"vec3"),Pn=new xn("Quaternion",Rn.buffer,"vec4"),Fn=new xn("Scale",Rn.buffer,"vec3"),Bn=new Cn("RotationZ",An,"float"),Mn=cn.registerComponent({name:"CpuBoneOffset",type:"obj"}),zn=new Cn("BoneOffset",Rn.buffer,"mat4"),Nn=new Cn("BoneMatrix",Rn.buffer,"mat4"),Gn=new Cn("TransformParent",Rn.buffer,"ivec2"),Hn=new Array(20).fill(0).map((function(t,e){return cn.registerComponent({name:"LocalToParentOrder"+e,type:"token"})})),Ln=new xn("LocalToWorld",Rn.buffer,"mat4"),Un=new Cn("LocalToParent",Rn.buffer,"mat4"),Vn=new Cn("OffsetLocalToWorld",Rn.buffer,"mat4"),Qn=new xn("LocalToWorld",Rn.buffer,"mat4"),qn=At("TransformHelpers",[ve,Ln.sm],{worldPosition:Ct("vec3",[["ivec2","entityCell"]],"\n    return ".concat(ve.transformPoint,"(").concat(Ln.sm.value,"(entityCell), vec3(0));\n  "))}),Wn=function(){function t(e){var n=this;Object(l.a)(this,t),this.gls=e,this.positionRotation=new Re([Ln.gpuComponent,Dn.gpuComponent,Bn.component]).mapGpu(this.gls,Ln.gpuComponent,At([ve,Dn.sm,Bn.sm],{map:Ct("mat4",[["ivec2","entityCell"]],"\n        return ".concat(ve.translate,"(").concat(Dn.sm.value,"(entityCell)) *\n          ").concat(ve.rotateZ,"(").concat(Bn.sm.value,"(entityCell));\n      "))})),this.localToWorld=Hn.map((function(t){return new Re([Ln.gpuComponent,Un.component,Gn.component,t]).mapGpu(n.gls,Ln.gpuComponent,At([Un.sm,Gn.sm,Ln.sm],{map:Ct("mat4",[["ivec2","entityCell"]],"\n          mat4 localToParent = ".concat(Un.sm.value,"(entityCell);\n          ivec2 parent = ").concat(Gn.sm.value,"(entityCell);\n          mat4 parentWorld = ").concat(Ln.sm.value,"(parent);\n          return parentWorld * localToParent;\n        "))}))})),this.boneMatrix=new Re([Nn.component,zn.component,Ln.gpuComponent]).mapGpu(this.gls,Nn.component,At([Ln.sm,zn.sm],{map:Ct("mat4",[["ivec2","entityCell"]],"\n        mat4 localToWorld = ".concat(Ln.sm.value,"(entityCell);\n        mat4 boneOffset = ").concat(zn.sm.value,"(entityCell);\n        return localToWorld * boneOffset;\n      "))})),this.offsetLocalToWorld=new Re([Ln.gpuComponent,Vn.component]).mapGpu(this.gls,Ln.gpuComponent,At([Ln.sm,Vn.sm],{map:Ct("mat4",[["ivec2","entityCell"]],"\n        mat4 localToWorld = ".concat(Ln.sm.value,"(entityCell);\n        mat4 offset = ").concat(Vn.sm.value,"(entityCell);\n        return localToWorld * offset;\n      "))})),this.cpuPositionToGpu=new Re([Dn.cpuComponent,Dn.gpuComponent]).gpuComponentBlocks(Dn.gpuComponent).uploadFrom(Dn.cpuComponent),this.cpuQuaternionToGpu=new Re([Pn.cpuComponent,Pn.gpuComponent]).gpuComponentBlocks(Pn.gpuComponent).uploadFrom(Pn.cpuComponent),this.cpuScaleToGpu=new Re([Fn.cpuComponent,Fn.gpuComponent]).gpuComponentBlocks(Fn.gpuComponent).uploadFrom(Fn.cpuComponent),this.localToParentFromPosQatScaleQuery=new Re([Un.component,Dn.gpuComponent,Pn.gpuComponent,Fn.gpuComponent]).mapGpu(this.gls,Un.component,At([Dn.sm,Pn.sm,Fn.sm,ve],{map:Ct("mat4",[["ivec2","entityCell"]],"\n        vec3 position = ".concat(Dn.sm.value,"(entityCell);\n        vec4 rotation = ").concat(Pn.sm.value,"(entityCell);\n        vec3 scale = ").concat(Fn.sm.value,"(entityCell);\n        return ").concat(ve.rotateTranslateScale,"(rotation, position, scale);\n      "))})),this.boneMatrixFromCpuQuery=new Me([Nn.component,Mn,Ln.cpuComponent]),this.localToWorldFromCpuQuery=new Me([Ln.gpuComponent,Ln.cpuComponent]),this.localToWorldFromCpuPosQuatScaleQuery=new Me([Ln.cpuComponent,Dn.cpuComponent,Pn.cpuComponent,Fn.cpuComponent]),this.invLocalToWorldFromCpuQuery=new Me([Ln.cpuComponent,Qn.cpuComponent])}return Object(p.a)(t,[{key:"runPosRot",value:function(t){this.positionRotation.run(t)}},{key:"runLocalToWorld",value:function(t){var e,n=Object(m.a)(this.localToWorld);try{for(n.s();!(e=n.n()).done;){e.value.run(t)}}catch(Nt){n.e(Nt)}finally{n.f()}}},{key:"runBoneMatrix",value:function(t){this.boneMatrix.run(t)}},{key:"runOffset",value:function(t){this.offsetLocalToWorld.run(t)}},{key:"runLocalToParentFromCpuPosQatScale",value:function(t){this.cpuPositionToGpu.run(t),this.cpuQuaternionToGpu.run(t),this.cpuScaleToGpu.run(t),this.localToParentFromPosQatScaleQuery.run(t)}},{key:"runBoneMatrixFromCpu",value:function(t){var e,n=Object(m.a)(this.boneMatrixFromCpuQuery.get(t));try{for(n.s();!(e=n.n()).done;){var a=e.value,i=vn(t.ecs.getComponentData(Ln.cpuComponent,a),t.ecs.getComponentData(Mn,a).value);t.ecs.setComponentData(Nn.component,a,pn(i))}}catch(Nt){n.e(Nt)}finally{n.f()}}},{key:"runLocalToWorldFromCpu",value:function(t){var e,n=Object(m.a)(this.localToWorldFromCpuQuery.get(t));try{for(n.s();!(e=n.n()).done;){var a=e.value,i=t.ecs.getComponentData(Ln.cpuComponent,a);t.ecs.setComponentData(Ln.gpuComponent,a,pn(i))}}catch(Nt){n.e(Nt)}finally{n.f()}}},{key:"runLocalToWorldFromCpuPosQuatScale",value:function(t){var e,n=Object(m.a)(this.localToWorldFromCpuPosQuatScaleQuery.get(t));try{for(n.s();!(e=n.n()).done;){var a=e.value,i=t.ecs.getComponentData(Dn.cpuComponent,a),r=t.ecs.getComponentData(Pn.cpuComponent,a),o=t.ecs.getComponentData(Fn.cpuComponent,a),s=t.ecs.getCpuComponentDataView(Ln.cpuComponent,a);s&&w.b.fromRotationTranslationScale(s,r,i,o)}}catch(Nt){n.e(Nt)}finally{n.f()}}},{key:"runInvLocalToWorldFromCpu",value:function(t){var e,n=Object(m.a)(this.invLocalToWorldFromCpuQuery.get(t));try{for(n.s();!(e=n.n()).done;){var a=e.value,i=t.ecs.getCpuComponentDataView(Ln.cpuComponent,a),r=t.ecs.getCpuComponentDataView(Qn.cpuComponent,a);i&&r&&w.b.invert(r,i)}}catch(Nt){n.e(Nt)}finally{n.f()}}},{key:"run",value:function(t){this.runPosRot(t),this.runLocalToParentFromCpuPosQatScale(t),this.runOffset(t),this.runLocalToWorld(t),this.runBoneMatrixFromCpu(t),this.runBoneMatrix(t),this.runLocalToWorldFromCpu(t),this.runLocalToWorldFromCpuPosQuatScale(t),this.runInvLocalToWorldFromCpu(t)}}]),t}();!function(t){t[t.Jan=0]="Jan",t[t.Feb=1]="Feb",t[t.Mar=2]="Mar",t[t.Apr=3]="Apr",t[t.May=4]="May",t[t.Jun=5]="Jun",t[t.Jul=6]="Jul",t[t.Aug=7]="Aug",t[t.Sep=8]="Sep",t[t.Oct=9]="Oct",t[t.Nov=10]="Nov",t[t.Dec=11]="Dec"}(yn||(yn={}));var Yn,Xn=10,Kn=60,Jn=1/Kn,Zn=120,_n=function(){function t(e){Object(l.a)(this,t),this.steps=e,this.timeInSecondsFractional=this.steps*Jn,this.timeInMinutesFractional=this.timeInSecondsFractional/60,this.timeInHoursFractional=this.timeInSecondsFractional/3600,this.timeInDaysFractional=this.timeInSecondsFractional/86400,this.timeInMonthsFractional=this.timeInSecondsFractional/864e3,this.timeInYearsFractional=this.timeInSecondsFractional/10368e3,this.timeInSeconds=Math.floor(this.timeInSecondsFractional),this.timeInMinutes=Math.floor(this.timeInMinutesFractional),this.timeInHours=Math.floor(this.timeInHoursFractional),this.timeInDays=Math.floor(this.timeInDaysFractional),this.timeInMonths=Math.floor(this.timeInMonthsFractional),this.timeInYears=Math.floor(this.timeInYearsFractional),this.secondOfMinute=this.timeInSeconds%60,this.minuteOfHour=this.timeInMinutes%60,this.hourOfDay=this.timeInHours%24,this.dayOfYear=this.timeInDays%Zn,this.monthOfYear=this.timeInMonths%12,this.years=this.timeInYears,this.dayOfMonth=this.timeInDays-this.timeInMonths*Xn}return Object(p.a)(t,[{key:"stringifyComp",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=n.short,i=void 0===a||a,r=n.padded,o=void 0===r||r,s=o?(t+"").padStart(2," "):t;return i?s+e.slice(0,1):1===t?s+" "+e+(o?" ":""):s+" "+e+"s"}},{key:"toString",value:function(t){var e=[this.stringifyComp(this.secondOfMinute,"second",t)];return this.timeInMinutes>0&&e.unshift(this.stringifyComp(this.minuteOfHour,"minute",t)),this.timeInHours>0&&e.unshift(this.stringifyComp(this.hourOfDay,"hour",t)),this.timeInDays>0&&e.unshift(this.stringifyComp(this.dayOfMonth,"day",t)),this.timeInMonths>0&&e.unshift(this.stringifyComp(this.monthOfYear,"month",t)),this.timeInYears>0&&e.unshift(this.stringifyComp(this.years,"year",t)),e.join(" ")}},{key:"toStringMinimal",value:function(t){return this.years>0?this.stringifyComp(this.years,"year",t):this.dayOfYear>0?this.stringifyComp(this.dayOfYear,"day",t):this.hourOfDay>0?this.stringifyComp(this.hourOfDay,"hour",t):this.minuteOfHour>0?this.stringifyComp(this.minuteOfHour,"minute",t):this.stringifyComp(this.secondOfMinute,"second",t)}}],[{key:"fromDef",value:function(e){return new t(function(t){return Math.floor(function(t){switch(t.unit){case Yn.Steps:return t.value;case Yn.Minutes:return 60*t.value/Jn;case Yn.Hours:return 60*t.value*60/Jn;case Yn.Days:return 60*t.value*60*24/Jn;case Yn.Years:return 60*t.value*60*24*Zn/Jn}}(t))}(e))}}]),t}();!function(t){t[t.Steps=0]="Steps",t[t.Minutes=1]="Minutes",t[t.Hours=2]="Hours",t[t.Days=3]="Days",t[t.Years=4]="Years"}(Yn||(Yn={}));var $n,ta,ea,na=n(77),aa=1200;!function(t){t[t.None=0]="None",t[t.HomeTeam=1]="HomeTeam",t[t.AwayTeam=2]="AwayTeam",t[t.Both=3]="Both"}(ta||(ta={})),function(t){t[t.NearbyHome=0]="NearbyHome",t[t.NearbyAway=1]="NearbyAway",t[t.VicinityHome=2]="VicinityHome",t[t.VicinityAway=3]="VicinityAway",t[t.VicinityHomeMinerals=4]="VicinityHomeMinerals",t[t.VicinityAwayMinerals=5]="VicinityAwayMinerals"}(ea||(ea={}));var ia;Object(b.q)(ea);!function(t){t[t.Inactive=0]="Inactive",t[t.Casting=1]="Casting",t[t.Performing=2]="Performing",t[t.WindDown=3]="WindDown"}(ia||(ia={}));var ra,oa,sa;Object(b.q)(ia);!function(t){t[t.None=0]="None",t[t.Idle1=1]="Idle1",t[t.Run1=2]="Run1",t[t.Attack1=3]="Attack1",t[t.Attack2=4]="Attack2",t[t.TailAttack1=5]="TailAttack1",t[t.Fire1=6]="Fire1",t[t.Death1=7]="Death1",t[t.Jump1=8]="Jump1",t[t.Dazed1=9]="Dazed1",t[t.BreathAttack1=10]="BreathAttack1",t[t.ShellHide1=11]="ShellHide1",t[t.MuzzleFlash1=12]="MuzzleFlash1"}(ra||(ra={})),function(t){t[t.None=0]="None",t[t.KnifeHit=1]="KnifeHit",t[t.FleshHit=2]="FleshHit",t[t.StoneHit=3]="StoneHit",t[t.Dart=4]="Dart",t[t.DartThud=5]="DartThud",t[t.Knife=6]="Knife",t[t.Wimper=7]="Wimper",t[t.Snore=8]="Snore",t[t.HealBuzz=9]="HealBuzz",t[t.Resurrect=10]="Resurrect",t[t.BubbleWobble=11]="BubbleWobble",t[t.Balloon=12]="Balloon",t[t.Jump=13]="Jump",t[t.CountIn=14]="CountIn",t[t.Gunshot=15]="Gunshot",t[t.HeavyDoorClose=16]="HeavyDoorClose",t[t.Footstep=17]="Footstep",t[t.Victory=18]="Victory",t[t.ApplyItem=19]="ApplyItem",t[t.Bite=20]="Bite",t[t.PlanksFalling=21]="PlanksFalling",t[t.WoodHit=22]="WoodHit",t[t.Explosion=23]="Explosion",t[t.Brass=24]="Brass",t[t.StoneTick=25]="StoneTick",t[t.Coins=26]="Coins"}(oa||(oa={})),function(t){t[t.MoveX=0]="MoveX",t[t.Rotate=1]="Rotate",t[t.ChaseFocus=2]="ChaseFocus",t[t.CastSlot0=3]="CastSlot0",t[t.CastSlot1=4]="CastSlot1",t[t.CastSlot2=5]="CastSlot2",t[t.FocusFriendStatue=6]="FocusFriendStatue",t[t.FocusFriend1=7]="FocusFriend1",t[t.FocusFriend2=8]="FocusFriend2",t[t.FocusEnemyStatue=9]="FocusEnemyStatue",t[t.FocusEmemy1=10]="FocusEmemy1",t[t.FocusEnemy2=11]="FocusEnemy2",t[t.FocusEnemy3=12]="FocusEnemy3"}(sa||(sa={}));var ca,ua=Object(b.q)(sa);!function(t){t[t.Elevation=0]="Elevation"}(ca||(ca={}));Object(b.q)(ca);var la=na.MaxTeamSize+1,ha=2*la,fa=12,da=13,ma={x:51,y:51,z:3.31552},pa=2.23807,va=($n={},Object(G.a)($n,na.DbBattleground.Solo,[ma,{x:57,y:57,z:pa}]),Object(G.a)($n,na.DbBattleground.Duo,[ma,{x:57.2,y:59.2,z:pa},{x:58.9,y:56,z:pa}]),Object(G.a)($n,na.DbBattleground.Team,[ma,{x:52.7,y:58.4,z:pa},{x:58.2,y:58.2,z:pa},{x:60.4,y:54.8,z:pa}]),$n);function ga(t,e){return{x:e.width-t.x,y:e.height-t.y,z:t.z}}var ya="ReplayCamera",ba=function t(e){Object(l.a)(this,t),this.config=e,this.worldSize={width:128,height:128},this.brain2={hiddenLayerOutputSlices:8},this.arenas=this.config.arenaCount,this.arenasSize=function(t){var e=32;return{width:t<=e?t:e,height:Math.ceil(t/e)}}(this.config.arenaCount),this.arenasRect=Object(r.a)({x:0,y:0},this.arenasSize),this.arenasSizeVec2=Object(y.l)(this.arenasSize),this.arenasWorldSize={width:this.worldSize.width*this.arenasSize.width,height:this.worldSize.height*this.arenasSize.height},this.arenasWorldSizeVec2=Object(y.l)(this.arenasWorldSize),this.heatmapSize={width:Math.max(1,this.worldSize.width/32),height:Math.max(1,this.worldSize.height/32)},this.heatmapSizeVec2=Object(y.l)(this.heatmapSize)};var wa,Ca="#87c741",xa="#d9613d",Aa="#2e92d9",Oa=new bn({name:"UnitBuffer",format:"float"}),ja=100,Sa=new Cn("Hitpoints",Oa,"float"),ka=100,Ia=new Cn("Mana",Oa,"float"),Ea=new Cn("Team",Oa,"int"),Ta=cn.registerComponent({type:"obj",name:"CpuTeam"}),Ra=new Cn("GymIndex",Oa,"ivec2");!function(t){t[t.Friend=0]="Friend",t[t.Enemy=1]="Enemy",t[t.FriendStatue=2]="FriendStatue",t[t.EnemyStatue=3]="EnemyStatue"}(wa||(wa={}));Object(b.q)(wa).length;var Da=At([Sn.sm],{category:Ct("int",[["ivec2","selfEntityCell"],["ivec2","otherEntityCell"]],"\n    int selfArenaMemberIndex = ".concat(Sn.sm.value,"(selfEntityCell);\n    int otherArenaMemberIndex = ").concat(Sn.sm.value,"(otherEntityCell);\n    bool isStatue = otherArenaMemberIndex == 0 || otherArenaMemberIndex == ").concat(la,";\n    bool selfIsHome = selfArenaMemberIndex < ").concat(la,";\n    bool otherIsHome = otherArenaMemberIndex < ").concat(la,";\n    bool isFriendly = selfIsHome == otherIsHome;\n    if (isStatue) {\n      return isFriendly ? ").concat(wa.FriendStatue," : ").concat(wa.EnemyStatue,";\n    } else {\n      return isFriendly ? ").concat(wa.Friend," : ").concat(wa.Enemy,";\n    }\n  "))});var Pa,Fa=cn.registerComponent({type:"obj",name:"CpuPlayerUnit"}),Ba=new wn("Unit"),Ma=new wn("PlayerUnit"),za=new wn("Creature"),Na=(new Cn("Generation",Oa.buffer,"int"),new wn("TakesGroundDamage"),new Cn("WorthPoints",Oa.buffer,"int")),Ga=cn.registerComponent({type:"obj",name:"ModelCreated"}),Ha=new Cn("TailAttachment",Oa.buffer,"ivec2"),La=new Cn("BackAttachment",Oa.buffer,"ivec2"),Ua=new Cn("HeadAttachment",Oa.buffer,"ivec2"),Va=new Cn("HandLeftAttachment",Oa.buffer,"ivec2"),Qa=new Cn("HandRightAttachment",Oa.buffer,"ivec2"),qa=new Cn("ProjectileAttachment",Oa.buffer,"ivec2"),Wa=At([Dn.sm],{center:Ct("vec3",[["ivec2","entityCell"]],"\n    return ".concat(Dn.sm.value,"(entityCell) + vec3(0, 0, 1);\n  "))}),Ya=new Cn("HitpointsTrailing",Oa,"float"),Xa=cn.registerComponent({name:"HitpointsRegen",type:"token"}),Ka=cn.registerComponent({name:"ManaRegen",type:"token"}),Ja=new Cn("Gold",Oa,"float"),Za=new Cn("PreviousGold",Oa,"float"),_a=new Cn("PreviousHitpoints",Oa,"float"),$a=new Cn("DiedStep",Oa,"int"),ti=new Cn("ImpactOwner",Oa,"ivec2"),ei=new Cn("LastPushedBy",Oa,"ivec2"),ni=new Cn("IsTakingFallDamage",Oa,"bool"),ai=new wn("CrabAI"),ii=new wn("DuckAI"),ri=new Cn("Focuser",Oa,"ivec2"),oi=new Cn("Focusable",An.buffer,"bool"),si=cn.registerComponent({name:"AnimatableUnit",type:"obj"}),ci=cn.registerComponent({name:"UnitSoundMaterial",type:"obj"}),ui=cn.registerComponent({name:"UnitSounds",type:"obj"}),li=new wn("UnitMovement"),hi=new Cn("UnitMovementSpeed",Oa,"float"),fi=new Cn("UnitRotationSpeed",Oa,"float"),di=new Cn("WalkingSpeed",Oa.buffer,"float"),mi=new Cn("Velocity",Rn.buffer,"vec3"),pi=new Cn("Force",Rn.buffer,"vec3"),vi=new Cn("IsOnGround",Rn.buffer,"bool"),gi=new Cn("Stuck",Oa,"bool"),yi={AliveTime:new Cn("UnitStatsAliveTime",Oa.buffer,"float"),CumulativeHitpoints:new Cn("UnitStatsCumulativeHitpoints",Oa.buffer,"float"),MinDistEnemyStatue:new Cn("UnitStatsMinDistEnemyStatue",Oa.buffer,"float")},bi={},wi=Object(m.a)(na.BountyDefs);try{for(wi.s();!(Pa=wi.n()).done;){var Ci=Pa.value;bi[Ci.key]=new Cn("UnitBounty"+Ci.key,Oa,"float")}}catch(Nt){wi.e(Nt)}finally{wi.f()}function xi(t){return[t.data.renderArena,t.data.renderAllArenas]}var Ai,Oi,ji=function(){function t(){Object(l.a)(this,t),this.visibleQuery=new Me([En,jn.cpuComponent]).updateCpu((function(t,e){var n,a=Object(m.a)(e);try{for(a.s();!(n=a.n()).done;){var i=n.value,r=t.ecs.getComponentData(jn.cpuComponent,i)[0];t.ecs.setComponentData(En,i,r===t.data.renderArena||t.data.renderAllArenas&&-1===r)}}catch(Nt){a.e(Nt)}finally{a.f()}}),xi),this.visibleFromQuery=new Me([En,Tn]).updateCpu((function(t,e){var n,a=Object(m.a)(e);try{for(a.s();!(n=a.n()).done;){var i=n.value,r=t.ecs.getComponentData(Tn,i),o=t.ecs.getComponentData(En,r.value);t.ecs.setComponentData(En,i,o)}}catch(Nt){a.e(Nt)}finally{a.f()}}),xi)}return Object(p.a)(t,[{key:"run",value:function(t){this.visibleQuery.run(t),this.visibleFromQuery.run(t)}}]),t}(),Si=function(){function t(e,n){Object(l.a)(this,t),this.gls=e,this.conf=n,this.maxInstanceCount=128,this.query=new Me([Sa.component,Ia.component]).filterValue(En,(function(t){return!!t}),xi).render(this.gls,{mesh:"quad",vertexShader:At([It,Sa.sm,ve,Dn.sm],{size:bt("vec2",D(this.conf.size)),offsetY:bt("float",R(this.conf.offsetY)),view:pt("mat4",(function(t){return t.derived.cameraView})),projection:pt("mat4",(function(t){return t.derived.cameraProjection})),texcoord:yt("vec2"),barEntityCell:yt("ivec2",!0),shader:Ct("void",[["ivec2","entityCell"]],"\n          if (".concat(Sa.sm.value,"(entityCell) <= 0.0) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          barEntityCell = entityCell;\n          vec3 translation = ").concat(Dn.sm.value,"(entityCell) + vec3(0, 0, 3.5);\n          mat4 modelView = ").concat(ve.toBillboard,"(view * ").concat(ve.translate,"(translation));\n          gl_Position = projection * modelView * ").concat(ve.translateScale,"(vec3(0, offsetY, 0),\n            vec3(size, 1)) * vec4(").concat(It.position,".xy * 0.1, 0, 1);\n          texcoord = (").concat(It.position,".xy + 1.0) / 2.0;\n        "))}),fragmentShader:At([this.conf.barColor],{outColor:yt("vec4"),padding:bt("vec2",D(this.conf.padding)),texcoord:gt("vec2"),barEntityCell:gt("ivec2",!0),main:Ct("void",[],"\n          outColor = vec4(0.1, 0.1, 0.1, 0.8);\n          vec2 paddedTc = (texcoord - padding) / (1. - padding * 2.);\n          if (paddedTc.x > 0. && paddedTc.y > 0. && paddedTc.x <= 1. && paddedTc.y <= 1.) {\n            vec4 bar = ".concat(this.conf.barColor.getBarColor,"(barEntityCell, paddedTc.x);\n            outColor.rgb = mix(outColor.rgb, bar.rgb, bar.a);\n            outColor.a = max(bar.a, outColor.a);\n          }\n        "))})})}return Object(p.a)(t,[{key:"render",value:function(t){this.query.run(t)}}]),t}(),ki=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.health=new Si(this.gls,{offsetY:.3,size:{x:10,y:3},padding:{x:.02,y:.1},barColor:At([Sa.sm,Ea.sm,Ya.sm],{homeHealthColor:pt("vec3",(function(t){return t.data.homeHealthColor})),awayHealthColor:pt("vec3",(function(t){return t.data.awayHealthColor})),getBarColor:Ct("vec4",[["ivec2","entityCell"],["float","p"]],"\n        float perc = ".concat(Sa.sm.value,"(entityCell) / ").concat(R(ja),";\n        float trailingPerc = ").concat(Ya.sm.value,"(entityCell) / ").concat(R(ja),";\n        if (p < perc) {\n          vec3 col = ").concat(Ea.sm.value,"(entityCell) == ").concat(ta.HomeTeam," ? homeHealthColor : awayHealthColor;\n          if (p > trailingPerc) {\n            col = vec3(24, 237, 194)/255.;\n          }\n          return vec4(col, 1);\n        } else {\n          if (p < trailingPerc) {\n            return vec4(252, 223, 3, 255)/255.;\n          } else {\n            return vec4(0);\n          }\n        }\n      "))})}),this.mana=new Si(this.gls,{offsetY:0,size:{x:10,y:1},padding:{x:.02,y:.2},barColor:At([Ia.sm],{manaColor:pt("vec3",(function(t){return t.data.manaColor})),getBarColor:Ct("vec4",[["ivec2","entityCell"],["float","p"]],"\n        float perc = ".concat(Ia.sm.value,"(entityCell) / ").concat(R(ka),";\n        if (p < perc) {\n          return vec4(manaColor, 1);\n        } else {\n          return vec4(0);\n        }\n      "))})})}return Object(p.a)(t,[{key:"run",value:function(t){var e;t.data.rendererConfig.overheadBars&&!(null===(e=t.appState)||void 0===e?void 0:e.state.hideUI)&&(this.gls.disable($t.DEPTH_TEST),this.gls.disable($t.CULL_FACE),this.health.render(t))}}]),t}(),Ii=At([],{lightDirection:pt("vec3",(function(t){return t.derived.renderLightDirection})),light:Ct("float",[["vec3","normal"]],"\n    return dot(normal, Self.lightDirection) > 0.0 ? 1.0 : 0.0;\n  ")}),Ei=At([],{fogFactorExp2:Ct("float",[["float","dist"],["float","density"]],"\n    const float LOG2 = -1.442695;\n    float d = density * dist;\n    return 1.0 - clamp(exp2(d * d * LOG2), 0.0, 1.0);\n  ")}),Ti=At("QuadLine",[It,Ce],{vertexPosition01:Ct("vec2",[],"\n    return (".concat(It.position,".xy + 1.0) / 2.0;\n  ")),fromPoints:Ct("vec3",[["vec3","backLeft"],["vec3","backRight"],["vec3","frontLeft"],["vec3","frontRight"]],"\n    return mix(\n      mix(backLeft, backRight, Self.vertexPosition01().y),\n      mix(frontLeft, frontRight, Self.vertexPosition01().y),\n      Self.vertexPosition01().x\n    );\n  "),fromLineWithDeltas:Ct("vec3",[["vec3","start"],["vec3","startDelta"],["vec3","end"],["vec3","endDelta"]],"\n    return Self.fromPoints(\n      start - startDelta,\n      start + startDelta,\n      end - endDelta,\n      end + endDelta\n    );\n  "),fromLineWithDelta:Ct("vec3",[["vec3","start"],["vec3","end"],["vec3","delta"]],"\n    return Self.fromLineWithDeltas(\n      start,\n      delta,\n      end,\n      delta\n    );\n  "),fromLineWithWidths:Ct("vec3",[["vec3","start"],["float","startWidth"],["vec3","end"],["float","endWidth"]],"\n    vec2 v = ".concat(Ce.perpendicular,"(normalize((end - start).xy));\n    return Self.fromLineWithDeltas(\n      start,\n      vec3(v * startWidth / 2.0, 0),\n      end,\n      vec3(v * endWidth / 2.0, 0)\n    );\n  ")),fromLineWithWidth:Ct("vec3",[["vec3","start"],["vec3","end"],["float","width"]],"\n    return Self.fromLineWithWidths(\n      start,\n      width,\n      end,\n      width\n    );\n  ")});(Oi=Ai||(Ai={}))[Oi.None=$t.NONE]="None",Oi[Oi.Front=$t.FRONT]="Front",Oi[Oi.Back=$t.BACK]="Back",Oi[Oi.FrontAndBack=$t.FRONT_AND_BACK]="FrontAndBack";var Ri=new bn({name:"ModelRendererBuffer",format:"vec4"}),Di=new Cn("MaterialColor",Ri.buffer,"vec4"),Pi=new Cn("MaterialUseLighting",Ri.buffer,"bool"),Fi=cn.registerComponent({name:"Renderable",type:"obj"}),Bi=new bn({name:"SkinmeshBuffer",format:"vec4"}),Mi=new Cn("SkinmeshBones",Bi,"ivec2",256),zi=new Cn("SkinmeshBindMatrix",Bi,"mat4"),Ni=function t(e,n,a){Object(l.a)(this,t),this.gls=e,this.fragmentShader=n,this.vertexShader=a,this.program=new Xt(this.gls,this.fragmentShader.source,this.vertexShader.source)},Gi=function(){function t(e){var n=this;Object(l.a)(this,t),this.gls=e,this.maxInstanceCount=256,this.createVertexShader=function(t){return new jt(At([It,t,Di.sm,Pi.sm],{entityCells:vt("ivec2[]",n.maxInstanceCount),viewPosition:yt("vec3"),normal:yt("vec3"),materialColor:yt("vec4"),materialUseLighting:yt("int",!0),viewMatrix:pt("mat4",(function(t){return t.derived.cameraView})),projectionMatrix:pt("mat4",(function(t){return t.derived.cameraProjection})),main:Ct("void",[],"\n      ivec2 entityCell = entityCells[gl_InstanceID];\n      mat4 worldTransform = ".concat(t.getWorldTransform,"(entityCell);\n\n      vec4 viewPos = viewMatrix * worldTransform * vec4(").concat(It.position,", 1.0 );\n      viewPosition = viewPos.xyz / viewPos.w;\n      gl_Position = projectionMatrix * viewPos;\n\n      mat4 invTranspWorldTransform = transpose(inverse(worldTransform));\n      normal = normalize((invTranspWorldTransform * vec4(").concat(It.normal,", 1)).xyz);\n\n      materialColor = ").concat(Di.sm.value,"(entityCell);\n      materialUseLighting = int(").concat(Pi.sm.value,"(entityCell));\n    "))}))},this.staticVertexShader=this.createVertexShader(At([Ln.sm],{getWorldTransform:Ct("mat4",[["ivec2","entityCell"]],"\n      return ".concat(Ln.sm.value,"(entityCell);\n    "))})),this.skinmeshVertexShader=this.createVertexShader(At([Nn.sm,Mi.sm,zi.sm],{getWorldTransform:Ct("mat4",[["ivec2","entityCell"]],"\n      ivec2 boneEntity0 = ".concat(Mi.sm.value,"(entityCell, int(").concat(It.skinIndex,"[0]));\n      ivec2 boneEntity1 = ").concat(Mi.sm.value,"(entityCell, int(").concat(It.skinIndex,"[1]));\n      ivec2 boneEntity2 = ").concat(Mi.sm.value,"(entityCell, int(").concat(It.skinIndex,"[2]));\n      ivec2 boneEntity3 = ").concat(Mi.sm.value,"(entityCell, int(").concat(It.skinIndex,"[3]));\n      mat4 bone0 = ").concat(Nn.sm.value,"(boneEntity0);\n      mat4 bone1 = ").concat(Nn.sm.value,"(boneEntity1);\n      mat4 bone2 = ").concat(Nn.sm.value,"(boneEntity2);\n      mat4 bone3 = ").concat(Nn.sm.value,"(boneEntity3);\n      mat4 skinMatrix = mat4(0.0);\n      skinMatrix += ").concat(It.skinWeight,".x * bone0;\n      skinMatrix += ").concat(It.skinWeight,".y * bone1;\n      skinMatrix += ").concat(It.skinWeight,".z * bone2;\n      skinMatrix += ").concat(It.skinWeight,".w * bone3;\n      mat4 bindMatrix = ").concat(zi.sm.value,"(entityCell);\n      return skinMatrix * bindMatrix;\n    "))})),this.fragmentShader=new jt(At([Ii,Ei],{outColor:yt("vec4"),materialColor:gt("vec4"),materialUseLighting:gt("int",!0),materialIsUnit:gt("int",!0),normal:gt("vec3"),viewPosition:gt("vec3"),fogColor:pt("vec4",(function(t){return Object(b.A)(t.data.rendererConfig.fogColor)})),fogDensity:pt("float",(function(t){return t.data.rendererConfig.fogDensity})),fogOffset:pt("float",(function(t){return t.data.rendererConfig.fogOffset})),main:Ct("void",[],"\n      outColor = materialColor;\n      if (bool(materialUseLighting)) {\n        float lightAmount = ".concat(Ii.light,"(normal);\n        outColor.rgb *= mix(0.8, 1., lightAmount);\n      }\n\n      float depthFog = ").concat(Ei.fogFactorExp2,"(max(0.0, length(viewPosition) - fogOffset), fogDensity);\n      outColor.rgb = mix(outColor.rgb, fogColor.rgb, fogColor.a * depthFog);\n    "))})),this.programs={static:new Ni(this.gls,this.fragmentShader,this.staticVertexShader),skinmesh:new Ni(this.gls,this.fragmentShader,this.skinmeshVertexShader)},this.query=new Me([Fi,Ln.gpuComponent,En]).filterValue(En,(function(t){return!!t}),xi).transform((function(t,e){var n,a={opaque:{skinmesh:{},static:{}},transparent:{skinmesh:{},static:{}}},i=Object(m.a)(e);try{for(i.s();!(n=i.n()).done;){var r=n.value,o=t.ecs.getComponentData(Fi,r),s=a[o.transparent?"transparent":"opaque"][o.skinning?"skinmesh":"static"],c=JSON.stringify(o);s[c]||(s[c]={entities:[],renderable:o}),s[c].entities.push(r)}}catch(Nt){i.e(Nt)}finally{i.f()}return a}))}return Object(p.a)(t,[{key:"run",value:function(t){this.gls.enable($t.DEPTH_TEST),this.gls.depthFunc($t.LEQUAL),this.gls.disable($t.POLYGON_OFFSET_FILL),this.gls.polygonOffset(0,0);for(var e=this.query.get(t),n=0,a=Object.keys(e);n<a.length;n++){var i=a[n];"opaque"===i?this.gls.disable($t.BLEND):(this.gls.enable($t.BLEND),this.gls.blendFuncSeparate($t.SRC_ALPHA,$t.ONE_MINUS_SRC_ALPHA,$t.ONE,$t.ONE_MINUS_SRC_ALPHA));for(var r=e[i],o=0,s=Object.keys(r);o<s.length;o++){var c=s[o],u=this.programs[c];u.vertexShader.updateUniformValues(t),u.fragmentShader.updateUniformValues(t),u.program.prepare(),u.vertexShader.writeUniforms(u.program),u.fragmentShader.writeUniforms(u.program);for(var l=r[c],h=0,f=Object.keys(l);h<f.length;h++){var d=l[f[h]];d.renderable.cullFace===Ai.None?this.gls.disable($t.CULL_FACE):(this.gls.enable($t.CULL_FACE),this.gls.cullFace(d.renderable.cullFace));var p=this.gls.getMesh(d.renderable.mesh);if(!p)throw new Error("No such mesh: ".concat(d.renderable.mesh));var v,g=Object(m.a)(j(d.entities.length,this.maxInstanceCount));try{for(g.s();!(v=g.n()).done;){var y=v.value,b=y.l,w=y.count;u.program.setUniform("entityCells","ivec2[]",d.entities.slice(b,b+w)),this.gls.draw(u.program,p,w)}}catch(Nt){g.e(Nt)}finally{g.f()}}}}}}]),t}(),Hi=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Me([ri.component]).filterValue(En,(function(t){return!!t}),xi).render(this.gls,{mesh:"quad",vertexShader:At([Ti,ri.sm,qn,Ua.sm,La.sm,Ua.hasComponentSM,La.hasComponentSM],{viewProjection:pt("mat4",(function(t){return t.derived.cameraProjectionView})),shader:Ct("void",[["ivec2","entityCell"]],"\n          ivec2 focus = ".concat(ri.sm.value,"(entityCell);\n          if (focus.x < 0) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          ivec2 head = ").concat(Ua.hasComponentSM.value,"(entityCell) ? ").concat(Ua.sm.value,"(entityCell) : entityCell;\n          ivec2 back = ").concat(La.hasComponentSM.value,"(focus) ? ").concat(La.sm.value,"(focus) : focus;\n          vec3 position = ").concat(Ti.fromLineWithWidths,"(\n            ").concat(qn.worldPosition,"(head),\n            0.2,\n            ").concat(qn.worldPosition,"(back),\n            0.0\n          );\n          gl_Position = Self.viewProjection * vec4(position, 1);\n        "))}),fragmentShader:At([],{outColor:yt("vec4"),main:Ct("void",[],"\n          outColor = vec4(1);\n        ")})})}return Object(p.a)(t,[{key:"run",value:function(t){t.data.renderGazes&&this.query.run(t)}}]),t}();function Li(t){return"vec3"===t.type?3:4}var Ui=function(){function t(e){Object(l.a)(this,t),this.track=e,this.results=new Float32Array(Li(this.track)),this.interpolant="vec3"===this.track.type?new _.E(new Float32Array(this.track.times),new Float32Array(this.track.values),Li(this.track),this.results):new _.gb(new Float32Array(this.track.times),new Float32Array(this.track.values),Li(this.track),this.results)}return Object(p.a)(t,[{key:"value",value:function(t){return this.interpolant.evaluate(t)}}]),t}(),Vi=cn.registerComponent({name:"AnimationController",type:"obj"}),Qi=cn.registerComponent({name:"AnimationBinder",type:"obj"});function qi(t){return{duration:t.duration,tracks:t.tracks.map(Wi)}}function Wi(t){var e=t.name.split("."),n=Object(u.a)(e,2),a=n[0],i=n[1];if(t instanceof _.Db){var r;if("position"===i)r=Dn.cpuComponent;else{if("scale"!==i)throw new Error("Unsupported property: ".concat(i));r=Fn.cpuComponent}return{type:"vec3",targetName:a,componentName:r.name,times:Array.from(t.times),values:Array.from(t.values)}}if("quaternion"!==i)throw new Error("Unsupported property: ".concat(i));return{type:"quat",targetName:a,componentName:Pn.cpuComponent.name,times:Array.from(t.times),values:Array.from(t.values)}}function Yi(t,e,n,a){var i=e+"_"+n,r=t.animationInterpolators[i];return r&&r.track===a?r:t.animationInterpolators[i]=new Ui(a)}var Xi=function(){function t(){Object(l.a)(this,t),this.query=new Me([Vi,En]).filterValue(En,(function(t){return!!t}),xi)}return Object(p.a)(t,[{key:"run",value:function(t){var e,n,a,i,r,o=new _n(t.data.stepCounter+t.data.substep).timeInSecondsFractional,s=Object(m.a)(this.query.get(t));try{for(s.s();!(e=s.n()).done;){var c,u=e.value,l=t.ecs.getComponentData(Vi,u),h=t.ecs.getComponentData(Qi,u),f={},d=Object(m.a)(l.actions);try{for(d.s();!(c=d.n()).done;){var p=c.value,v=h?h.clipNames[p.clip]:p.clip,g=t.data.animationClips[v];if(g){var b=void 0;if("startTime"===p.positionType)b=o-p.positionValue;else if("percentage"===p.positionType){if(void 0===g.duration)throw new Error("'percentage' positionType requires clip.duration to be defined. Clip name=".concat(v));b=p.positionValue*g.duration}else b=p.positionValue;if(p.looping){if(void 0===g.duration)throw new Error("Looping clip requires clip.duration to be defined. Clip name=".concat(v));b=Object(y.g)(b,g.duration)}for(var w=0;w<g.tracks.length;w++){var C,x=g.tracks[w],A=Yi(t,v,w,x).value(b),O=x.targetName+x.componentName,j=f[O],S=null!==(C=p.weight)&&void 0!==C?C:1;if(0!==S)if(j){j.weight+=S;var k=S/j.weight;n=x.type,a=j.value,i=A,r=k,"vec3"===n?(a[0]=a[0]*(1-r)+i[0]*r,a[1]=a[1]*(1-r)+i[1]*r,a[2]=a[2]*(1-r)+i[2]*r):_.eb.slerpFlat(a,0,a,0,i,0,r)}else f[O]={track:x,value:A,weight:S}}}}}catch(Nt){d.e(Nt)}finally{d.f()}for(var I=0,E=Object.keys(f);I<E.length;I++){var T=f[E[I]],R=h&&T.track.targetName?h.entityLookup[T.track.targetName]:u,D=t.ecs.getComponentByName(T.track.componentName);if(!D)throw new Error("[UpdateAnimation] No such component: ".concat(T.track.componentName));if("cpu"!==D.type)throw new Error("[UpdateAnimation] Not a cpu component: ".concat(T.track.componentName));var P=t.ecs.getCpuComponentDataView(D,R);if(!P)throw new Error("[UpdateAnimation] No data for component: ".concat(T.track.componentName));for(var F=0;F<T.value.length;F++)P[F]=T.value[F]}}}catch(Nt){s.e(Nt)}finally{s.f()}}}]),t}(),Ki=new Cn("IronBubbable",Oa.buffer,"int"),Ji=new Cn("HeliumBubbable",Oa.buffer,"int"),Zi=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([Ki.component]).mapGpu(this.gls,Ki.component,At([],{map:Ct("int",[["ivec2","entityCell"],["int","value"]],"\n        return max(0, value - 1);\n      ")}))}return Object(p.a)(t,[{key:"run",value:function(t){this.update.run(t)}}]),t}(),_i=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([Ji.component]).mapGpu(this.gls,Ji.component,At([],{map:Ct("int",[["ivec2","entityCell"],["int","value"]],"\n        return max(0, value - 1);\n      ")})),this.velocity=new Re([Ji.component,mi.component]).mapGpu(this.gls,mi.component,At([Ji.sm],{map:Ct("vec3",[["ivec2","entityCell"],["vec3","value"]],"\n        if (".concat(Ji.sm.value,"(entityCell) > 0) {\n          return vec3(0, 0, 1.0);\n        } else {\n          return value;\n        }\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.update.run(t),this.velocity.run(t)}}]),t}(),$i={vertex:At([It],{viewProjection:pt("mat4",(function(t){return t.derived.cameraProjectionView})),normal:yt("vec3"),update:Ct("void",[["mat4","worldTransform"]],"\n      mat4 invTranspWorldTransform = transpose(inverse(worldTransform));\n      normal = normalize((invTranspWorldTransform * vec4(".concat(It.normal,", 1)).xyz);\n      normal = (viewProjection * vec4(normal, 0)).xyz;\n\n      gl_Position = viewProjection * worldTransform * vec4(").concat(It.position,", 1);\n    "))})},tr=function(){function t(e,n,a){Object(l.a)(this,t),this.gls=e,this.buff=n,this.color=a,this.query=new Me([this.buff.component]).filterValue(En,(function(t){return!!t}),xi).render(this.gls,{mesh:"sphere",vertexShader:At([Ln.sm,ve,this.buff.sm,$i.vertex],{shader:Ct("void",[["ivec2","entityCell"]],"\n          if (".concat(this.buff.sm.value,"(entityCell) <= 0) {\n            gl_Position = vec4(-1);\n            return;\n          }\n\n          mat4 worldTransform = ").concat(ve.translate,"(vec3(0, 0, 1)) *\n            ").concat(Ln.sm.value,"(entityCell) *\n            ").concat(ve.scale,"(vec3(1.5));\n\n          ").concat($i.vertex.update,"(worldTransform);\n        "))}),fragmentShader:At([],{outColor:yt("vec4"),normal:gt("vec3"),main:Ct("void",[],"\n          if (normal.z < -0.3) {\n            discard;\n          }\n          outColor = vec4(".concat(this.color,", 1);\n        "))})})}return Object(p.a)(t,[{key:"run",value:function(t){this.gls.enable($t.CULL_FACE),this.gls.cullFace(Ai.Back),this.query.run(t)}}]),t}(),er="vec3(0.5)",nr="vec3(1.0, 0.75, 1.0)",ar=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.bubbles=[new tr(this.gls,Ki,er),new tr(this.gls,Ji,nr)]}return Object(p.a)(t,[{key:"run",value:function(t){var e,n=Object(m.a)(this.bubbles);try{for(n.s();!(e=n.n()).done;){e.value.run(t)}}catch(Nt){n.e(Nt)}finally{n.f()}}}]),t}(),ir=new Cn("Dazeable",Oa,"int"),rr=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.dazed=new Re([ir.component]).mapGpu(this.gls,ir.component,At([],{map:Ct("int",[["ivec2","entityCell"],["int","value"]],"\n        return max(0, value - 1);\n      ")}))}return Object(p.a)(t,[{key:"run",value:function(t){this.dazed.run(t)}}]),t}(),or=z("data:image/png;base64,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"),sr=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.maxInstanceCount=128,this.query=new Me([ir.component]).filterValue(En,(function(t){return!!t}),xi).render(this.gls,{mesh:"quad",vertexShader:At([It,qn,Ua.sm,ve,ir.sm],{projection:pt("mat4",(function(t){return t.derived.cameraProjection})),view:pt("mat4",(function(t){return t.derived.cameraView})),texcoord:yt("vec2"),shader:Ct("void",[["ivec2","entityCell"]],"\n          if (".concat(ir.sm.value,"(entityCell) <= 0) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          vec3 translation = ").concat(qn.worldPosition,"(").concat(Ua.sm.value,"(entityCell)) + vec3(0, 0, 0.5);\n          mat4 transform = ").concat(ve.toBillboard,"(view * ").concat(ve.translate,"(translation)) * ").concat(ve.scale,"(vec3(0.2));\n          gl_Position = projection * transform * vec4(").concat(It.position,", 1);\n          texcoord = (").concat(It.position,".xy + 1.0) / 2.0;\n        "))}),fragmentShader:At([],{outColor:yt("vec4"),tex:pt("sampler2D",(function(t){return t.gls.textures.buffs})),texcoord:gt("vec2"),main:Ct("void",[],"\n          outColor = texture(tex, texcoord);\n          if (outColor.a < 2.0/255.0) {\n            discard;\n          }\n        ")})}),or.then((function(t){return e.textures.buffs=ut.fromImage(e,t)}))}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}(),cr=n(340),ur={Fovy:cn.registerComponent({name:"CameraFovy",type:"cpu",format:"float"}),Near:cn.registerComponent({name:"CameraNear",type:"cpu",format:"float"}),Far:cn.registerComponent({name:"CameraFar",type:"cpu",format:"float"}),Projection:cn.registerComponent({name:"CameraProjection",type:"cpu",format:"mat4"}),ProjectionView:cn.registerComponent({name:"CameraProjectionView",type:"cpu",format:"mat4"}),InvProjectionView:cn.registerComponent({name:"CameraInvProjectionView",type:"cpu",format:"mat4"})};function lr(t){return t.ecs.createEntities((new $e).setComponent(Dn.cpuComponent).setComponent(Pn.cpuComponent,new Float32Array(w.c.identity(w.c.create()))).setComponent(Fn.cpuComponent,new Float32Array([1,1,1])).setComponent(Ln.cpuComponent).setComponent(Qn.cpuComponent).setComponent(ur.Fovy,new Float32Array([70/360*Math.PI*2])).setComponent(ur.Near,new Float32Array([.1])).setComponent(ur.Far,new Float32Array([850])).setComponent(ur.Projection).setComponent(ur.ProjectionView).setComponent(ur.InvProjectionView).setComponent(Vi,{actions:[]}).setComponent(En,!0)).getIndex(0)}var hr=function(){function t(){Object(l.a)(this,t),this.query=new Me([ur.Projection])}return Object(p.a)(t,[{key:"run",value:function(t){var e,n=Object(m.a)(this.query.get(t));try{for(n.s();!(e=n.n()).done;){var a=e.value,i=t.ecs.getCpuComponentDataView(ur.Projection,a),r=t.ecs.getComponentData(ur.Fovy,a),o=t.ecs.getComponentData(ur.Near,a),s=t.ecs.getComponentData(ur.Far,a),c=t.data.canvasRect.width/t.data.canvasRect.height;if(i){w.b.perspective(i,r[0],c,o[0],s[0]);var u=t.ecs.getCpuComponentDataView(Qn.cpuComponent,a),l=t.ecs.getCpuComponentDataView(ur.ProjectionView,a);if(l&&u){w.b.mul(l,i,u);var h=t.ecs.getCpuComponentDataView(ur.InvProjectionView,a);h&&w.b.invert(h,l)}}}}catch(Nt){n.e(Nt)}finally{n.f()}}}]),t}();_.W.DefaultUp=new _.Cb(0,0,1);var fr=function(){function t(e,n){Object(l.a)(this,t),this.name=e,this.model=n,this.animationClips={},this.clipNames={},n.scene.updateMatrixWorld(),console.log("Model loaded",e,n);var a,i=Object(m.a)(n.animations);try{for(i.s();!(a=i.n()).done;){var r=a.value,o=e+"/"+r.name;this.clipNames[r.name]=o,this.animationClips[o]=qi(r)}}catch(Nt){i.e(Nt)}finally{i.f()}n.scene.traverse((function(t){if("Mesh"===t.type||"SkinnedMesh"===t.type){var e=t,n=e.geometry;n instanceof _.g&&(ne[e.geometry.id]=function(t){return Et.fromThree(t,n)})}}))}return Object(p.a)(t,[{key:"createInstances",value:function(t){var e,n,a,i,r,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=null!==(e=o.rootEntities)&&void 0!==e?e:t.ecs.createEntities((null!==(n=o.rootEntityInit)&&void 0!==n?n:new $e).setComponent(Ln.gpuComponent).setComponent(Qi,{entityLookup:{},clipNames:{}}).setComponent(Vi,{actions:[]}).setComponent(En,!1),null!==(a=o.count)&&void 0!==a?a:1),c={},l=[],h=Object(m.a)(this.model.scene.children);try{for(h.s();!(r=h.n()).done;){var f,d=r.value;this.createRecursive(t,d,s,s,c,l,(null!==(f=o.localToParentStartOrder)&&void 0!==f?f:0)+1,o)}}catch(Nt){h.e(Nt)}finally{h.f()}for(var p=0,v=l;p<v.length;p++)for(var g=Object(u.a)(v[p],2),y=g[0],b=g[1],w=function(e){for(var n=y.skeleton.bones.map((function(t){return c[t.name].getIndex(e)})),a=Math.min(256,n.length),i=new Float32Array(4*a),r=0;r<a;r++)i[4*r+0]=n[r].x,i[4*r+1]=n[r].y;t.ecs.setComponentData(Mi.component,b.getIndex(e),i)},C=0;C<(null!==(x=o.count)&&void 0!==x?x:1);C++){var x;w(C)}for(var A=0;A<(null!==(O=o.count)&&void 0!==O?O:1);A++){for(var O,j={},S=0,k=Object.keys(c);S<k.length;S++){var I=k[S];j[I]=c[I].getIndex(A)}t.ecs.setComponentData(Qi,s.getIndex(A),{entityLookup:j,clipNames:this.clipNames})}t.ecs.setComponentData(En,s,null===(i=o.visible)||void 0===i||i);for(var E=0,T=Object.keys(this.animationClips);E<T.length;E++){var R=T[E];t.data.animationClips[R]=this.animationClips[R]}return{roots:s,entities:Object.keys(c).map((function(t){return c[t]}))}}},{key:"createRecursive",value:function(t,e,n,a,i,o,s,c){var u,l=(new $e).setComponent(Un.component,pn(hn(e.matrix.elements))).setComponent(Gn.component).setComponent(Hn[s]).setComponent(Ln.gpuComponent,pn(hn(e.matrixWorld.elements))).setComponents(Dn.components,new Float32Array([e.position.x,e.position.y,e.position.z,0])).setComponents(Pn.components,new Float32Array([e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w])).setComponents(Fn.components,new Float32Array([e.scale.x,e.scale.y,e.scale.z,0])).setComponent(On,{value:e.name});if("Object3D"===e.type||"Group"===e.type);else if("Bone"===e.type){var h=new _.N;h.getInverse(e.matrixWorld),l=l.setComponent(zn.component,pn(hn(h.elements))).setComponent(Nn.component)}else{if("SkinnedMesh"!==e.type&&"Mesh"!==e.type){if("PerspectiveCamera"===e.type||"OrthographicCamera"===e.type)return;throw new Error("Not implemented yet")}var f=e;if(!(f.geometry instanceof _.g))throw new Error("Not implemented yet");var d=f.material,p=""+f.geometry.id,v=d.side===_.q?Ai.Back:d.side===_.c?Ai.Front:Ai.None;l=l.setComponent(En,!0).setComponent(Tn,{value:{x:-1,y:-1}}).setComponent(Di.component).setComponent(Pi.component,[new Float32Array([-1===d.name.indexOf("NoLighting")?1:0])]),"SkinnedMesh"===e.type&&(l=l.setComponent(Mi.component).setComponent(zi.component,hn(f.matrixWorld.elements))),l=l.setComponent(Fi,{mesh:p,cullFace:v,skinning:"SkinnedMesh"===e.type,transparent:!1})}if(c.beforeEntityCreated&&(l=c.beforeEntityCreated(e,l)),l){if(u=t.ecs.createEntities(l,c.count),l.hasComponent(Gn.component))for(var g=0;g<(null!==(y=c.count)&&void 0!==y?y:1);g++){var y;t.ecs.setComponentData(Gn.component,u.getIndex(g),[Object(r.a)(Object(r.a)({},a.getIndex(g)),{},{z:0,w:0})])}if("SkinnedMesh"===e.type||"Mesh"===e.type)for(var b=e.material,w=0;w<(null!==(C=c.count)&&void 0!==C?C:1);w++){var C,x,A;t.ecs.setComponentData(Tn,u.getIndex(w),{value:n.getIndex(w)});var O=null!==(x=null===(A=c.onMaterial)||void 0===A?void 0:A.call(c,b,w))&&void 0!==x?x:1===b.emissiveIntensity?dr(b.emissive):dr(b.color);if(t.ecs.setComponentData(Di.component,u.getIndex(w),[new Float32Array([O.x,O.y,O.z,O.w])]),O.w<1){var j=t.ecs.getComponentData(Fi,u.getIndex(w));t.ecs.setComponentData(Fi,u.getIndex(w),Object(r.a)(Object(r.a)({},j),{},{transparent:!0}))}}"SkinnedMesh"===e.type&&o.push([e,u]),c.afterEntityCreated&&c.afterEntityCreated(e,u),i[e.name]=u;var S,k=Object(m.a)(e.children);try{for(k.s();!(S=k.n()).done;){var I=S.value;this.createRecursive(t,I,n,u,i,o,s+1,c)}}catch(Nt){k.e(Nt)}finally{k.f()}}return u}},{key:"createCamera",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Camera",n=lr(t);return this.writeCamera(t,n,e),n}},{key:"writeCamera",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Camera",a=this.model.scene.getObjectByName(n);t.ecs.setComponentData(Dn.cpuComponent,e,new Float32Array([a.position.x,a.position.y,a.position.z])),t.ecs.setComponentData(Pn.cpuComponent,e,new Float32Array([a.quaternion.x,a.quaternion.y,a.quaternion.z,a.quaternion.w])),t.ecs.setComponentData(Fn.cpuComponent,e,new Float32Array([-a.scale.x,-a.scale.y,a.scale.z])),t.ecs.setComponentData(ur.Fovy,e,new Float32Array([a.fov])),t.ecs.setComponentData(ur.Near,e,new Float32Array([a.near])),t.ecs.setComponentData(ur.Far,e,new Float32Array([a.far]))}},{key:"getCamera",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Camera",e=this.model.scene.getObjectByName(t),n=new _.Cb(0,0,-1);return n.applyQuaternion(e.quaternion),Object(na.full)({view:{type:"LookatView",eye:e.position,lookAt:ln.add(e.position,n),up:{x:0,y:0,z:1},screenOffset:{x:0,y:0}},projection:{type:"Perspective",fovy:e.fov,aspectRatio:e.aspect,near:e.near,far:e.far}})}}],[{key:"fromPath",value:function(e){return new Promise((function(n){(new cr.a).load(e,(function(a){n(new t(e,a))}))}))}}]),t}();function dr(t){return{x:t.r,y:t.g,z:t.b,w:1}}var mr,pr=n.p+"static/media/Impact.72b6441b.glb";!function(t){t[t.Undecided=0]="Undecided",t[t.Home=1]="Home",t[t.Away=2]="Away",t[t.Tie=3]="Tie"}(mr||(mr={}));var vr=At("UnitsInArena",[Xe],{size:bt("int",""+ha),sampler:pt("isampler2D",(function(t){return t.unitsInArenaGpu.get(t)})),unit:Ct("ivec2",[["int","arenaIndex"],["int","arenaMemberIndex"]],"\n    return ".concat(Xe.entityCell,"(Self.sampler, arenaIndex, arenaMemberIndex);\n  "))}),gr=(At("DistanceToClosestUnit",[vr,Ea.sm,Sa.sm,Dn.sm],{value:Ct("float",[["int","arenaIndex"],["vec3","position"],["int","team"]],"\n    float minDist = 999999.;\n    for (int l=0; l < ".concat(vr.size,"; l++) {\n      ivec2 other = ").concat(vr.unit,"(arenaIndex, l);\n      if (other.x >= 0 && ").concat(Ea.sm.value,"(other) == team && ").concat(Sa.sm.value,"(other) > 0.) {\n        vec3 otherPosition = ").concat(Dn.sm.value,"(other);\n        float d = distance(position, otherPosition);\n        if (d < minDist) {\n          minDist = d;\n        }\n      }\n    }\n    return minDist;\n  "))}),At("TeamStats",[Sa.sm,Dn.sm,yi.AliveTime.sm,yi.CumulativeHitpoints.sm,Na.sm,vr,yi.MinDistEnemyStatue.sm,Ja.sm],{Stats:wt({alive:"int",unitsAlive:"int",pointsLoss:"int",hitpoints:"float",aliveTime:"float",cumulativeHitpoints:"float",minDistEnemyStatue:"float",gold:"float"}),worldSize:pt("vec2",(function(t){return Object(y.l)(t.data.worldSize)})),stats:Ct("Self.Stats",[["int","arenaIndex"],["int","team"]],"\n    Self.Stats stats;\n    stats.minDistEnemyStatue = Self.worldSize.x;\n    ivec2 enemyStatue = ".concat(vr.unit,"(arenaIndex, team == ").concat(ta.HomeTeam," ? ").concat(la," : 0);\n    for (int l=0; l < ").concat(la,"; l++) {\n      int i = l + (team == ").concat(ta.AwayTeam," ? ").concat(la," : 0);\n      ivec2 unit = ").concat(vr.unit,"(arenaIndex, i);\n      if (unit.x < 0) {\n        continue;\n      }\n      float hitpoints = ").concat(Sa.sm.value,"(unit);\n\n      if (hitpoints > 0.0) {\n        stats.alive++;\n        if (l != 0) {\n          stats.unitsAlive++;\n        }\n      } else {\n        stats.pointsLoss += ").concat(Na.sm.value,"(unit);\n      }\n      stats.hitpoints += hitpoints;\n      stats.aliveTime += ").concat(yi.AliveTime.sm.value,"(unit);\n      stats.cumulativeHitpoints += ").concat(yi.CumulativeHitpoints.sm.value,"(unit);\n      vec3 position = ").concat(Dn.sm.value,"(unit);\n      stats.minDistEnemyStatue = min(stats.minDistEnemyStatue, ").concat(yi.MinDistEnemyStatue.sm.value,"(unit));\n      stats.gold += ").concat(Ja.sm.value,"(unit);\n    }\n\n    return stats;\n  "))})),yr=At("ArenaStats",[gr],{Stats:wt({home:"TeamStats_Stats",away:"TeamStats_Stats",homePoints:"int",awayPoints:"int",winner:"int"}),homeCount:pt("int",(function(t){return t.data.teams.home.unitCount})),awayCount:pt("int",(function(t){return t.data.teams.away.unitCount})),stats:Ct("Self.Stats",[["int","arenaIndex"]],"\n    Self.Stats stats;\n    stats.home = ".concat(gr.stats,"(arenaIndex, ").concat(ta.HomeTeam,");\n    stats.away = ").concat(gr.stats,"(arenaIndex, ").concat(ta.AwayTeam,");\n    stats.homePoints = stats.away.pointsLoss;\n    stats.awayPoints = stats.home.pointsLoss;\n\n    stats.winner = ").concat(mr.Tie,";\n    if (stats.homePoints > stats.awayPoints) {\n      stats.winner = ").concat(mr.Home,";\n    } else if (stats.homePoints < stats.awayPoints) {\n      stats.winner = ").concat(mr.Away,";\n    }\n    return stats;\n  "))}),br=fr.fromPath(pr);function wr(t,e){return Cr.apply(this,arguments)}function Cr(){return(Cr=Object(c.a)(s.a.mark((function t(e,n){var a,i,r;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,br;case 2:for(a=t.sent.createInstances(e,{count:n.count,rootEntityInit:(new $e).setComponent(ti.component).setComponent(Tn,{value:{x:-1,y:-1}}),visible:!0}),i=0;i<n.count;i++)r=n.getIndex(i),e.ecs.setComponentData(ti.component,a.roots.getIndex(i),[r.x,r.y]),e.ecs.setComponentData(Tn,a.roots.getIndex(i),{value:r});case 4:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var xr=function(){return At([Ki.sm,Zo],{shellArmorBonus:pt("float",(function(){return Do.get(Yo.Shell,"Settings").activeArmor.value})),ironBubbleArmorBonus:pt("float",(function(){return Do.get(Yo.IronBubblegum,"Settings").armor.value})),armor:Ct("float",[["ivec2","entityCell"]],"\n    return 1.0 +\n      (".concat(Ki.sm.value,"(entityCell) > 0 ? Self.ironBubbleArmorBonus : 0.0) +\n      (").concat(Zo.isPerforming,"(entityCell, ").concat(Yo.Shell,") ? Self.shellArmorBonus : 0.0);\n  "))})},Ar=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.damageTakenBounty=new Re([Ja.component]).updateGpu(this.gls,[Ja.component],At([_a.sm,Ja.writer,Ja.sm,Sa.sm,vr,jn.sm,Sn.sm,bi.damageTaken.sm,bi.statueDamageTaken.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n        float hitpoints = ".concat(Sa.sm.value,"(entityCell);\n        float previousHitpoints = ").concat(_a.sm.value,"(entityCell);\n        float gold = ").concat(Ja.sm.value,"(entityCell);\n        hitpoints = clamp(hitpoints, 0.0, ").concat(R(ja),");\n        int arenaMemberIndex = ").concat(Sn.sm.value,"(entityCell);\n        float hpLoss = max(0., previousHitpoints - hitpoints);\n        gold += ").concat(bi.damageTaken.sm.value,"(entityCell) * hpLoss;\n        int arenaIndex = ").concat(jn.sm.value,"(entityCell);\n        ivec2 statue = ").concat(vr.unit,"(arenaIndex, int(arenaMemberIndex / ").concat(la,") * ").concat(la,");\n        float statueHp = ").concat(Sa.sm.value,"(statue);\n        float statuePreviousHp = ").concat(_a.sm.value,"(statue);\n        float statueHpLoss = max(0., statuePreviousHp - statueHp);\n        gold += ").concat(bi.statueDamageTaken.sm.value,"(entityCell) * statueHpLoss;\n        ").concat(Ja.writer.write,"(gold);\n      "))})),this.query=new Re([Sa.component,_a.component]).updateGpu(this.gls,[Sa.component,_a.component,$a.component],At([_a.sm,Sa.writer,_a.writer,$a.writer,Sa.sm,$a.sm],{time:pt("int",(function(t){return t.data.stepCounter})),update:Ct("void",[["ivec2","entityCell"]],"\n        float hitpoints = ".concat(Sa.sm.value,"(entityCell);\n        float previousHitpoints = ").concat(_a.sm.value,"(entityCell);\n        int diedStep = ").concat($a.sm.value,"(entityCell);\n        if (hitpoints <= 0. && previousHitpoints > 0.) {\n          diedStep = time;\n        }\n        hitpoints = clamp(hitpoints, 0.0, ").concat(R(ja),");\n        ").concat(Sa.writer.write,"(hitpoints);\n        ").concat(_a.writer.write,"(hitpoints);\n        ").concat($a.writer.write,"(diedStep);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.damageTakenBounty.run(t),this.query.run(t)}}]),t}();function Or(t){return new Re([ti.component]).updateGpu(t,[Ln.gpuComponent],At([ti.sm,Sa.sm,_a.sm,Dn.sm,Ln.writer,Ln.sm,pe],{update:Ct("void",[["ivec2","entityCell"]],"\n        ivec2 owner = ".concat(ti.sm.value,"(entityCell);\n        float hitpoints = ").concat(Sa.sm.value,"(owner);\n        float previousHitpoints = ").concat(_a.sm.value,"(owner);\n        float ownerIncomingDamage = max(0., previousHitpoints - hitpoints);\n        if (ownerIncomingDamage > 0.) {\n          vec3 ownerPosition = ").concat(Dn.sm.value,"(owner);\n          ").concat(Ln.writer.write,"(").concat(ve.translateScale,"(\n            ownerPosition + vec3(0, 0, 1),\n            vec3(").concat(pe.interpolateClamped,"(ownerIncomingDamage, 0., 100., 1., 7.))\n          ));\n        } else {\n          mat4 localToWorld = ").concat(Ln.sm.value,"(entityCell);\n          localToWorld[0][0] /= 1.4;\n          localToWorld[1][1] /= 1.4;\n          localToWorld[2][2] /= 1.4;\n          ").concat(Ln.writer.write,"(localToWorld);\n        }\n      "))}))}var jr,Sr,kr=At("DamageBounties",[bi.damageEnemyStatue.sm,bi.damageEnemyUnit.sm,bi.friendlyFire.sm],{get:Ct("float",[["ivec2","selfEntityCell"],["int","selfArenaMemberIndex"],["int","targetArenaMemberIndex"]],"\n    int selfTeam = selfArenaMemberIndex / ".concat(la,";\n    int targetTeam = targetArenaMemberIndex / ").concat(la,";\n    if (selfTeam != targetTeam) {\n      bool targetIsStatue = targetArenaMemberIndex == 0 || targetArenaMemberIndex == ").concat(la,";\n      if (targetIsStatue) {\n        return ").concat(bi.damageEnemyStatue.sm.value,"(selfEntityCell);\n      } else {\n        return ").concat(bi.damageEnemyUnit.sm.value,"(selfEntityCell);\n      }\n    } else {\n      return ").concat(bi.friendlyFire.sm.value,"(selfEntityCell);\n    }\n  "))}),Ir=At("KillBounties",[bi.killEnemyStatue.sm,bi.killEnemyUnit.sm],{get:Ct("float",[["ivec2","selfEntityCell"],["int","selfArenaMemberIndex"],["int","targetArenaMemberIndex"]],"\n    int selfTeam = selfArenaMemberIndex / ".concat(la,";\n    int targetTeam = targetArenaMemberIndex / ").concat(la,";\n    if (selfTeam != targetTeam) {\n      bool targetIsStatue = targetArenaMemberIndex == 0 || targetArenaMemberIndex == ").concat(la,";\n      if (targetIsStatue) {\n        return ").concat(bi.killEnemyStatue.sm.value,"(selfEntityCell);\n      } else {\n        return ").concat(bi.killEnemyUnit.sm.value,"(selfEntityCell);\n      }\n    } else {\n      return 0.;\n    }\n  "))}),Er=At("HealBounties",[bi.healFriendlyStatue.sm,bi.healTeammate1.sm,bi.healTeammate2.sm,bi.healEnemy.sm],{get:Ct("float",[["ivec2","selfEntityCell"],["int","selfArenaMemberIndex"],["int","targetArenaMemberIndex"]],"\n    int selfTeam = selfArenaMemberIndex / ".concat(la,";\n    int targetTeam = targetArenaMemberIndex / ").concat(la,";\n    if (selfTeam == targetTeam) {\n      int selfIndex = selfTeam == 0 ? selfArenaMemberIndex : (selfArenaMemberIndex - ").concat(la,");\n      int targetIndex = targetTeam == 0 ? targetArenaMemberIndex : (targetArenaMemberIndex - ").concat(la,");\n      if (targetIndex > selfIndex) {\n        targetIndex--;\n      }\n      return targetIndex == 0 ? ").concat(bi.healFriendlyStatue.sm.value,"(selfEntityCell) :\n        targetIndex == 1 ? ").concat(bi.healTeammate1.sm.value,"(selfEntityCell) :\n        targetIndex == 2 ? ").concat(bi.healTeammate2.sm.value,"(selfEntityCell) :\n        0.;\n    } else {\n      return ").concat(bi.healEnemy.sm.value,"(selfEntityCell);\n    }\n  "))}),Tr=function(){function t(e,n,a){Object(l.a)(this,t),this.gls=e,this.fromComponents=n,this.sm=a,this.gold=new Re(this.fromComponents).updateGpu(this.gls,[Ja.component],At([this.sm,Ja.writer,xr(),Sa.sm,Da,kr,Ir,Sn.sm],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 target = ".concat(this.sm.getTarget,"(entityCell);\n        if (target.x < 0) {\n          return ivec2(-1);\n        }\n        float damage = ").concat(this.sm.baseDamage,"(entityCell) / ").concat(xr().armor,"(target);\n        ivec2 originator = ").concat(this.sm.originator,"(entityCell);\n        int originatorArenaMemberIndex = ").concat(Sn.sm.value,"(originator);\n        int targetArenaMemberIndex = ").concat(Sn.sm.value,"(target);\n        float damageBounty = ").concat(kr.get,"(originator, originatorArenaMemberIndex, targetArenaMemberIndex) * damage;\n        float targetHitpoints = ").concat(Sa.sm.value,"(target);\n        float killBounty = (targetHitpoints - damage < 0.) ?\n          ").concat(Ir.get,"(originator, originatorArenaMemberIndex, targetArenaMemberIndex) : 0.;\n        ").concat(Ja.writer.write,"(damageBounty + killBounty);\n        return originator;\n      "))}),"sum"),this.damage=new Re(this.fromComponents).updateGpu(this.gls,[Sa.component],At([this.sm,Sa.sm,Sa.writer,xr()],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 target = ".concat(this.sm.getTarget,"(entityCell);\n        if (target.x < 0) {\n          return ivec2(-1);\n        }\n        float damage = ").concat(this.sm.baseDamage,"(entityCell) / ").concat(xr().armor,"(target);\n        ").concat(Sa.writer.write,"(-damage);\n        return target;\n      "))}),"sum")}return Object(p.a)(t,[{key:"run",value:function(t){this.gold.run(t),this.damage.run(t)}}]),t}(),Rr=function(){function t(e,n,a){Object(l.a)(this,t),this.gls=e,this.fromComponents=n,this.sm=a,this.gold=new Re(this.fromComponents).updateGpu(this.gls,[Ja.component],At([this.sm,Ja.writer,Sa.sm,Da,Sn.sm,Er],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 target = ".concat(this.sm.getTarget,"(entityCell);\n        if (target.x < 0) {\n          return ivec2(-1);\n        }\n        float heal = ").concat(this.sm.hitpoints,"(entityCell);\n        float targetHitpoints = ").concat(Sa.sm.value,"(target);\n        float newTargetHitpoints = clamp(targetHitpoints + heal, 0., ").concat(R(ja),");\n        float healClamped = newTargetHitpoints - targetHitpoints;\n        ivec2 originator = ").concat(this.sm.originator,"(entityCell);\n        int originatorArenaMemberIndex = ").concat(Sn.sm.value,"(originator);\n        int targetArenaMemberIndex = ").concat(Sn.sm.value,"(target);\n        float bounty = ").concat(Er.get,"(originator, originatorArenaMemberIndex, targetArenaMemberIndex) * healClamped;\n        ").concat(Ja.writer.write,"(bounty);\n        return originator;\n      "))}),"sum"),this.heal=new Re(this.fromComponents).updateGpu(this.gls,[Sa.component],At([this.sm,Sa.sm,Sa.writer],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 target = ".concat(this.sm.getTarget,"(entityCell);\n        if (target.x < 0) {\n          return ivec2(-1);\n        }\n        float heal = ").concat(this.sm.hitpoints,"(entityCell);\n        ").concat(Sa.writer.write,"(heal);\n        return target;\n      "))}),"sum")}return Object(p.a)(t,[{key:"run",value:function(t){this.gold.run(t),this.heal.run(t)}}]),t}(),Dr=n.p+"static/media/Bullet.35b36172.glb",Pr=n.p+"static/media/Dart.27a3a7be.glb",Fr={};try{Sr=new AudioContext}catch(Nt){console.error(Nt)}function Br(t){return Mr.apply(this,arguments)}function Mr(){return(Mr=Object(c.a)(s.a.mark((function t(e){var n,a,i;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Sr){t.next=2;break}return t.abrupt("return",null);case 2:return t.next=4,Fr;case 4:if(n=t.sent,a=n[e]){t.next=8;break}return t.abrupt("return",null);case 8:return t.next=10,N(a);case 10:return i=t.sent,t.next=13,Sr.decodeAudioData(i);case 13:return t.abrupt("return",t.sent);case 14:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function zr(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return{type:"single",path:t,buffer:Promise.resolve(null),looping:e}}function Nr(t,e){return{type:"random-slice",path:t,buffer:Promise.resolve(null),slices:e}}function Gr(t,e,n){return{type:"random-lowpass",effect:n,minFreq:t,maxFreq:e}}function Hr(t,e,n){return{type:"gain",effect:n,minGain:t,maxGain:e}}var Lr=(jr={},Object(G.a)(jr,oa.Dart,Nr("Dart1",[[.11,.4],[.6,.37],[1.1,.37],[1.58,.34],[2.04,.23]])),Object(G.a)(jr,oa.DartThud,zr("DartThud1")),Object(G.a)(jr,oa.Knife,Gr(600,8e3,Nr("Knife1",[[0,.5],[.73,.25]]))),Object(G.a)(jr,oa.KnifeHit,Hr(.3,1,zr("KnifeSlice1"))),Object(G.a)(jr,oa.FleshHit,{type:"mix",effects:[Hr(.1,.5,zr("ImpactBloodSquirt1")),Hr(.1,.3,zr("IceHit1"))]}),Object(G.a)(jr,oa.StoneHit,zr("StoneHit1")),Object(G.a)(jr,oa.WoodHit,Gr(600,8e3,Hr(.5,.5,zr("WoodHit1")))),Object(G.a)(jr,oa.Wimper,zr("MonsterGroan1")),Object(G.a)(jr,oa.Wimper,Nr("DogWhine2",[[0,1],[1.8,1],[4,1]])),Object(G.a)(jr,oa.Wimper,Gr(1e3,8e3,function(t){return{type:"random-mix-of",effects:t}}([zr("DogWhine3"),zr("DogWhine4")]))),Object(G.a)(jr,oa.Snore,Hr(.1,.1,zr("Snore1",!0))),Object(G.a)(jr,oa.HealBuzz,zr("HealBuzz1",!0)),Object(G.a)(jr,oa.Resurrect,zr("Resurrect1",!0)),Object(G.a)(jr,oa.BubbleWobble,zr("BubbleWobble1",!0)),Object(G.a)(jr,oa.Balloon,zr("Balloon1")),Object(G.a)(jr,oa.Jump,function(t){return{type:"random-select",effects:t}}([zr("Jump1"),zr("Jump2")])),Object(G.a)(jr,oa.Footstep,Hr(.03,.03,Nr("Footstep1",[[0,.3],[.43,.3],[.87,.34],[1.36,.34],[1.75,.34],[2.17,.34],[2.65,.34],[3.07,.34]]))),Object(G.a)(jr,oa.CountIn,Nr("CountIn1",[[.51,.7],[1.5,.58],[2.48,.58],[3.5,.6]])),Object(G.a)(jr,oa.Gunshot,Nr("Gunshot1",[[1.014,3],[9.24,3],[16.01,3],[22.08,3],[28.95,3],[34.7,2]])),Object(G.a)(jr,oa.HeavyDoorClose,zr("HeavyDoorCloseish1")),Object(G.a)(jr,oa.Victory,zr("Victory1")),Object(G.a)(jr,oa.ApplyItem,zr("ApplyItem1")),Object(G.a)(jr,oa.Bite,zr("Bite1")),Object(G.a)(jr,oa.PlanksFalling,zr("PlanksFalling1")),Object(G.a)(jr,oa.Explosion,zr("Explosion1")),Object(G.a)(jr,oa.Brass,zr("Brass1")),Object(G.a)(jr,oa.StoneTick,zr("StoneTick1")),Object(G.a)(jr,oa.Coins,Nr("Coins2",[[1.1,.4],[2.3,.4],[3.4,.4],[4.7,.5],[8.2,.4],[10,.4],[16.7,.4],[17.8,.4],[18.9,.4],[22.8,.4]])),jr);function Ur(t){if("random-mix-of"===t.type||"random-select"===t.type||"mix"===t.type){var e,n=Object(m.a)(t.effects);try{for(n.s();!(e=n.n()).done;){Ur(e.value)}}catch(Nt){n.e(Nt)}finally{n.f()}}else{if("random-lowpass"===t.type||"gain"===t.type)return Ur(t.effect);t.buffer=Br(t.path)}}for(var Vr=0,Qr=Object.keys(Lr);Vr<Qr.length;Vr++){var qr=Qr[Vr];Ur(Lr[qr])}var Wr={wind1:Br("Wind1")},Yr={music1:Br("Music1"),music2:Br("Music2"),music3:Br("Music3"),music4:Br("Music4")},Xr=function(){function t(e,n,a){Object(l.a)(this,t),this.audioContext=e,this.sources=n,this.gain=a,this.sourcesEnded=this.sources.map((function(t){return new Promise((function(e){return t.addEventListener("ended",e)}))})),this.ended=Promise.all(this.sourcesEnded),this.looping=this.sources.reduce((function(t,e){return t||e.loop}),!1)}return Object(p.a)(t,[{key:"stop",value:function(t){var e,n=Object(m.a)(this.sources);try{for(n.s();!(e=n.n()).done;){e.value.stop(t)}}catch(Nt){n.e(Nt)}finally{n.f()}}},{key:"fadeOut",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.3;this.gain.gain.setValueAtTime(this.gain.gain.value,this.audioContext.currentTime),this.gain.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+t),this.stop(this.audioContext.currentTime+t)}}]),t}(),Kr=Sr?new(function(){function t(e){Object(l.a)(this,t),this.audioContext=e,this.musicStarted=!1,this.musicGain=this.audioContext.createGain(),this.effectsGain=this.audioContext.createGain(),this.environmentGain=this.audioContext.createGain(),this.masterGain=this.audioContext.createGain(),this.masterCompressor=this.audioContext.createDynamicsCompressor(),this.windSource=void 0,this.windGain=this.audioContext.createGain(),this.musicSource=void 0,this.musicHighass=this.audioContext.createBiquadFilter(),this.musicInnerGain=this.audioContext.createGain(),this.playingSoundEffects=[],this.prevCameraView=void 0,this.masterGain.connect(this.audioContext.destination),this.masterCompressor.connect(this.masterGain),this.effectsGain.connect(this.masterCompressor),this.environmentGain.connect(this.masterCompressor),this.musicGain.connect(this.masterCompressor),this.musicInnerGain.connect(this.musicGain),this.musicHighass.connect(this.musicInnerGain),this.musicHighass.type="highpass",this.musicHighass.frequency.setValueAtTime(0,this.audioContext.currentTime),this.musicInnerGain.gain.setValueAtTime(.1,this.audioContext.currentTime),this.windGain.connect(this.environmentGain),this.windGain.gain.setValueAtTime(.1,this.audioContext.currentTime)}return Object(p.a)(t,[{key:"ensureWindStarted",value:function(){var t=Object(c.a)(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.windSource){t.next=8;break}return this.windSource=this.audioContext.createBufferSource(),t.next=4,Wr.wind1;case 4:this.windSource.buffer=t.sent,this.windSource.connect(this.windGain),this.windSource.loop=!0,this.windSource.start();case 8:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"startMusic",value:function(){var t=Object(c.a)(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.musicStarted||(this.musicStarted=!0,this.playNextMusic());case 1:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"playNextMusic",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a,i=this;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=Object.keys(Yr);do{a=n[Math.floor(Math.random()*n.length)]}while(a===e);return this.musicSource=this.audioContext.createBufferSource(),t.next=5,Yr[a];case 5:this.musicSource.buffer=t.sent,this.musicSource.connect(this.musicHighass),this.musicSource.loop=!1,this.musicSource.start(),this.musicSource.onended=function(){i.playNextMusic(a)};case 10:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"highpassMusic",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.audioContext.currentTime,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;console.log("[highpassMusic]"),this.musicHighass.frequency.setValueAtTime(this.musicHighass.frequency.value,t),this.musicHighass.frequency.linearRampToValueAtTime(1e3,t+e),this.musicInnerGain.gain.setValueAtTime(this.musicInnerGain.gain.value,t),this.musicInnerGain.gain.linearRampToValueAtTime(.03,t+e)}},{key:"restoreMusic",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.audioContext.currentTime,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;console.log("[restoreMusic]"),this.musicHighass.frequency.setValueAtTime(this.musicHighass.frequency.value,t),this.musicHighass.frequency.linearRampToValueAtTime(0,t+e),this.musicInnerGain.gain.setValueAtTime(this.musicInnerGain.gain.value,t),this.musicInnerGain.gain.linearRampToValueAtTime(.1,t+e)}},{key:"tempHighpassMusic",value:function(t){this.highpassMusic(),this.restoreMusic(this.audioContext.currentTime+t)}},{key:"createEffectSource",value:function(t,e){var n=this;if("random-lowpass"===t.type){var a=this.createEffectSource(t.effect,e),i=Object(u.a)(a,2),r=i[0],o=i[1],s=this.audioContext.createBiquadFilter();return s.type="lowpass",s.frequency.setValueAtTime(Object(y.f)(t.minFreq,t.maxFreq,Math.random()),this.audioContext.currentTime),r.connect(s),[s,o]}if("gain"===t.type){var c=this.createEffectSource(t.effect,e),l=Object(u.a)(c,2),h=l[0],f=l[1],d=this.audioContext.createGain();return d.gain.setValueAtTime(Object(y.f)(t.minGain,t.maxGain,Math.random()),this.audioContext.currentTime),h.connect(d),[d,f]}if("mix"===t.type){for(var m=this.audioContext.createGain(),p=[],v=0;v<t.effects.length;v++){var b=this.createEffectSource(t.effects[v],e),w=Object(u.a)(b,2),C=w[0],x=w[1];C.connect(m),p.push(x)}return[m,g.a.flatten(p)]}if("random-mix-of"===t.type){for(var A=this.audioContext.createGain(),O=t.effects.map((function(){return Math.random()})),j=O.reduce((function(t,e){return t+e}),0),S=[],k=0;k<t.effects.length;k++){var I=this.createEffectSource(t.effects[k],e),E=Object(u.a)(I,2),T=E[0],R=E[1],D=this.audioContext.createGain();T.connect(D);var P=O[k]/j;D.gain.setValueAtTime(P,this.audioContext.currentTime),D.connect(A),S.push(R)}return[A,g.a.flatten(S)]}if("random-select"===t.type){var F=t.effects[Math.floor(Math.random()*t.effects.length)];return this.createEffectSource(F,e)}var B=this.audioContext.createBufferSource();return t.buffer.then((function(a){if(B.buffer=a,"random-slice"===t.type){var i=t.slices[Math.floor(Math.random()*t.slices.length)];B.start(n.audioContext.currentTime+e,i[0],i[1])}else B.loop=t.looping,B.start(n.audioContext.currentTime+e)})),[B,[B]]}},{key:"playSoundEffect",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2?arguments[2]:void 0;if("running"===this.audioContext.state){var i=Lr[t],r=this.createEffectSource(i,n),o=Object(u.a)(r,2),s=o[0],c=o[1],l=this.audioContext.createGain();if(s=s.connect(l),a){var h=this.audioContext.createPanner();h.distanceModel="inverse",h.maxDistance=200,h.refDistance=32,h.rolloffFactor=1,h.setPosition(a.x,a.y,a.z),s=s.connect(h)}s=s.connect(this.effectsGain);var f=new Xr(this.audioContext,c,l);return this.playingSoundEffects.push(f),f.ended.then((function(){var t=e.playingSoundEffects.indexOf(f);e.playingSoundEffects.splice(t,1)})),f}}},{key:"fadeOutAllLoopingSoundEffects",value:function(){var t,e=this.playingSoundEffects.slice(0),n=Object(m.a)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;a.looping&&a.fadeOut()}}catch(Nt){n.e(Nt)}finally{n.f()}}},{key:"updateCamera",value:function(t){if(!this.prevCameraView||!w.b.equals(this.prevCameraView,t)){this.prevCameraView=t;var e=w.b.invert(w.b.create(),t);if(e){var n=w.e.create();w.b.getTranslation(n,e);var a=w.c.create();w.b.getRotation(a,e);var i=w.e.fromValues(0,0,-1);w.e.transformQuat(i,i,a);var r=w.e.fromValues(0,0,1),o=this.audioContext.listener;Jr(n)||o.setPosition(n[0],n[1],n[2]),Jr(i)||Jr(r)||o.setOrientation(i[0],i[1],i[2],r[0],r[1],r[2])}}}}]),t}())(Sr):void 0;function Jr(t){return isNaN(t[0])||isNaN(t[1])||isNaN(t[2])||!isFinite(t[0])||!isFinite(t[1])||!isFinite(t[2])}var Zr,_r=fr.fromPath(Dr),$r=fr.fromPath(Pr),to=new bn({name:"ProjectileBuffer",format:"vec4"});!function(t){t[t.Bullet=0]="Bullet",t[t.KnockbackBullet=1]="KnockbackBullet",t[t.SleepingDart=2]="SleepingDart"}(Zr||(Zr={}));var eo=cn.registerComponent({name:"CpuProjectileType",type:"obj"}),no=new Cn("ProjectileOriginator",to,"ivec2"),ao=new Cn("SeekingProjectileTarget",to,"ivec2"),io=new Cn("ProjectileSpeed",to,"float"),ro=new Cn("DamageProjectile",to,"float"),oo=new Cn("DazeProjectile",to,"float"),so=new Cn("KnockbackProjectile",to,"float"),co=new Cn("ProjectilePreviousPosition",to,"vec3");function uo(t,e,n){return lo.apply(this,arguments)}function lo(){return(lo=Object(c.a)(s.a.mark((function t(e,n,a){var i,r;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=(new $e).setComponent(Dn.gpuComponent).setComponent(Bn.component).setComponent(no.component).setComponent(ao.component).setComponent(ro.component).setComponent(io.component,[new Float32Array([1,0,0,0])]).setComponent(co.component).setComponents(jn.components,new Float32Array([n])).setComponent(eo,a),a===Zr.KnockbackBullet?i=i.setComponent(so.component):a===Zr.SleepingDart&&(i=i.setComponent(oo.component)),a!==Zr.SleepingDart){t.next=8;break}return t.next=5,$r;case 5:t.t0=t.sent,t.next=11;break;case 8:return t.next=10,_r;case 10:t.t0=t.sent;case 11:return r=t.t0.createInstances(e,{rootEntityInit:i,visible:!1}),t.abrupt("return",r.roots.getIndex(0));case 13:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var ho,fo,mo=At([Dn.sm,ao.sm,io.sm,co.sm],{ProjectileState:wt({target:"ivec2",position:"vec3",targetPosition:"vec3",speed:"float",delta:"vec3",velocity:"vec3",hitting:"bool"}),getProjectileState:Ct("ProjectileState",[["ivec2","entityCell"]],"\n    ProjectileState state;\n    state.target = ".concat(ao.sm.value,"(entityCell);\n    state.position = ").concat(Dn.sm.value,"(entityCell);\n    state.targetPosition = ").concat(Dn.sm.value,"(state.target) + vec3(0, 0, 1);\n    state.speed = ").concat(io.sm.value,"(entityCell);\n    state.delta = state.targetPosition - state.position;\n    state.hitting = length(state.delta) < state.speed;\n    vec3 previousPosition = ").concat(co.sm.value,"(entityCell);\n    state.velocity = state.position - previousPosition;\n    return state;\n  "))}),po=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.applyDamage=new Tr(this.gls,[ro.component],At([mo,ro.sm,no.sm],{originator:Ct("ivec2",[["ivec2","entityCell"]],"\n        return ".concat(no.sm.value,"(entityCell);\n      ")),getTarget:Ct("ivec2",[["ivec2","entityCell"]],"\n        ProjectileState state = ".concat(mo.getProjectileState,"(entityCell);\n        if (!state.hitting) {\n          return ivec2(-1);\n        } else {\n          return state.target;\n        }\n      ")),baseDamage:Ct("float",[["ivec2","entityCell"]],"\n        return ".concat(ro.sm.value,"(entityCell);\n      "))})),this.applyDaze=new Re([oo.component]).updateGpu(this.gls,[ir.component],At([mo,ao.sm,oo.sm,ir.writer],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ProjectileState state = ".concat(mo.getProjectileState,"(entityCell);\n        if (!state.hitting) {\n          return ivec2(-1);\n        }\n        float duration = ").concat(oo.sm.value,"(entityCell);\n        ").concat(ir.writer.write,"(int(duration));\n        return state.target;\n      "))}),"sum"),this.applyKnockback=new Re([so.component]).updateGpu(this.gls,[pi.component],At([mo,ao.sm,so.sm,pi.writer],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ProjectileState state = ".concat(mo.getProjectileState,"(entityCell);\n        if (!state.hitting) {\n          return ivec2(-1);\n        }\n        float force = ").concat(so.sm.value,"(entityCell);\n        ").concat(pi.writer.write,"(normalize(state.velocity) * force);\n        return state.target;\n      "))}),"sum"),this.applyLastPushedBy=new Re([so.component]).updateGpu(this.gls,[ei.component],At([mo,ao.sm,so.sm,ei.writer,no.sm],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ProjectileState state = ".concat(mo.getProjectileState,"(entityCell);\n        if (!state.hitting) {\n          return ivec2(-1);\n        }\n        ").concat(ei.writer.write,"(").concat(no.sm.value,"(entityCell));\n        return state.target;\n      "))})),this.updateProjectiles=new Re([ao.component,io.component]).updateGpu(this.gls,[Dn.gpuComponent,Bn.component,ao.component,co.component],At([Dn.writer,Bn.writer,Dn.sm,ao.sm,io.sm,ao.writer,mo,co.writer],{update:Ct("void",[["ivec2","entityCell"]],"\n        ProjectileState state = ".concat(mo.getProjectileState,"(entityCell);\n        if (!state.hitting) {\n          vec3 delta = normalize(state.delta);\n          ").concat(Dn.writer.write,"(state.position + delta * state.speed);\n          ").concat(Bn.writer.write,"(atan(delta.y, delta.x));\n          ").concat(ao.writer.write,"(state.target);\n          ").concat(co.writer.write,"(state.position);\n        } else {\n          ").concat(Dn.writer.write,"(vec3(-10000));\n          ").concat(Bn.writer.write,"(0.0);\n          ").concat(ao.writer.write,"(ivec2(-1));\n          ").concat(co.writer.write,"(vec3(0));\n        }\n      "))})),this.sound=new Me([io.component]).filterValue(En,(function(t){return!!t}),xi).toGpu(this.gls).mapToTemp(At([mo],{map:Ct("vec4[1]",[["ivec2","entityCell"]],"\n        ProjectileState state = ".concat(mo.getProjectileState,"(entityCell);\n        return vec4[](\n          vec4(state.position, state.hitting)\n        );\n      "))})).toCpuQueuing((function(t){return t.data.round}))}return Object(p.a)(t,[{key:"run",value:function(t){this.applyDamage.run(t),this.applyDaze.run(t),this.applyKnockback.run(t),this.applyLastPushedBy.run(t),this.updateProjectiles.run(t);var e,n=this.sound.queueRead(t),a=Object(m.a)(n());try{for(a.s();!(e=a.n()).done;){var i,r=e.value,o=Object(m.a)(r);try{for(o.s();!(i=o.n()).done;){var s=i.value,c=s.entityCell,u=s.value,l=u[0];if(!!u[0].w&&Kr)t.ecs.getComponentData(eo,c)===Zr.SleepingDart&&Kr.playSoundEffect(oa.DartThud,0,l)}}catch(Nt){o.e(Nt)}finally{o.f()}}}catch(Nt){a.e(Nt)}finally{a.f()}}}]),t}();!function(t){t[t.Any=0]="Any",t[t.Close=1]="Close",t[t.Ranged=2]="Ranged"}(ho||(ho={})),function(t){t[t.NoSlot=-1]="NoSlot",t[t.Slot0=0]="Slot0",t[t.Slot1=1]="Slot1",t[t.Slot2=2]="Slot2"}(fo||(fo={}));var vo;Object(b.q)(fo);function go(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function(n,a,i,r,o,s){if(!e||i===ia.Performing||i===ia.WindDown){var c=ra[t],u=n.find((function(t){return t.clip===c}));a.push({positionType:"startTime",positionValue:u?u.positionValue:s,clip:c,looping:!1})}}}function yo(t,e,n){return function(a,i,r,o,s,c){var u=r===ia.Casting?e*o/Do.castTime[s]:e+n*o/Do.windDown[s];i.push({positionType:"time",positionValue:u*Jn,clip:ra[t],looping:!1})}}!function(t){t[t.Anything=0]="Anything",t[t.Creature=1]="Creature"}(vo||(vo={}));var bo=function(){};function wo(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function(n,a,i,r,o,s,c){if((e?a===ia.Performing:a===ia.Casting)&&0===i&&Kr)return Kr.playSoundEffect(t,void 0,c)}}var Co,xo,Ao,Oo,jo,So,ko=function(t,e,n,a,i,r,o){if(Kr&&0===n){if(e===ia.Casting)return Kr.playSoundEffect(oa.Knife,void 0,o);e===ia.Performing&&(null===Kr||void 0===Kr||Kr.playSoundEffect(oa.KnifeHit,0,o))}},Io=yo(ra.Attack1,20,15),Eo=(Co=[yo(ra.Fire1,13,17),go(ra.MuzzleFlash1,!0)],function(t,e,n,a,i,r){var o,s=Object(m.a)(Co);try{for(s.s();!(o=s.n()).done;)(0,o.value)(t,e,n,a,i,r)}catch(Nt){s.e(Nt)}finally{s.f()}}),To=(xo=ra.TailAttack1,Ao=10,Oo=15,jo=35,function(t,e,n,a,i,r){var o=n===ia.Casting?Ao*a/Do.castTime[i]:n===ia.Performing?Ao+Oo*a/Do.duration[i]:Ao+Oo+jo*a/Do.windDown[i];e.push({positionType:"time",positionValue:o*Jn,clip:ra[xo],looping:!1})}),Ro=function(){function t(){var e=this;Object(l.a)(this,t),this.columns=["Name","TargetRange","ValidTargets","CastTime","Duration","WindDown","Cooldown","DoesDamage","Heals","CastAnimation","CastSound","OnCreate","Settings"],this.data={None:[ho.Any,vo.Anything,0,0,30,0,!1,!1,function(){},bo,null,{}],Talons:[ho.Close,vo.Creature,20,1,30,0,!0,!1,Io,ko,null,{damage:{value:30,name:"Damage",unit:"hp"}}],BloodClaws:[ho.Close,vo.Creature,20,1,30,0,!0,!1,Io,ko,null,{damage:{value:20,name:"Damage",unit:"hp"}}],Cleavers:[ho.Close,vo.Creature,40,1,60,0,!0,!1,Io,ko,null,{damage:{value:60,name:"Damage",unit:"hp"}}],Cripplers:[ho.Close,vo.Creature,20,1,30,0,!0,!1,Io,ko,null,{damage:{value:20,name:"Damage",unit:"hp"}}],HealingGland:[ho.Ranged,vo.Creature,5,120,30,240,!1,!0,To,wo(oa.HealBuzz),null,{healing:{value:60,name:"Healing",unit:"hp/sec"}}],VampireGland:[ho.Ranged,vo.Creature,5,250,30,420,!1,!0,To,wo(oa.HealBuzz),null,{damage:{value:24,name:"Damage",unit:"hp/sec"},healing:{value:18,name:"Healing",unit:"hp/sec"}}],Leap:[ho.Any,vo.Anything,9,1,30,0,!1,!1,go(ra.Jump1),wo(oa.Jump),null,{}],Pistol:[ho.Ranged,vo.Creature,13,1,17,45,!0,!1,Eo,wo(oa.Gunshot,!0),Go,{damage:{value:20,name:"Damage",unit:"hp"}}],Magnum:[ho.Ranged,vo.Creature,13,1,17,80,!0,!1,Eo,wo(oa.Gunshot,!0),Lo,{damage:{value:15,name:"Damage",unit:"hp"}}],Blaster:[ho.Ranged,vo.Creature,26,1,34,90,!0,!1,Eo,wo(oa.Gunshot,!0),Go,{damage:{value:45,name:"Damage",unit:"hp"}}],SleepDart:[ho.Ranged,vo.Creature,10,1,30,420,!0,!1,To,wo(oa.Dart),Vo,{sleepDuration:{value:3,name:"Sleep duration",unit:"sec"}}],IronBubblegum:[ho.Close,vo.Creature,20,1,30,300,!1,!1,go(ra.BreathAttack1),wo(oa.Balloon),null,{armor:{value:3,name:"Bubble armor bonus",unit:"armor"},duration:{value:5,name:"Bubble duration",unit:"sec"}}],HeliumBubblegum:[ho.Close,vo.Creature,20,1,30,300,!1,!1,go(ra.BreathAttack1),wo(oa.Balloon),null,{duration:{value:5,name:"Bubble duration",unit:"sec"}}],Shell:[ho.Any,vo.Anything,5,20,5,0,!1,!1,go(ra.ShellHide1),bo,null,{activeArmor:{value:5,name:"Armor bonus while active",unit:"armor"}}],Trombone:[ho.Any,vo.Anything,20,60,30,300,!1,!1,go(ra.BreathAttack1),wo(oa.Brass,!0),null,{}]},this.table=Object.keys(this.data).reduce((function(t,n){return[].concat(Object(mt.a)(t),[[n].concat(Object(mt.a)(e.data[n]))])}),[]),this.name=this.table.map((function(t){return t[e.columns.indexOf("Name")]})),this.component=this.name.map((function(t){return new xn(t+"Ability",Oa.buffer,"int")})),this.targetRange=this.table.map((function(t){return t[e.columns.indexOf("TargetRange")]})),this.validTargets=this.table.map((function(t){return t[e.columns.indexOf("ValidTargets")]})),this.castTime=this.table.map((function(t){return t[e.columns.indexOf("CastTime")]})),this.duration=this.table.map((function(t){return t[e.columns.indexOf("Duration")]})),this.windDown=this.table.map((function(t){return t[e.columns.indexOf("WindDown")]})),this.cooldown=this.table.map((function(t){return t[e.columns.indexOf("Cooldown")]})),this.doesDamage=this.table.map((function(t){return t[e.columns.indexOf("DoesDamage")]})),this.heals=this.table.map((function(t){return t[e.columns.indexOf("Heals")]})),this.castAnimation=this.table.map((function(t){return t[e.columns.indexOf("CastAnimation")]})),this.castSound=this.table.map((function(t){return t[e.columns.indexOf("CastSound")]})),this.onCreate=this.table.map((function(t){return t[e.columns.indexOf("OnCreate")]}))}return Object(p.a)(t,[{key:"get",value:function(t,e){return this.data[Yo[t]][this.columns.indexOf(e)-1]}}]),t}(),Do=new Ro,Po=new bn({name:"AbilitiesBuffer",format:"float"}),Fo=new Cn("UnitRef",Po,"ivec2"),Bo=new Cn("GunProjectileRef",Po,"ivec2"),Mo=new Cn("SleepDartProjectileRef",Po,"ivec2");function zo(t,e,n,a,i){return No.apply(this,arguments)}function No(){return(No=Object(c.a)(s.a.mark((function t(e,n,a,i,r){var o,c;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o=(new $e).setComponent(Fo.component,[n.x,n.y]).setComponent(En,!1).setComponent(Tn,{value:n}).setComponents(Do.component[i].components,new Float32Array([0])),!(c=Do.onCreate[i])){t.next=6;break}return t.next=5,c(e,o,a,r);case 5:o=t.sent;case 6:return t.abrupt("return",e.ecs.createEntities(o).getIndex(0));case 7:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Go(t,e,n,a){return Ho.apply(this,arguments)}function Ho(){return(Ho=Object(c.a)(s.a.mark((function t(e,n,a,i){var r;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,uo(e,a,Zr.Bullet);case 2:return r=t.sent,i.attach((function(t){return e.ecs.setComponentData(no.component,r,[new Float32Array([t.x,t.y,0,0])])})),t.abrupt("return",n.setComponent(Bo.component,[r.x,r.y]));case 5:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Lo(t,e,n,a){return Uo.apply(this,arguments)}function Uo(){return(Uo=Object(c.a)(s.a.mark((function t(e,n,a,i){var r;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,uo(e,a,Zr.KnockbackBullet);case 2:return r=t.sent,i.attach((function(t){return e.ecs.setComponentData(no.component,r,[new Float32Array([t.x,t.y,0,0])])})),t.abrupt("return",n.setComponent(Bo.component,[r.x,r.y]));case 5:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Vo(t,e,n,a){return Qo.apply(this,arguments)}function Qo(){return(Qo=Object(c.a)(s.a.mark((function t(e,n,a,i){var r;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,uo(e,a,Zr.SleepingDart);case 2:return r=t.sent,i.attach((function(t){return e.ecs.setComponentData(no.component,r,[new Float32Array([t.x,t.y,0,0])])})),t.abrupt("return",n.setComponent(Mo.component,[r.x,r.y]));case 5:case"end":return t.stop()}}),t)})))).apply(this,arguments)}!function(t){t[t.AbilitiesCount=Do.table.length]="AbilitiesCount"}(So||(So={}));var qo,Wo,Yo=Object.keys(Do.data).reduce((function(t,e,n){var a;return Object(r.a)(Object(r.a)({},t),{},(a={},Object(G.a)(a,e,n),Object(G.a)(a,n,e),a))}),{}),Xo=At("Ability",[],{targetRange:vt("int[]",So.AbilitiesCount,(function(t){return t.data.abilities.targetRange})),validTargets:vt("int[]",So.AbilitiesCount,(function(t){return t.data.abilities.validTargets})),castTime:vt("int[]",So.AbilitiesCount,(function(t){return t.data.abilities.castTime})),duration:vt("int[]",So.AbilitiesCount,(function(t){return t.data.abilities.duration})),windDown:vt("int[]",So.AbilitiesCount,(function(t){return t.data.abilities.windDown})),cooldown:vt("int[]",So.AbilitiesCount,(function(t){return t.data.abilities.cooldown}))}),Ko=new Cn("UnitAbilities",Oa,"int",3),Jo={Ability:new Cn("CastingAbility",Oa,"int"),StateStartStep:new Cn("CastingStateStartStep",Oa,"int"),Target:new Cn("CastingTarget",Oa,"ivec2"),State:new Cn("CastingState",Oa,"int"),Cooldowns:new Cn("CastingCooldown0",Oa,"int",3)},Zo=At("CastingAbilityHelpers",[Jo.Ability.sm,Jo.State.sm,Xo,pe,Jo.StateStartStep.sm],{isPerforming:Ct("bool",[["ivec2","entityCell"],["int","ability"]],"\n    int currentAbility = ".concat(Jo.Ability.sm.value,"(entityCell);\n    int state = ").concat(Jo.State.sm.value,"(entityCell);\n    return currentAbility == ability && state == ").concat(ia.Performing,";\n  ")),isCasting:Ct("bool",[["ivec2","entityCell"],["int","ability"]],"\n    int currentAbility = ".concat(Jo.Ability.sm.value,"(entityCell);\n    int state = ").concat(Jo.State.sm.value,"(entityCell);\n    return currentAbility == ability && state == ").concat(ia.Casting,";\n  ")),isWindDown:Ct("bool",[["ivec2","entityCell"],["int","ability"]],"\n    int currentAbility = ".concat(Jo.Ability.sm.value,"(entityCell);\n    int state = ").concat(Jo.State.sm.value,"(entityCell);\n    return currentAbility == ability && state == ").concat(ia.WindDown,";\n  ")),time:pt("int",(function(t){return t.data.stepCounter})),stateSteps:Ct("int",[["ivec2","entityCell"]],"\n    int startStep = ".concat(Jo.StateStartStep.sm.value,"(entityCell);\n    return Self.time - startStep;\n  ")),castingProgress:Ct("float",[["ivec2","entityCell"]],"\n    int ability = ".concat(Jo.Ability.sm.value,"(entityCell);\n    int state = ").concat(Jo.State.sm.value,"(entityCell);\n    if (state != ").concat(ia.Casting,") {\n      return 0.0;\n    }\n    return ").concat(pe.interpolateClamped,"(float(Self.stateSteps(entityCell)),\n      0.0, float(").concat(Xo.castTime,"[ability]),\n      0.0, 1.0\n    );\n  ")),performingProgress:Ct("float",[["ivec2","entityCell"]],"\n    int ability = ".concat(Jo.Ability.sm.value,"(entityCell);\n    int state = ").concat(Jo.State.sm.value,"(entityCell);\n    if (state != ").concat(ia.Performing,") {\n      return 0.0;\n    }\n    return ").concat(pe.interpolateClamped,"(float(Self.stateSteps(entityCell)),\n      0.0, float(").concat(Xo.duration,"[ability]),\n      0.0, 1.0\n    );\n  "))}),_o=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.singleTargetHeal=new Rr(this.gls,[Do.component[Yo.HealingGland].gpuComponent],At([Jo.Target.sm,Zo,Fo.sm],{originator:Ct("ivec2",[["ivec2","entityCell"]],"\n        return ".concat(Fo.sm.value,"(entityCell);\n      ")),getTarget:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.HealingGland,")) {\n          return ivec2(-1);\n        } else {\n          return ").concat(Jo.Target.sm.value,"(unit);\n        }\n      ")),hps:pt("float",(function(){return Do.get(Yo.HealingGland,"Settings").healing.value/Kn})),hitpoints:Ct("float",[["ivec2","entityCell"]],"\n        return Self.hps;\n      ")}))}return Object(p.a)(t,[{key:"run",value:function(t){this.singleTargetHeal.run(t)}}]),t}(),$o=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Me([Do.component[Yo.HealingGland].gpuComponent]).filterValue(En,(function(t){return!!t}),xi).render(this.gls,{mesh:"quad",vertexShader:At([Ti,Zo,Jo.Target.sm,qn,Ha.sm,Wa,Do.component[Yo.HealingGland].sm,Fo.sm],{viewProjection:pt("mat4",(function(t){return t.derived.cameraProjectionView})),shader:Ct("void",[["ivec2","entityCell"]],"\n          ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n          if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.HealingGland,")) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          float progress = ").concat(Zo.performingProgress,"(unit);\n          float width = 0.4;\n          vec3 position = ").concat(Ti.fromLineWithWidths,"(\n            ").concat(qn.worldPosition,"(").concat(Ha.sm.value,"(unit)),\n            width + 0.2 * sin(progress * 10.0),\n            ").concat(Wa.center,"(").concat(Jo.Target.sm.value,"(unit)),\n            width + 0.2 * cos(progress * 10.0)\n          );\n          gl_Position = Self.viewProjection * vec4(position, 1);\n        "))}),fragmentShader:At([],{outColor:yt("vec4"),main:Ct("void",[],"\n          outColor = vec4(0, 1, 0, 1);\n        ")})})}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}(),ts=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.arrows=new Re([Do.component[Yo.IronBubblegum].gpuComponent]).updateGpu(this.gls,[Ki.component],At([Zo,Jo.Target.sm,Ki.writer,Fo.sm],{duration:pt("int",(function(){return Do.get(Yo.IronBubblegum,"Settings").duration.value*Kn})),update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.IronBubblegum,")) {\n          return ivec2(-1);\n        }\n        ").concat(Ki.writer.write,"(Self.duration);\n        return ").concat(Jo.Target.sm.value,"(unit);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.arrows.run(t)}}]),t}(),es=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.arrows=new Re([Do.component[Yo.HeliumBubblegum].gpuComponent]).updateGpu(this.gls,[Ji.component],At([Zo,Jo.Target.sm,Ji.writer,Fo.sm],{duration:pt("int",(function(){return Do.get(Yo.HeliumBubblegum,"Settings").duration.value*Kn})),update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.HeliumBubblegum,")) {\n          return ivec2(-1);\n        }\n        ").concat(Ji.writer.write,"(Self.duration);\n        return ").concat(Jo.Target.sm.value,"(unit);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.arrows.run(t)}}]),t}(),ns=function(){function t(e,n,a,i){Object(l.a)(this,t),this.gls=e,this.abilityComponent=n,this.ability=a,this.color=i,this.query=new Me([this.abilityComponent]).filterValue(En,(function(t){return!!t}),xi).render(this.gls,{mesh:"sphere",vertexShader:At([Ln.sm,ve,$i.vertex,Fo.sm,Ua.sm,pe,Jo.Ability.sm,Jo.State.sm,Jo.StateStartStep.sm],{time:pt("float",(function(t){return t.data.stepCounter})),shader:Ct("void",[["ivec2","entityCell"]],"\n          ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n\n          int ability = ").concat(Jo.Ability.sm.value,"(unit);\n          int state = ").concat(Jo.State.sm.value,"(unit);\n\n          float scale = 0.5;\n          if (ability == ").concat(this.ability," && state == ").concat(ia.Casting,") {\n            float t = time - float(").concat(Jo.StateStartStep.sm.value,"(unit));\n            scale = 0.5 + t * 0.05;\n          } else if (ability == ").concat(this.ability," && (state == ").concat(ia.Performing," || state == ").concat(ia.WindDown,")) {\n            scale = 0.0;\n          } else {\n            float scaleMin = 0.5;\n            float scaleMax = 0.55;\n            scale = ").concat(pe.interpolate,"(sin(time * 0.1), -1.0, 1.0, scaleMin, scaleMax);\n          }\n\n          ivec2 head = ").concat(Ua.sm.value,"(unit);\n          mat4 worldTransform = ").concat(Ln.sm.value,"(head) *\n            ").concat(ve.translate,"(vec3(0, 0.7, 0.8)) *\n            ").concat(ve.scale,"(vec3(scale));\n\n          ").concat($i.vertex.update,"(worldTransform);\n        "))}),fragmentShader:At([],{outColor:yt("vec4"),normal:gt("vec3"),main:Ct("void",[],"\n          if (normal.z < -0.6) {\n            discard;\n          }\n          outColor = vec4(".concat(this.color,", 1);\n        "))})})}return Object(p.a)(t,[{key:"run",value:function(t){this.gls.enable($t.CULL_FACE),this.gls.cullFace(Ai.Back),this.gls.disable($t.BLEND),this.query.run(t)}}]),t}(),as=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.bubblegums=[new ns(this.gls,Do.component[Yo.IronBubblegum].gpuComponent,Yo.IronBubblegum,er),new ns(this.gls,Do.component[Yo.HeliumBubblegum].gpuComponent,Yo.HeliumBubblegum,nr)]}return Object(p.a)(t,[{key:"run",value:function(t){var e,n=Object(m.a)(this.bubblegums);try{for(n.s();!(e=n.n()).done;){e.value.run(t)}}catch(Nt){n.e(Nt)}finally{n.f()}}}]),t}(),is=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.singleTargetDamage=new Tr(this.gls,[Do.component[Yo.VampireGland].gpuComponent],At([Jo.Target.sm,Zo,Fo.sm],{originator:Ct("ivec2",[["ivec2","entityCell"]],"\n        return ".concat(Fo.sm.value,"(entityCell);\n      ")),getTarget:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.VampireGland,")) {\n          return ivec2(-1);\n        } else {\n          return ").concat(Jo.Target.sm.value,"(unit);\n        }\n      ")),dps:pt("float",(function(){return Do.get(Yo.VampireGland,"Settings").damage.value/Kn})),baseDamage:Ct("float",[["ivec2","entityCell"]],"\n        return Self.dps;\n      ")})),this.heal=new Re([Do.component[Yo.VampireGland].gpuComponent]).updateGpu(this.gls,[Sa.component],At([Zo,Sa.writer,Sa.sm,Fo.sm],{hps:pt("float",(function(){return Do.get(Yo.VampireGland,"Settings").healing.value/Kn})),update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        float hitpoints = ").concat(Sa.sm.value,"(unit);\n        if (").concat(Zo.isPerforming,"(unit, ").concat(Yo.VampireGland,")) {\n          hitpoints = clamp(hitpoints + Self.hps, 0.0, ").concat(R(ja),");\n        }\n        ").concat(Sa.writer.write,"(hitpoints);\n        return unit;\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.singleTargetDamage.run(t),this.heal.run(t)}}]),t}(),rs=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Me([Do.component[Yo.VampireGland].gpuComponent]).filterValue(En,(function(t){return!!t}),xi).render(this.gls,{mesh:"quad",vertexShader:At([Ti,Zo,Jo.Target.sm,qn,Ha.sm,Wa,Do.component[Yo.VampireGland].sm,Fo.sm],{viewProjection:pt("mat4",(function(t){return t.derived.cameraProjectionView})),shader:Ct("void",[["ivec2","entityCell"]],"\n          ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n          if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.VampireGland,")) {\n            gl_Position = vec4(-1);\n            return;\n          }\n          float progress = ").concat(Zo.performingProgress,"(unit);\n          float width = 0.4;\n          vec3 position = ").concat(Ti.fromLineWithWidths,"(\n            ").concat(qn.worldPosition,"(").concat(Ha.sm.value,"(unit)),\n            width + 0.2 * sin(progress * 10.0),\n            ").concat(Wa.center,"(").concat(Jo.Target.sm.value,"(unit)),\n            width + 0.2 * cos(progress * 10.0)\n          );\n          gl_Position = Self.viewProjection * vec4(position, 1);\n        "))}),fragmentShader:At([],{outColor:yt("vec4"),main:Ct("void",[],"\n          outColor = vec4(0, 0, 0, 1);\n        ")})})}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}();function os(t,e){var n=new bn({name:t+"LayerWeightsBuffer",format:"vec4"}),a=new bn({name:t+"LayerBiasesBuffer",format:"float"}),i=new bn({name:t+"LayerResBuffer",format:"vec4"});return{weights:new Cn(t+"LayerWeights",n.buffer,"vec4",e.weightsSlices),biases:new Cn(t+"LayerBiases",a.buffer,"float",e.biasesSlices),res:new Cn(t+"LayerRes",i.buffer,"vec4",e.outputSlices)}}!function(t){t[t.Hitpoints=0]="Hitpoints",t[t.Ability0Ready=1]="Ability0Ready",t[t.FriendStatueDistance=2]="FriendStatueDistance",t[t.FriendStatueAngle=3]="FriendStatueAngle",t[t.Friend1Distance=4]="Friend1Distance",t[t.Friend1Angle=5]="Friend1Angle",t[t.Friend2Distance=6]="Friend2Distance",t[t.Friend2Angle=7]="Friend2Angle",t[t.EnemyStatueDistance=8]="EnemyStatueDistance",t[t.EnemyStatueAngle=9]="EnemyStatueAngle",t[t.Enemy1Distance=10]="Enemy1Distance",t[t.Enemy1Angle=11]="Enemy1Angle",t[t.Enemy2Distance=12]="Enemy2Distance",t[t.Enemy2Angle=13]="Enemy2Angle",t[t.Enemy3Distance=14]="Enemy3Distance",t[t.Enemy3Angle=15]="Enemy3Angle",t[t.HasFocus=16]="HasFocus",t[t.FocusRelativeRotation=17]="FocusRelativeRotation",t[t.FocusFacingUs=18]="FocusFacingUs",t[t.FocusFocusingBack=19]="FocusFocusingBack",t[t.FocusHitpoints=20]="FocusHitpoints",t[t.Ability1Ready=21]="Ability1Ready",t[t.Ability2Ready=22]="Ability2Ready",t[t.FocusDazed=23]="FocusDazed",t[t.FocusCrippled=24]="FocusCrippled",t[t.HeightFront1=25]="HeightFront1",t[t.HeightFront5=26]="HeightFront5",t[t.HeightBack2=27]="HeightBack2",t[t.PositionLeftRight=28]="PositionLeftRight",t[t.PositionUpDown=29]="PositionUpDown",t[t.Stuck=30]="Stuck"}(qo||(qo={})),function(t){t[t.HasTalons=0]="HasTalons",t[t.HasBloodClaws=1]="HasBloodClaws",t[t.HasCleavers=2]="HasCleavers",t[t.HasCripplers=3]="HasCripplers",t[t.HasHealingGland=4]="HasHealingGland",t[t.HasVampireGland=5]="HasVampireGland",t[t.HasFrogLegs=6]="HasFrogLegs",t[t.HasPistol=7]="HasPistol",t[t.HasMagnum=8]="HasMagnum",t[t.HasBlaster=9]="HasBlaster",t[t.HasParalyzingDart=10]="HasParalyzingDart",t[t.HasIronBubblegum=11]="HasIronBubblegum",t[t.HasHeliumBubblegum=12]="HasHeliumBubblegum",t[t.HasShell=13]="HasShell",t[t.HasTrombone=14]="HasTrombone",t[t.FocusHasTalons=15]="FocusHasTalons",t[t.FocusHasBloodClaws=16]="FocusHasBloodClaws",t[t.FocusHasCleavers=17]="FocusHasCleavers",t[t.FocusHasCripplers=18]="FocusHasCripplers",t[t.FocusHasHealingGland=19]="FocusHasHealingGland",t[t.FocusHasVampireGland=20]="FocusHasVampireGland",t[t.FocusHasFrogLegs=21]="FocusHasFrogLegs",t[t.FocusHasPistol=22]="FocusHasPistol",t[t.FocusHasMagnum=23]="FocusHasMagnum",t[t.FocusHasBlaster=24]="FocusHasBlaster",t[t.FocusHasParalyzingDart=25]="FocusHasParalyzingDart",t[t.FocusHasIronBubblegum=26]="FocusHasIronBubblegum",t[t.FocusHasHeliumBubblegum=27]="FocusHasHeliumBubblegum",t[t.FocusHasShell=28]="FocusHasShell",t[t.FocusHasTrombone=29]="FocusHasTrombone"}(Wo||(Wo={}));var ss=Math.ceil(Object(b.q)(qo).length/4),cs=ss+8,us=new function t(){Object(l.a)(this,t),this.inputSlices=cs,this.outputSlices=8,this.outputs=4*this.outputSlices,this.weightsSlices=this.inputSlices*this.outputs,this.weights=4*this.weightsSlices,this.biasesSlices=this.outputs},ls=new function t(){Object(l.a)(this,t),this.inputSlices=cs,this.outputSlices=8,this.outputs=4*this.outputSlices,this.weightsSlices=this.inputSlices*this.outputs,this.weights=4*this.weightsSlices,this.biasesSlices=this.outputs},hs=new function t(){Object(l.a)(this,t),this.inputSlices=us.outputSlices,this.outputSlices=Math.ceil(ua.length/4),this.outputs=4*this.outputSlices,this.weightsSlices=this.inputSlices*this.outputs,this.weights=4*this.weightsSlices,this.biasesSlices=this.outputs},fs=os("Memory",ls),ds=os("Hidden",us),ms=os("Output",hs),ps=new bn({name:"SensesBuffer",format:"vec4"}),vs=new Cn("Senses",ps,"vec4",ss),gs=Math.ceil(Object(b.q)(Wo).length/4),ys=new Cn("GymExtraSenses",ps,"vec4",gs),bs=function(){function t(e,n){Object(l.a)(this,t),this.gls=e,this.component=n,this.shader=new jt(At([vr,this.component.sm,pe,this.component.hasComponentSM,Sa.sm],{outValues:yt("vec4[8]"),nArenas:pt("int",(function(t){return t.layout.arenas})),main:Ct("void",[],"\n      vec4 values[8];\n      int arenaMemberIndex = int(gl_FragCoord.x);\n      int decision = int(gl_FragCoord.y);\n      float nAlive = 0.;\n      for (int i=0; i < Self.nArenas; i++) {\n        ivec2 unit = ".concat(vr.unit,"(i, arenaMemberIndex);\n        if (unit.x >= 0 && ").concat(this.component.hasComponentSM.value,"(unit) && ").concat(Sa.sm.value,"(unit) > 0.) {\n          vec4 outputSlice = ").concat(this.component.sm.value,"(unit, decision / 4);\n          float decisionValue = outputSlice[decision % 4];\n          float bucketFloat = ").concat(pe.interpolateClamped,"(decisionValue, -1., 1., 0., 32.);\n          int bucket = clamp(int(bucketFloat), 0, 31);\n          nAlive++;\n          values[bucket / 4][bucket % 4]++;\n        }\n      }\n      for (int i=0; i < 32; i++) {\n        values[i / 4][i % 4] /= nAlive;\n      }\n      outValues = values;\n    "))})),this.program=new Xt(this.gls,this.shader.source),this.renderTarget=new at(this.gls)}return Object(p.a)(t,[{key:"run",value:function(t,e){this.shader.updateUniformValues(t),this.renderTarget.set(e),this.program.prepare(),this.shader.writeUniforms(this.program),this.gls.prepareForComputation(e.rect),this.gls.drawQuad(this.program)}}]),t}(),ws=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.senses=new bs(this.gls,vs),this.decisions=new bs(this.gls,ms.res)}return Object(p.a)(t,[{key:"run",value:function(t){t.data.showSensesHistogram&&this.senses.run(t,t.textures.sensesHistogram.sliceAll()),t.data.showDecisionsHistogram&&this.decisions.run(t,t.textures.decisionsHistogram.sliceAll())}}]),t}(),Cs=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.vertexShader=new jt(At([It,pe],{texcoord:yt("vec2"),corners:pt("vec4"),main:Ct("void",[],"\n      gl_Position = vec4(\n        ".concat(pe.interpolate,"(").concat(It.position,".xy, vec2(-1.), vec2(1.), corners.xy, corners.zw),\n        0.,\n        1.\n      );\n      texcoord = (").concat(It.position,".xy + 1.0) / 2.0;\n    "))})),this.fragmentShader=new jt(At([It],{texcoord:gt("vec2"),outColor:yt("vec4"),histogram:pt("sampler2DArray"),histogramSize:pt("vec2"),main:Ct("void",[],"\n      vec2 histogramCell = texcoord * Self.histogramSize;\n      int arenaMemberIndex = int(histogramCell.x);\n      int decision = int(histogramCell.y);\n      int bucket = int(32. * mod(histogramCell.x, 1.));\n      float y = 1. - mod(histogramCell.y, 1.);\n      vec4 bucketSlice = texelFetch(Self.histogram, ivec3(arenaMemberIndex, decision, bucket / 4), 0);\n      float bucketPerc = bucketSlice[bucket % 4];\n      vec3 background;\n      if (arenaMemberIndex % 2 == 0) {\n        background += 0.1;\n      }\n      if (decision % 2 == 0) {\n        background += 0.1;\n      }\n      outColor = y < bucketPerc ? vec4(1) : vec4(background, 1);\n    ")})),this.program=new Xt(this.gls,this.fragmentShader.source,this.vertexShader.source)}return Object(p.a)(t,[{key:"run",value:function(t,e,n){var a={x:Object(y.e)(n.left,0,t.data.canvasRect.width,-1,1),y:Object(y.e)(n.top,0,t.data.canvasRect.height,1,-1),z:Object(y.e)(n.left+n.width,0,t.data.canvasRect.width,-1,1),w:Object(y.e)(n.top+n.height,0,t.data.canvasRect.height,1,-1)};this.vertexShader.updateUniformValues(t),this.fragmentShader.updateUniformValues(t),this.program.prepare(),this.vertexShader.writeUniforms(this.program),this.fragmentShader.writeUniforms(this.program),this.program.setUniform("histogram","sampler2DArray",e),this.program.setUniform("histogramSize","vec2",Object(y.l)(e.size)),this.program.setUniform("corners","vec4",a),this.gls.disable($t.DEPTH_TEST),this.gls.disable($t.BLEND),this.gls.drawQuad(this.program)}}]),t}(),xs=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.renderer=new Cs(this.gls)}return Object(p.a)(t,[{key:"run",value:function(t){t.data.showDecisionsHistogram&&this.renderer.run(t,t.textures.decisionsHistogram,t.data.decisionHistogramView),t.data.showSensesHistogram&&this.renderer.run(t,t.textures.sensesHistogram,t.data.sensesHistogramView)}}]),t}(),As=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.shader=new jt(At([vr,ms.res.sm,ms.res.hasComponentSM],{outValue:yt("float"),renderArena:pt("int",(function(t){return t.data.renderArena})),decisionsViz:pt("sampler2D",(function(t){return t.textures.decisionsViz})),main:Ct("void",[],"\n      int history = int(gl_FragCoord.x);\n      int arenaMemberIndex = int(gl_FragCoord.y) / ".concat(ua.length,";\n      int brainOutput = int(gl_FragCoord.y) % ").concat(ua.length,";\n      if (history == 0) {\n        ivec2 unit = ").concat(vr.unit,"(renderArena, arenaMemberIndex);\n        if (").concat(ms.res.hasComponentSM.value,"(unit)) {\n          vec4 outputSlice = ").concat(ms.res.sm.value,"(unit, brainOutput / 4);\n          outValue = outputSlice[brainOutput % 4];\n        } else {\n          outValue = 0.;\n        }\n      } else {\n        outValue = texelFetch(Self.decisionsViz, ivec2(gl_FragCoord) - ivec2(1, 0), 0).x;\n      }\n    "))})),this.program=new Xt(this.gls,this.shader.source),this.renderTarget=new at(this.gls)}return Object(p.a)(t,[{key:"run",value:function(t){if(t.data.showDecisionsViz){var e=t.textures.decisionsViz.sliceAll();this.shader.updateUniformValues(t),this.renderTarget.set(e.back),this.program.prepare(),this.shader.writeUniforms(this.program),this.gls.prepareForComputation(e.rect),this.gls.drawQuad(this.program),this.gls.getCopyLayers().copyBackToFront(e)}}}]),t}(),Os=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.gridSize={x:23,y:ua.length-1},this.grid=Et.fromThree(this.gls,new _.Z(1,1,this.gridSize.x,this.gridSize.y)),this.vertexShader=new jt(At([It,ve,pe,vr,Dn.sm,ms.res.hasComponentSM],{decisionsViz:pt("sampler2D",(function(t){return t.textures.decisionsViz})),viewProjection:pt("mat4",(function(t){return t.derived.cameraProjectionView})),renderArena:pt("int",(function(t){return t.data.renderArena})),color:yt("vec4"),main:Ct("void",[],"\n      int arenaMemberIndex = gl_InstanceID;\n      ivec2 unit = ".concat(vr.unit,"(renderArena, arenaMemberIndex);\n      if (!").concat(ms.res.hasComponentSM.value,"(unit)) {\n        gl_Position = vec4(-1);\n        return;\n      }\n      ivec2 read = ivec2((vec2(").concat(It.position,".x, -").concat(It.position,".y) + 0.5) * ").concat(D({x:24,y:ua.length}),") +\n        ivec2(0, arenaMemberIndex * ").concat(ua.length,");\n      float value = texelFetch(Self.decisionsViz, read, 0).x;\n      vec3 position = ").concat(Dn.sm.value,"(unit) + vec3(0, -2, 0.2);\n      gl_Position = viewProjection * ").concat(ve.translateScale,"(position, vec3(2, 2, 0.3)) * vec4(").concat(It.position,".xy, value, 1);\n      color = vec4(").concat(pe.interpolateClamped,"(value, -1., 1., vec3(1., 0.1, 0.2), vec3(0.3, 1., 0.4)), 1);\n    "))})),this.fragmentShader=new jt(At([],{outColor:yt("vec4"),color:gt("vec4"),main:Ct("void",[],"\n      outColor = color;\n    ")})),this.program=new Xt(this.gls,this.fragmentShader.source,this.vertexShader.source)}return Object(p.a)(t,[{key:"run",value:function(t){t.data.showDecisionsViz&&(this.vertexShader.updateUniformValues(t),this.fragmentShader.updateUniformValues(t),this.program.prepare(),this.vertexShader.writeUniforms(this.program),this.fragmentShader.writeUniforms(this.program),this.gls.enable($t.DEPTH_TEST),this.gls.disable($t.BLEND),this.gls.draw(this.program,this.grid,ha))}}]),t}(),js=z("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAABiCAYAAAAm22uCAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAACJOSURBVHgB7Z1fbB3VncdP4n/Xf4IdZ7G3tuqkIU4V0sAikmpBhLyQSLsC+lCWrESlItEHVt2Hon3qvq1W4rE8beFhqYoEVUHsA3/aSnFewBGsiFctJCEChxSD7GKzcewktq8d36TznZsTTy53Zs7vd87MnZn7+0i3SYo9M/fMzPn9//02vf2bQ9eVIAiCIBSQ1qub1MDnbar361a1ePu6mhldU2nQsbRZ7Z7o9M7bopb6rvnnnt2+5v89K7QqQRAEQSgYELwjH5f8PzXbZlp9heCLO1dV0gyfa7957u6Fzd6nXQ1Ntqty1zX1pXf+2R1XVaMRBUAQBEEoDPUEf+1/TwMoGvUoLW9Wo55n4NsfdzRcERAFQBAEQcg9ELgjnlCFlR3F4u0VlQZw9yP0EIZWBLoXW9T5u8uqEWxWgiAIgpBjEG+/53h3rPC/MLSeivsfQNH440NX1HpbdJodrnn/73u877BJpY0oAIIgCEJuQXz9rne7fCUgiqW+ipo8sKLSBAl/pw4txSoB8Abse6c7dSVAFABBEAQhl0Do3/l+vPBH4t2pQ8uxgjgJKEoAvktY7kASiAIgCIIg5A4IfRPLvyr8lxoi/DVQAky8D90LLX4eQ1qIAiAIgiDkjpGzHbHCHyDTfrW78e1uTPMPkBOQVqWCKACCIAhCrhj8vN37tMX+3NyOq07K7FwJZTQhMvFEjJ7sVGkgCoAgCIKQK0bOthv93NQe+/I6eBnQ1MeFax7C36QTIfIB0ggFiAIgCIIg5AZY/yauf7jcXbj+d35Y8s+HVsJxZYYmmHoBBgw8HLaIAiAIgiDkhqFzZoJxzoHrH1Y42gcH/42yQxsoXoCkcwFEARAEQRByASxxZMrHASF7YchOAYC1X+uGR4nenve6rOv1MRjIhMEpe49DFKIACIIgCLlgcMrM+rdt9wvhD9d/PVw07cH1mYQB+qeT7dYvswAEQRAyzLO/XCD9/PdG29Wjh7tUEUEc3gRTC7seEPxxsX6tBJy9f5k93hfXuG0mWqGBxwEeD3QxTIKGKAD4Ui0WI5mzUNPJ0f4q7aqhzSgEQcgfFxdoAmZltbh7jGlMnCMwEdvf+WGn8TmgBNxzvMev7TdN7Lv1Gq95CkD8z+F6CqUAfMfTsAYtMhzR1SmtiU5h7J7oIidoQONDO0pBEASBBmW/XSeIFxx3YKqdLZOQJ4CM/fnhdTW9y7zp0GqX2c/1LCaXCNgQBWCbZVwDCy6CVBAEoXmg9Mhfb7sWeywIbbjgXWTawxuAsAE+KD+c27Hm/+kCk6RHLqkrAKjhtB12gDgQjiHudEEQhObAhSCE3NCCOqmhOygbxAczCNCG2LYTYatFuDz22CplBqbcNDfADUxrrrMgCILQWGBl26DL+tKatofrHZ3oVN/2zllPEWgx1As6lpMr1ku1DLDaTcmNO8NFRyZBEAShePQsbti2SO6753i3n92f5qhdjVYEdnufYPI4RaGx7TsQRqoKAKY3uQI3Mq2JSYIgCEJjMWn/q9Hd+mAoolwvyTi6Kcg5CPYPyMI1paoA9DkW2EOT6c1NFgRBEPIBjEPdzKcRVn8YunQQCkoWDNjUcgBMBzhQwAJKMqAgCELxWe2+ppSh0ESieBYs7HpAZsETQKGSUMQ7NQ+Aq+S/ILqUQxAEQRCCZMnyr4V6bUkZuakoAC6T/2oJTmoSBEEQignK6poRbqthE1JRAAankrPS4eqRZEBBEITioJP3gtnvpp3zikZtUyOUMuo8AltyrwCAuIEKgiAIQj6AgEPyHgy74XMbid4Lt7vprJc3gm3v4U3H+kD4YyyxbZgjcQUAN9F18l8tyAPIcrxHEARBiAeCDQJOE9zbkQTYjAnfwcmGwVJ6VBTsea9T2ZC4AoAhC0mDB0RyAQRBEPILDMU73791jLFu3atZbEIvgPYAYH1qBxYhBB5UmKgkqgDUu+A4oOH55R5EpBpAEAQhv1Q75X1TJAX79s9Z9tXPG8HvG9ZIDwoANw8uUQWg72u6VY6RirPb6TcZmlBS7RIFQRCE5IgSYkEvAKzhZgoDzG6vTgKKM6aRD8CRf4kqACNn6e5/fOGZUd74o8EpmQ8gCIKQJ5DEHefGhgIAAQfh3yxD4Jb6Kjfd/3Ft9KEkIXxCzYVLTAHgJP+hzlNreJxYjwwIEgRByA+QETs/jI9hQ7AhRABgIBY9FwAy8OP7lv2/I7/NJJSOzofUfIDEFABO8h/c/5q57fQbLAOC6JTL19TFhY0P/i24Q9ZXEMK5690uY0Mx2PMlyeY4WUG3/0VJpCkwgimGcCKp835W/jT90NO7Nlw7F4avqu98SJ/dDA3o1KFlJdwKBM/0bEWd/2Jdzcyuq+m5ii+QwhgabFH9vZ52PtLm//2O7flOssR37fTeo1IpGZ1Xr++ZT6+qi4uVpltfYQM8C+e89+z81Loqr15X84vXvE/VldvZscl7Djd7fyq1tbdF7dzeqoYHWtXWvlTnsmUCCDaql3j0ZKc6e/9y4au+gnkP1DWCDISHxERJSmQVt03T6/JxwavdG8kdcIEgA5Lq1oeWKAOCNvhs6qovlE5+tOpvRqbMeMIMn9OfVhMyt3rC6o6RVnXkYJfTzWqlfF299D9XSL/zwIEO9b3d9Z8LbL6nvGv+s7cBT3uKzjys7prvDYH7zFO9ygVY3/87taZOfbKWmfV96fXLaoUYJv3e7jZvXc0tjSjOfLqmxk/S47SHHyg5U4Ree3vJF7ymlEqb1JM/7FFc8Nyd/GhNnZlc856JcO/lRf9/dWOXq946Vf+GZ/Kgt/53eAphMygDVEtVg9r3sGqBohGsfqCA30FS4J8OL8XKwUQUAM7gn7k6mf8Xhq6yHhL8TrMkioQBwTR2YiVyM6Jw0dtMJzxBh8/+fe3OFAEITVwrBZy/FhzjhCd0znl/xgliKB22THgK1fjJsi/EXRBcXwhBG2HY51mWp71rowCvkCsFAOvCee6GBtx4Qi4uVHyFl8L+u3i11BD8UHbe/aBMUgBrwXP0qqe0QBF88PslZ/cii1Tj/vzvl9Upf66xaW4HRWn0ZMnzlqxE/pxzBYA7+Kdem0edEEhdCGSVNqsCgM3v1d8tORP89UhCEeCCDfjYeNkXOmkARePN48vOBH/YOfDhri+8IyeI6wGlCN8JlqgNeP64z97EqVV1+MGS5x63e54++4J+/r276YrHuCf0j42vWAn+WqAIvjG27CswT/5wS+G8AZAPiPsLyQM5ODRZiayqc/50xZUr1AOu/qD7PwinJBDtJJsxGRAb0i9evJSo8A8CJeD5Vy751mMjgLB5/pXLqQh/KBpvehvzC975khT+QbC+z/1qkSzM7/Diyog1U4Hr3haO8NX4SshX9mt7+hP69wgLKdUDz90L3nMPRdCl8A+CZwzv1spqsZLdOHF/gY+eqRCG8zvRxxC8utlBPbg9AZppQBCE06tvX0l0QwoDFstzntJxIiULXIPv/HxKwjhNRaMWCEVYhG+OLZF+b+936aEzF4ojrHi737dXQs4TlRCK8K8K5supKNl4t157i3bfswyS06Rle/ogcTJscqBTBWDw83Z27X8Y3J4AzTIgSAvCiY/sN04bIKTGxldUWuB8FxeTt4608E/L6g8DcebnXlw0tgj376N74j774qqVxWnj/tfAC2FzDTj/ClEJNnX/+8L/5UupPHcanSRaBHq/FuHfCJAP0BOSN+FUAeAk/10aiN9YLwzxegIUfT5AmlawCYiHpuEJmJmrOLEU49DCP80NPwrc5xdevmwkIBHLZ4UBPuELHBv3v8Y2DHCaEcYwSTz0nwVP+KftYSsSzTjIJwvAiL4wXH/tnSkA3OS/qT3xAgM5ApyyvqK7m3779lJmhL8GSkDSOQHIdUiarAl/De73m8fi+1x0ljbxwgAWQtzW/b9xHL5yR60ogfBH5n0U+lkQ4W8HwrlSnp0+aLAXtu7OFABO8h8aFYQl/wXBxc8P0zemYOeoogFBeyaD7kFYcL9+nVbXn0XeOL6cOeGvgYA08bTsHKErwNxEQBfu/+A1cMIAuIa/zNEU4nolpbXgXcvqs5AnsI9zc7oEPlFGtjMFgJP8N7PL3GKIShSMoohxJ2x0acbbqWCzzPL1xQEPQxaVqyDIgYjztCC5jRoGgAJHtaKBy1g1NwzA8V7Euf/R7yGNcFOzIF6AdMF6RxnZTqQjXO2c0o4FQkyI2xMATYGK9tDBHekCCAfUGQ8PbjwGaFmKzXfF0t2JjPkHvt9hXdOdNlCujjlSXlCONzTQ6neZw1pjTf/iufD9NXYQunlzbEU9/aMtof8dYQDkAlAFI7LoqQ15qI134tANkShQy/9M3P+ungW8Z7tG2lTJew7wPJQ9JQeKMpS4+SbyLmgvAHVojUAHCfbTMUa2EwWAk2yHxD4T938QzoMDhQElEFGVBnkCFomtO1K3fY3aYCGgIMQnmBs7rLgTH6yqwwc7VZ6wbeyC/v733tXhd3MrRVjfuId+GOeTNbayhax93J+oLna4FqoCAFf+4YPmP89xvcdRDQN0khTIM5M0L0Rc9j88QTbvGpS+B7znAO/b0GD4Vmv7ruUNNGkbnGqTfgAJ86W3znEy1loBwE3k1NwjsY8KlAaO5likAUE2Fgks0kcf6jbq9oafOfpwtzriCfAXXr7EslKwqTVKAfA9G571DSu474aVt+B9h2ob4PovBQSZjbsXvdyPPNgZKfhvXp93TVjfi976oMHQaWbsHc9DlAKAMMBrilZLrssBTYVvEqVquE+oSDBt0cvJP4ir/7fp+4B37ejDPbEeBuDiXcsbn+5fUfve6VZCMkC+zhrIWGsFoI8RY4drAn3+qSz1VfxSEmpcvygDgmysfwinRw/TW3BiA/vZU73+xjRDtPJ0PDmtSXfa4jqwr4PVQtVGucIGzuknj/X98WM9/rk5eRN4HqLWGAoQhgxRvQDoK3HQsB99Ug2ScA2mazrxEe0aIHSjhHOj3rWf/7RPvfrWlcLnHcAjC48uZ9aLEA3kq0l1HbD2wYycpd9Ak9r/MDg9AUARHjRumRV3Q9JAiDz5T1t89zaVtMoU8R3//V/7fCuK2z+dWwKHteUOk9HgurkDYMbGo1/2vbvpz/55Q4t65qv1xDLkZ+bWjasBqPcOU/eiaNS7Bo4+0kPqTphXzt9dlt4AjoGRe+rQknF43UoBQIkdJ44zvYuv3XJ7AuRdAeCWWUFo225IANbJ4w+bjUuthhq61H/+21Z18PvJTzWD9Y3vWOrgd35EAhlHkEHwH3Q0uQ1KAEfJiuvgx1FOcEwTThItVUz8M0WHAeLgKCFRa9Lodw087j3TnGchb2Ba3Wq3lFi6YvJAmZRbZxUCGJiiC1W4J+DK5wLhj9+nhgEQAoDCktdkQK51io3EFRDsYe5k/Le9o+3qwN0dVoKYCoSmrfUNOPXv2KCPOMxxgKcFShYGzVCJipdzwgCm4RvKuuFYe0fb/JkVppiEAajvBu5bVB5MFt413DPkz2BEcJHBfv7Rg8v+hMC0kgKhcOC8kEWV9qpMWu2qKiHlG8pIuetaze/cKlQ7ljb2OMgWXZ1W8r5Dy41/owUvfq6aiJ5sPxp8n7P3L5PlG1sBwM0aZGT/f+lgTC+ySPe9Q7/0ockOb4HymQzImXCGDdd1/P3wwS712Q0B1Sihr8H5XSUZTjNCFei0t9WxlRalZEWBn48SlAgDUI+JXgiRlSJEyxtNd3AdFAVAhwGiEhLPTNLejZ0x7wSnD0IS7xruJxJEVwregRAC+Y8PLfnJ2q48tdpQhOC+0lvxz4E/IfBd5IIFFYLVQFJxlADWFWlQEroXW/y/QzGwnVmD7/nxfcvkqjr/mhSTPmaDnQUHMR9uTwB4APKaDMjJDDbpckZFu/cbJfSDHDUMScQBa5dTxubK9V8Lp3QvrimQL0yO05RfVCZEubTHyWOK28jeiLhqgKqngrZWce8FRxlM4l0DeBZONGAKZdr4AruXFwrQwh6dZZFTUBX42dvjq4PtKjeUhA0lUysGunMtVSnAcbnfl60ADJ2ja7u4Sb7i8LWyBjeb2uZXDwjKYztKjoDa+91ksu/TiOvHYdLExRROomJcFrkNnNK9uO/ACQPAuscn7HtSjoXvpI9DVXCiwgBUax3u/zhLnfOuJVXpgnVrBgUAezMnoRxub25ieFa4VTGoAtmGELuJlx2Kg254R4WlAEBD4cQ08DujE41tDIOuhXlTAOBqpVKdBlfcJCKXFhc681GJyyK3AcIawpKa2BYlrAFc31TPArwA9TwdsLop1xdsugOh9laHuWs7qi8BNXcjzv3PSQTV9ysJTHp2FAG4/zk5ALD2iwiUgdJSxTjMjvVDaT3VE8B6aofO5TejPo8DglYYaRP9vcXeOKI6q1HhbPrcUkNTOBZltclROAcYyZJhWfjUuvugNwoCcyfx+8ELUA+qQhPX/W9+gf4suHwWa+m80Ua6yEDwSz+Ab9JCcG7Bg7KbYVyzdrG+nE/Y43QubCQrZYaAKngJUaMtoyyub9xzgmu+gzghMKwWn+r+r7XeqfkT9RQRahIihGke6+sxO6DIoAKAS+vV8PcQigW6Dd5zvEft/LDUUMMP58Y1HPhDj39NJjF+VBHQztHqe7gpkFXXwc/bc9/DGXkAqCTISzIgJwu4yJuGa+EbZznXI2mrLCkFgxoG0JP57ti+cT027n9NNUS1ySoM4Lr5D5eiK9tJwnX9a3oWN4eWlUMYaqHfvdDuexl0vH3ec5cjIT2pZEGdb6Y9zkGB37GkjHLROGH20ZOdavEfrxjLNvLKD0zly3quB24GVVMSskN/n1tNvpOhLCVdmsVRSkzgCMHa0cgU9z/Wtl4CH/7/e4khidowALX8L879L6QLBL/tVMAoIVlPMdB7P3LRDvxhi+8dCNb026K9Dn//xhbf4se56ln7cR0QcRyOx8JPpiSsKUkB4F5UFuFMMGwUHGszqfasQpVyOVkFoJyQgoEyTqrFWtsWl2J5R7Uhprrjg2EATre+pKpikn7Xkn7WGgUEpC0onwsDlv7Jf7gS2XIYvz845S4sNHyuva6MrHoe1v1r+d8fXPar2KLgltkDeDpM5TTpLCNnizPDGa4ZaH5ZrBethdMStKibRhJwFKykPQAXGZUJnSWz5wQWOWXwkB8GmK34bnsX7n8NlBFuGIDs/kcPAoOqmH5Gcuf8QnKZ6Fj7IjYCQijZhRdWu9jDGvCgARBc7fjobrD9M21+HpsOPax2uVPgIOR1QiPOjRJFZOdD4FNCzpySyCAIBfzp8FLsOUl3IO/Jf7VA8/vizuzP4O7sZMxbmJUhG6Zw8iWSHnKEuDuVrX1m3wNhgDFFmzwI4QsFgOr+j7PyqY1u9JRCav2/adloielto4xPppDWMK008V3/Z91Z3abj3iEMqwK5ujfC+rdpolMPHBteB4wc5x4XCoRtnh0SCHGcOPlmfJYiJP/VkpfSE7hsqVaqbuIixDM8QFdsObMDTEF2O9Xqq5aLmb2f2vKmoN3vtfkAUZhMIeSGATgeABO4ZXcchc3ouAVU5OFJdilLuKXdsMrjhDS8BpATKLHTHygcUeeD5c8V/i7yIjQ4TlSIBBjfhf6Z4tWVa5dQHuCUvWGmeRJA+KFHOadnehbZ2tdC3vT1sJwkOD1JPy61Fp2agAcPAJ4nimJiknRHVUZwHdTJjdSukZx3jaIYkY47mb+upVHAkBxMIP8KLm+XyXyQDXve67qZzIecMf2BYEWi3/7f9zhNJsc5URJpOxsgSFyehdFbAa0kb7XzprjStpLmW4xmI+jVbjpPncIbnvDHsV945bJ69r8W1KtvXcm1MgCrj7Ppj40n06KVo7gNEb0YnHp4yiwB5K2YnoOqjLz2O1qbZGr2/05GEyYkSrp+17hjibMKt92vCXB53/m+G+EJeXfP8e5Y4Y5zQklwIUNw3fvecT8RUbcJDj2vMoCr5SD5oZKil52T2Y8FysOAIE5PcFipJz5YdTYxD0A4Ba0v/H3i1Jr/0Y1mkGSWVG/0pOC0yYU1ajIyl8Kx8RVW6IYq5KgJeIBSmkgRotRnm1oiSVV2ODkSSbxrx8Zp15B1XMS2o0BJ4N+NdatTh5bYLni4zKFIUK4TCgCUgak9ZdZ5OeekENUm2EiyDzNa/2Ke8tn7032A4QLq/ZozJjj7yYCcDRvAUodwcNGuFBZJ1KaUZ2WAs+kDzGt/5ie3OUkAw/qOMTZ9kwE39Uhy0hxlVoMuTUwiZ4UztMnmXdu/r8NJm2go2niPioLL2HYUEMRwz2Ps/OwOc6+kjvVzrxHG521zLaTz2p7TFN0muF6iZOyT2hsol6AwP5y+62puO++ceQlvPMCYwgfL5NevX/GEi/3m+obnAjbdpLUyMHYiH5PMsOlT2+QCfM83j9HG7NY9jif8n/dCKhx2MhWspNrichSS/Xclswlyu//dy7gevGvPv3LJ+l1D5j/CbEXCpt0vFSgBaPSDGD3yDaJyAyDfIIDxs7aCOHheCNzaDoAA1wKPOmLzLs5pSlib4Ngdb4DZJGF6V/oW9YXhq+o7H3aQ40DVWczhtaRZAeVPHAsRQgob0788cRvLOimXr6nfepYuJ9EpqTnpSbCfOKZWA0WnvHpZPf5IN8sToIU/1wI+wnQ7cy3dODgKCZSRsQRc3lzFgjuG1/ZdQ0gJCnu5QLX/tu1+uWiBDHQdPjL0QcvaproC2tV5S59vviUkjfM2uoquXpvgyCvCBXMyNhcT7LEcBb7Y3A5eMloevABhbVVNwMb07C8X/E22TBguhA3pFy9eYmc55ykXAGvbz+zrftpbn+f++xI5gW/8g7K/vlzhj2u26UW/97vuFTSO0gdXPccDEwXuJXdoFNcjBHAvn/vVIkmBwDuJyhok1hZJ+Gdl0p828nQmf1iL3qTIQgl9vTbBkU84tx3h3PbGZYQj2YHzwOVlQBCsvTOfrLGtNsTwT3pCSsfnh70NslTTQQ61x8g+RgmSTRayrXBqBEjiQlyfAzZ+/C7WGPcJwqde7gWUqvOep+FdT/jbbvZHLJPOELN2WS7KzUcAnETMuOPZcPhgl/rMs+Y5IBwANz7uMbwJyMOpfdcg9Kc9dz+Ua7yTRRL8GtT8pylohWggGyEjtbc7UsJzSzYWbm9c6Qq+GIQ49aHT05viJjQ1GghU5ALYuEuDyXo3j3vDXekiVwDAtXzEYUZ0WkBpgUC0EURaEQDoLNfZuemmq93V+gKsr62CRZ3KF4eN0OWGuMKwDT9pL4Dts4DkwPEb3gD9PKysXC+kwA8CizuJmn/BjmDnxNDdg5v8Bxd8o/vrc4V4XiYEYuN37S6FYHIpnA56Skpex6QefaTH2bjf8g2hj8Qul+sLS9tFyRnCSi7DADZCF9fi6rm28UQEcfksAP08FF34g4Gp/OT/NBO69B2E7tDcm6f7LDeSWWYIgttSshG43phc4ko4NYqtGb9+3Penf3SbcsXODAndvY4qE3Y6yj3J+rOQZbZN2z9XOnEPbmsYdgjTTu4vVn+EMDA5EN8XRjXy6lyGp7VxX/cO+TOTGTcPtf+4UY0GDwwWjNMTAL+T9WoAgI0JQuCFly9lalpY/43ryjvwYGBdxzLYjOXoI91OvSuIUb/VsWz9HLkQugjBUDoOhh7HYfUJnoV5z5WfVM8EoQoE3FJfxc/YX+qt+KHkMG/ywFQba3+vPR9wnaOgR/9WW83zrhGytJ4nG8dEQiOaHnUvtqieG3+nX2PVG1n36rZNt7EW5dJAdgQnPBHcpkBY+KwnAwLEbx893MVOWnMNLNMfP7Ylt67/WhBqQYlelhqy4Jr2Oq7f162QbRPwXAhdHQawuRb/GI6rT37gvWdI2itSc56kgfUa1Ysewh7GVpywrwd+z0YBQJM6baz61QFT9jMKIDP06GEtP2BpowcCNZwe1kenqlxUvmGk4jtAEcCfKEOMUgpwX/Ra111BaFccpndl5+WA2wTJDpxkQGhYefACgGqmfYt66fXLDfUEaLc0t+wqqyDUsrVvJROegKMPdyfWMOdeZg8EjauYO4CCY3MtexNqcIRnQakrqSoBWFck6OZxJgAEIfbRwamNZjwQPBC8ui7f5tjcJjoQgEFPdVWgrqgv9qz6lW8YfBeMk0dR9TZXvLDzWl2Zgf/+8X0r/mwBCtQ+OlopmBmt/lvLsWBYG+s97xnGwU6F31AAoKlwRytCo8sK2g3Dqe83nS+dFZCt/MxPev1wwHwDRgBrt39RLP9adDVDo5QArO/jnvBPsqcCwgCvKb4nyaXQtQ0DUOciUEhTIdTv1RvHaPclS2PAIRPOJyAX9P7O8QJAWNcDwnq2e80TkNV/Q4BCkJY8mdixvPnmeSveZ739urrieS5MvBZUueiij06Yp6CWb6we6jY5zOzKXi99aIkcBSAvA4KCQPj+7KlevwY9zVglNv5/9mLSpYwmJLoCSsABTzClrWRBuTv6cE/iypWt692lZ8L2WrBmSYJnAcIZSkBSz0JQqe7sLKZibQss+X3v0O+1qXCFUQtsvcFU93+ac2m+cWV9zCz4Rtb+h6F7AnDIQvcqKtg4Eat8xlME+hMWGP4G9cQW9eRjPYUX/hpsxj//aZ+fFZ7W+j79RHqeFa4Vb9NxL4x7LVr4uhjMFAcUHgjoJEIyUGCCHjXq+zW/kI/wpS1VC5cud2DZpwnFqMb3STP8fIv6pOvgdb9kU3DBja79DwPaFGeaIdYiShPDGq0u017MtDwK2IwhqE5/sqZOTJSdxg9xbDRsSSoWnQe0NwAd/Vxbgdj80Z2vEevLdb0nEXPnViYk6f6vBQIaeRl4HuB5s+nQCXT5bO297+8VD0AYHC8AEhORBJjGfoxwMiW58NOUSxw3vf2bQ8XvSNHkICYIZYDb2hcJftiUsLm6jkOjZerpT2lJVfB0JDXJjgPWdOLUqjrvKQQcZQBJXhD6cHs3enbCaYYQ2+VdcxJeiixdiwlo7oNrRujC9FnAuzX0ty3qAU+pDnum8f6em6KVVx9oIgUdAp3qsUWZHTLtkWzn2njVXWUHp9pJ3gYkrosCICQKNqnpryp+v39sLPisrG5sVHCfQsD2IfvY++waaXMy37xZQMc/uGBn5ipqwVvb+cVb3Xn9vVVX+bcGqnPqd+1oa5oQSrOh3zU8A2VP0dXKjB/X9+758GCrvFsOgMBFlj134A482HPb18iliLXXgN45vf/fqvqn6YOGoJCcOrSUuiddFABBEAQh16Bybd87tFK7ekAQ64q2Ve/v5ZBwuK4MQM09t21+kGBfgjTJR/N7QRAEQQgBVjzyAbi9ATSlG0I9zbkwtX0J0kT8T4IgCELugSANNrnJA7jeNMv+ahEFQBAEQSgEGBSUFyUAYYZGDzaSEIAgCIJQGLRQte3tnyRQUv58d+OHS4kHQBAEQSgUUAIa6VqPAh1qcX1Z6DQrHgBBEAShcPhT77quq5Gz7dZZ+i6AwMc11Rvz2yhEARAEQRAKyeyOan0/2vE2MiSAFr9o8pO1jrmiAAiCIAiFBW3b4XJHsx+UCXImCHKB4IfVn9Xx8qIACIIgCIUHQhhj3tGed+hch9+5j9qxzwS4+tHWF7X9WRX8GlEABEEQhKYBnf7gEZjcX+0giJHxUAq6F1pYCgEEPkr6cFwIffyZl1HyrdevX/8PJQiCIAhNxsLfrPsfTd9cq7rtQqvfDbD9SnTi4KWBdXVpm/f7A3UGrOWkwf5fAZ50lxSL4D+tAAAAAElFTkSuQmCC"),Ss=function(){function t(e){var n=this;Object(l.a)(this,t),this.gls=e,this.logoTexture=void 0,this.logoSampler=void 0,this.vertexShader=new jt(At([It,ve,ue],{texcoord:yt("vec2"),worldSize:pt("vec2",(function(t){return t.derived.worldSize})),projectionViewMatrix:pt("mat4",(function(t){return t.derived.cameraProjectionView})),main:Ct("void",[],"\n      texcoord = ".concat(It.texcoord,";\n      texcoord.y = 1. - texcoord.y;\n      gl_Position = projectionViewMatrix * ").concat(ve.translate,"(vec3(worldSize / 2. - 0.7, 3.)) * ").concat(ve.rotateZ,"(").concat(ue.PI," / 4.) * vec4(").concat(It.position,".x * 2.3, ").concat(It.position,".y * ").concat(2.3*24/126,", 0., 1.0);\n    "))})),this.fragmentShader=new jt(At([],{outColor:yt("vec4"),texcoord:gt("vec2"),logo:pt("sampler2D",(function(t){return n.logoSampler})),main:Ct("void",[],"\n      outColor = texture(logo, texcoord);\n      if (outColor.a < 2.0/255.0) {\n        discard;\n      }\n    ")})),this.program=new Xt(this.gls,this.fragmentShader.source,this.vertexShader.source),js.then((function(t){n.logoTexture=ut.fromImage(e,t),n.logoTexture.generateMipmap(),n.logoSampler=new Qt(n.logoTexture,ee.LinearMipMap)}))}return Object(p.a)(t,[{key:"destroy",value:function(){var t;null===(t=this.logoTexture)||void 0===t||t.destroy()}},{key:"run",value:function(t){t.data.aiCrowdLogo&&(this.vertexShader.updateUniformValues(t),this.fragmentShader.updateUniformValues(t),this.program.prepare(),this.vertexShader.writeUniforms(this.program),this.fragmentShader.writeUniforms(this.program),this.gls.depthMask(!1),this.gls.enable($t.DEPTH_TEST),this.gls.disable($t.BLEND),this.gls.blendFuncSeparate($t.SRC_ALPHA,$t.ONE_MINUS_SRC_ALPHA,$t.ONE,$t.ONE_MINUS_SRC_ALPHA),this.gls.disable($t.CULL_FACE),this.gls.drawQuad(this.program))}}]),t}(),ks=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.effects=[new $o(this.gls),new rs(this.gls),new as(this.gls)]}return Object(p.a)(t,[{key:"run",value:function(t){var e,n=Object(m.a)(this.effects);try{for(n.s();!(e=n.n()).done;){e.value.run(t)}}catch(Nt){n.e(Nt)}finally{n.f()}}}]),t}(),Is=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.destroyed=!1,this.systems=[new ji,new Xi,new Wn(this.gls),new hr,new ws(this.gls)],this.renderers=[new Gi(this.gls),new Ss(this.gls),new Os(this.gls),new sr(this.gls),new ar(this.gls),new ks(this.gls),new Hi(this.gls),new ki(this.gls),new xs(this.gls)],console.log("Renderer initialized")}return Object(p.a)(t,[{key:"destroy",value:function(){console.log("Destroying renderer"),this.destroyed=!0}},{key:"render",value:function(t){var e,n=Object(m.a)(this.systems);try{for(n.s();!(e=n.n()).done;){e.value.run(t)}}catch(Nt){n.e(Nt)}finally{n.f()}var a=t.data.canvasRect,i=t.data.rendererConfig,r=this.gls.gl;this.gls.framebuffer=null,this.gls.viewport={x:0,y:0,width:a.width,height:a.height},this.gls.depthMask(!0),r.clearColor(i.clearColor.r/255,i.clearColor.g/255,i.clearColor.b/255,i.clearColor.a),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);var o,s=Object(m.a)(this.renderers);try{for(s.s();!(o=s.n()).done;){o.value.run(t)}}catch(Nt){s.e(Nt)}finally{s.f()}}}]),t}();function Es(t){var e=t.gls.canvas.getBoundingClientRect();t.gls.canvas.width=e.width,t.gls.canvas.height=e.height,t.data.canvasRect.width===e.width&&t.data.canvasRect.height===e.height&&t.data.canvasRect.left===e.left&&t.data.canvasRect.right===e.right&&t.data.canvasRect.bottom===e.bottom&&t.data.canvasRect.top===e.top||t.setData({canvasRect:e})}var Ts=At("GroundHeight",[],{heightmap:pt("sampler2D",(function(t){return t.textures.heightmap})),heightmapSize:pt("vec2",(function(t){return Object(y.l)(t.textures.heightmap.size)})),worldSize:pt("ivec2",(function(t){return t.derived.worldSize})),atCoord:Ct("float",[["vec2","worldCoord"]],"\n    return 59.1 + texelFetch(Self.heightmap, ivec2(worldCoord * Self.heightmapSize), 0).x;\n  "),atPosition:Ct("float",[["vec2","position"]],"\n    return Self.atCoord(position / vec2(Self.worldSize));\n  ")}),Rs=At("GroundNormal",[],{normalmap:pt("sampler2D",(function(t){return t.textures.normalmap})),normalmapSize:pt("vec2",(function(t){return Object(y.l)(t.textures.normalmap.size)})),worldSize:pt("ivec2",(function(t){return t.derived.worldSize})),atCoord:Ct("vec3",[["vec2","worldCoord"]],"\n    return texelFetch(Self.normalmap, ivec2(worldCoord * Self.normalmapSize), 0).xyz;\n  "),atPosition:Ct("vec3",[["vec2","position"]],"\n    return Self.atCoord(position / vec2(Self.worldSize));\n  ")}),Ds=new Cn("Crippleable",Oa,"int"),Ps=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([Ds.component]).mapGpu(this.gls,Ds.component,At([],{map:Ct("int",[["ivec2","entityCell"],["int","value"]],"\n        return max(0, value - 1);\n      ")}))}return Object(p.a)(t,[{key:"run",value:function(t){this.update.run(t)}}]),t}(),Fs=At("BrainFocusables",[vr],{size:bt("int","".concat(ha-1)),get:Ct("ivec3[".concat(ha-1,"]"),[["ivec2","entityCell"],["int","selfTeam"],["int","arenaIndex"]],"\n    ivec3 res[".concat(ha-1,"];\n    int r=0;\n    for (int i=0; i < ").concat(vr.size,"; i++) {\n      int l = selfTeam == ").concat(ta.HomeTeam," ? i : ((i + ").concat(la,") % ").concat(ha,");\n      ivec2 unit = ").concat(vr.unit,"(arenaIndex, l);\n      if (unit == entityCell) {\n        continue;\n      }\n      if (unit.x < 0) {\n        unit = ").concat(vr.unit,"(arenaIndex, (l / ").concat(la,") * ").concat(la,");\n      }\n      res[r++] = ivec3(unit, l);\n    }\n    return res;\n  "))}),Bs=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Re([vs.component]).updateGpu(this.gls,[vs.component],At([ri.sm,Sa.sm,Jo.Cooldowns.sm,vs.writer,Dn.sm,we,Ea.sm,Bn.sm,ir.sm,Ds.sm,Ts,ue,Na.sm,vr,jn.sm,gi.sm,Fs,ye],{mapCenter:pt("vec2",(function(t){return{x:t.data.worldSize.width/2,y:t.data.worldSize.width/2}})),update:Ct("void",[["ivec2","entityCell"]],"\n        ivec2 focus = ".concat(ri.sm.value,"(entityCell);\n        vec3 position = ").concat(Dn.sm.value,"(entityCell);\n        float rotation = ").concat(Bn.sm.value,"(entityCell);\n        vec2 forward = ").concat(we.forward,"(rotation);\n        int selfTeam = ").concat(Ea.sm.value,"(entityCell);\n\n        vec4 values[").concat(ss,"];\n        ").concat(this.get(qo.Hitpoints)," = clamp(").concat(Sa.sm.value,"(entityCell) / ").concat(R(ja),", 0.0, 1.0);\n        ").concat(this.get(qo.Ability0Ready)," = ").concat(Jo.Cooldowns.sm.value,"(entityCell, 0) == 0 ? 1. : 0.;\n        ").concat(this.get(qo.Ability1Ready)," = ").concat(Jo.Cooldowns.sm.value,"(entityCell, 1) == 0 ? 1. : 0.;\n        ").concat(this.get(qo.Ability2Ready)," = ").concat(Jo.Cooldowns.sm.value,"(entityCell, 2) == 0 ? 1. : 0.;\n        bool hasFocus = focus.x >= 0;\n        ").concat(this.get(qo.HasFocus)," = float(hasFocus);\n\n        int arenaIndex = ").concat(jn.sm.value,"(entityCell);\n        ivec3[] brainFocusables = ").concat(Fs.get,"(entityCell, selfTeam, arenaIndex);\n        int distanceI = ").concat(qo.FriendStatueDistance,";\n        int angleI = ").concat(qo.FriendStatueAngle,";\n        for (int i=0; i < ").concat(Fs.size,"; i++) {\n          ivec2 unit = brainFocusables[i].xy;\n          vec3 unitPosition = ").concat(Dn.sm.value,"(unit);\n          bool isAlive = ").concat(Sa.sm.value,"(unit) > 0.;\n          if (isAlive) {\n            values[distanceI / 4][distanceI % 4] = clamp(distance(position, unitPosition) / ").concat(R(30),", 0.0, 1.0);\n            values[angleI / 4][angleI % 4] = ").concat(ye.withoutNaNInf,"(\n              ").concat(we.angleToPosition,"(position.xy, forward, unitPosition.xy) / ").concat(ue.PI,"\n            );\n          } else {\n            values[distanceI / 4][distanceI % 4] = 2.;\n            values[angleI / 4][angleI % 4] = 0.;\n          }\n          distanceI += 2;\n          angleI += 2;\n        }\n\n\n        if (hasFocus) {\n          vec3 focusPosition = ").concat(Dn.sm.value,"(focus);\n          float focusRotation = ").concat(Bn.sm.value,"(focus);\n          vec2 focusForward = ").concat(we.forward,"(focusRotation);\n\n          ").concat(this.get(qo.FocusRelativeRotation)," = ").concat(ye.withoutNaNInf,"(\n            ").concat(we.relativeRotationTo,"(forward, focusForward) / ").concat(ue.PI,"\n          );\n          ").concat(this.get(qo.FocusFacingUs)," = ").concat(ye.withoutNaNInf,"(\n            ").concat(we.facingUs,"(position.xy, focusPosition.xy, focusForward)\n          );\n\n          ivec2 focusOfFocus = ").concat(ri.sm.value,"(focus);\n          ").concat(this.get(qo.FocusFocusingBack)," = (focusOfFocus == entityCell ? 1.0 : 0.0);\n\n          int focusTeam = ").concat(Ea.sm.value,"(focus);\n          ").concat(this.get(qo.FocusHitpoints)," = clamp(").concat(Sa.sm.value,"(focus) / ").concat(R(ja),", 0.0, 1.0);\n          ").concat(this.get(qo.FocusDazed)," = ").concat(ir.sm.value,"(focus) > 0 ? 1.0 : 0.0;\n          ").concat(this.get(qo.FocusCrippled)," = ").concat(Ds.sm.value,"(focus) > 0 ? 1.0 : 0.0;\n        }\n        float heightFront2 = ").concat(Ts.atPosition,"(position.xy + forward * 1.);\n        ").concat(this.get(qo.HeightFront1)," = ").concat(ye.withoutNaNInf,"(\n          tanh(heightFront2 - position.z)\n        );\n        float heightFront7 = ").concat(Ts.atPosition,"(position.xy + forward * 5.);\n        ").concat(this.get(qo.HeightFront5)," = ").concat(ye.withoutNaNInf,"(\n          tanh(heightFront7 - position.z)\n        );\n        float heightBack2 = ").concat(Ts.atPosition,"(position.xy - forward * 2.);\n        ").concat(this.get(qo.HeightBack2)," = ").concat(ye.withoutNaNInf,"(\n          tanh(heightBack2 - position.z)\n        );\n\n        vec2 mapUp = selfTeam == ").concat(ta.HomeTeam," ? normalize(vec2(1, 1)) : -normalize(vec2(1, 1));\n        vec2 mapRight = selfTeam == ").concat(ta.HomeTeam," ? normalize(vec2(1, -1)) : normalize(vec2(-1, 1));\n        vec2 positionD = position.xy - mapCenter;\n        ").concat(this.get(qo.PositionUpDown)," = dot(positionD, mapUp) / length(mapCenter);\n        ").concat(this.get(qo.PositionLeftRight)," = dot(positionD, mapRight) / length(mapCenter);\n\n        ").concat(this.get(qo.Stuck)," = ").concat(gi.sm.value,"(entityCell) ? 1. : 0.;\n\n        ").concat(vs.writer.write,"(values);\n      "))}))}return Object(p.a)(t,[{key:"get",value:function(t){return"values[".concat(Math.floor(t/4),"][").concat(t%4,"]")}},{key:"run",value:function(t){this.query.run(t)}}]),t}(),Ms=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Re([ys.component]).updateGpu(this.gls,[ys.component],At([ri.sm,ys.writer,Ko.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n        ivec2 focus = ".concat(ri.sm.value,"(entityCell);\n\n        int ability0 = ").concat(Ko.sm.value,"(entityCell, 0);\n        int ability1 = ").concat(Ko.sm.value,"(entityCell, 1);\n        int ability2 = ").concat(Ko.sm.value,"(entityCell, 2);\n\n        vec4 values[").concat(gs,"];\n        int i=0;\n        ").concat(Object(b.q)(Yo).slice(1).map((function(t){return"\n        values[i / 4][i % 4] = float(ability0 == ".concat(Yo[t]," ||\n          ability1 == ").concat(Yo[t]," ||\n          ability2 == ").concat(Yo[t],");\n        i++;\n        ")})).join("\n"),"\n\n        if (focus.x >= 0) {\n          int focusAbility0 = ").concat(Ko.sm.value,"(focus, 0);\n          int focusAbility1 = ").concat(Ko.sm.value,"(focus, 1);\n          int focusAbility2 = ").concat(Ko.sm.value,"(focus, 2);\n\n          ").concat(Object(b.q)(Yo).slice(1).map((function(t){return"\n          values[i / 4][i % 4] = float(focusAbility0 == ".concat(Yo[t]," ||\n            focusAbility1 == ").concat(Yo[t]," ||\n            focusAbility2 == ").concat(Yo[t],");\n          i++;\n          ")})).join("\n"),"\n        }\n\n        ").concat(ys.writer.write,"(values);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){"gym"===t.data.gameInstance.type&&this.query.run(t)}}]),t}();function zs(t,e,n,a,i){return At("DenseLayer",[ye,t,e],{calcNeuron:Ct("float",[["int","outputIndex"],["vec4","inputs[".concat(n,"]")],["ivec2","entityCell"]],"\n      float v = 0.0;\n      for (int i=0; i < ".concat(n,"; i++) {\n        vec4 weight = ").concat(t.value,"(entityCell, outputIndex * ").concat(n," + i);\n        v += dot(inputs[i], weight);\n      }\n      float bias = ").concat(e.value,"(entityCell, outputIndex);\n      return v + bias;\n    ")),runLayer:Ct("void",[["vec4[".concat(n,"]"),"inputs"],["ivec2","entityCell"]],"\n      ".concat(new Array(a).fill(0).map((function(t,e){return"{\n        for (int l=0; l < 4; l++) {\n          int outputIndex = ".concat(4*e," + l;\n          float value = Self.calcNeuron(outputIndex, inputs, entityCell);\n          value = ").concat(i?"tanh(value)":"value",";\n          value = clamp(value, -10.0, 10.0);\n          value = ").concat(ye.withoutNaNInf,"(value);\n          outValues[").concat(e,"][l] = value;\n        }\n      }")})).join("\n"),"\n    "))})}var Ns=At([Sa.sm],{running:Ct("bool",[["ivec2","entityCell"]],"\n    return ".concat(Sa.sm.value,"(entityCell) > 0.0;\n  "))}),Gs=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.dense=zs(ds.weights.sm,ds.biases.sm,us.inputSlices,us.outputSlices,!0),this.query=new Re([ds.res.component,ds.weights.component,ds.biases.component]).updateGpu(this.gls,[ds.res.component],At([Ns,this.dense,vs.sm,fs.res.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n        if (!".concat(Ns.running,"(entityCell)) {\n          return;\n        }\n        vec4 inputs[").concat(cs,"];\n        for (int i=0; i < ").concat(ss,"; i++) {\n          inputs[i] = ").concat(vs.sm.value,"(entityCell, i);\n        }\n        for (int i=0; i < ").concat(8,"; i++) {\n          inputs[").concat(ss," + i] = ").concat(fs.res.sm.value,"(entityCell, i);\n        }\n        ").concat(this.dense.runLayer,"(inputs, entityCell);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}(),Hs=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.dense=zs(fs.weights.sm,fs.biases.sm,ls.inputSlices,ls.outputSlices,!0),this.query=new Re([fs.res.component,fs.weights.component,fs.biases.component]).updateGpu(this.gls,[fs.res.component],At([Ns,this.dense,vs.sm,fs.res.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n        if (!".concat(Ns.running,"(entityCell)) {\n          return;\n        }\n        vec4 inputs[").concat(cs,"];\n        for (int i=0; i < ").concat(ss,"; i++) {\n          inputs[i] = ").concat(vs.sm.value,"(entityCell, i);\n        }\n        for (int i=0; i < ").concat(8,"; i++) {\n          inputs[").concat(ss," + i] = ").concat(fs.res.sm.value,"(entityCell, i);\n        }\n        ").concat(this.dense.runLayer,"(inputs, entityCell);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}(),Ls=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.dense=zs(ms.weights.sm,ms.biases.sm,hs.inputSlices,hs.outputSlices,!1),this.query=new Re([ms.res.component,ms.weights.component,ms.biases.component]).updateGpu(this.gls,[ms.res.component],At([Ns,this.dense,ms.res.writer,ds.res.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n        if (!".concat(Ns.running,"(entityCell)) {\n          return;\n        }\n        vec4 inputs[").concat(hs.inputSlices,"];\n        for (int i = 0; i < ").concat(hs.inputSlices,"; i++) {\n          inputs[i] = ").concat(ds.res.sm.value,"(entityCell, i);\n        }\n        ").concat(this.dense.runLayer,"(inputs, entityCell);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}(),Us=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.senses=new Bs(this.gls),this.gymExtraSenses=new Ms(this.gls),this.hiddenLayer=new Gs(this.gls),this.memoryLayer=new Hs(this.gls),this.outputLayer=new Ls(this.gls),this.decisionsViz=new As(this.gls)}return Object(p.a)(t,[{key:"run",value:function(t){if("battle"===t.data.gameInstance.type||"train"===t.data.gameInstance.type){var e=t.data.stepCounter-t.data.battleStartStep;e%8===1&&this.senses.run(t),e%8===2&&this.hiddenLayer.run(t),e%8===3&&this.memoryLayer.run(t),e%8===4&&(this.outputLayer.run(t),this.decisionsViz.run(t))}}}]),t}(),Vs={MoveX:new Cn("DecisionsMoveX",Oa,"float"),Rotate:new Cn("DecisionsRotate",Oa,"float"),ChaseFocus:new Cn("DecisionsChaseFocus",Oa,"float"),CastingSlot:new Cn("DecisionsCastingSlot",Oa,"int"),ChangeFocus:new Cn("DecisionsChangeFocus",Oa,"int")},Qs=Object.keys(Vs).map((function(t){return Vs[t]})),qs=be(3),Ws=be(ha-1);function Ys(t){return new Re([ms.res.component]).updateGpu(t,Qs.map((function(t){return t.component})),At([].concat(Object(mt.a)(Qs.map((function(t){return t.writer}))),[qs,Ws,ms.res.sm,ye]),{brainOutput:Ct("float",[["ivec2","entityCell"],["int","brainOutput"]],"\n        int slice = brainOutput / 4;\n        int channel = brainOutput % 4;\n        return ".concat(ye.withoutNaNInf,"(").concat(ms.res.sm.value,"(entityCell, slice)[channel]);\n      ")),update:Ct("void",[["ivec2","entityCell"]],"\n        ".concat(Vs.MoveX.writer.write,"(tanh(Self.brainOutput(entityCell, ").concat(sa.MoveX,")));\n        ").concat(Vs.Rotate.writer.write,"(tanh(Self.brainOutput(entityCell, ").concat(sa.Rotate,")));\n        ").concat(Vs.ChaseFocus.writer.write,"(clamp(Self.brainOutput(entityCell, ").concat(sa.ChaseFocus,"), 0.0, 1.0));\n        float[] castSlots = float[](\n          clamp(Self.brainOutput(entityCell, ").concat(sa.CastSlot0,"), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ").concat(sa.CastSlot1,"), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ").concat(sa.CastSlot2,"), 0., 1.)\n        );\n        int maxCastSlotI = ").concat(qs.max,"(castSlots);\n        float maxCastSlot = castSlots[maxCastSlotI];\n        ").concat(Vs.CastingSlot.writer.write,"(maxCastSlot > 0. ? (maxCastSlotI + 1) : 0);\n        float[] focuses = float[](\n          clamp(Self.brainOutput(entityCell, ").concat(sa.FocusFriendStatue,"), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ").concat(sa.FocusFriend1,"), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ").concat(sa.FocusFriend2,"), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ").concat(sa.FocusEnemyStatue,"), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ").concat(sa.FocusEmemy1,"), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ").concat(sa.FocusEnemy2,"), 0., 1.),\n          clamp(Self.brainOutput(entityCell, ").concat(sa.FocusEnemy3,"), 0., 1.)\n        );\n        int maxFocusI = ").concat(Ws.max,"(focuses);\n        float maxFocus = focuses[maxFocusI];\n        if (maxFocus > 0.) {\n          ").concat(Vs.ChangeFocus.writer.write,"(maxFocusI + 1);\n        } else {\n          ").concat(Vs.ChangeFocus.writer.write,"(0);\n        }\n      "))}))}var Xs=function(){function t(){Object(l.a)(this,t)}return Object(p.a)(t,[{key:"run",value:function(t){if(t.data.userControlEntity&&t.data.userControlSet)for(var e=0,n=Object.keys(t.data.userControlSet);e<n.length;e++){var a=n[e],i=t.data.userControlSet[a];t.ecs.setComponentData(i.component,t.data.userControlEntity,i.value)}}}]),t}(),Ks=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.writer=new Re([ri.component]).mapGpu(this.gls,ri.component,At([Dn.sm,Bn.sm,ri.sm,Vs.ChangeFocus.sm,Xe,jn.sm,we,Sa.sm,Ea.sm,Fs],{unitsInArena:pt("isampler2D",(function(t){return t.unitsInArenaGpu.get(t)})),map:Ct("ivec2",[["ivec2","entityCell"],["ivec2","value"]],"\n        if (".concat(Sa.sm.value,"(entityCell) <= 0.0) {\n          return ivec2(-1);\n        }\n\n        vec3 position = ").concat(Dn.sm.value,"(entityCell);\n        float rotation = ").concat(Bn.sm.value,"(entityCell);\n        vec2 forward = ").concat(we.forward,"(rotation);\n        ivec2 focus = ").concat(ri.sm.value,"(entityCell);\n        bool hasFocus = focus.x >= 0;\n        vec3 focusPosition = ").concat(Dn.sm.value,"(focus);\n\n        bool focusIsInFront = ").concat(we.isInFront,"(position.xy, forward, focusPosition.xy);\n\n        int changeFocusI = ").concat(Vs.ChangeFocus.sm.value,"(entityCell);\n        bool changeFocus = changeFocusI > 0 ||\n          !hasFocus ||\n          distance(position, focusPosition) > ").concat(R(30)," ||\n          !focusIsInFront ||\n          ").concat(Sa.sm.value,"(focus) <= 0.0;\n\n        if (!changeFocus) {\n          return value;\n        }\n\n        int arenaIndex = ").concat(jn.sm.value,"(entityCell);\n        int selfTeam = ").concat(Ea.sm.value,"(entityCell);\n        ivec3[] brainFocusables = ").concat(Fs.get,"(entityCell, selfTeam, arenaIndex);\n        ivec2 candidate = brainFocusables[changeFocusI - 1].xy;\n\n        // Can't focus on self or nothing\n        if (changeFocusI == 0 || candidate == entityCell || candidate.x < 0) {\n          return ivec2(-1);\n        }\n\n        vec3 candidatePosition = ").concat(Dn.sm.value,"(candidate);\n\n        bool isInFront = ").concat(we.isInFront,"(position.xy, forward, candidatePosition.xy);\n        bool isInRange = distance(position, candidatePosition) < ").concat(R(30),";\n        bool focusable = isInFront && isInRange && ").concat(Sa.sm.value,"(candidate) > 0.0;\n        if (focusable) {\n          return candidate;\n        } else {\n          return ivec2(-1);\n        }\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.writer.run(t)}}]),t}(),Js=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.castingAbility=new Re([Jo.Ability.component]).updateGpu(this.gls,[Jo.Ability.component,Jo.State.component,Jo.StateStartStep.component,Jo.Target.component,Jo.Cooldowns.component],At([Jo.Ability.writer,Jo.State.writer,Jo.StateStartStep.writer,Jo.Target.writer,Jo.Cooldowns.writer,Jo.Ability.sm,Jo.State.sm,Jo.StateStartStep.sm,Jo.Target.sm,Jo.Cooldowns.sm,Sa.sm,Xo,Dn.sm,Bn.sm,we,ir.sm,Ia.sm,Vs.CastingSlot.sm,Ko.sm,ri.sm,ue],{time:pt("int",(function(t){return t.data.stepCounter})),isValidTarget:Ct("bool",[["int","ability"],["ivec2","targetCell"]],"\n        switch (".concat(Xo.validTargets,"[ability]) {\n          case ").concat(vo.Anything,": return true;\n          case ").concat(vo.Creature,": return targetCell.x >= 0 && ").concat(Sa.sm.value,"(targetCell) > 0.0;\n        }\n      ")),targetInRange:Ct("bool",[["ivec2","entityCell"],["int","ability"],["ivec2","targetCell"]],"\n        int abilityRange = ".concat(Xo.targetRange,"[ability];\n        if (abilityRange == ").concat(ho.Any,") {\n          return true;\n        } else {\n          float maxRange = abilityRange == ").concat(ho.Close," ? 2.0 : 15.0;\n          float minRange = abilityRange == ").concat(ho.Close," ? 0.0 : 1.5;\n          vec3 selfPosition = ").concat(Dn.sm.value,"(entityCell);\n          float selfRotation = ").concat(Bn.sm.value,"(entityCell);\n          vec2 selfForward = ").concat(we.forward,"(selfRotation);\n          vec3 targetPosition = ").concat(Dn.sm.value,"(targetCell);\n          float angle = ").concat(we.angleToPosition,"(selfPosition.xy, selfForward, targetPosition.xy);\n          bool isInFront = abs(angle) < (").concat(ue.PI," / 4.);\n          float dist = distance(selfPosition, targetPosition);\n          return isInFront && dist >= minRange && dist < maxRange;\n        }\n      ")),update:Ct("void",[["ivec2","entityCell"]],"\n        int currentAbility = ".concat(Jo.Ability.sm.value,"(entityCell);\n        int currentState = ").concat(Jo.State.sm.value,"(entityCell);\n        int currentStateStartStep = ").concat(Jo.StateStartStep.sm.value,"(entityCell);\n        ivec2 currentTarget = ").concat(Jo.Target.sm.value,"(entityCell);\n        int cooldowns[] = int[](\n          ").concat(Jo.Cooldowns.sm.value,"(entityCell, 0),\n          ").concat(Jo.Cooldowns.sm.value,"(entityCell, 1),\n          ").concat(Jo.Cooldowns.sm.value,"(entityCell, 2)\n        );\n\n        bool dazed = ").concat(ir.sm.value,"(entityCell) > 0;\n\n        int nextState = currentState;\n        int nextAbility = currentAbility;\n        int nextStateStartStep = currentStateStartStep;\n        ivec2 nextTarget = currentTarget;\n        int nextCooldowns[] = int[](\n          max(0, cooldowns[0] - 1),\n          max(0, cooldowns[1] - 1),\n          max(0, cooldowns[2] - 1)\n        );\n\n        if (currentState != ").concat(ia.Inactive,") {\n          int steps = Self.time - nextStateStartStep;\n          int castTime = ").concat(Xo.castTime,"[currentAbility];\n          int duration = ").concat(Xo.duration,"[currentAbility];\n          int windDown = ").concat(Xo.windDown,"[currentAbility];\n\n          bool shouldAbort = dazed ||\n            !Self.isValidTarget(currentAbility, currentTarget) ||\n            !Self.targetInRange(entityCell, currentAbility, currentTarget) ||\n            ").concat(Sa.sm.value,"(entityCell) <= 0.0;\n\n          if (currentState != ").concat(ia.WindDown," && shouldAbort) {\n            nextState = ").concat(ia.WindDown,";\n            nextStateStartStep = time;\n          } else if (currentState == ").concat(ia.Casting,") {\n            if (steps >= castTime) {\n              nextState = ").concat(ia.Performing,";\n              nextStateStartStep = time;\n            }\n          } else if (currentState == ").concat(ia.Performing,") {\n            if (steps >= duration) {\n              nextState = ").concat(ia.WindDown,";\n              nextStateStartStep = time;\n            }\n          } else if (currentState == ").concat(ia.WindDown,") {\n            if (steps >= windDown) {\n              nextState = ").concat(ia.Inactive,";\n              nextAbility = ").concat(Yo.None,";\n              nextStateStartStep = -1;\n              nextTarget = ivec2(-1);\n            }\n          }\n\n        } else {\n\n          bool canCastAbility = ").concat(Sa.sm.value,"(entityCell) > 0.0 &&\n            currentState == ").concat(ia.Inactive," &&\n            !dazed;\n\n          int decisionCastingSlot = ").concat(Vs.CastingSlot.sm.value,"(entityCell);\n          int desiredCastingAbility = ").concat(Ko.sm.value,"(entityCell, decisionCastingSlot - 1);\n\n          ivec2 focus = ").concat(ri.sm.value,"(entityCell);\n\n          bool isStartingCast = canCastAbility &&\n            decisionCastingSlot > 0 &&\n            cooldowns[decisionCastingSlot - 1] == 0 &&\n            Self.isValidTarget(desiredCastingAbility, focus) &&\n            Self.targetInRange(entityCell, desiredCastingAbility, focus) &&\n            desiredCastingAbility != ").concat(Yo.None,";\n\n          if (isStartingCast) {\n            nextState = ").concat(ia.Casting,";\n            nextAbility = desiredCastingAbility;\n            nextStateStartStep = Self.time;\n            nextTarget = focus;\n            nextCooldowns[decisionCastingSlot - 1] = ").concat(Xo.cooldown,"[nextAbility];\n          }\n        }\n\n        ").concat(Jo.Ability.writer.write,"(nextAbility);\n        ").concat(Jo.State.writer.write,"(nextState);\n        ").concat(Jo.StateStartStep.writer.write,"(nextStateStartStep);\n        ").concat(Jo.Target.writer.write,"(nextTarget);\n        ").concat(Jo.Cooldowns.writer.write,"(nextCooldowns);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.castingAbility.run(t)}}]),t}(),Zs=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.buffs=[new rr(this.gls),new Zi(this.gls),new _i(this.gls),new Ps(this.gls)]}return Object(p.a)(t,[{key:"run",value:function(t){var e,n=Object(m.a)(this.buffs);try{for(n.s();!(e=n.n()).done;){e.value.run(t)}}catch(Nt){n.e(Nt)}finally{n.f()}}}]),t}(),_s=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([li.component,Bn.component]).updateGpu(this.gls,[di.component,Bn.component],At([di.writer,Bn.writer,Jo.Ability.sm,Jo.State.sm,ri.sm,Vs.MoveX.sm,Vs.Rotate.sm,Vs.ChaseFocus.sm,ir.sm,Ds.sm,Sa.sm,vi.sm,xe,Bn.sm,Dn.sm,we,hi.sm,fi.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n\n        int castingState = ".concat(Jo.State.sm.value,"(entityCell);\n        int castingAbility = ").concat(Jo.Ability.sm.value,"(entityCell);\n        ivec2 focus = ").concat(ri.sm.value,"(entityCell);\n\n        vec3 selfPosition = ").concat(Dn.sm.value,"(entityCell);\n        float selfRotation = ").concat(Bn.sm.value,"(entityCell);\n        vec2 selfForward = ").concat(we.forward,"(selfRotation);\n        vec3 focusPosition = ").concat(Dn.sm.value,"(focus);\n\n        float chaseFocus = focus.x >= 0 ? ").concat(Vs.ChaseFocus.sm.value,"(entityCell) : 0.0;\n\n        bool dazed = ").concat(ir.sm.value,"(entityCell) > 0;\n        bool crippled = ").concat(Ds.sm.value,"(entityCell) > 0;\n        bool canWalk = ").concat(Sa.sm.value,"(entityCell) > 0.0 &&\n          !dazed &&\n          ").concat(vi.sm.value,"(entityCell);\n\n        float walkingSpeed = 0.0;\n        float newRotation = 0.0;\n        if (canWalk) {\n          float maximumMovementSpeed = ").concat(hi.sm.value,"(entityCell);\n          float move = mix(\n            ").concat(Vs.MoveX.sm.value,"(entityCell),\n            1.0,\n            chaseFocus\n            // Scale with max move speed so that 1 from the brain is max\n          ) * maximumMovementSpeed;\n\n          float movementSpeed = maximumMovementSpeed *\n            (castingAbility == ").concat(Yo.Shell," ? 0.2 : 1.) *\n            (crippled ? 0.1 : 1.) *\n            ((castingState == ").concat(ia.Casting," || castingState == ").concat(ia.Performing,") ? 0. : 1.);\n\n          // It's important that we clamp like this so that the decision to move is absolute, since\n          // the pixlings doesn't know it's own speed limitations (i.e. \"I want to move forward 5km/h\"\n          // rather than \"I want to move forward at 50% speed, whatever that means since I don't know my max speed\")\n          walkingSpeed = clamp(\n            move,\n            -movementSpeed,\n            movementSpeed\n          );\n\n          float maximumRotationSpeed = ").concat(fi.sm.value,"(entityCell);\n          float speed = maximumRotationSpeed *\n            (crippled ? 0.2 : 1.) *\n            ((castingState == ").concat(ia.Casting," || castingState == ").concat(ia.Performing,") ? 0.0 : 1.0);\n          float chaseAngle = ").concat(we.angleToPosition,"(selfPosition.xy, selfForward, focusPosition.xy);\n\n          // Scale by maximum speed, so that 1 brain output is max\n          float manualRotate = ").concat(Vs.Rotate.sm.value,"(entityCell) * maximumRotationSpeed;\n          // Same here with the clamping as in movement speed\n          manualRotate = selfRotation + clamp(manualRotate, -speed, speed);\n\n          float chaseRotate = selfRotation + clamp(chaseAngle, -speed, speed);\n\n          newRotation = ").concat(xe.angleLerp,"(manualRotate, chaseRotate, chaseFocus);\n        }\n\n        ").concat(di.writer.write,"(walkingSpeed);\n        ").concat(Bn.writer.write,"(newRotation);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.update.run(t)}}]),t}(),$s=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([mi.component,pi.component,Dn.gpuComponent,vi.component,Ba.component]).updateGpu(this.gls,[mi.component,pi.component,Dn.gpuComponent,vi.component,Sa.component,Ja.component,gi.component,ni.component],At([mi.writer,mi.sm,vi.sm,vi.writer,pi.sm,pi.writer,Dn.sm,Dn.writer,Ts,Rs,Sa.sm,Sa.writer,Xe,jn.sm,Sa.sm,Bn.sm,we,di.sm,Ja.sm,Ja.writer,gi.writer,Sn.sm,ni.writer,bi.fallDamageTaken.sm],{timestep:pt("float",(function(t){return t.data.physicsTimestep})),unitsInArena:pt("isampler2D",(function(t){return t.unitsInArenaGpu.get(t)})),clampPositions:pt("bool",(function(t){return"gym"===t.data.gameInstance.type})),mapCenter:pt("vec2",(function(t){return{x:t.data.worldSize.width/2,y:t.data.worldSize.width/2}})),update:Ct("void",[["ivec2","entityCell"]],"\n          // https://gamedev.stackexchange.com/questions/15708/how-can-i-implement-gravity/41917#41917\n          vec3 position = ".concat(Dn.sm.value,"(entityCell);\n          vec3 velocity = ").concat(mi.sm.value,"(entityCell);\n          vec3 force = ").concat(pi.sm.value,"(entityCell);\n          bool isOnGround = ").concat(vi.sm.value,"(entityCell);\n          float hitpoints = ").concat(Sa.sm.value,"(entityCell);\n          float walking = ").concat(di.sm.value,"(entityCell);\n          bool selfAlive = hitpoints > 0.;\n          float gold = ").concat(Ja.sm.value,"(entityCell);\n          vec3 prevPosition = position;\n          if (length(force) > 0.01 || velocity.z > 0.1) {\n            isOnGround = false;\n          }\n          if (isOnGround) {\n            float rotation = ").concat(Bn.sm.value,"(entityCell);\n            vec2 forward = ").concat(we.forward,"(rotation);\n            velocity = vec3(forward, 0) * walking;\n            vec3 delta = Self.timestep * velocity;\n            position += delta;\n            float height = ").concat(Ts.atPosition,"(position.xy);\n            float elevation = position.z - height;\n            vec3 normal = ").concat(Rs.atPosition,"(position.xy);\n            if (elevation > 0.1) {\n              isOnGround = false;\n            } else if (normal.z < 0.7 && height > prevPosition.z) { // sin(pi/4) = 0.7 -> 45deg incline\n              // Prevent hillclimbing\n              position = prevPosition;\n              position.z = ").concat(Ts.atPosition,"(position.xy);\n            } else {\n              position.z = height;\n            }\n          } else {\n            const float G = 9.82 * 6.0;\n            const float mass = 1.0;\n            vec3 acceleration = force / mass;\n            acceleration += vec3(0, 0, -G);\n            velocity += Self.timestep * acceleration;\n            position += Self.timestep * velocity;\n            float height = ").concat(Ts.atPosition,"(position.xy);\n            if (position.z <= height) {\n              if (velocity.z < -40.) {\n                // Fall damage\n                if (selfAlive) {\n                  hitpoints -= 10000.;\n                  int arenaMemberIndex = ").concat(Sn.sm.value,"(entityCell);\n                  gold += ").concat(bi.fallDamageTaken.sm.value,"(entityCell);\n                  ").concat(ni.writer.write,'(true);\n                }\n              }\n              if (prevPosition.z < height && velocity.z < -10.) {\n                // We hit a "wall", so start falling straight down instead\n                // to avoid characters "leaping up from the abyss"\n                position = prevPosition;\n                velocity.xy = vec2(0);\n              } else {\n                position.z = height;\n                // We\'re on the ground, but might be sliding\n                velocity -= normalize(velocity) * length(velocity) * 0.1; // Friction\n                if (length(velocity.xy) < 1.) {\n                  velocity = vec3(0);\n                  isOnGround = true;\n                } else {\n                  velocity.z = -0.1;\n                }\n              }\n            }\n          }\n          // Unit-unit collisions\n          if (selfAlive) {\n            int arenaIndex = ').concat(jn.sm.value,"(entityCell);\n            int unitsCount = ").concat(2*la,";\n            vec3 unitCenter = vec3(0, 0, 1);\n            vec3 selfCenter = position + unitCenter;\n            const float unitRadius = 0.5;\n            for (int i=0; i < unitsCount; i++) {\n              ivec2 other = ").concat(Xe.entityCell,"(Self.unitsInArena, arenaIndex, i);\n              if (other == entityCell || other.x < 0) {\n                continue;\n              }\n              bool otherAlive = ").concat(Sa.sm.value,"(other) > 0.;\n              if (!otherAlive) {\n                continue;\n              }\n              vec3 otherCenter = ").concat(Dn.sm.value,"(other) + unitCenter;\n              vec3 delta = selfCenter - otherCenter;\n              if (length(delta) < unitRadius * 2.) {\n                selfCenter = otherCenter + normalize(delta) * unitRadius * 2.;\n              }\n            }\n            position = selfCenter - unitCenter;\n          }\n          if (clampPositions) {\n            vec2 size = vec2(20);\n            position.xy = clamp(position.xy, mapCenter - size, mapCenter + size);\n          }\n          ").concat(mi.writer.write,"(velocity);\n          ").concat(Dn.writer.write,"(position);\n          ").concat(vi.writer.write,"(isOnGround);\n          ").concat(pi.writer.write,"(vec3(0));\n          ").concat(Sa.writer.write,"(hitpoints);\n          ").concat(Ja.writer.write,"(gold);\n          ").concat(gi.writer.write,"(distance(prevPosition, position) < walking * Self.timestep * 0.5 && isOnGround && walking > 0.01);\n        "))})),this.fallDamageKillBounty=new Re([ei.component]).updateGpu(this.gls,[Ja.component],At([ei.sm,Ja.writer,ni.sm,bi.killEnemyUnit.sm],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n          if (".concat(ni.sm.value,"(entityCell)) {\n            ivec2 lastPushedBy = ").concat(ei.sm.value,"(entityCell);\n            if (lastPushedBy.x >= 0) {\n              float bounty = ").concat(bi.killEnemyUnit.sm.value,"(lastPushedBy);\n              ").concat(Ja.writer.write,"(bounty);\n              return lastPushedBy;\n            }\n          }\n          return ivec2(-1);\n        "))}),"sum"),this.resetLastPushedBy=new Re([ei.component]).mapGpu(this.gls,ei.component,At([vi.sm],{map:Ct("ivec2",[["ivec2","entityCell"],["ivec2","value"]],"\n          if (".concat(vi.sm.value,"(entityCell)) {\n            return ivec2(-1);\n          } else {\n            return value;\n          }\n        "))}))}return Object(p.a)(t,[{key:"run",value:function(t){var e;null===(e=t.ecs.gpuComponentInfo(ni.component))||void 0===e||e.slice.clear(),this.update.run(t),this.fallDamageKillBounty.run(t),this.resetLastPushedBy.run(t)}}]),t}(),tc=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Me([si,En]).filterValue(En,(function(t){return!!t}),xi).toGpu(this.gls).mapToTemp(At([Sa.sm,Jo.Ability.sm,Jo.StateStartStep.sm,Jo.State.sm,Jo.Target.sm,di.sm,ir.sm,Dn.sm,$a.sm,_a.sm,Ji.sm,xr()],{time:pt("int",(function(t){return t.data.stepCounter})),map:Ct("vec4[4]",[["ivec2","entityCell"]],"\n        ivec2 castingTarget = ".concat(Jo.Target.sm.value,"(entityCell);\n        return vec4[](\n          vec4(\n            ").concat(Dn.sm.value,"(entityCell),\n            ").concat(di.sm.value,"(entityCell)\n          ),\n          vec4(\n            time - ").concat(Jo.StateStartStep.sm.value,"(entityCell),\n            ").concat(Jo.Ability.sm.value,"(entityCell),\n            ").concat(Jo.State.sm.value,"(entityCell),\n            ").concat(Ji.sm.value,"(entityCell) > 0\n          ),\n          vec4(\n            ").concat(Sa.sm.value,"(entityCell),\n            time - ").concat($a.sm.value,"(entityCell),\n            ").concat(_a.sm.value,"(entityCell),\n            ").concat(ir.sm.value,"(entityCell) > 0\n          ),\n          vec4(\n            ").concat(xr().armor,"(entityCell),\n            castingTarget.x,\n            castingTarget.y,\n            0\n          )\n        );\n      "))})).toCpuQueuing((function(t){return t.data.round}))}return Object(p.a)(t,[{key:"run",value:function(t){null===Kr||void 0===Kr||Kr.updateCamera(t.derived.cameraView);var e,n=new _n(t.data.stepCounter).timeInSecondsFractional,a=this.query.queueRead(t),i=Object(m.a)(a());try{for(i.s();!(e=i.n()).done;){var r,o=e.value,s=Object(m.a)(o);try{for(s.s();!(r=s.n()).done;){var c=r.value,u=c.entityCell,l=c.value,h=l[0],f=l[0].w,d=l[1].x,p=l[1].y,v=l[1].z,g=l[1].w,b=l[2].x,w=l[2].y,C=l[2].z,x=l[2].w,A=l[3].x,O={x:l[3].y,y:l[3].z},j=Math.max(0,C-b),S=t.ecs.getComponentData(ci,u),k=t.ecs.getComponentData(si,u),I=t.ecs.getComponentData(Vi,u),E=t.ecs.getComponentData(ui,u);j>5&&(A>1?null===Kr||void 0===Kr||Kr.playSoundEffect(oa.StoneHit,0,h):"wood"===S.value?null===Kr||void 0===Kr||Kr.playSoundEffect(oa.WoodHit,0,h):"statue"===S.value?null===Kr||void 0===Kr||Kr.playSoundEffect(oa.StoneHit,0,h):null===Kr||void 0===Kr||Kr.playSoundEffect(oa.FleshHit,0,h));var T=[],R=b<=0;if(!E.playing.Dazed||!R&&x||(E.playing.Dazed.fadeOut(),delete E.playing.Dazed),!E.playing.HeliumBubble||!R&&g||(E.playing.HeliumBubble.fadeOut(),delete E.playing.HeliumBubble),E.playing.Ability&&E.playing.Ability.looping&&v===ia.WindDown&&(E.playing.Ability.fadeOut(),delete E.playing.Ability),R)!function(){var t=ra[ra.Death1],e=I.actions.find((function(e){return e.clip===t}));T.push({positionType:"startTime",positionValue:e?e.positionValue:n-w,clip:t,looping:!1}),0===w&&("wood"===S.value?null===Kr||void 0===Kr||Kr.playSoundEffect(oa.PlanksFalling,0,h):"statue"===S.value?null===Kr||void 0===Kr||Kr.playSoundEffect(oa.Explosion,0,h):null===Kr||void 0===Kr||Kr.playSoundEffect(oa.Wimper,0,h))}();else{var D,P;x&&function(){var t=ra[ra.Dazed1],e=I.actions.find((function(e){return e.clip===t}));T.push({positionType:"startTime",positionValue:e?e.positionValue:n,clip:t,looping:!0}),!E.playing.Dazed&&Kr&&(E.playing.Dazed=Kr.playSoundEffect(oa.Snore,0,h))}(),g&&!E.playing.HeliumBubble&&Kr&&(E.playing.HeliumBubble=Kr.playSoundEffect(oa.BubbleWobble,0,h));var F,B;if(function(){var t,e=ra[ra.Run1],n=I.actions.find((function(t){return t.clip===e})),a=null!==(t=null===n||void 0===n?void 0:n.positionValue)&&void 0!==t?t:0,i=a+f*Jn/k.stepLength;T.push({clip:e,looping:!0,positionType:"percentage",positionValue:i,weight:Object(y.e)(Math.abs(f),0,.1,0,1)});var r=Object(y.g)(Math.floor(48*a),48),o=Object(y.g)(Math.floor(48*i),48);(r<43&&o>=43||r<18&&o>=18)&&(null===Kr||void 0===Kr||Kr.playSoundEffect(oa.Footstep,0,h))}(),function(){var t,e=ra[ra.Idle1],n=I.actions.find((function(t){return t.clip===e}));T.push({clip:e,looping:!0,positionType:"time",positionValue:(null!==(t=null===n||void 0===n?void 0:n.positionValue)&&void 0!==t?t:0)+Jn,weight:Object(y.e)(Math.abs(f),0,.1,1,0)*(v===ia.Casting||v===ia.Performing?0:1)})}(),v!==ia.Inactive)null===(F=(B=Do.castAnimation)[p])||void 0===F||F.call(B,I.actions,T,v,d,p,n);var M=null===(D=(P=Do.castSound)[p])||void 0===D?void 0:D.call(P,t,v,d,p,O,n,h);M&&(E.playing.Ability=M)}t.ecs.setComponentData(Vi,u,{actions:T})}}catch(Nt){s.e(Nt)}finally{s.f()}}}catch(Nt){i.e(Nt)}finally{i.f()}}}]),t}(),ec=n(1),nc=n.n(ec),ac=new Cn("CopyMutateParent",Oa.buffer,"ivec2"),ic=new Cn("MutationRate",Oa.buffer,"float"),rc=function(){function t(e){var n=this;Object(l.a)(this,t),this.gls=e,this.matrices=[].concat(oc,sc).map((function(t){return new cc(n.gls,t)}))}return Object(p.a)(t,[{key:"run",value:function(t){var e,n=Object(m.a)(this.matrices);try{for(n.s();!(e=n.n()).done;){e.value.run(t)}}catch(Nt){n.e(Nt)}finally{n.f()}}}]),t}(),oc=[ds.weights.component,fs.weights.component,ms.weights.component],sc=[ds.biases.component,fs.biases.component,ms.biases.component],cc=function(){function t(e,n){Object(l.a)(this,t),this.gls=e,this.weightsComponent=n,this.weightsSM=Oe(this.weightsComponent),this.shader=new jt(At([this.weightsSM,le,fe,ac.sm,ic.sm],{outValues:yt("vec4[8]"),outArchetype:pt("int"),randomSeeds:vt("vec2[]",8),weightsOffset:pt("int"),renormalization:pt("float",(function(t){return t.data.trainingConfig.weightsRenormalizationRate})),main:Ct("void",[],"\n      ivec2 outDataCell = ivec2(gl_FragCoord);\n      ivec2 outEntityCell = ivec2(\n        outDataCell.y * ".concat(_e.ChunkSize," + outDataCell.x,\n        outArchetype\n      );\n\n      float mutationRate = ").concat(ic.sm.value,"(outEntityCell);\n      ivec2 readCell = ").concat(ac.sm.value,"(outEntityCell);\n      if (readCell.x < 0) {\n        readCell = outEntityCell;\n      }\n\n      vec4 values[8];\n      for (int i=0; i < 8; i++) {\n        vec4 weight = vec4(").concat(this.weightsSM.value,"(readCell, weightsOffset + i));\n\n        if (mutationRate > 0.) {\n          vec2 s = vec2(outEntityCell) / 1024.0 + randomSeeds[i];\n          vec4 r = vec4(\n            ").concat(fe.sample,"(s + 0.0, s + 0.1),\n            ").concat(fe.sample,"(s + 0.2, s + 0.3),\n            ").concat(fe.sample,"(s + 0.4, s + 0.5),\n            ").concat(fe.sample,"(s + 0.6, s + 0.7)\n          );\n\n          weight += r * mutationRate;\n          weight *= (1. - mutationRate * renormalization);\n        }\n        values[i] = weight;\n      }\n      outValues = values;\n    "))})),this.renderTarget=new at(this.gls),this.program=new Xt(this.gls,this.shader.source),this.copy=this.gls.getCopyTexture()}return Object(p.a)(t,[{key:"run",value:function(t){this.shader.updateUniformValues(t);var e,n=Object(m.a)(new Re([this.weightsComponent]).gpuComponentBlocks(this.weightsComponent).get(t));try{for(n.s();!(e=n.n()).done;){var a,i=e.value,r=Object(m.a)(j(i.slices.layers.length,8));try{for(r.s();!(a=r.n()).done;){var o=a.value,s=o.l,c=o.count;this.program.prepare(),this.shader.writeUniforms(this.program);var u=this.gls.getTmpTextureSlice(i.slices.texture.internalFormat,i.slices.rect,c);this.renderTarget.set(u),this.gls.prepareForComputation(u.rect),this.program.setUniform("randomSeeds","vec2[]",new Array(8).fill(0).map((function(){return{x:Math.random(),y:Math.random()}}))),this.program.setUniform("weightsOffset","int",s),this.program.setUniform("outArchetype","int",i.archetype.index),this.gls.drawQuad(this.program),this.copy.copy(i.slices.sliceRange(s,c),u)}}catch(Nt){r.e(Nt)}finally{r.f()}}}catch(Nt){n.e(Nt)}finally{n.f()}}}]),t}(),uc=function t(){Object(l.a)(this,t),this.winPercs=[],this.tiePercs=[],this.lossPercs=[],this.homeDistanceClosestEnemy=[],this.win5Percs=[],this.tie5Percs=[],this.losses5Percs=[],this.homeGold=[],this.awayGold=[]},lc=function t(){Object(l.a)(this,t),this.points=[],this.gold=[]},hc=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.creatures=new Me([za.component]).toGpu(this.gls).mapToTemp(At([Ja.sm],{map:Ct("vec4",[["ivec2","entityCell"]],"\n        return vec4(".concat(Ja.sm.value,"(entityCell));\n      "))})).toCpuSync(),this.arenaStats=new Me([In.gpuComponent]).toGpu(this.gls).mapToTemp(At([yr,pe,In.sm],{map:Ct("vec4[2]",[["ivec2","entityCell"]],"\n        int arenaIndex = ".concat(In.sm.value,"(entityCell);\n        ").concat(yr.Stats," stats = ").concat(yr.stats,"(arenaIndex);\n        return vec4[](\n          vec4(arenaIndex, stats.homePoints, stats.awayPoints, 0),\n          vec4(stats.home.gold, stats.away.gold, 0, 0)\n        );\n      "))})).toCpuSync(),this.copyAndMutate=new rc(this.gls)}return Object(p.a)(t,[{key:"runSelection",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a,i,r,o,c,u,l,h,f;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(null===(n=e.ecs.gpuComponentInfo(ac.component))||void 0===n||n.slice.clear([-1,-1,-1,-1]),null===(a=e.ecs.gpuComponentInfo(ic.component))||void 0===a||a.slice.clear(),i=this.creatures.get(e),r=new Array(ha).fill(0).map((function(){return{units:[]}})),o=0;o<i.length;o++)c=i[o].entityCell,u=e.ecs.getComponentData(jn.cpuComponent,c)[0],l=e.ecs.getComponentData(Sn.cpuComponent,c)[0],r[l].units[u]={entityCell:c,gold:i[o].value[0].x,fitness:0};h=function(t){var n=r[t].units,a=t<la&&e.data.teams.home.train||t>=la&&e.data.teams.away.train;if(0===n.length||!a)return"continue";for(var i=n.slice().sort((function(t,e){return e.gold-t.gold})),o=0;o<e.layout.arenas;o++)i[o].fitness=32-31*Math.pow(o/e.layout.arenas,1/4);for(var s=i.reduce((function(t,e){return t+e.fitness}),0),c=function(t){if(t<e.data.trainingConfig.elitismCount)return i[t].entityCell;for(var n=Math.random(),a=0,r=0;r<i.length;r++)if(n<=(a+=i[r].fitness/s))return i[r].entityCell;throw new Error("Unreachable")},u=0;u<e.layout.arenas;u++){var l=n[u].entityCell,h=c(u);e.ecs.setComponentData(ac.component,l,[h.x,h.y]),u>=e.data.trainingConfig.elitismCount&&e.ecs.setComponentData(ic.component,l,[Math.random()>.8?.1:.01])}},f=0;case 7:if(!(f<ha)){t.next=14;break}if("continue"!==h(f)){t.next=11;break}return t.abrupt("continue",11);case 11:f++,t.next=7;break;case 14:return this.copyAndMutate.run(e),t.next=17,this.updateArenaStats(e);case 17:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"updateArenaStats",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a,i,o,u,l,h,f,d,m;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((n=this.arenaStats.get(e).map((function(t){return{arenaIndex:t.value[0].x,homePoints:t.value[0].y,awayPoints:t.value[0].z,homeGold:t.value[1].x,awayGold:t.value[1].y}}))).sort((function(t,e){return t.arenaIndex-e.arenaIndex})),a=n.slice(0,e.data.trainingConfig.elitismCount),i=Object(r.a)({},e.data.trainingStats),o=Object(r.a)({},e.data.teams.home.trainingStats),u=Object(r.a)({},e.data.teams.away.trainingStats),i.winPercs=[].concat(Object(mt.a)(i.winPercs),[a.reduce((function(t,e){return t+(e.homePoints>e.awayPoints?1:0)}),0)/a.length]),i.lossPercs=[].concat(Object(mt.a)(i.lossPercs),[a.reduce((function(t,e){return t+(e.homePoints<e.awayPoints?1:0)}),0)/a.length]),i.tiePercs=[].concat(Object(mt.a)(i.tiePercs),[a.reduce((function(t,e){return t+(e.homePoints===e.awayPoints?1:0)}),0)/a.length]),l=i.winPercs.slice(-5).reduce((function(t,e){return t+e}),0),h=i.tiePercs.slice(-5).reduce((function(t,e){return t+e}),0),f=i.lossPercs.slice(-5).reduce((function(t,e){return t+e}),0),d=l+h+f,i.win5Percs=[].concat(Object(mt.a)(i.win5Percs),[l/d]),i.tie5Percs=[].concat(Object(mt.a)(i.tie5Percs),[h/d]),i.losses5Percs=[].concat(Object(mt.a)(i.losses5Percs),[f/d]),o.points=[].concat(Object(mt.a)(o.points),[a.reduce((function(t,e){return t+e.homePoints}),0)/a.length]),u.points=[].concat(Object(mt.a)(u.points),[a.reduce((function(t,e){return t+e.awayPoints}),0)/a.length]),o.gold=[].concat(Object(mt.a)(o.gold),[a.reduce((function(t,e){return t+e.homeGold}),0)/a.length]),u.gold=[].concat(Object(mt.a)(u.gold),[a.reduce((function(t,e){return t+e.awayGold}),0)/a.length]),e.setData({trainingStats:i}),e.updateTeam("home",{trainingStats:o}),e.updateTeam("away",{trainingStats:u}),m=function(){var t=Object(c.a)(s.a.mark((function t(a){var i,o,c;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return(i=n.slice(0,e.data.trainingConfig.elitismCount).map((function(t){return Object(r.a)(Object(r.a)({},t),{},{points:a===ta.HomeTeam?t.homeGold-t.awayGold:t.awayGold-t.homeGold})}))).sort((function(t,e){return e.points-t.points})),o=i[0].arenaIndex,c=new Me([za.component]).filterValue(jn.cpuComponent,(function(t){return t[0]===o}),(function(t){return[]})).filterValue(Ta,(function(t){return t===a}),(function(t){return[]})).get(e),t.next=6,Promise.all(c.map((function(t){return dc(e,t)})));case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),t.t0=e,t.t1=[],t.t2=mt.a,!e.data.teams.home.train){t.next=33;break}return t.next=30,m(ta.HomeTeam);case 30:t.t3=t.sent,t.next=34;break;case 33:t.t3=[];case 34:if(t.t4=t.t3,t.t5=(0,t.t2)(t.t4),t.t6=mt.a,!e.data.teams.away.train){t.next=43;break}return t.next=40,m(ta.AwayTeam);case 40:t.t7=t.sent,t.next=44;break;case 43:t.t7=[];case 44:t.t8=t.t7,t.t9=(0,t.t6)(t.t8),t.t10=t.t1.concat.call(t.t1,t.t5,t.t9),t.t11={toSaveCreatureBrains:t.t10},t.t0.setData.call(t.t0,t.t11);case 49:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()}]),t}();function fc(t){var e=new Float32Array(t);return nc.a.firestore.Blob.fromUint8Array(new Uint8Array(e.buffer))}function dc(t,e){return mc.apply(this,arguments)}function mc(){return(mc=Object(c.a)(s.a.mark((function t(e,n){var a,i,r,o,c,u,l,h,f,d,m,p,v;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(u=e.ecs.getComponentData(ds.weights.component,n,!0),l=e.ecs.getComponentData(ds.biases.component,n,!0),h=e.ecs.getComponentData(fs.weights.component,n,!0),f=e.ecs.getComponentData(fs.biases.component,n,!0),d=e.ecs.getComponentData(ms.weights.component,n,!0),m=e.ecs.getComponentData(ms.biases.component,n,!0),"creature"===(p=e.ecs.getComponentData(Fa,n)).unit.type){t.next=9;break}throw new Error("Not a creature");case 9:return t.t0=null!==(a=p.unit.id)&&void 0!==a?a:"",t.t1=null!==(i=null===(r=e.appState)||void 0===r?void 0:r.state.loggedInUserId)&&void 0!==i?i:"",t.t2=(null!==(o=p.unit.generation)&&void 0!==o?o:0)+e.data.round+1,t.t3=fc,t.t4=g.a,t.next=16,u;case 16:return t.t5=t.sent,t.t6=function(t){return[t.x,t.y,t.z,t.w]},t.t7=t.t4.flatMap.call(t.t4,t.t5,t.t6),t.t8=(0,t.t3)(t.t7),t.t9=fc,t.next=23,l;case 23:return t.t10=t.sent,t.t11=(0,t.t9)(t.t10),t.t12=fc,t.t13=g.a,t.next=29,h;case 29:return t.t14=t.sent,t.t15=function(t){return[t.x,t.y,t.z,t.w]},t.t16=t.t13.flatMap.call(t.t13,t.t14,t.t15),t.t17=(0,t.t12)(t.t16),t.t18=fc,t.next=36,f;case 36:return t.t19=t.sent,t.t20=(0,t.t18)(t.t19),t.t21=fc,t.t22=g.a,t.next=42,d;case 42:return t.t23=t.sent,t.t24=function(t){return[t.x,t.y,t.z,t.w]},t.t25=t.t22.flatMap.call(t.t22,t.t23,t.t24),t.t26=(0,t.t21)(t.t25),t.t27=fc,t.next=49,m;case 49:return t.t28=t.sent,t.t29=(0,t.t27)(t.t28),v={creatureId:t.t0,name:"",ownerId:t.t1,generation:t.t2,hiddenLayerWeights:t.t8,hiddenLayerBiases:t.t11,memoryLayerWeights:t.t17,memoryLayerBiases:t.t20,outputLayerWeights:t.t26,outputLayerBiases:t.t29},t.abrupt("return",{brain:v,id:null!==(c=p.unit.id)&&void 0!==c?c:""});case 53:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var pc=function t(){Object(l.a)(this,t),this.wins=[],this.losses=[],this.ties=[],this.homeAlive=[],this.awayAlive=[]},vc=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.arenaStats=new Me([In.gpuComponent]).toGpu(this.gls).mapToTemp(At([yr,In.sm],{homeCount:pt("int",(function(t){return t.data.teams.home.unitCount})),awayCount:pt("int",(function(t){return t.data.teams.away.unitCount})),map:Ct("vec4[2]",[["ivec2","entityCell"]],"\n        int arenaIndex = ".concat(In.sm.value,"(entityCell);\n        ").concat(yr.Stats," stats = ").concat(yr.stats,"(arenaIndex);\n        return vec4[](\n          vec4(\n            float(stats.winner == ").concat(mr.Home,"),\n            float(stats.winner == ").concat(mr.Away,"),\n            float(stats.winner == ").concat(mr.Tie,"),\n            0\n          ),\n          vec4(\n            stats.home.alive,\n            stats.away.alive,\n            0,\n            0\n          )\n        );\n      "))})).reduceSum()}return Object(p.a)(t,[{key:"run",value:function(t){var e=this.arenaStats.get(t);t.setData({roundStats:{wins:[].concat(Object(mt.a)(t.data.roundStats.wins),[e.data[0]]),losses:[].concat(Object(mt.a)(t.data.roundStats.losses),[e.data[1]]),ties:[].concat(Object(mt.a)(t.data.roundStats.ties),[e.data[2]]),homeAlive:[].concat(Object(mt.a)(t.data.roundStats.homeAlive),[e.data[4]/t.layout.arenas]),awayAlive:[].concat(Object(mt.a)(t.data.roundStats.awayAlive),[e.data[5]/t.layout.arenas])}})}}]),t}(),gc={metatype:"struct",properties:{x:{metatype:"float"},y:{metatype:"float"}}};function yc(){return 1===arguments.length?"number"===typeof(arguments.length<=0?void 0:arguments[0])?{x:arguments.length<=0?void 0:arguments[0],y:arguments.length<=0?void 0:arguments[0]}:Object(r.a)({},arguments.length<=0?void 0:arguments[0]):{x:arguments.length<=0?void 0:arguments[0],y:arguments.length<=1?void 0:arguments[1]}}function bc(){return{x:0,y:0}}function wc(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return Cc(t,t,e,e)}function Cc(t,e,n,a){return{x:t+Math.random()*(n-t),y:e+Math.random()*(a-e)}}function xc(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return Ac(t,e,e,n,n)}function Ac(t,e,n,a,i){return{x:e+t.random()*(a-e),y:n+t.random()*(i-n)}}function Oc(t,e){return{x:Math.cos(t)*e,y:Math.sin(t)*e}}function jc(t){return t.x*t.x+t.y*t.y}function Sc(t){return Math.sqrt(jc(t))}function kc(t,e){return Sc(zc(t,e))}function Ic(t,e){return t.x*e.y-t.y*e.x}function Ec(t,e){return t.x*e.x+t.y*e.y}function Tc(t){var e=Sc(t);return{x:t.x/e,y:t.y/e}}function Rc(t){return{x:Math.round(t.x),y:Math.round(t.y)}}function Dc(t){return{x:Math.floor(t.x),y:Math.floor(t.y)}}function Pc(t){return{x:Math.ceil(t.x),y:Math.ceil(t.y)}}function Fc(t){return{x:y.b(t.x),y:y.b(t.y)}}function Bc(){for(var t=yc(arguments.length<=0?void 0:arguments[0]),e=1;e<arguments.length;e++){var n=e<0||arguments.length<=e?void 0:arguments[e];"number"===typeof n?(t.x+=n,t.y+=n):(t.x+=n.x,t.y+=n.y)}return t}function Mc(t){return{x:-t.x,y:-t.y}}function zc(t,e){return Bc(t,"number"===typeof e?-e:Mc(e))}function Nc(t,e){return"number"===typeof e?{x:t.x*e,y:t.y*e}:{x:t.x*e.x,y:t.y*e.y}}function Gc(t,e){return"number"===typeof e?Nc(t,1/e):{x:t.x/e.x,y:t.y/e.y}}function Hc(t){return Math.atan2(t.y,t.x)}function Lc(t,e){return{x:y.g(t.x,e.x),y:y.g(t.y,e.y)}}function Uc(t,e,n){return"number"===typeof e&&(e=yc(e)),"number"===typeof n&&(n=yc(n)),{x:y.a(t.x,e.x,n.x),y:y.a(t.y,e.y,n.y)}}function Vc(t,e,n){return"number"===typeof n?{x:y.f(t.x,e.x,n),y:y.f(t.y,e.y,n)}:{x:y.f(t.x,e.x,n.x),y:y.f(t.y,e.y,n.y)}}var Qc=Vc;function qc(t){return{x:t.y,y:-t.x}}function Wc(t,e){return t.x===e.x&&t.y===e.y}function Yc(t,e,n,a,i){return Vc(a,i,"number"===typeof t?(t-e)/(n-e):Gc(zc(t,e),zc(n,e)))}function Xc(t,e,n,a,i){return Vc(a,i,"number"===typeof t?y.a((t-e)/(n-e),0,1):Uc(Gc(zc(t,e),zc(n,e)),0,1))}function Kc(t){return w.d.fromValues(t.x,t.y)}function Jc(t){return{x:t[0],y:t[1]}}function Zc(t,e){var n=Math.sin(e),a=Math.cos(e),i=w.a.fromValues(a,n,-n,a);return Jc(w.d.transformMat2(w.d.create(),Kc(t),i))}function _c(t){var e=t.x,n=t.y;return{x:(e+n)/Math.sqrt(2),y:(n-e)/Math.sqrt(2)}}var $c=function t(){Object(l.a)(this,t),this.winner=mr.Undecided,this.homeUnits=[],this.awayUnits=[],this.homeGold=0,this.awayGold=0},tu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.units=new Me([Ma.component]).filterValue(jn.cpuComponent,(function(t){return t[0]<128}),(function(t){return[]})),this.unitDatas=this.units.toGpu(this.gls).mapToTemp(At([Dn.sm,Sa.sm,Ja.sm],{map:Ct("vec4",[["ivec2","entityCell"]],"\n        return vec4(".concat(Dn.sm.value,"(entityCell).xy, ").concat(Sa.sm.value,"(entityCell), ").concat(Ja.sm.value,"(entityCell));\n      "))})).toCpuQueuing((function(t){return t.data.round}))}return Object(p.a)(t,[{key:"updateArenaInfos",value:function(t){for(var e=Object(mt.a)(t.data.arenaInfos),n=0;n<e.length;n++)e[n]=Object(r.a)(Object(r.a)({},e[n]),{},{homeUnits:[],awayUnits:[]});for(var a=this.units.get(t),i=this.unitDatas.queueRead(t),o=g.a.last(i()),s=0;s<a.length;s++){var c=a[s],u=t.ecs.getComponentData(jn.cpuComponent,c)[0],l=t.ecs.getComponentData(Sn.cpuComponent,c)[0],h=t.ecs.getComponentData(Ta,c),f=t.ecs.getComponentData(Fa,c),d=o?o[s]:void 0,m={position:d?C(d.value[0]):yc(0),hitpoints:d?d.value[0].z:ja,unit:f.unit,gold:d?d.value[0].w:0};h===ta.HomeTeam?e[u].homeUnits[l]=m:e[u].awayUnits[l-la]=m}for(var p=0;p<e.length;p++)e[p]=Object(r.a)(Object(r.a)({},e[p]),{},{homeGold:e[p].homeUnits.reduce((function(t,e){return t+e.gold}),0),awayGold:e[p].awayUnits.reduce((function(t,e){return t+e.gold}),0)});t.setData({arenaInfos:e})}},{key:"run",value:function(t){t.data.stepCounter%Kn!==0||t.data.turboMode||this.updateArenaInfos(t)}}]),t}();function eu(t){return new Re([yi.AliveTime.component,yi.CumulativeHitpoints.component,Sa.component]).updateGpu(t,[yi.AliveTime.component,yi.CumulativeHitpoints.component,yi.MinDistEnemyStatue.component],At([Sa.sm,yi.AliveTime.sm,yi.CumulativeHitpoints.sm,yi.MinDistEnemyStatue.sm,yi.AliveTime.writer,yi.CumulativeHitpoints.writer,yi.MinDistEnemyStatue.writer,Ea.sm,vr,Dn.sm,jn.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n        float aliveTime = ".concat(yi.AliveTime.sm.value,"(entityCell);\n        float cumulativeHitpoints = ").concat(yi.CumulativeHitpoints.sm.value,"(entityCell);\n        float minDistEnemyStatue = ").concat(yi.MinDistEnemyStatue.sm.value,"(entityCell);\n        float hitpoints = ").concat(Sa.sm.value,"(entityCell);\n        if (hitpoints > 0.0) {\n          aliveTime += 1.0;\n\n          int arenaIndex = ").concat(jn.sm.value,"(entityCell);\n          int team = ").concat(Ea.sm.value,"(entityCell);\n          int enemyStatueIndex = team == ").concat(ta.HomeTeam," ? ").concat(la," : ",0,";\n          ivec2 enemyStatue = ").concat(vr.unit,"(arenaIndex, enemyStatueIndex);\n          vec3 position = ").concat(Dn.sm.value,"(entityCell);\n          vec3 statuePosition = ").concat(Dn.sm.value,"(enemyStatue);\n          minDistEnemyStatue = min(distance(position, statuePosition), minDistEnemyStatue);\n        }\n        cumulativeHitpoints += clamp(hitpoints, 0., ").concat(R(ja),");\n\n        ").concat(yi.AliveTime.writer.write,"(aliveTime);\n        ").concat(yi.CumulativeHitpoints.writer.write,"(cumulativeHitpoints);\n        ").concat(yi.MinDistEnemyStatue.writer.write,"(minDistEnemyStatue);\n      "))}))}var nu,au=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.singleTargetDamage=new Tr(this.gls,[Do.component[Yo.Talons].gpuComponent],At([Jo.Target.sm,Zo,Fo.sm],{originator:Ct("ivec2",[["ivec2","entityCell"]],"\n        return ".concat(Fo.sm.value,"(entityCell);\n      ")),getTarget:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.Talons,")) {\n          return ivec2(-1);\n        } else {\n          return ").concat(Jo.Target.sm.value,"(unit);\n        }\n      ")),damageSetting:pt("float",(function(){return Do.get(Yo.Talons,"Settings").damage.value})),baseDamage:Ct("float",[["ivec2","entityCell"]],"\n        return Self.damageSetting;\n      ")}))}return Object(p.a)(t,[{key:"run",value:function(t){this.singleTargetDamage.run(t)}}]),t}(),iu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.singleTargetDamage=new Tr(this.gls,[Do.component[Yo.Cleavers].gpuComponent],At([Jo.Target.sm,Zo,Fo.sm],{originator:Ct("ivec2",[["ivec2","entityCell"]],"\n        return ".concat(Fo.sm.value,"(entityCell);\n      ")),getTarget:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.Cleavers,")) {\n          return ivec2(-1);\n        } else {\n          return ").concat(Jo.Target.sm.value,"(unit);\n        }\n      ")),damageSetting:pt("float",(function(){return Do.get(Yo.Cleavers,"Settings").damage.value})),baseDamage:Ct("float",[["ivec2","entityCell"]],"\n        return Self.damageSetting;\n      ")}))}return Object(p.a)(t,[{key:"run",value:function(t){this.singleTargetDamage.run(t)}}]),t}(),ru=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.singleTargetDamage=new Tr(this.gls,[Do.component[Yo.BloodClaws].gpuComponent],At([Jo.Target.sm,Zo,Fo.sm],{originator:Ct("ivec2",[["ivec2","entityCell"]],"\n        return ".concat(Fo.sm.value,"(entityCell);\n      ")),getTarget:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.BloodClaws,")) {\n          return ivec2(-1);\n        } else {\n          return ").concat(Jo.Target.sm.value,"(unit);\n        }\n      ")),damageSetting:pt("float",(function(){return Do.get(Yo.BloodClaws,"Settings").damage.value})),baseDamage:Ct("float",[["ivec2","entityCell"]],"\n        return Self.damageSetting;\n      ")})),this.heal=new Re([Do.component[Yo.BloodClaws].gpuComponent]).mapGpu(this.gls,Sa.component,At([Zo,Jo.Target.sm,Sa.sm,Sa.writer,Fo.sm],{map:Ct("float",[["ivec2","entityCell"],["float","value"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.BloodClaws,")) {\n          return value;\n        }\n        float targetHp = ").concat(Sa.sm.value,"(").concat(Jo.Target.sm.value,"(unit));\n        return value + min(targetHp, 20.);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.singleTargetDamage.run(t),this.heal.run(t)}}]),t}(),ou=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.singleTargetDamage=new Tr(this.gls,[Do.component[Yo.Cripplers].gpuComponent],At([Jo.Target.sm,Zo,Fo.sm],{originator:Ct("ivec2",[["ivec2","entityCell"]],"\n        return ".concat(Fo.sm.value,"(entityCell);\n      ")),getTarget:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.Cripplers,")) {\n          return ivec2(-1);\n        } else {\n          return ").concat(Jo.Target.sm.value,"(unit);\n        }\n      ")),damageSetting:pt("float",(function(){return Do.get(Yo.BloodClaws,"Settings").damage.value})),baseDamage:Ct("float",[["ivec2","entityCell"]],"\n        return Self.damageSetting;\n      ")})),this.buff=new Re([Do.component[Yo.Cripplers].gpuComponent]).updateGpu(this.gls,[Ds.component],At([Zo,Jo.Target.sm,Ds.writer,Fo.sm],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.Cripplers,")) {\n          return ivec2(-1);\n        }\n        ").concat(Ds.writer.write,"(60 * 3); // duration\n        return ").concat(Jo.Target.sm.value,"(unit);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.singleTargetDamage.run(t),this.buff.run(t)}}]),t}(),su={x:0,y:1.237,z:1.1705},cu={x:0,y:.3068,z:2.1917},uu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([Do.component[Yo.SleepDart].gpuComponent]).updateGpu(this.gls,[Dn.gpuComponent,ao.component,io.component,oo.component],At([Zo,Jo.Target.sm,Do.component[Yo.SleepDart].sm,ao.writer,Dn.writer,oo.writer,Mo.sm,Dn.sm,io.writer,ve,Ln.sm,Fo.sm],{sleepDuration:pt("float",(function(){return Do.get(Yo.SleepDart,"Settings").sleepDuration.value*Kn})),update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.SleepDart,")) {\n          return ivec2(-1);\n        }\n        vec3 projectileOffset = ").concat(P(cu),";\n        vec3 projectileStartPosition = ").concat(ve.transformPoint,"(").concat(Ln.sm.value,"(unit), projectileOffset);\n        ").concat(Dn.writer.write,"(projectileStartPosition);\n        ").concat(ao.writer.write,"(").concat(Jo.Target.sm.value,"(unit));\n        ").concat(io.writer.write,"(1.0);\n        ").concat(oo.writer.write,"(Self.sleepDuration);\n        return ").concat(Mo.sm.value,"(entityCell);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.update.run(t)}}]),t}(),lu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([Do.component[Yo.Pistol].gpuComponent]).updateGpu(this.gls,[Dn.gpuComponent,ao.component,io.component,ro.component],At([Zo,Jo.Target.sm,ao.writer,Dn.writer,ro.writer,Bo.sm,Dn.sm,io.writer,ve,Ln.sm,Fo.sm],{damageSetting:pt("float",(function(){return Do.get(Yo.Pistol,"Settings").damage.value})),update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.Pistol,")) {\n          return ivec2(-1);\n        }\n        vec3 projectileOffset = ").concat(P(su),";\n        vec3 projectileStartPosition = ").concat(ve.transformPoint,"(").concat(Ln.sm.value,"(unit), projectileOffset);\n        ").concat(Dn.writer.write,"(projectileStartPosition);\n        ").concat(ao.writer.write,"(").concat(Jo.Target.sm.value,"(unit));\n        ").concat(io.writer.write,"(0.5);\n        ").concat(ro.writer.write,"(Self.damageSetting);\n        return ").concat(Bo.sm.value,"(entityCell);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.update.run(t)}}]),t}(),hu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([Do.component[Yo.Blaster].gpuComponent]).updateGpu(this.gls,[Dn.gpuComponent,ao.component,io.component,ro.component],At([Zo,Jo.Target.sm,ao.writer,Dn.writer,ro.writer,Bo.sm,Dn.sm,io.writer,ve,Ln.sm,Fo.sm],{damageSetting:pt("float",(function(){return Do.get(Yo.Blaster,"Settings").damage.value})),update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.Blaster,")) {\n          return ivec2(-1);\n        }\n        vec3 projectileOffset = ").concat(P(su),";\n        vec3 projectileStartPosition = ").concat(ve.transformPoint,"(").concat(Ln.sm.value,"(unit), projectileOffset);\n        ").concat(Dn.writer.write,"(projectileStartPosition);\n        ").concat(ao.writer.write,"(").concat(Jo.Target.sm.value,"(unit));\n        ").concat(io.writer.write,"(0.5);\n        ").concat(ro.writer.write,"(Self.damageSetting);\n        return ").concat(Bo.sm.value,"(entityCell);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.update.run(t)}}]),t}(),fu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([Do.component[Yo.Magnum].gpuComponent]).updateGpu(this.gls,[Dn.gpuComponent,ao.component,io.component,ro.component,so.component],At([Zo,Jo.Target.sm,ao.writer,Dn.writer,ro.writer,so.writer,Bo.sm,Dn.sm,io.writer,ve,Ln.sm,Fo.sm],{damageSetting:pt("float",(function(){return Do.get(Yo.Magnum,"Settings").damage.value})),update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (!").concat(Zo.isPerforming,"(unit, ").concat(Yo.Magnum,")) {\n          return ivec2(-1);\n        }\n        vec3 projectileOffset = ").concat(P(su),";\n        vec3 projectileStartPosition = ").concat(ve.transformPoint,"(").concat(Ln.sm.value,"(unit), projectileOffset);\n        ").concat(Dn.writer.write,"(projectileStartPosition);\n        ").concat(ao.writer.write,"(").concat(Jo.Target.sm.value,"(unit));\n        ").concat(io.writer.write,"(0.5);\n        ").concat(ro.writer.write,"(Self.damageSetting);\n        ").concat(so.writer.write,"(2000.);\n        return ").concat(Bo.sm.value,"(entityCell);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.update.run(t)}}]),t}(),du=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.forces=new Re([Do.component[Yo.Leap].gpuComponent,pi.component]).updateGpu(this.gls,[pi.component],At([Zo,Bn.sm,we,pi.writer,Fo.sm,pi.sm],{update:Ct("ivec2",[["ivec2","entityCell"]],"\n        ivec2 unit = ".concat(Fo.sm.value,"(entityCell);\n        if (").concat(Zo.isPerforming,"(unit, ").concat(Yo.Leap,")) {\n          float rotation = ").concat(Bn.sm.value,"(unit);\n          vec2 forward = ").concat(we.forward,"(rotation);\n          ").concat(pi.writer.write,"(vec3(forward, 1.4) * 1000.);\n        } else {\n          ").concat(pi.writer.write,"(").concat(pi.sm.value,"(unit));\n        }\n        return unit;\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.forces.run(t)}}]),t}(),mu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.arenaStats=new Me([In.gpuComponent]).filterValue(In.cpuComponent,(function(t,e){return t[0]===e.data.renderArena}),(function(t){return[t.data.renderArena]})).toGpu(this.gls).mapToTemp(At([yr,In.sm],{map:Ct("vec4",[["ivec2","entityCell"]],"\n        int arenaIndex = ".concat(In.sm.value,"(entityCell);\n        ").concat(yr.Stats," stats = ").concat(yr.stats,"(arenaIndex);\n        return vec4(stats.homePoints, stats.awayPoints, stats.home.unitsAlive, stats.away.unitsAlive);\n      "))})).toCpuQueuing((function(t){return t.data.round}))}return Object(p.a)(t,[{key:"run",value:function(t){var e=this.arenaStats.queueRead(t),n=g.a.last(e());if(n){var a=n[0].value[0].x,i=n[0].value[0].y,r=n[0].value[0].z,o=n[0].value[0].w;t.data.teams.home.battlePoints!==a&&t.updateTeam("home",{battlePoints:a}),t.data.teams.away.battlePoints!==i&&t.updateTeam("away",{battlePoints:i}),t.data.teams.home.battleUnitsAlive!==r&&t.updateTeam("home",{battleUnitsAlive:r}),t.data.teams.away.battleUnitsAlive!==o&&t.updateTeam("away",{battleUnitsAlive:o})}}}]),t}();function pu(t){return new Re([ii.component]).updateGpu(t,[Vs.MoveX.component,Vs.Rotate.component],At([Vs.MoveX.writer,Vs.Rotate.writer,Dn.sm,Sa.sm,Bn.sm,xe,ue,he],{update:Ct("void",[["ivec2","entityCell"]],"\n        float moveX = 0.;\n        float rotation = ".concat(Bn.sm.value,"(entityCell);\n        float hitpoints = ").concat(Sa.sm.value,"(entityCell);\n        float rotate;\n        if (hitpoints > 0.) {\n          if (hitpoints >= ").concat(R(ja),") {\n            // Roaming\n            float mc = ").concat(he.entityRandom,"(entityCell, ").concat(b.d.get("duckMoveChange1"),", ").concat(b.d.get("duckMoveChange2"),");\n            if (mc > 0.9) {\n              moveX = moveX > 0. ? 0. : 0.1;\n            }\n            float rc = ").concat(he.entityRandom,"(entityCell, ").concat(b.d.get("duckRotateChange1"),", ").concat(b.d.get("duckRotateChange2"),");\n            if (rc > 0.9) {\n              float rr = ").concat(he.entityRandom,"(entityCell, ").concat(b.d.get("duckRotate1"),", ").concat(b.d.get("duckRotate2"),");\n              rotate = (rr * 2. - 1.);\n            }\n          } else {\n            // Fleeing\n            vec3 position = ").concat(Dn.sm.value,"(entityCell);\n            moveX = 1.;\n            float targetRotation = position.x < position.y\n              ? (").concat(ue.PI," * 3. / 4.)\n              : (").concat(ue.PI," * 7. / 4.);\n            float rot = ").concat(xe.shortestAngleDist,"(rotation, targetRotation);\n            rotate = rot < 0. ? -1. : 1.;\n          }\n        }\n        ").concat(Vs.MoveX.writer.write,"(moveX);\n        ").concat(Vs.Rotate.writer.write,"(rotate);\n      "))}))}function vu(t){return new Re([ai.component]).updateGpu(t,[Vs.ChaseFocus.component,Vs.CastingSlot.component,Vs.MoveX.component,Vs.Rotate.component,Vs.ChangeFocus.component],At([Vs.ChaseFocus.writer,Vs.CastingSlot.writer,Vs.MoveX.writer,Vs.Rotate.writer,Vs.ChangeFocus.writer,Vs.MoveX.sm,Vs.Rotate.sm,ri.sm,Ea.sm,we,he,Ts,Dn.sm,Bn.sm],{homeCount:pt("int",(function(t){return t.data.teams.home.unitCount})),awayCount:pt("int",(function(t){return t.data.teams.away.unitCount})),update:Ct("void",[["ivec2","entityCell"]],"\n        vec3 position = ".concat(Dn.sm.value,"(entityCell);\n        float rotation = ").concat(Bn.sm.value,"(entityCell);\n        vec2 forward = ").concat(we.forward,"(rotation);\n        int team = ").concat(Ea.sm.value,"(entityCell);\n        float forwardHeight = ").concat(Ts.atPosition,"(position.xy + forward * 2.);\n        float forwardElevation = position.z - forwardHeight;\n        bool precipiceInFront = forwardElevation > 1.;\n\n        ivec2 focus = ").concat(ri.sm.value,"(entityCell);\n        bool hasFocus = focus.x >= 0;\n        float moveX = ").concat(Vs.MoveX.sm.value,"(entityCell);\n        float rotate = ").concat(Vs.Rotate.sm.value,"(entityCell);\n        bool changeFocus = true;\n        if (hasFocus) {\n          int focusTeam = ").concat(Ea.sm.value,"(focus);\n          if (team != focusTeam) {\n            vec3 focusPosition = ").concat(Dn.sm.value,"(focus);\n            float focusHeight = ").concat(Ts.atPosition,"(focusPosition.xy);\n            float focusElevation = focusPosition.z - focusHeight;\n            if (focusElevation > 1. || precipiceInFront) {\n              ").concat(Vs.ChaseFocus.writer.write,"(0.);\n              ").concat(Vs.CastingSlot.writer.write,"(0);\n              changeFocus = true;\n            } else {\n              ").concat(Vs.ChaseFocus.writer.write,"(1.);\n              ").concat(Vs.CastingSlot.writer.write,"(1);\n              changeFocus = false;\n            }\n          }\n          moveX = 0.;\n          rotate = 0.;\n        } else {\n          // Roaming\n          float mc = ").concat(he.entityRandom,"(entityCell, ").concat(b.d.get("crabMoveChange1"),", ").concat(b.d.get("crabMoveChange2"),");\n          if (mc > 0.9) {\n            moveX = moveX > 0. ? 0. : 0.1;\n          }\n          float rc = ").concat(he.entityRandom,"(entityCell, ").concat(b.d.get("crabRotateChange1"),", ").concat(b.d.get("crabRotateChange2"),");\n          if (rc > 0.9) {\n            float rr = ").concat(he.entityRandom,"(entityCell, ").concat(b.d.get("crabRotate1"),", ").concat(b.d.get("crabRotate2"),");\n            rotate = (rr * 2. - 1.);\n          }\n          if (precipiceInFront) {\n            moveX = 0.;\n          }\n          ").concat(Vs.ChaseFocus.writer.write,"(0.);\n          ").concat(Vs.CastingSlot.writer.write,"(0);\n        }\n        ").concat(Vs.MoveX.writer.write,"(moveX);\n        ").concat(Vs.Rotate.writer.write,"(rotate);\n        if (changeFocus) {\n          int enemyCount = team == ").concat(ta.HomeTeam," ? awayCount : homeCount;\n          int newFocus = ").concat(la," - 1;\n          if (enemyCount > 1) { // If there are any units\n            float r = ").concat(he.entityRandom,"(entityCell, ").concat(b.d.get("crabAiFocus1"),", ").concat(b.d.get("crabAiFocus2"),");\n            newFocus += 1 + int(r * float(enemyCount - 1));\n          }\n          ").concat(Vs.ChangeFocus.writer.write,"(newFocus + 1);\n        } else {\n          ").concat(Vs.ChangeFocus.writer.write,"(0);\n        }\n      "))}))}!function(t){t[t.PositionX=0]="PositionX",t[t.PositionY=1]="PositionY",t[t.PositionZ=2]="PositionZ",t[t.Hitpoints=3]="Hitpoints"}(nu||(nu={}));var gu=Object(b.q)(nu).length+Qs.length,yu=Math.ceil(gu/4),bu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.shader=new jt(At([].concat(Object(mt.a)(Qs.map((function(t){return t.sm}))),[vr,Dn.sm,Sa.sm]),{outValues:yt("vec4[".concat(yu,"]")),renderArena:pt("int",(function(t){return t.data.renderArena})),main:Ct("void",[],"\n      int arenaMemberIndex = int(gl_FragCoord.y);\n      ivec2 entityCell = ".concat(vr.unit,"(Self.renderArena, arenaMemberIndex);\n      vec3 position = ").concat(Dn.sm.value,"(entityCell);\n      outValues[").concat(Math.floor(nu.PositionX/4),"][").concat(nu.PositionX%4,"] = position.x;\n      outValues[").concat(Math.floor(nu.PositionY/4),"][").concat(nu.PositionY%4,"] = position.y;\n      outValues[").concat(Math.floor(nu.PositionZ/4),"][").concat(nu.PositionZ%4,"] = position.z;\n      outValues[").concat(Math.floor(nu.Hitpoints/4),"][").concat(nu.Hitpoints%4,"] = ").concat(Sa.sm.value,"(entityCell);\n      ").concat(Qs.map((function(t,e){var n=e+Object(b.q)(nu).length;return"outValues[".concat(Math.floor(n/4),"][").concat(n%4,"] = float(").concat(t.sm.value,"(entityCell));")})).join("\n"),"\n    "))})),this.program=new Xt(this.gls,this.shader.source),this.renderTarget=new at(this.gls)}return Object(p.a)(t,[{key:"run",value:function(t){if("battle"===t.data.gameInstance.type||"train"===t.data.gameInstance.type){this.shader.updateUniformValues(t);var e=t.textures.unitsReplay.sliceAll().selectAbsolute({x:t.data.stepCounter-t.data.battleStartStep,y:0,width:1,height:t.textures.unitsReplay.size.height});this.renderTarget.set(e.back),this.program.prepare(),this.shader.writeUniforms(this.program),this.gls.prepareForComputation(e.rect),this.gls.drawQuad(this.program)}}}]),t}();var wu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.decisions=new Re([Ba.component]).updateGpu(this.gls,Object(mt.a)(Qs.map((function(t){return t.component}))),At([Sn.sm].concat(Object(mt.a)(Qs.map((function(t){return t.writer})))),{stepCounter:pt("int",(function(t){return t.data.stepCounter-t.data.battleStartStep})),replay:pt("sampler2DArray",(function(t){return t.textures.unitsReplay})),update:Ct("void",[["ivec2","entityCell"]],"\n        int arenaMemberIndex = ".concat(Sn.sm.value,"(entityCell);\n        ").concat(Qs.map((function(t,e){var n=e+Object(b.q)(nu).length;return"".concat(t.writer.write,"(").concat(t.component.format,"(texelFetch(Self.replay, ivec3(Self.stepCounter, arenaMemberIndex, ").concat(Math.floor(n/4),"), 0)[").concat(n%4,"]));")})).join("\n"),"\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){"replay"===t.data.gameInstance.type&&this.decisions.run(t)}}]),t}(),Cu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.common=new Re([Ba.component]).updateGpu(this.gls,[Dn.gpuComponent,Sa.component],At([Sn.sm,Dn.writer,Sa.writer],{stepCounter:pt("int",(function(t){return t.data.stepCounter-t.data.battleStartStep})),replay:pt("sampler2DArray",(function(t){return t.textures.unitsReplay})),update:Ct("void",[["ivec2","entityCell"]],"\n        int arenaMemberIndex = ".concat(Sn.sm.value,"(entityCell);\n        vec4 slice0 = texelFetch(Self.replay, ivec3(Self.stepCounter, arenaMemberIndex, 0), 0);\n        ").concat(Dn.writer.write,"(slice0.xyz);\n        ").concat(Sa.writer.write,"(slice0.w);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){"replay"===t.data.gameInstance.type&&this.common.run(t)}}]),t}(),xu=At("UnitFieldPosition",[Ea.sm,Dn.sm],{worldSize:pt("vec2",(function(t){return Object(y.l)(t.data.worldSize)})),statuePosition:pt("vec3",(function(t){return ma})),get:Ct("int",[["ivec2","entityCell"]],"\n    int team = ".concat(Ea.sm.value,"(entityCell);\n    vec3 position = ").concat(Dn.sm.value,"(entityCell);\n    vec2 mapUp = team == ").concat(ta.HomeTeam," ? normalize(vec2(1, 1)) : -normalize(vec2(1, 1));\n    vec2 mapCenter = Self.worldSize / 2.;\n    vec2 positionD = position.xy - mapCenter;\n    float positionUpDown = dot(positionD, mapUp) / length(mapCenter);\n    bool inEnemyTerritory = positionUpDown > 0.;\n    vec3 friendStatuePosition = vec3(Self.worldSize, 0) - Self.statuePosition;\n    vec3 enemyStatuePosition = Self.statuePosition;\n    if (team == ").concat(ta.HomeTeam,") {\n      enemyStatuePosition = friendStatuePosition;\n      friendStatuePosition = Self.statuePosition;\n    }\n    if (inEnemyTerritory) {\n      bool inEnemyBase = distance(position, enemyStatuePosition) < 5.;\n      if (inEnemyBase) {\n        return ").concat(na.UnitFieldPositions.AwayBase,";\n      } else {\n        return ").concat(na.UnitFieldPositions.AwayTerritory,";\n      }\n    } else {\n      bool inFriendBase = distance(position, friendStatuePosition) < 5.;\n      if (inFriendBase) {\n        return ").concat(na.UnitFieldPositions.HomeBase,";\n      } else {\n        return ").concat(na.UnitFieldPositions.HomeTerritory,";\n      }\n    }\n  "))}),Au=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Re([Ja.component]).updateGpu(this.gls,[Ja.component],At([Ja.sm,Ja.writer,xu,bi.timeSpentHomeBase.sm,bi.timeSpentHomeTerritory.sm,bi.timeSpentAwayBase.sm,bi.timeSpentAwayTerritory.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n        float gold = ".concat(Ja.sm.value,"(entityCell);\n        int fieldPosition = ").concat(xu.get,"(entityCell);\n        float bounty = fieldPosition == ").concat(na.UnitFieldPositions.HomeBase," ? ").concat(bi.timeSpentHomeBase.sm.value,"(entityCell) :\n          fieldPosition == ").concat(na.UnitFieldPositions.HomeTerritory," ? ").concat(bi.timeSpentHomeTerritory.sm.value,"(entityCell) :\n          fieldPosition == ").concat(na.UnitFieldPositions.AwayTerritory," ? ").concat(bi.timeSpentAwayTerritory.sm.value,"(entityCell) :\n          fieldPosition == ").concat(na.UnitFieldPositions.AwayBase," ? ").concat(bi.timeSpentAwayBase.sm.value,"(entityCell) :\n          0.;\n        gold += bounty;\n        ").concat(Ja.writer.write,"(gold);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){(t.data.stepCounter-t.data.battleStartStep)%300===0&&this.query.run(t)}}]),t}(),Ou=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Re([Ja.component,Za.component]).updateGpu(this.gls,[Ja.component],At([Ja.sm,Ja.writer,Za.sm,vr,jn.sm,Ea.sm,bi.teamSpirit.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n        float gold = ".concat(Ja.sm.value,"(entityCell);\n        float previousGold = ").concat(Za.sm.value,"(entityCell);\n        int arenaIndex = ").concat(jn.sm.value,"(entityCell);\n        int team = ").concat(Ea.sm.value,"(entityCell);\n        int teamOffset = team == ").concat(ta.HomeTeam," ? 0 : ").concat(la,";\n        float teamGoldGain = 0.;\n        int nTeamMates = 0;\n        for (int i=1; i < ").concat(la,"; i++) {\n          ivec2 unit = ").concat(vr.unit,"(arenaIndex, teamOffset + i);\n          if (unit.x >= 0) {\n            float unitGold = ").concat(Ja.sm.value,"(unit);\n            float unitPreviousGold = ").concat(Za.sm.value,"(unit);\n            float gain = unitGold - unitPreviousGold;\n            teamGoldGain += gain;\n            nTeamMates++;\n          }\n        }\n        if (nTeamMates > 0) {\n          float gain = gold - previousGold;\n          float avgTeamGain = teamGoldGain / float(nTeamMates);\n          float teamSpirit = ").concat(bi.teamSpirit.sm.value,"(entityCell);\n          gold = previousGold + teamSpirit * avgTeamGain + (1. - teamSpirit) * gain;\n        }\n        ").concat(Ja.writer.write,"(gold);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}(),ju=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Re([Ja.component]).updateGpu(this.gls,[Ja.component],At([Ja.sm,Za.sm,Ja.writer,bi.timeScaling.sm],{time:pt("float",(function(t){return(t.data.stepCounter-t.data.battleStartStep)/aa})),update:Ct("void",[["ivec2","entityCell"]],"\n        float gold = ".concat(Ja.sm.value,"(entityCell);\n        float previousGold = ").concat(Za.sm.value,"(entityCell);\n        float goldGain = gold - previousGold;\n        goldGain = mix(goldGain, goldGain * ").concat(bi.timeScaling.sm.value,"(entityCell), time);\n        gold = previousGold + goldGain;\n        ").concat(Ja.writer.write,"(gold);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}(),Su=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Re([Za.component]).updateGpu(this.gls,[Za.component],At([Ja.sm,Za.writer],{update:Ct("void",[["ivec2","entityCell"]],"\n        float gold = ".concat(Ja.sm.value,"(entityCell);\n        ").concat(Za.writer.write,"(gold);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}(),ku=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Re([Ja.component]).updateGpu(this.gls,[Ja.component],At([Ja.sm,Ja.writer,jn.sm,Ea.sm,yr,bi.victory.sm,bi.tie.sm,bi.loss.sm],{update:Ct("void",[["ivec2","entityCell"]],"\n        float gold = ".concat(Ja.sm.value,"(entityCell);\n        int arena = ").concat(jn.sm.value,"(entityCell);\n        int winner = ").concat(yr.stats,"(arena).winner;\n        int team = ").concat(Ea.sm.value,"(entityCell);\n        if ((team == ").concat(ta.HomeTeam," && winner == ").concat(mr.Home,") || (team == ").concat(ta.AwayTeam," && winner == ").concat(mr.Away,")) {\n          gold += ").concat(bi.victory.sm.value,"(entityCell);\n        } else if ((team == ").concat(ta.HomeTeam," && winner == ").concat(mr.Away,") || (team == ").concat(ta.AwayTeam," && winner == ").concat(mr.Home,")) {\n          gold += ").concat(bi.loss.sm.value,"(entityCell);\n        } else {\n          gold += ").concat(bi.tie.sm.value,"(entityCell);\n        }\n        ").concat(Ja.writer.write,"(gold);\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}();function Iu(t){return new Re([Sa.component,Ya.component]).mapGpu(t,Ya.component,At([Sa.sm],{map:Ct("float",[["ivec2","entityCell"],["float","value"]],"\n        float hp = ".concat(Sa.sm.value,"(entityCell);\n        float d = hp - value;\n        d = sign(d) * min(1., abs(d));\n        return value + d;\n      "))}))}var Eu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.update=new Re([Sa.component,Xa]).mapGpu(this.gls,Sa.component,At([],{map:Ct("float",[["ivec2","entityCell"],["float","value"]],"\n        if (value > 0.) {\n          float hitpointsRegen = 0.25 * ".concat(R(ja)," / ").concat(R(aa),";\n          return clamp(value + hitpointsRegen, 0., ").concat(R(ja),");\n        } else {\n          return value;\n        }\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.update.run(t)}}]),t}(),Tu=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Re([ri.component]).mapGpu(this.gls,ri.component,At([Zo,vr,Ea.sm,jn.sm],{map:Ct("ivec2",[["ivec2","entityCell"],["ivec2","value"]],"\n        int unitsOffset = ".concat(Ea.sm.value,"(entityCell) == ").concat(ta.HomeTeam," ? ").concat(la," : 0;\n        int arenaIndex = ").concat(jn.sm.value,"(entityCell);\n        for (int i=0; i < ").concat(la,"; i++) {\n          ivec2 unit = ").concat(vr.unit,"(arenaIndex, i + unitsOffset);\n          if (").concat(Zo.isPerforming,"(unit, ").concat(Yo.Trombone,")) {\n            return unit;\n          }\n        }\n        return value;\n      "))}))}return Object(p.a)(t,[{key:"run",value:function(t){this.query.run(t)}}]),t}(),Ru=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.abilities=[new Tu(this.gls),new au(this.gls),new iu(this.gls),new ru(this.gls),new ou(this.gls),new uu(this.gls),new _o(this.gls),new is(this.gls),new du(this.gls),new ts(this.gls),new es(this.gls),new lu(this.gls),new hu(this.gls),new fu(this.gls)]}return Object(p.a)(t,[{key:"run",value:function(t){var e,n=Object(m.a)(this.abilities);try{for(n.s();!(e=n.n()).done;){e.value.run(t)}}catch(Nt){n.e(Nt)}finally{n.f()}}}]),t}(),Du=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.copyLayers=this.gls.getCopyLayers(),this.copyTexture=this.gls.getCopyTexture(),this.renderer=new Is(this.gls),this.breeding=new hc(this.gls),this.roundStats=new vc(this.gls),this.battleScore=new mu(this.gls),this.victoryLossBounty=new ku(this.gls),this.updateArenaInfos=new tu(this.gls),this.updateNeuralNetwork=new Us(this.gls),this.stepSystems=[this.updateNeuralNetwork,Ys(this.gls),vu(this.gls),pu(this.gls),new Xs,new wu(this.gls),new Ks(this.gls),new Js(this.gls),new _s(this.gls),new Ru(this.gls),new Zs(this.gls),new po(this.gls),new $s(this.gls),Or(this.gls),new Ar(this.gls),new Eu(this.gls),Iu(this.gls),eu(this.gls),new Au(this.gls),new Ou(this.gls),new ju(this.gls),new Su(this.gls),new tc(this.gls),this.updateArenaInfos,new Cu(this.gls),new bu(this.gls)],this.updateMouseover=function(t){},this.throttledUpdateMouseover=g.a.throttle(this.updateMouseover,100),console.log("GpuWorldProgram created")}return Object(p.a)(t,[{key:"destroy",value:function(){this.renderer.destroy(),this.gls.destroy(),this.gls.shaderCache.destroy()}},{key:"step",value:function(t){this.gls.stats.drawCalls=0,t.setData({stepCounter:t.data.stepCounter+1,randomSeed:t.random.random()});var e=t.data.teams.home.battleUnitsAlive+t.data.teams.away.battleUnitsAlive;if("none"!==t.data.gameInstance.type&&(t.data.stepCounter>=t.data.battleStartStep+aa||"battle"===t.data.gameInstance.type&&0===e))return t.data.simulationEnded?Promise.resolve():this.endRound(t);var n,a=Object(m.a)(this.stepSystems);try{for(a.s();!(n=a.n()).done;){n.value.run(t)}}catch(Nt){a.e(Nt)}finally{a.f()}"battle"!==t.data.gameInstance.type&&"gym"!==t.data.gameInstance.type||this.battleScore.run(t);return Promise.all([])}},{key:"render",value:function(t){this.gls.stats.drawCalls=0,this.renderer.render(t),this.throttledUpdateMouseover(t)}},{key:"endRound",value:function(){var t=Object(c.a)(s.a.mark((function t(e){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.victoryLossBounty.run(e),e.setData({simulationEnded:!0}),null===Kr||void 0===Kr||Kr.fadeOutAllLoopingSoundEffects(),"train"!==e.data.gameInstance.type&&"battle"!==e.data.gameInstance.type||e.textures.unitsReplay.swap(),"train"!==e.data.gameInstance.type){t.next=8;break}return t.next=7,this.breeding.runSelection(e);case 7:this.updateArenaInfos.run(e);case 8:if(this.roundStats.run(e),e.events.roundEnd.dispatch({type:"RoundEnd",round:e.data.round}),"train"!==e.data.gameInstance.type||!e.data.autoStartNextTrainingRound){t.next=13;break}return t.next=13,this.breedAndRestartTraining(e);case 13:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"breedAndRestartTraining",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.resetForNextRound(e,!0),n=e.data.round+1,e.setData({simulationEnded:!1,battleStartStep:e.data.stepCounter,round:n});case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"resetForNextRound",value:function(t,e){var n,a,i,r,o,s,c,u,l,h,f,d,p,v,g,y,b,w,C;(t.ecs.gpuComponentInfo(Ia.component).slice.clear([ka,0,0,0]),e)&&(t.ecs.gpuComponentInfo(Sa.component).slice.clear([ja,0,0,0]),t.ecs.gpuComponentInfo(Ya.component).slice.clear([ja,0,0,0]),t.ecs.gpuComponentInfo(_a.component).slice.clear([ja,0,0,0]),null===(C=t.ecs.gpuComponentInfo($a.component))||void 0===C||C.slice.clear([-1,0,0,0]));t.ecs.gpuComponentInfo(ir.component).slice.clear(),t.ecs.gpuComponentInfo(Ki.component).slice.clear(),t.ecs.gpuComponentInfo(Ji.component).slice.clear(),t.ecs.gpuComponentInfo(oi.component).slice.clear([1,1,1,1]),null===(n=t.ecs.gpuComponentInfo(ri.component))||void 0===n||n.slice.clear([-1,-1,-1,-1]),null===(a=t.ecs.gpuComponentInfo(ei.component))||void 0===a||a.slice.clear([-1,-1,-1,-1]),null===(i=t.ecs.gpuComponentInfo(mi.component))||void 0===i||i.slice.clear(),null===(r=t.ecs.gpuComponentInfo(pi.component))||void 0===r||r.slice.clear(),null===(o=t.ecs.gpuComponentInfo(vi.component))||void 0===o||o.slice.clear([1,0,0,0]),null===(s=t.ecs.gpuComponentInfo(gi.component))||void 0===s||s.slice.clear(),null===(c=t.ecs.gpuComponentInfo(di.component))||void 0===c||c.slice.clear(),null===(u=t.ecs.gpuComponentInfo(Ja.component))||void 0===u||u.slice.clear(),null===(l=t.ecs.gpuComponentInfo(Za.component))||void 0===l||l.slice.clear(),null===(h=t.ecs.gpuComponentInfo(Vs.MoveX.component))||void 0===h||h.slice.clear(),null===(f=t.ecs.gpuComponentInfo(Vs.Rotate.component))||void 0===f||f.slice.clear(),null===(d=t.ecs.gpuComponentInfo(Vs.ChaseFocus.component))||void 0===d||d.slice.clear(),null===(p=t.ecs.gpuComponentInfo(Vs.CastingSlot.component))||void 0===p||p.slice.clear(),null===(v=t.ecs.gpuComponentInfo(Vs.ChangeFocus.component))||void 0===v||v.slice.clear(),null===(g=t.ecs.gpuComponentInfo(ds.res.component))||void 0===g||g.slice.clear(),null===(y=t.ecs.gpuComponentInfo(fs.res.component))||void 0===y||y.slice.clear(),null===(b=t.ecs.gpuComponentInfo(ms.res.component))||void 0===b||b.slice.clear();for(var x=0,A=Object.keys(yi);x<A.length;x++){var O,j=A[x];null===(O=t.ecs.gpuComponentInfo(yi[j].component))||void 0===O||O.slice.clear()}null===(w=t.ecs.gpuComponentInfo(yi.MinDistEnemyStatue.component))||void 0===w||w.slice.clear([t.data.worldSize.width,0,0,0]);for(var S=0,k=Object.keys(Jo);S<k.length;S++){var I,E=k[S];null===(I=t.ecs.gpuComponentInfo(Jo[E].component))||void 0===I||I.slice.clear()}var T,R=t.data.battleground,D=va[R],P=new Me([Dn.gpuComponent,Ta]).filterValue(Ta,(function(t){return t===ta.HomeTeam}),(function(t){return[]})).get(t),F=Object(m.a)(P);try{for(F.s();!(T=F.n()).done;){var B=T.value,M=t.ecs.getComponentData(Sn.cpuComponent,B)[0],z=D[M];0!==M&&(z=ln.add(z,{x:2*t.random.random()-1,y:2*t.random.random()-1,z:0})),t.ecs.setComponentData(Dn.gpuComponent,B,[new Float32Array([z.x,z.y,z.z,0])]),t.ecs.setComponentData(Bn.component,B,[Math.PI/4])}}catch(Nt){F.e(Nt)}finally{F.f()}var N,G=new Me([Dn.gpuComponent,Ta]).filterValue(Ta,(function(t){return t===ta.AwayTeam}),(function(t){return[]})).get(t),H=Object(m.a)(G);try{for(H.s();!(N=H.n()).done;){var L=N.value,U=t.ecs.getComponentData(Sn.cpuComponent,L)[0],V=ga(D[U-la],t.layout.worldSize);U!==la&&(V=ln.add(V,{x:2*t.random.random()-1,y:2*t.random.random()-1,z:0})),t.ecs.setComponentData(Dn.gpuComponent,L,[new Float32Array([V.x,V.y,V.z,0])]),t.ecs.setComponentData(Bn.component,L,[Math.PI+Math.PI/4])}}catch(Nt){H.e(Nt)}finally{H.f()}this.updateArenaInfos.run(t),"replay"===t.data.gameInstance.type&&t.ecs.setComponentData(Vi,t.data.camera,{actions:[{clip:ya,positionType:"startTime",positionValue:0}]})}}]),t}(),Pu=(n(341),n(127)),Fu=(n(342),n(35),n(343),n(344)),Bu=n(346);Bu.default&&(Bu=Bu.default);var Mu=function(){function t(e){var n=this;Object(l.a)(this,t),this.onSize=e,this.ref=null,this.handleRef=function(e){n.ref&&t.resizeObserver.unobserve(n.ref),e&&(e.__measureSizeOnSize=n.handleOnSize,t.resizeObserver.observe(e)),n.ref=e},this.handleOnSize=function(t){n.onSize(t)}}return Object(p.a)(t,[{key:"handleUnmount",value:function(){this.ref&&t.resizeObserver.unobserve(this.ref)}}]),t}();Mu.resizeObserver=new Bu((function(t,e){requestAnimationFrame((function(){var e,n=Object(m.a)(t);try{for(n.s();!(e=n.n()).done;){var a=e.value;a.target.__measureSizeOnSize(a.target.getBoundingClientRect())}}catch(Nt){n.e(Nt)}finally{n.f()}}))}));f.Component;function zu(t){return{left:t,top:t,bottom:t,right:t}}var Nu=zu(5),Gu=zu(5),Hu=zu(0),Lu=function(){function t(e,n){Object(l.a)(this,t),this.borderPx=e,this.marginPx=n,this.topLeft={x:this.borderPx.left*Math.random(),y:this.borderPx.top*Math.random()},this.topRight={x:this.borderPx.right*Math.random(),y:this.borderPx.top*Math.random()},this.bottomRight={x:this.borderPx.right*Math.random(),y:this.borderPx.bottom*Math.random()},this.bottomLeft={x:this.borderPx.left*Math.random(),y:this.borderPx.bottom*Math.random()}}return Object(p.a)(t,[{key:"renderToDataUrl",value:function(t,e,n,a,i){var r=this.topLeft,o=this.topRight,s=this.bottomLeft,c=this.bottomRight,u="\n      M".concat(r.x+this.marginPx.left," ").concat(r.y+this.marginPx.top,"\n      L ").concat(t.width-o.x-e-this.marginPx.right," ").concat(o.y+this.marginPx.top,"\n      L ").concat(t.width-c.x-e-this.marginPx.right," ").concat(t.height-c.y-e-this.marginPx.bottom,"\n      L ").concat(s.x+this.marginPx.left," ").concat(t.height-s.y-e-this.marginPx.bottom,"\n      Z\n    "),l=Object(Fu.renderToString)(Object(h.jsxs)("svg",{className:"WonkyPanelBackground",xmlns:"http://www.w3.org/2000/svg",width:t.width,height:t.height,children:[0!==e&&Object(h.jsx)("path",{d:u,fill:"rgba(0, 0, 0, 0.3)",transform:"translate(".concat(e,", ").concat(e,")")}),Object(h.jsx)("path",{d:u,fill:n,stroke:a,strokeWidth:i})]}));return"data:image/svg+xml;base64,".concat(window.btoa(l))}}]),t}(),Uu=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(t){var a;return Object(l.a)(this,n),(a=e.call(this,t)).measure=new Mu((function(t){return a.setState({size:t})})),a.wonkyPanelSvg=new Lu(void 0!==a.props.borderPx?a.props.borderPx:Nu,void 0!==a.props.backgroundMarginPx?a.props.backgroundMarginPx:Hu),a.state={size:{width:0,height:0}},a}return Object(p.a)(n,[{key:"componentDidUpdate",value:function(t){v.isEqual(t.borderPx,this.props.borderPx)&&v.isEqual(t.backgroundMarginPx,this.props.backgroundMarginPx)||(this.wonkyPanelSvg=new Lu(void 0!==this.props.borderPx?this.props.borderPx:Nu,void 0!==this.props.backgroundMarginPx?this.props.backgroundMarginPx:Hu))}},{key:"componentWillUnmount",value:function(){this.measure.handleUnmount()}},{key:"render",value:function(){var t=this.props,e=t.children,n=t.className,a=t.shadowPx,i=void 0===a?10:a,o=t.borderPx,s=void 0===o?Nu:o,c=t.paddingPx,u=void 0===c?Gu:c,l=t.fill,f=void 0===l?"#171717":l,d=t.onClick,m=t.stroke,p=t.strokeWidth;return Object(h.jsx)("div",{className:"WonkyPanel ".concat(void 0!==n?n:""),ref:this.measure.handleRef,style:Object(r.a)({paddingLeft:s.left+u.left+"px",paddingTop:s.top+u.top+"px",paddingRight:s.right+u.right+i+"px",paddingBottom:s.bottom+u.bottom+i+"px",background:"url('".concat(this.wonkyPanelSvg.renderToDataUrl(this.state.size,i,f,m,p),"') no-repeat")},this.props.style),onClick:d,children:e})}}]),n}(f.Component);n(347);new(function(){function t(){Object(l.a)(this,t),this.onChange=new b.a}return Object(p.a)(t,[{key:"push",value:function(t){window.history.pushState(null,"",t),this.onChange.dispatch()}},{key:"replace",value:function(t){window.history.replaceState(null,"",t),this.onChange.dispatch()}}]),t}());function Vu(t){t.className;var e=t.style,n=t.onClick,a=t.onPerform,i=t.children,o=t.disabled,l=t.toggled,d=t.fill,m=t.primary,p=t.large,v=t.purpose,g=t.flat,y=t.borderPx,w=t.paddingPx,C=t.materialIcon,x=t.fontAwesomeIcon,A=Object(Pu.a)(t,["className","style","onClick","onPerform","children","disabled","toggled","fill","primary","large","purpose","flat","borderPx","paddingPx","materialIcon","fontAwesomeIcon"]),O=f.useState(),j=Object(u.a)(O,2),S=j[0],k=j[1],I=function(){var t=Object(c.a)(s.a.mark((function t(e){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.stopPropagation(),!a){t.next=10;break}return k(!0),t.next=5,Object(b.H)(1);case 5:return t.next=7,a(e);case 7:k(!1),t.next=11;break;case 10:n&&n(e);case 11:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),E=i;return x&&(E=Object(h.jsxs)("span",{children:[Object(h.jsx)("i",{className:"fas fa-".concat(x)}),"\xa0",E]})),C&&(E=Object(h.jsxs)("span",{children:[Object(h.jsx)("i",{className:"material-icons",children:C}),"\xa0",E]})),Object(h.jsx)("button",Object(r.a)(Object(r.a)({},A),{},{disabled:o||S,onClick:I,className:"Button ".concat(t.className||""," ").concat(m?"ButtonPrimary":""," ").concat(g?"ButtonFlat":""," ").concat(l?"ButtonToggled":""," ").concat(p?"ButtonLarge":""," Purpose").concat(v),style:e,children:g?E:Object(h.jsx)(Uu,{fill:o||S?"#eee":m?"#8ECC95":l?"#c6c041":d||"#fff",borderPx:y||zu(2),paddingPx:w||{left:5,right:5,top:2,bottom:2},shadowPx:4,children:E})}))}function Qu(t){var e=t.className,n=t.icon,a=t.children,i=Object(Pu.a)(t,["className","icon","children"]);return Object(h.jsxs)(Vu,Object(r.a)(Object(r.a)({className:"".concat(void 0!==e?e:""," MaterialIconButton"),paddingPx:zu(3),borderPx:zu(3)},i),{},{children:[Object(h.jsx)("i",{className:"material-icons",children:n}),void 0!==a?Object(h.jsxs)("span",{children:["\xa0",a]}):null]}))}function qu(t){var e=t.className,n=t.icon,a=t.iconStyle,i=t.children,o=Object(Pu.a)(t,["className","icon","iconStyle","children"]);return Object(h.jsxs)(Vu,Object(r.a)(Object(r.a)({className:"".concat(void 0!==e?e:""," MaterialIconButton"),paddingPx:zu(3),borderPx:zu(3)},o),{},{children:[Object(h.jsx)("i",{className:"".concat("brand"===a?"fab":"regular"===a?"far":"fas"," fa-").concat(n)}),void 0!==i?Object(h.jsxs)("span",{children:["\xa0",i]}):null]}))}var Wu=n(7),Yu=(n(353),n(109)),Xu=n.n(Yu);n(354),n(355);n(356),n(359),n(360),n(361);var Ku,Ju=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){var t;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))).handleChange=function(e){t.props.onChange&&t.props.onChange(e.getValue())},t.handleKeyDown=function(e,n){t.props.onKeyDown&&t.props.onKeyDown(n)},t.container=null,t.codeMirror=void 0,t}return Object(p.a)(n,[{key:"componentDidMount",value:function(){if(this.container){var t=Xu()(this.container,Object(r.a)({value:this.props.value||""},this.props.options));t.on("change",this.handleChange),t.on("keydown",this.handleKeyDown),this.codeMirror=t}}},{key:"componentWillReceiveProps",value:function(t){var e=t.value||"";this.codeMirror&&this.codeMirror.getValue()!==e&&this.codeMirror.setValue(e)}},{key:"shouldComponentUpdate",value:function(t){return t.className!==this.props.className}},{key:"render",value:function(){var t=this;return Object(h.jsx)("div",{className:this.props.className,ref:function(e){return t.container=e}})}}]),n}(f.Component),Zu=n(25);n(362),n(363);!function(t){t[t.Normal=0]="Normal",t[t.Primary=1]="Primary",t[t.Floating=2]="Floating",t[t.Thin=3]="Thin"}(Ku||(Ku={}));var _u="rgba(31, 31, 33, 0.9)";var $u=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){return Object(l.a)(this,n),e.apply(this,arguments)}return Object(p.a)(n,[{key:"render",value:function(){var t=this,e=void 0===this.props.background||this.props.background,n=void 0===this.props.showCloseButton||this.props.showCloseButton,a=document.getElementById("PopupsContainer");return a?Zu.createPortal(Object(h.jsx)("div",{className:"Fader ".concat(this.props.fullscreen?"FaderPopupFullscreen":""),onClick:this.props.onClose,children:e?Object(h.jsxs)(Uu,{className:"Popup ".concat(this.props.className||""),fill:_u,onClick:function(t){return t.stopPropagation()},children:[n&&Object(h.jsx)(Qu,{icon:"clear",className:"ClosePopup",onClick:this.props.onClose,purpose:"ClosePopup"}),this.props.children]}):Object(h.jsxs)("div",{className:"Popup",onClick:function(t){return t.stopPropagation()},children:[n&&Object(h.jsx)(Qu,{icon:"clear",className:"ClosePopup",onClick:this.props.onClose,purpose:"ClosePopup"}),this.props.children]})}),a):(setTimeout((function(){return t.forceUpdate()}),0),null)}}]),n}(f.Component);n(364);function tl(t){return function(e){var n=e.children,a=e.className,i=void 0===a?"":a,r=e.style;return Object(h.jsx)("div",{className:"".concat(t," ").concat(i),style:r,children:n})}}var el=tl("Row"),nl=tl("Column"),al=(tl("Column Centered"),tl("Block")),il=(tl("Column Section"),tl("Block Section")),rl=(tl("SectionHeading"),tl("Column Scrollable")),ol=(tl("Row Scrollable"),tl("Row Items")),sl=tl("Column Items");tl("FloatList");tl("VerticalLeft"),tl("VerticalCentered"),tl("VerticalFill"),tl("HorizontalCentered"),tl("HorizontalLeft"),tl("HorizontalRight"),tl("HorizontalFill");var cl=tl("ScrollVertical");tl("ScrollBoth");function ul(t){var e=t.shaderErrors.slice().sort((function(t,e){return"FailedToCompileShader"===t.type&&"FailedToCompileShader"!==e.type?-1:"FailedToCompileShader"!==t.type&&"FailedToCompileShader"===e.type?1:0}))[0],n=f.useState(""),a=Object(u.a)(n,2),i=a[0],r=a[1],o=f.useState("FailedToCompileShader"===e.type?e.shaderSource:""),s=Object(u.a)(o,2),c=s[0],l=s[1],d="FailedToCompileShader"===e.type?e.shaderType:"vertex";return f.useEffect((function(){if("FailedToCompileShader"===e.type){var t=Lt($t,d,c);"ok"===t.result?r("OK!"):"FailedToCompileShader"===t.error.type?r(t.error.message):r(t.error.type)}}),[c,d,e.type]),f.useEffect((function(){l("FailedToCompileShader"===e.type?e.shaderSource:"")}),[e]),Object(h.jsx)($u,{fullscreen:!0,children:Object(h.jsxs)(el,{className:"ShaderDebugger",children:[Object(h.jsx)(Ju,{className:"ShaderDebuggerCode",value:c,onChange:l,options:{theme:"one-dark",mode:"clike",lineNumbers:!0}}),Object(h.jsx)(nl,{className:"ShaderDebuggerError",children:Object(h.jsx)("pre",{children:i})})]})})}var ll=f.createContext(null),hl=f.createContext(void 0);var fl=function(){function t(e){Object(l.a)(this,t),this.state=e,this.onChange=new b.a}return Object(p.a)(t,[{key:"update",value:function(t){this.state=Object(r.a)(Object(r.a)({},this.state),t),this.onChange.dispatch(this.state,t)}}]),t}();function dl(t,e){var n=f.useContext(t),a=f.useRef(e(n.state)),i=f.useState(a.current),r=Object(u.a)(i,2),o=r[0],s=r[1];return f.useEffect((function(){var t=function(t){var i=e(n.state);g.a.isEqual(a.current,i)||(a.current=i,s(i))};return n.onChange.attach(t),function(){n.onChange.detach(t)}}),[n,e]),o}function ml(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),a=1;a<e;a++)n[a-1]=arguments[a];var i=f.useCallback((function(t){return n.reduce((function(e,n){return Object(r.a)(Object(r.a)({},e),{},Object(G.a)({},n,t[n]))}),{})}),n);return dl(t,i)}n(365);var pl=f.createContext(void 0);function vl(t){var e=f.useContext(pl),n=f.useState(e?t(e.data):{}),a=Object(u.a)(n,2),i=a[0],r=a[1];return f.useEffect((function(){function n(n){var a=e?t(e.data):{};(function(t,e){for(var n=0,a=Object.keys(e);n<a.length;n++){var i=a[n];if(t[i]!==e[i])return!0}for(var r=0,o=Object.keys(t);r<o.length;r++){var s=o[r];if(t[s]!==e[s])return!0}return!1})(i,a)&&r(a)}return e&&e.events.dataChanged.attach(n),function(){e&&e.events.dataChanged.detach(n)}})),i}function gl(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return vl((function(t){return e.reduce((function(e,n){return Object(r.a)(Object(r.a)({},e),{},Object(G.a)({},n,t[n]))}),{})}))}function yl(){var t=f.useContext(pl),e=f.useState([]),n=Object(u.a)(e,2),a=n[0],i=n[1],r=f.useState(0),o=Object(u.a)(r,2),s=o[0],c=o[1],l=f.useState([]),d=Object(u.a)(l,2),p=d[0],v=d[1],g=f.useState(0),y=Object(u.a)(g,2),b=y[0],w=y[1],C=f.useState([]),x=Object(u.a)(C,2),A=x[0],O=x[1],j=f.useState(""),S=Object(u.a)(j,2),k=S[0],I=S[1];f.useEffect((function(){t&&v(new De(s).entities().get(t))}),[t,s]);var E=function(){if(t){var e=p[b];O(e?t.ecs.getAllEntityData(e,!1):[])}};f.useEffect(E,[t,b,p]);var T=function(){t&&i(t.ecs.archetypes.map((function(t){return{components:t.components.map((function(t){return t.name}))}})))};if(f.useEffect(T,[]),!t)return null;var R=k.split(",").map((function(t){return t.trim().toLowerCase()}));return Object(h.jsxs)(el,{className:"ECSInspector",style:{overflow:"hidden"},children:[Object(h.jsxs)(nl,{style:{maxWidth:300},children:[Object(h.jsx)(Vu,{onClick:T,children:"Update archetypes"}),Object(h.jsx)(rl,{children:Object(h.jsx)(nl,{children:a.map((function(t,e){return Object(h.jsx)(el,{children:Object(h.jsxs)(il,{children:[Object(h.jsxs)(Vu,{toggled:e===s,onClick:function(){return c(e)},children:[e,":"]}),t.components.join(", ")]})},e)}))})})]}),Object(h.jsx)(rl,{className:"ECSInspectorEntitiesColumn",children:Object(h.jsx)(nl,{children:p.map((function(t,e){return Object(h.jsx)(el,{children:Object(h.jsx)(Vu,{toggled:e===b,onClick:function(){return w(e)},children:JSON.stringify(t)})},e)}))})}),Object(h.jsxs)(nl,{style:{overflow:"hidden"},children:[Object(h.jsxs)(el,{style:{flexShrink:0},children:[Object(h.jsx)("input",{type:"text",className:"ECSInspectorComponentFilter",value:k,onChange:function(t){return I(t.target.value)}}),Object(h.jsx)(qu,{icon:"sync",onClick:function(){return E()}}),Object(h.jsx)(qu,{icon:"copy",onClick:function(){return navigator.clipboard.writeText(JSON.stringify(A,null,2))}})]}),Object(h.jsx)(rl,{children:Object(h.jsx)(nl,{children:A.filter((function(t){return function(t,e){if(0===e.length)return!0;var n,a=Object(m.a)(e);try{for(a.s();!(n=a.n()).done;){var i=n.value;if(-1!==t.toLowerCase().indexOf(i))return!0}}catch(Nt){a.e(Nt)}finally{a.f()}return!1}(t.component.name,R)})).map((function(t,e){var n=t.component,a=t.data;return Object(h.jsxs)(el,{children:[Object(h.jsx)(nl,{className:"ECSInspectorComponentName",children:n.name}),Object(h.jsx)(nl,{className:"ECSInspectorComponentValue",children:Object(h.jsx)("pre",{children:JSON.stringify(a,null,2)})})]},e)}))})})]})]})}function bl(t){if(!t)return!1;var e=t;return-1!==["input","select","textarea"].indexOf(e.tagName.toLowerCase())||"true"===e.contentEditable}function wl(t,e,n){return{theta:y.f(t.theta,e.theta,n),phi:y.f(t.phi,e.phi,n),radius:y.f(t.radius,e.radius,n)}}function Cl(t,e){return ln.distance(ln.fromSphericalCoordinates(t),ln.fromSphericalCoordinates(e))}function xl(t,e){return t.theta===e.theta&&t.phi===e.phi&&t.radius===e.radius}function Al(t){var e=t.target,n=t.speed,a=void 0===n?.1:n,i=t.stopAnimateDistance;return{target:e,speed:a,stopAnimateDistance:void 0===i?.001:i}}function Ol(t){var e=t.mix,n=t.distance,a=t.isEqual;return{create:function(t){return{current:t}},target:function(t){return void 0!==t.animate?t.animate.target:t.current},nextValue:function(t,a){if(void 0!==t.animate){var i=Al(t.animate),r=i.target,o=i.stopAnimateDistance,s=i.speed;return n(t.current,r)>o?{current:e(t.animate.target,t.current,Math.pow(1-s,60*a/1e3)),animate:t.animate}:{current:t.animate.target,animate:void 0}}return t},easeTo:function(t,e){var i;if(("object"!==typeof(i=e)||void 0===i.target)&&(e={target:e}),a(t.current,e.target))return t.animate?{current:e.target}:t;var r=Al(e),o=r.target,s=r.stopAnimateDistance;return n(t.current,o)<s?{current:e.target}:{current:t.current,animate:e}}}}var jl=Ol(a),Sl=Ol(ln),kl=Ol({mix:y.f,distance:function(t,e){return Math.abs(t-e)},isEqual:function(t,e){return t===e}});Ol(i);function Il(t){return"LookatView"===t.view.type?ln.length(ln.sub(t.view.eye,t.view.lookAt)):t.view.rotation.radius}function El(t){return"LookatView"===t.view.type?t.view.eye:ln.add(t.view.lookAt,ln.fromSphericalCoordinates(t.view.rotation))}function Tl(){return{fovy:27.8/360*Math.PI*2,angle:34/360*Math.PI*2,zrot:-Math.PI/2,keyboardPanSpeed:.001,panningFriction:.05,panningStopSpeed:2e-4,rotationSpeed:.01}}function Rl(t){var e=t.conf,n=void 0===e?Tl():e,a=f.useContext(pl),i=f.useContext(hl),o=f.useContext(ll);return f.useEffect((function(){if(a&&i){var t,e,s,c=a.data.worldSize,u={x:c.width/2,y:c.height/2},l=zc(u,10),h=Bc(u,10),f=function(t){return ln.fromSphericalCoordinates({theta:n.angle,phi:n.zrot,radius:t})},d={camera:{view:{type:"LookatView",lookAt:{x:0,y:0,z:0},eye:{x:10,y:10,z:10},up:{x:0,y:0,z:1},screenOffset:{x:0,y:0}},projection:{type:"Perspective",fovy:1,near:.1,far:30,aspectRatio:1}},isPanning:!1,position:jl.create({x:c.width/2,y:c.height/2}),elevation:kl.create(0),eyeMeasuredHeight:1,positionMeasuredHeight:1,navigationModeTilt:Sl.create(f(70)),slideVelocity:ln.zero(),slideTargetPosition:null,screenOffset:jl.create({x:0,y:0}),zoom:70},m=function(){if(!d.isPanning&&e){var t=w.b.clone(a.derived.cameraInvProjectionView),n=Dl(e,0,t,a.data.canvasRect),i=d.position.current;return!!n&&(d=Object(r.a)(Object(r.a)({},d),{},{panning:{originalInvViewProjection:t,originalMouseWorldPlaneIntersection:n,originalCameraPosition:i},slideTargetPosition:i}),!0)}},p=function(){d=Object(r.a)(Object(r.a)({},d),{},{slideTargetPosition:null,panning:void 0}),setTimeout((function(){d=Object(r.a)(Object(r.a)({},d),{},{isPanning:!1})}),10)},v=function(n){if(s){t=e,e={x:n.clientX,y:n.clientY},!s.ctrlKey&&n.ctrlKey?m():s.ctrlKey&&!n.ctrlKey&&p();var i=d.panning;if(i){var o=Dl(e,0,i.originalInvViewProjection,a.data.canvasRect),c=d.isPanning||Sc(zc(t,e))>3;o&&(d=Object(r.a)(Object(r.a)({},d),{},{isPanning:c,slideTargetPosition:Uc(Bc(i.originalCameraPosition,zc(i.originalMouseWorldPlaneIntersection,o)),l,h)}))}a.ensureRendered()}s=n},g=function(t){if(0===t.button){var e=m();document.addEventListener("mouseup",(function t(){document.removeEventListener("mouseup",t),e&&p()}))}},C=function(n){n.preventDefault(),n.stopImmediatePropagation(),t=e,e={x:n.clientX,y:n.clientY};var i=-("Win32"===window.navigator.platform?-.2*(n.deltaY<0?-1:1):-.005*n.deltaY)*a.derived.userSettingsOrFallback.mouseWheelSensitivity,o=Object(y.a)(d.zoom*(1+i),30,70);d=Object(r.a)(Object(r.a)({},d),{},{navigationModeTilt:{current:f(o)},zoom:o})},x=function(t){var e=function(t,e){var i=e.camera;if(e=Object(b.u)(e,{elevation:kl.easeTo(e.elevation,{target:e.positionMeasuredHeight})}),(e=Object(b.u)(e,{position:jl.nextValue(e.position,t),navigationModeTilt:Sl.nextValue(e.navigationModeTilt,t),screenOffset:jl.nextValue(e.screenOffset,t),elevation:kl.nextValue(e.elevation,t)})).slideTargetPosition){var o=zc(e.slideTargetPosition,e.position.current);e=Object(r.a)(Object(r.a)({},e),{},{slideVelocity:Gc(o,t)})}Sc(e.slideVelocity)>n.panningStopSpeed&&(e=Object(r.a)(Object(r.a)({},e),{},{position:{current:Bc(e.position.current,Nc(e.slideVelocity,t))},slideVelocity:Nc(e.slideVelocity,1-n.panningFriction)}),e=Object(r.a)(Object(r.a)({},e),{},{position:{current:Uc(e.position.current,l,h)}}));var s=e.navigationModeTilt.current,c=Object(b.u)(i.view.lookAt,Object(r.a)(Object(r.a)({},e.position.current),{},{z:e.elevation.current})),u=Object(b.u)(i.view.eye,ln.add(c,s));i=Object(b.u)(i,{view:Object(b.u)(i.view,{type:"LookatView",lookAt:c,eye:u,up:Object(b.u)(i.view.up,{x:0,y:0,z:1}),screenOffset:Object(b.u)(i.view.screenOffset,e.screenOffset.current)})});var f=e.eyeMeasuredHeight+5;return i.view.eye.z<f&&(i=Object(b.u)(i,{view:Object(b.u)(i.view,{eye:Object(b.u)(i.view.eye,{z:f})})})),i=Object(b.u)(i,{projection:Object(b.u)(i.projection,{type:"Perspective",fovy:n.fovy,near:.1,far:450,aspectRatio:a.data.canvasRect.width/a.data.canvasRect.height})}),Object(b.u)(e,{camera:i})}(t.delta,d);if(e!==d){var i=a.data.camera,o=a.ecs.getCpuComponentDataView(Dn.cpuComponent,i),s=a.ecs.getCpuComponentDataView(Pn.cpuComponent,i),c=a.ecs.getCpuComponentDataView(Fn.cpuComponent,i),u=w.b.create();w.b.lookAt(u,ln.toGlVec3(e.camera.view.eye),ln.toGlVec3(e.camera.view.lookAt),ln.toGlVec3(e.camera.view.up)),w.b.invert(u,u),w.b.getTranslation(o,u),w.b.getRotation(s,u),w.b.getScaling(c,u),a.ecs.setComponentData(ur.Fovy,i,new Float32Array([e.camera.projection.fovy])),a.ecs.setComponentData(ur.Near,i,new Float32Array([e.camera.projection.near])),a.ecs.setComponentData(ur.Far,i,new Float32Array([e.camera.projection.far])),d=e,a.ensureRendered()}},A=function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=Il(d.camera),i=n.keyboardPanSpeed*a,o=Object(r.a)({},El(d.camera));o.z=0;var s=Object(r.a)({},d.camera.view.lookAt);s.z=0;var c=Tc(zc(o,s)),u=qc(c),l=Bc(d.slideVelocity,Bc(Nc(u,i*t.x),Nc(c,i*t.y)));d=e?Object(r.a)(Object(r.a)({},d),{},{slideVelocity:l}):Object(r.a)(Object(r.a)({},d),{},{position:jl.create(Bc(d.position.current,l))})},O=function(t){if(!bl(t.target))switch(t.code){case"ArrowLeft":A({x:1,y:0});break;case"ArrowRight":A({x:-1,y:0});break;case"ArrowUp":A({x:0,y:-1});break;case"ArrowDown":A({x:0,y:1})}};return a.events.camera.attach(x),document.addEventListener("mousemove",v),document.addEventListener("mouseleave",v),document.addEventListener("keydown",O),o&&(o.addEventListener("mousedown",g),o.addEventListener("wheel",C)),x({delta:0}),function(){a.events.camera.detach(x),document.removeEventListener("mousemove",v),document.removeEventListener("mouseleave",v),document.removeEventListener("keydown",O),o&&(o.removeEventListener("mousedown",g),o.removeEventListener("wheel",C))}}}),[a,i,o]),null}function Dl(t,e,n,a){if(!n)return null;var i={x:t.x-a.left,y:t.y-a.top},r={x:0,y:0,width:a.width,height:a.height},o=Object(y.i)(n,r,i);return Object(y.h)(o,{normal:{x:0,y:0,z:1},distance:-e})}n(366),n(367);function Pl(t){return Object(r.a)({metatype:"struct"},t)}function Fl(){return{lightExponent:10,lightDirection:ln.normalize({x:-.1,y:1,z:.45}),diffuseColor:{r:30,g:101,b:168,a:1},diffuseStrength:1,ambientColor:{r:105,g:127,b:185,a:1},ambientStrength:1,worldPlaneColor:{r:178.755,g:148.92,b:61.71,a:1},skyColor:{r:68,g:112,b:155,a:1},fogColor:{r:245,g:244,b:235,a:1},sunColor:{r:255,g:255,b:255,a:1},sunFlareColor:{r:255,g:99,b:48,a:1},sunSize:.001,sunFlareSize:.09,sunFlareExponent:10,sunBorder:.001,skybox:!1,skyboxFogExponent:2,skyboxFogHeight:1,horizon:1.45,overheadBars:!0,clearColor:{r:245,g:244,b:235,a:1},fogDensity:.003,fogOffset:80}}var Bl=function t(){Object(l.a)(this,t),this.id=void 0,this.units=new Array(la).fill(void 0),this.unitCount=0,this.dbTeam=void 0,this.battlePoints=0,this.battleUnitsAlive=la,this.maxPossiblePoints=0,this.trainingStats=new lc,this.train=!0},Ml=function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{arenaCount:1};Object(l.a)(this,t),this.initConfig=e,this.layout=new ba(this.initConfig),this.gameInstance={type:"none"},this.battleground=na.DbBattleground.Solo,this.battleId="",this.battleResult=na.BattleWinner.Undecided,this.completeBattleRes=void 0,this.battlePostUpdateDone=!1,this.trainingRounds=0,this.worldSize=this.layout.worldSize,this.worldNCells=this.worldSize.width*this.worldSize.height,this.groundResolution=4,this.groundSize={width:Math.ceil(this.layout.worldSize.width/this.groundResolution),height:Math.ceil(this.layout.worldSize.height/this.groundResolution)},this.simulationStartTime=new Date,this.stepCounter=0,this.battleStartStep=0,this.roundResults=[],this.round=0,this.randomSeed=Math.random(),this.log=[],this.simulationPaused=!0,this.simulationEnded=!1,this.substep=0,this.simulationSpeed=1,this.turboMode=!1,this.teams={home:new Bl,away:new Bl},this.creaturesById={},this.ensureRenderNextLoop=!0,this.renderWorld=!0,this.physicsTimestep=1/60,this.previousMousePosition=void 0,this.mousePosition=void 0,this.mouseoverGround=void 0,this.canvasRect={left:0,top:0,width:1,height:1,right:0,bottom:0},this.fullscreen=!1,this.camera=void 0,this.cameraMode="rts",this.decisionHistogramView={left:0,top:0,width:1,height:1,right:0,bottom:0},this.sensesHistogramView={left:0,top:0,width:1,height:1,right:0,bottom:0},this.showDecisionsHistogram=!1,this.showSensesHistogram=!1,this.showDecisionsViz=!1,this.renderGazes=!1,this.gameLoopStats={stepsPerSecond:0,msPerFrame:0,runningTime:0},this.animationClips={},this.movement={crippledSlowdown:.8,uphillPunish:3},this.userControlEntity=void 0,this.userControlSet={},this.abilities=new Ro,this.showAbilitiesList=!1,this.rendererConfig=Fl(),this.renderArena=0,this.renderAllArenas=!1,this.roundStats=new pc,this.trainingConfig={weightsRenormalizationRate:0,elitismCount:10},this.unitBountiesEmpty=!0,this.arenaInfos=new Array(this.layout.arenas).fill(0).map((function(){return new $c})),this.toSaveCreatureBrains=[],this.autoStartNextTrainingRound=!0,this.trainingStats=new uc,this.showArenaList=!1,this.showBrainMemberIndex=-1,this.homeHealthColor=Object(b.w)(Object(b.y)(Ca)),this.awayHealthColor=Object(b.w)(Object(b.y)(xa)),this.manaColor=Object(b.w)(Object(b.y)(Aa)),this.aiCrowdLogo=!1,this.debugAudioEffectsPlaying=[]};function zl(t){return new Ml(t)}var Nl=function(){function t(e){Object(l.a)(this,t),this.state=e,this.maxGroundHeight=0}return Object(p.a)(t,[{key:"worldSize",get:function(){return Object(y.l)(this.state.data.worldSize)}},{key:"groundSize",get:function(){return Object(y.l)(this.state.data.groundSize)}},{key:"cameraView",get:function(){return this.state.ecs.getComponentData(Qn.cpuComponent,this.state.data.camera)}},{key:"cameraProjection",get:function(){return this.state.ecs.getComponentData(ur.Projection,this.state.data.camera)}},{key:"cameraProjectionView",get:function(){return this.state.ecs.getComponentData(ur.ProjectionView,this.state.data.camera)}},{key:"cameraInvProjectionView",get:function(){return this.state.ecs.getComponentData(ur.InvProjectionView,this.state.data.camera)}},{key:"generateGroundCellScaling",get:function(){return 1/this.groundSize.x*this.worldSize.x/1024}},{key:"sunlightDirection",get:function(){return ln.normalize(this.state.data.rendererConfig.lightDirection)}},{key:"renderLightDirection",get:function(){return this.state.data.rendererConfig.lightDirection}},{key:"simulationRunning",get:function(){return!this.state.data.simulationPaused&&!this.state.data.simulationEnded}},{key:"userSettingsOrFallback",get:function(){var t,e=null===(t=this.state.appState)||void 0===t?void 0:t.state.userSettings;return"loaded"===(null===e||void 0===e?void 0:e.status)?e.value:Object(na.defaultDbUserSettings)(nc.a.firestore.Timestamp.now())}},{key:"trainingSetup",get:function(){var t,e=null===(t=this.state.appState)||void 0===t?void 0:t.state.userSettings;if("loaded"===(null===e||void 0===e?void 0:e.status)){var n,a="train"===this.state.data.gameInstance.type?this.state.data.gameInstance.setupIndex:0;return null!==(n=e.value.trainingSetups[a])&&void 0!==n?n:Object(na.emptyTrainingSetup)()}return Object(na.emptyTrainingSetup)()}}]),t}(),Gl=n.p+"static/media/Image0000.e25d7315.exr",Hl=n.p+"static/media/Image0000.a88ec4c0.exr",Ll=n.p+"static/media/ArenaMap.67ee37db.glb",Ul=fr.fromPath(Ll),Vl=function(){function t(e){Object(l.a)(this,t),this.mapModel=e}return Object(p.a)(t,[{key:"createEntities",value:function(t){this.mapModel.createInstances(t,{beforeEntityCreated:function(t,e){return 0===t.name.indexOf("Mushroom")?void 0:e.removeComponent(Gn.component)}})}}]),t}(),Ql=Ul.then((function(t){return new Vl(t)})),ql=et.fromEXRUrl(Gl),Wl=et.fromEXRUrl(Hl),Yl=function(){function t(e,n,a,i){var r=this,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new cn(e);Object(l.a)(this,t),this.gls=e,this.initConfig=n,this.gameMap=a,this.appState=i,this.ecs=o,this.destroyed=!1,this.handleAppStateChange=function(t,e){e.creatures&&Xl(r)},this.random=new b.c,this.currentData=zl(this.initConfig),this.events={dataChanged:new b.a,step:new b.a,render:new b.a,camera:new b.a,roundEnd:new b.a},this.gameLoop=void 0,this.worldPow2Size=Object(y.j)(this.layout.worldSize),this.derived=new Nl(this),this.textures={heightmap:new ut(this.gls,this.gl.RGBA32F).init(),normalmap:new ut(this.gls,this.gl.RGBA32F).init(),sensesHistogram:new ut(this.gls,this.gl.RGBA32F,{width:ha,height:Object(b.q)(qo).length},8).init(),decisionsHistogram:new ut(this.gls,this.gl.RGBA32F,{width:ha,height:ua.length},8).init(),unitsReplay:lt.create(this.gls,this.gl.RGBA32F,{width:aa,height:ha},yu).init(),decisionsViz:lt.create(this.gls,this.gl.R32F,{width:24,height:ha*ua.length}).init()},this.samplers={heightmap:{linear:new Qt(this.textures.heightmap,ee.Linear)}},this.unitsInArena=new Me([jn.cpuComponent,Sn.cpuComponent,Ba.component]).lookupTable(ha,(function(t,e){return{row:t.ecs.getComponentData(jn.cpuComponent,e)[0],column:t.ecs.getComponentData(Sn.cpuComponent,e)[0]}})),this.unitsInArenaGpu=this.unitsInArena.toGpu(this.gls),this.animationInterpolators={};for(var s=0,c=Object.keys(this.textures);s<c.length;s++){var u=c[s];this.textures[u].name=u}this.gameMap&&this.gameMap.createEntities(this);for(var h=0;h<this.layout.arenas;h++)this.ecs.createEntities((new $e).setComponents(In.components,new Float32Array([h])));this.setData({camera:lr(this)}),i&&i.onChange.attach(this.handleAppStateChange),console.log("[GpuWorldState] Map entities created")}return Object(p.a)(t,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];dt(this.textures),t&&this.ecs.destroy(),this.unitsInArenaGpu.destroy(),this.textures=void 0;for(var e=0,n=Object.keys(this.events);e<n.length;e++){var a=n[e];this.events[a].listeners=[]}this.appState&&this.appState.onChange.detach(this.handleAppStateChange),this.destroyed=!0}},{key:"setData",value:function(t){var e=this.currentData;this.currentData=Object(r.a)(Object(r.a)({},this.currentData),t),this.events.dataChanged.dispatch({type:"DataChanged",before:e,after:this.currentData,change:t})}},{key:"nextStep",value:function(){var t=this;return new Promise((function(e){t.events.step.attach((function n(){t.events.step.detach(n),e()}))}))}},{key:"nextStepIfRunning",value:function(){var t=Object(c.a)(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.derived.simulationRunning){t.next=3;break}return t.next=3,this.nextStep();case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"updateTeam",value:function(t,e){this.setData({teams:Object(r.a)(Object(r.a)({},this.data.teams),{},Object(G.a)({},t,Object(r.a)(Object(r.a)({},this.data.teams[t]),e)))})}},{key:"log",value:function(t,e){var n=this.data.log.length;return this.setData({log:[].concat(Object(mt.a)(this.data.log),[{time:new Date,step:this.data.stepCounter,category:t,message:"string"===typeof e?[e]:e}])}),n}},{key:"updateLogPart",value:function(t,e,n){var a=Object(mt.a)(this.data.log);a[t]={time:new Date,step:a[t].step,category:a[t].category,message:Object(b.h)(a[t].message,e,n)},this.setData({log:a})}},{key:"ensureRendered",value:function(){this.data.ensureRenderNextLoop||this.setData({ensureRenderNextLoop:!0})}},{key:"gl",get:function(){return this.gls.gl}},{key:"data",get:function(){return this.currentData}},{key:"worldSize",get:function(){return this.layout.worldSize}},{key:"layout",get:function(){return this.data.layout}}],[{key:"createWithMap",value:function(){var e=Object(c.a)(s.a.mark((function e(n,a,i,r){var o,c,u;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.t1=n,e.t2=a,e.next=5,Ql;case 5:return e.t3=e.sent,e.t4=i,e.t5=r,o=new e.t0(e.t1,e.t2,e.t3,e.t4,e.t5),e.next=11,ql;case 11:return c=e.sent,e.next=14,Wl;case 14:return u=e.sent,o.textures.heightmap.loadImage(c),o.textures.normalmap.loadImage(u),e.abrupt("return",o);case 18:case"end":return e.stop()}}),e)})));return function(t,n,a,i){return e.apply(this,arguments)}}()}]),t}();function Xl(t){for(var e,n=null===(e=t.appState)||void 0===e?void 0:e.state.creatures,a=!0,i=function(e){var i=e<la?t.data.teams.home.units[e]:t.data.teams.away.units[e-la],r=new Me([za.component]).filterValue(Sn.cpuComponent,(function(t){return t[0]===e}),(function(){return[]})).get(t);if(i&&"creature"===i.type&&n&&"loaded"===n.status){var o=n.values.find((function(t){return t.id===i.id}));if(o&&o.bounties)for(var s=0,c=Object.keys(o.bounties);s<c.length;s++){var u,l=c[s],h=Object(m.a)(r);try{for(h.s();!(u=h.n()).done;){var f,d,p=u.value;t.ecs.setComponentData(bi[l].component,p,[null!==(f=null===(d=o.bounties)||void 0===d?void 0:d[l])&&void 0!==f?f:0])}}catch(Nt){h.e(Nt)}finally{h.f()}a=!1}}},r=0;r<2*la;r++)i(r);t.setData({unitBountiesEmpty:a})}var Kl=function(){function t(){Object(l.a)(this,t),this.queue=[],this.running=!1}return Object(p.a)(t,[{key:"processNextJob",value:function(){var t=Object(c.a)(s.a.mark((function t(){var e;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this.queue.shift()){t.next=4;break}return this.running=!1,t.abrupt("return");case 4:return t.next=6,e();case 6:this.processNextJob();case 7:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"runJob",value:function(t){var e=this;return new Promise((function(n){e.queue.push(Object(c.a)(s.a.mark((function e(){var a;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t();case 2:a=e.sent,n(a);case 4:case"end":return e.stop()}}),e)})))),e.running||(e.running=!0,e.processNextJob())}))}}]),t}(),Jl=n.p+"static/media/UnitMarker.9ab9cf37.glb",Zl=fr.fromPath(Jl),_l=function t(){Object(l.a)(this,t),this.createAbilities=!0,this.createBrain=!1,this.bounties=void 0,this.profiler=void 0},$l=na.BountyDefs.reduce((function(t,e){return Object(r.a)(Object(r.a)({},t),{},Object(G.a)({},e.key,e.emptyValue))}),{});function th(t){if(t){var e,n=na.Items[t];return null!==(e=Yo[n.ability])&&void 0!==e?e:Yo.None}return Yo.None}function eh(t){return Array.isArray(t)?new Float32Array(t):new Float32Array(t.toUint8Array().buffer)}function nh(t,e){return ah.apply(this,arguments)}function ah(){return(ah=Object(c.a)(s.a.mark((function t(e,n){var a,i,o,c,u,l,h,f,d,p,v,g,y,w,C,x,A,O,j,S,k,I,E,T,R,D,P,F,B,M,z,N,G,H,L,U,V,Q,q,W,Y,X,K,J,Z,_,$,tt,et,nt,at,it,rt,ot,st,ct,ut,lt,ht,ft,dt,mt,pt,vt,gt,yt,bt,wt,Ct,xt,At,Ot,jt,St,kt=arguments;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:v=kt.length>2&&void 0!==kt[2]?kt[2]:new _l,g=n[0].unit.type,null===(a=v.profiler)||void 0===a||a.enter("createUnits(".concat(g,", ").concat(n.length,")")),y=n.length,w=(new $e).setComponent(Fa,{unit:n[0].unit}).setComponent(Ba.component).setComponents(jn.components).setComponents(Sn.components).setComponent(si,{stepLength:2.1}).setComponent(Ka).setComponent(Xa).setComponent(Ea.component).setComponent(Ta,ta.HomeTeam).setComponent(li.component).setComponent(hi.component,[12]).setComponent(fi.component,[.15]).setComponent(ci,{value:"flesh"}).setComponent(Na.component).setComponent(Ln.gpuComponent).setComponent(Qi,{entityLookup:{},clipNames:{}}).setComponent(Vi,{actions:[{clip:ra[ra.Idle1],positionType:"startTime",positionValue:0,looping:!0}]}).setComponent(En,!1).setComponent(Ga,!1).setComponent(Dn.gpuComponent,[new Float32Array([0,0,0,0])]).setComponent(Bn.component,[0]).setComponent(ri.component,[-1,-1]).setComponent(oi.component,[1]).setComponent(ui,{playing:{}}).setComponent(Sa.component,[ja]).setComponent(Ia.component,[ka]).setComponent(Ya.component,[ja]).setComponent(_a.component,[ja]).setComponent($a.component,[-1]).setComponent(ei.component,[-1,-1]).setComponent(ni.component).setComponent(ir.component).setComponent(Ki.component).setComponent(Ji.component).setComponent(Ds.component).setComponent(mi.component,[new Float32Array([0,0,0,0])]).setComponent(vi.component,[new Float32Array([1,0,0,0])]).setComponent(pi.component,[new Float32Array([0,0,0,0])]).setComponent(gi.component).setComponent(di.component).setComponent(Ja.component).setComponent(Za.component),C=Object(m.a)(Qs);try{for(C.s();!(x=C.n()).done;)A=x.value,w=w.setComponent(A.component)}catch(Nt){C.e(Nt)}finally{C.f()}for(O=0,j=Object.keys(yi);O<j.length;O++)S=j[O],w=w.setComponent(yi[S].component);for(k=0,I=Object.keys(Jo);k<I.length;k++)E=I[k],w=w.setComponent(Jo[E].component);T=new b.a,t.t0=g,t.next="creature"===t.t0?13:"statue"===t.t0?52:56;break;case 13:for(w=w.setComponent(za.component).setComponent(Ma.component).setComponent(Ra.component).setComponent(Ko.component).setComponent(di.component).setComponent(vs.component),"gym"===e.data.gameInstance.type&&(w=w.setComponent(ys.component)),v.createBrain&&(w=w.setComponent(ac.component).setComponent(ic.component).setComponent(ds.weights.component).setComponent(ds.biases.component).setComponent(ds.res.component).setComponent(fs.weights.component).setComponent(fs.biases.component).setComponent(fs.res.component).setComponent(ms.weights.component).setComponent(ms.biases.component).setComponent(ms.res.component)),F=0,B=Object.keys(bi);F<B.length;F++)N=B[F],w=w.setComponent(bi[N].component,[null!==(M=null===(z=v.bounties)||void 0===z?void 0:z[N])&&void 0!==M?M:$l[N]]);R=e.ecs.createEntities(w.setComponent(Vn.component,pn(vn(gn(Math.PI/2)))).setComponent(Ha.component).setComponent(La.component).setComponent(Ua.component).setComponent(Va.component).setComponent(Qa.component).setComponent(qa.component),y),G=[ds.weights.component,ds.biases.component,fs.weights.component,fs.biases.component,ms.weights.component,ms.biases.component],H=0;case 20:if(!(H<n.length)){t.next=28;break}if("creature"===(L=n[H].unit).type){t.next=24;break}throw new Error("All units in batch need to be of the same type");case 24:if(n[H].uploadBrain)for(X=[null===(U=L.brain)||void 0===U?void 0:U.hiddenLayerWeights,null===(V=L.brain)||void 0===V?void 0:V.hiddenLayerBiases,null===(Q=L.brain)||void 0===Q?void 0:Q.memoryLayerWeights,null===(q=L.brain)||void 0===q?void 0:q.memoryLayerBiases,null===(W=L.brain)||void 0===W?void 0:W.outputLayerWeights,null===(Y=L.brain)||void 0===Y?void 0:Y.outputLayerBiases],K=0;K<G.length;K++)X[K]&&e.ecs.setComponentData(G[K],R.getIndex(H),eh(X[K]));case 25:H++,t.next=20;break;case 28:if(!v.createAbilities){t.next=38;break}null===(J=v.profiler)||void 0===J||J.enter("createAbilities"),_=s.a.mark((function t(a){var i,r,o,c;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("creature"===(i=n[a].unit).type){t.next=3;break}throw new Error("All units in batch need to be of the same type");case 3:r=new Array(3).fill(0).map((function(t,e){return th(i.slots[e])})),e.ecs.setComponentData(Ko.component,R.getIndex(a),r),o=0;case 6:if(!(o<3)){t.next=15;break}if(!i.slots[o]||r[o]===Yo.None){t.next=12;break}if(!na.Items[i.slots[o]]){t.next=12;break}return t.next=12,zo(e,R.getIndex(a),null!==(c=n[a].arenaIndex)&&void 0!==c?c:0,r[o],T.transform((function(t){return[t.getIndex(a)]})));case 12:o++,t.next=6;break;case 15:case"end":return t.stop()}}),t)})),$=0;case 32:if(!($<n.length)){t.next=37;break}return t.delegateYield(_($),"t1",34);case 34:$++,t.next=32;break;case 37:null===(Z=v.profiler)||void 0===Z||Z.exit();case 38:null===(D=v.profiler)||void 0===D||D.enter("setBounties"),tt=0;case 40:if(!(tt<n.length)){t.next=50;break}if(e.ecs.setComponentData(Ra.component,R.getIndex(tt),null!==(et=n[tt].gymIndex)&&void 0!==et?et:[-1,-1]),"creature"===(nt=n[tt].unit).type){t.next=45;break}throw new Error("All units in batch need to be of the same type");case 45:if(at=nt.bounties)for(it=0,rt=Object.keys(at);it<rt.length;it++)ot=rt[it],e.ecs.setComponentData(bi[ot].component,R.getIndex(tt),[at[ot]]);case 47:tt++,t.next=40;break;case 50:return null===(P=v.profiler)||void 0===P||P.exit(),t.abrupt("break",77);case 52:for(w=w.setComponent(Vn.component,pn(vn(gn(Math.PI/2)))).removeComponent(di.component).removeComponent(ri.component).removeComponent(mi.component).removeComponent(li.component).removeComponent(Ja.component).removeComponent(Za.component).setComponent(ci,{value:"statue"}),st=0,ct=Object.keys(Jo);st<ct.length;st++)ut=ct[st],w=w.removeComponent(Jo[ut].component);return R=e.ecs.createEntities(w,y),t.abrupt("break",77);case 56:if(w=w.setComponent(Ma.component),"scarecrow"===g)for(w=w.removeComponent(di.component).removeComponent(ri.component).removeComponent(mi.component).removeComponent(li.component).setComponent(ci,{value:"wood"}),lt=0,ht=Object.keys(Jo);lt<ht.length;lt++)ft=ht[lt],w=w.removeComponent(Jo[ft].component);else w=w.setComponent(Vn.component,pn(vn(gn(Math.PI/2)))),w="duck"===g?w.setComponent(ii.component):"turtle"===g?w.setComponent(ai.component).setComponent(Ko.component,[Yo.Pistol,Yo.None,Yo.None]).setComponent(si,{stepLength:.7}).setComponent(hi.component,[1.5]).setComponent(fi.component,[.03]):w.setComponent(ai.component).setComponent(Ko.component,[Yo.Talons,Yo.None,Yo.None]).setComponent(fi.component,[.07]);if(R=e.ecs.createEntities(w.setComponent(qa.component),y),"turtle"!==g){t.next=69;break}dt=s.a.mark((function t(a){var i;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,zo(e,R.getIndex(a),null!==(i=n[a].arenaIndex)&&void 0!==i?i:0,Yo.Pistol,T.transform((function(t){return[t.getIndex(a)]})));case 2:case"end":return t.stop()}}),t)})),mt=0;case 62:if(!(mt<n.length)){t.next=67;break}return t.delegateYield(dt(mt),"t2",64);case 64:mt++,t.next=62;break;case 67:t.next=77;break;case 69:if("crab"!==g){t.next=77;break}pt=s.a.mark((function t(a){var i;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,zo(e,R.getIndex(a),null!==(i=n[a].arenaIndex)&&void 0!==i?i:0,Yo.Talons,T.transform((function(t){return[t.getIndex(a)]})));case 2:case"end":return t.stop()}}),t)})),vt=0;case 72:if(!(vt<n.length)){t.next=77;break}return t.delegateYield(pt(vt),"t3",74);case 74:vt++,t.next=72;break;case 77:for(null===(i=v.profiler)||void 0===i||i.enter("setProps"),gt=0;gt<y;gt++)e.ecs.setComponentData(Fa,R.getIndex(gt),{unit:n[gt].unit}),e.ecs.setComponentsData(jn.components,R.getIndex(gt),new Float32Array([null!==(yt=n[gt].arenaIndex)&&void 0!==yt?yt:0])),e.ecs.setComponentsData(Sn.components,R.getIndex(gt),new Float32Array([null!==(bt=n[gt].arenaMemberIndex)&&void 0!==bt?bt:0])),Ct=null!==(wt=n[gt].team)&&void 0!==wt?wt:ta.HomeTeam,e.ecs.setComponentData(Ea.component,R.getIndex(gt),[Ct]),e.ecs.setComponentData(Ta,R.getIndex(gt),Ct),xt=Ct===ta.HomeTeam?e.data.teams.home.unitCount:e.data.teams.away.unitCount,e.ecs.setComponentData(Na.component,R.getIndex(gt),["statue"===g?da:fa/(xt-1)]);return null===(o=v.profiler)||void 0===o||o.exit(),null===(c=v.profiler)||void 0===c||c.enter("createUnitMarker"),t.next=83,Zl;case 83:for(At=t.sent,null===(u=v.profiler)||void 0===u||u.enter("createModels"),Ot=At.createInstances(e,{count:y,rootEntityInit:(new $e).setComponent(Un.component,pn(fn())).setComponent(Gn.component).setComponent(Hn[0]).setComponents(jn.components,new Float32Array([-1])),localToParentStartOrder:1,onMaterial:function(t,e){var a=.4,i=n[e].unit;return"UnitMaterial"===t.name?Object(b.A)("creature"===i.type?Object(r.a)(Object(r.a)({},Object(b.y)(i.primaryColor)),{},{a:a}):"duck"===i.type?{r:255,g:255,b:255,a:a}:"crab"===i.type?{r:255,g:0,b:0,a:a}:"turtle"===i.type?{r:0,g:255,b:0,a:a}:"scarecrow"===i.type?{r:217,g:203,b:98,a:a}:"statue"===i.type?{r:200,g:200,b:200,a:a}:{r:0,g:0,b:0,a:a}):n[e].team===ta.HomeTeam?{x:90/255,y:110/255,z:83/255,w:a}:{x:163/255,y:84/255,z:73/255,w:a}}}),null===(l=v.profiler)||void 0===l||l.exit(),null===(h=v.profiler)||void 0===h||h.enter("setTransformParent"),jt=0;jt<y;jt++)St=R.getIndex(jt),e.ecs.setComponentData(Gn.component,Ot.roots.getIndex(jt),[Object(r.a)(Object(r.a)({},St),{},{z:0,w:0})]);return null===(f=v.profiler)||void 0===f||f.exit(),null===(d=v.profiler)||void 0===d||d.exit(),T.dispatch(R),null===(p=v.profiler)||void 0===p||p.exit(),t.abrupt("return",R);case 94:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var ih=n.p+"static/media/PlayerUnit.7dc5de54.glb",rh=n.p+"static/media/Scarecrow.32a50840.glb",oh=n.p+"static/media/Duck.1df0709b.glb",sh=n.p+"static/media/Crab.5939a931.glb",ch=n.p+"static/media/Turtle.445eabc4.glb",uh=n.p+"static/media/Statue.69f42e25.glb",lh=new b.b((function(){return fr.fromPath(ih)})),hh=new b.b((function(){return fr.fromPath(rh)})),fh=new b.b((function(){return fr.fromPath(oh)})),dh=new b.b((function(){return fr.fromPath(sh)})),mh=new b.b((function(){return fr.fromPath(ch)})),ph=new b.b((function(){return fr.fromPath(uh)}));function vh(t,e){return gh.apply(this,arguments)}function gh(){return(gh=Object(c.a)(s.a.mark((function t(e,n){var a,i,r,o;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=e.unitsInArena.get(e),i=Object(m.a)(a.rows[n].entities),t.prev=2,i.s();case 4:if((r=i.n()).done){t.next=11;break}if(!((o=r.value).x>=0)){t.next=9;break}return t.next=9,wh(e,o);case 9:t.next=4;break;case 11:t.next=16;break;case 13:t.prev=13,t.t0=t.catch(2),i.e(t.t0);case 16:return t.prev=16,i.f(),t.finish(16);case 19:case"end":return t.stop()}}),t,null,[[2,13,16,19]])})))).apply(this,arguments)}function yh(t){return bh.apply(this,arguments)}function bh(){return(bh=Object(c.a)(s.a.mark((function t(e){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.t0=e.type,t.next="creature"===t.t0?3:"statue"===t.t0?6:"scarecrow"===t.t0?9:"crab"===t.t0?12:"duck"===t.t0?15:"turtle"===t.t0?18:21;break;case 3:return t.next=5,lh.value;case 5:return t.abrupt("return",t.sent);case 6:return t.next=8,ph.value;case 8:return t.abrupt("return",t.sent);case 9:return t.next=11,hh.value;case 11:return t.abrupt("return",t.sent);case 12:return t.next=14,dh.value;case 14:return t.abrupt("return",t.sent);case 15:return t.next=17,fh.value;case 17:return t.abrupt("return",t.sent);case 18:return t.next=20,mh.value;case 20:return t.abrupt("return",t.sent);case 21:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function wh(t,e){return Ch.apply(this,arguments)}function Ch(){return(Ch=Object(c.a)(s.a.mark((function t(e,n){var a,i,r,o,c,l,h,f,d,m,p,v,g,y;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=e.ecs.getComponentData(Fa,n).unit,t.next=3,yh(a);case 3:if(i=t.sent,!e.ecs.getComponentData(Ga,n)){t.next=7;break}return t.abrupt("return",i);case 7:return e.ecs.setComponentData(Ga,n,!0),t.next=10,wr(e,on.fromEntity(n));case 10:if("creature"!==a.type){t.next=17;break}for(r=[],i.createInstances(e,{rootEntities:on.fromEntity(n),beforeEntityCreated:function(t,e){return 0===t.name.indexOf("Item")?0===t.name.indexOf("Item".concat(a.slots[0]))||0===t.name.indexOf("Item".concat(a.slots[1]))||0===t.name.indexOf("Item".concat(a.slots[2]))?e:void 0:0===t.name.indexOf("StyleEars")?0===t.name.indexOf("StyleEars00".concat(a.ears))?e:void 0:0===t.name.indexOf("StyleEyes")?0===t.name.indexOf("StyleEyes00".concat(a.eyes))?e:void 0:0===t.name.indexOf("StyleBackSpikes")?0===t.name.indexOf("StyleBackSpikes00".concat(a.backSpikes))?e:void 0:e},afterEntityCreated:function(t,e){var n=e.getIndex(0);"TailEnd"===t.name?r.push([Ha.component,[n.x,n.y]]):"Back"===t.name?r.push([La.component,[n.x,n.y]]):"Head"===t.name?r.push([Ua.component,[n.x,n.y]]):"HandL"===t.name?r.push([Va.component,[n.x,n.y]]):"HandR"===t.name?r.push([Qa.component,[n.x,n.y]]):"ProjectileAttachment"===t.name&&r.push([qa.component,[n.x,n.y]])},onMaterial:function(t){return"Primary"===t.name?Object(b.x)(Object(b.y)(a.primaryColor)):"Secondary"===t.name?Object(b.x)(Object(b.y)(a.secondaryColor)):void 0},visible:!1}),o=0,c=r;o<c.length;o++)l=Object(u.a)(c[o],2),h=l[0],f=l[1],e.ecs.setComponentData(h,n,f);return t.abrupt("return",i);case 17:if("statue"!==a.type){t.next=22;break}return i.createInstances(e,{rootEntities:on.fromEntity(n),visible:!1}),t.abrupt("return",i);case 22:for(d=[],i.createInstances(e,{rootEntities:on.fromEntity(n),afterEntityCreated:function(t,e){var n=e.getIndex(0);"ProjectileAttachment"===t.name&&d.push([qa.component,[n.x,n.y]])},visible:!1}),m=0,p=d;m<p.length;m++)v=Object(u.a)(p[m],2),g=v[0],y=v[1],e.ecs.setComponentData(g,n,y);return t.abrupt("return",i);case 26:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var xh=function(){function t(e,n){var a=this;Object(l.a)(this,t),this.canvas=e,this.gl=n,this.loopRunning=!1,this.renderLoop=function(){a.loopRunning&&(window.requestAnimationFrame(a.renderLoop),a.state.setData({stepCounter:a.state.data.stepCounter+1}),Es(a.state),a.renderer.render(a.state))},this.gls=new _t(this.canvas,this.gl),this.state=new Yl(this.gls,{arenaCount:1}),this.renderer=new Is(this.gls),this.jobQueue=new Kl,this.dataUrlCache={},this.state.setData({rendererConfig:Object(r.a)(Object(r.a)({},Fl()),{},{skybox:!1,overheadBars:!1,clearColor:{r:0,g:0,b:0,a:0}}),renderArena:0})}return Object(p.a)(t,[{key:"startRenderLoop",value:function(){this.loopRunning=!0,this.renderLoop()}},{key:"stopRenderLoop",value:function(){this.loopRunning=!1,this.renderLoop()}},{key:"renderOnce",value:function(){var t=Object(c.a)(s.a.mark((function t(){var e,n=arguments;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=n.length>0&&void 0!==n[0]?n[0]:{width:480,height:480},this.canvas.width=e.width,this.canvas.height=e.height,this.state.setData({canvasRect:{left:0,top:0,bottom:0,right:0,width:this.canvas.width,height:this.canvas.height}}),this.renderer.render(this.state);case 5:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"setUnit",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.state.ecs.removeAllEntities(),t.next=3,nh(this.state,[{unit:e}],Object(r.a)(Object(r.a)({},new _l),{},{createAbilities:!1}));case 3:return n=t.sent,t.next=6,wh(this.state,n.getIndex(0));case 6:return a=t.sent,this.state.setData({camera:a.createCamera(this.state)}),t.abrupt("return",n.getIndex(0));case 9:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"renderToDataURL",value:function(t,e){var n=this,a=JSON.stringify({unit:t,canvasSize:e});return this.dataUrlCache[a]?this.dataUrlCache[a]:this.dataUrlCache[a]=this.jobQueue.runJob(Object(c.a)(s.a.mark((function a(){return s.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,n.setUnit(t);case 2:return a.next=4,n.renderOnce(e);case 4:return n.gl.finish(),a.abrupt("return",n.canvas.toDataURL());case 6:case"end":return a.stop()}}),a)}))))}},{key:"renderToBlob",value:function(t,e){var n=this;return this.jobQueue.runJob(Object(c.a)(s.a.mark((function a(){return s.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,n.setUnit(t);case 2:return a.next=4,n.renderOnce(e);case 4:return n.gl.finish(),a.next=7,new Promise((function(t){return n.canvas.toBlob((function(e){return t(e)}))}));case 7:return a.abrupt("return",a.sent);case 8:case"end":return a.stop()}}),a)}))))}},{key:"renderToCanvas",value:function(){var t=Object(c.a)(s.a.mark((function t(e,n,a){var i;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.setUnit(n);case 2:return t.next=4,this.renderOnce(a);case 4:this.gl.finish(),(i=e.getContext("2d")).clearRect(0,0,e.width,e.height),i.drawImage(this.canvas,0,0);case 8:case"end":return t.stop()}}),t,this)})));return function(e,n,a){return t.apply(this,arguments)}}()}],[{key:"create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.createElement("canvas"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{desynchronized:!0},a=e.getContext("webgl2",n);if(a&&0===M(a).length)return new t(e,a)}}]),t}(),Ah=xh.create(),Oh=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){var t;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))).state={},t.imgRef=d.a.createRef(),t}return Object(p.a)(n,[{key:"componentDidMount",value:function(){this.renderPortrait()}},{key:"componentDidUpdate",value:function(t){this.props.unit!==t.unit&&this.renderPortrait()}},{key:"renderPortrait",value:function(){var t=this,e=this.props,n=e.renderer,a=void 0===n?Ah:n,i=e.unit;a&&a.renderToDataURL(i).then((function(e){return t.setState({img:e})}))}},{key:"render",value:function(){return Object(h.jsx)("img",{className:"PixlingPortrait",alt:"Portrait",src:this.state.img||this.props.fallbackPortrait||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAYAAACAvzbMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAtSSURBVHgB7d3dVVVJGsfhgjYAMxg7A0Ng0ADsCMQI6I6gJYKRCEYiGO8VZ4dgCE4G3ss5TG3n4CjNx+E9+6N21fOsxYK1uq/6g5/sP7sqJQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIq1l4BRPH/+/CB/+vPy8vLzarU66bruc4KKCAgM6ODg4PGjR4+O9vb2jnM4nlz7y28uLi5OhYRaCAgMYBOO4/zl7/nj8W1/Xw7Lt59GPn78+DbBwgkI7CCH40kOx8t0Tziu60OSP/32/v37TwkWSkAg4GrfyB8HaQf5Mddb+whLJSDwAEOF4wavP3z4cJJgQQQE7tHvG/v7+y/yR/+o6iCNxD7C0ggI3GLbYXwE3cXFxSuPtSidgMA1M4bjJ/YRSicgsNHvG/mb9sv8KOkoFcJjLUomIDRvxGF8MH1I1uv1H+fn5+8SFEJAaNbh4eHR2MP40DzWoiQCQlNK2TcG8HpzLMqXBDMREJpQUTi+s48wNwGhajkcTzdHjRylSsJxXR+Sr1+//t1jLaYmIFRpCcP40OwjTE1AqEqL4fhR/9NIHxLHojAFAWHx7rmDo0n2EaYgICxWjcP40DzWYkwCwuJs7uDow3GUhGNbbkNkcALCYrS+b+zKYy2GJiAUTziG5TZEhiIgFOlqGM9f9u9wPE0Mzj7CrgSEohjGZ+E2REIEhCIIx7zsI0QICLPa3MFxnL+BvUiUwG2IbE1AmIVhvGz2EbYhIExqiXdwtMpjLe4jIIzOvrFsbkPkNgLCaISjLh5rcZ2AMLjNMP4y/8n1KFEjtyHyjYAwGMN4O+wj9ASEnQlHu9yG2DYBIeRq3+gfU7mDA/tImwSEBzGMc4d+E3njWJR2CAhbcQcH27KPtENAuJN9gx28u7i4+MNjrXoJCDcSDgbkNsRKCQjfXd3BkR9BHBvGGZLHWnUSEAzjTMZtiHURkIZthvH+YEPhYFJ+7bcOAtIg+wYFcRvigglIQ4SDEtlHlktAKtfvG/v7+y/cwUHpckg+ff369TePtZZDQCplGGep7CPLISCVEQ5q0D/WyiE5zfvIm0SxBKQS7uCgRvaRsgnIwhnGaYHHWmUSkIU6PDw8MozToP42xDMhKYOALIh9AzzWKomALIBwwF+5DXF+AlKwHI6nm6NGjpJwwI3sI/MRkAIZxuHB3IY4AwEpiHDAbuwj0xKQmbmDA0bhNsQJCMhMDOMwPvvIuARkYps7OPpwHCXhgNF5rDUeAZmIfQPmtTlf61Ue2rvEIARkZMIBZfFYazgCMoKrYTx/2b/D8TQBJXIb4o4EZECGcVgW+8huBGQAwgHL5jbEGAHZweYOjuP8H9+LBCyefeRhBCTAMA71chvi9gTkAdzBAe2wj9xPQO5h34C2eax1OwG5hXAA17gN8RoBuWYzjL/MP74eJYAfeKz1MwHZMIwD23Ib4v80HxDhAKJa30eaDMjVvtE/pnIHB7CjZm9DbCoghnFgLC3uI00ExB0cwISauQ2x6oDYN4C5tLCPPEp1+3cCmEG/seYnH//JX75OldpPABAgIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQIiAABAiIACECAgAIQICQEjVAbm8vPycAGaQv/98yR+fUsWqDsj5+fmv6/X6lZAAU+nDkT+drFarX/P3oHepYnupEYeHh7/v7e0d548nCWBg/R9U8/eXs4uLizdd131JDWgmIL2Dg4Mnv/zyy+v8L/llAhhAH478cfLx48e3qTFNBeSKkAAD6PLHyYcPH7rUqCYDciWH5GkOyb881gIeoEuNh+NK0wG5kveRoxyRP4UEuEOXhOMnAvIDQztwgy4Jx40E5Br7CNDLw/jb/reqhON2AnILIYH2bN7hOFutVv2v4n5O3ElA7mFoh/r14cj/j5+29A7HEARkS4Z2qI9w7EZAHsjQDssnHMMQkAD7CCyTcAxLQHYgJLAMV8eNrNfrd8IxHAEZgKEditXlaJy1eE7VFARkQIZ2KEaXvPw3OgEZgaEdZtMl4ZiMgIzEPgKT6pJwTE5ARiYkMKouCcdsBGQiz58/P7i8vPynx1qwu/6cqtVqdeK4kXkJyMQM7RDjHY7yCMhM8k8kr/P/EC+FBO4mHOUSkBnZR+B2wlE+ASmAkMD/CcdyCEhBDO20rD9upL/ASTiWQ0AKZGinJVfnVDluZHkEpGCGdirXJe9wLJqAFM4+QoW6JBxVEJCFEBIq0CXhqIqALIyhnQXqknBUSUAWytBO6frjRvrfqhKOegnIwhnaKUn/Dkf+dLZard44p6p+AlIB+whz8/JfmwSkIkLC1ISjbQJSIUM7YxMOegJSMUM7QxMOfiQgDTC0syvHjXATAWmEfYSgbr1enwkHNxGQxggJW+qSl/+4h4A0ytDOLbokHGxJQBpnaGejS8LBAwkI3xjam9Ul4SBIQPjOPtKO/pyq1Wp14rgRdiEg/IWQ1Mk7HAxNQLiVob0OwsFYBIR7GdqXSTgYm4CwNUP7MggHUxEQHsQ+Uq7+uJFNON4KB1MQEEKEpCif1uv1qeNGmJqAsBND+6y65B0OZiQgDMLQPqkuCQcFEBAGZWgfVZeEg4IICIOzjwyuS8JBgQSE0QjJbvrjRvI/uzPhoFQCwugM7dvr3+HIn85Wq9Ub51RROgFhMob223n5jyUSECa3GdqP8zfMx6lxwsGSCQizaH0fEQ5qICDMqrWQCAc1ERCK8OzZsxf50z9q3Uf6c6ryx4njRqiJgFCUCof2Lofj9Pz8/F2CyggIRapgaO+Sl/+onIBQrIXuI10SDhohIBRvISHpknDQGAFhMQod2vtt41Q4aJGAsDglDO39OVWr1erEcSO0TEBYrKmHdu9wwM8EhEWbYh8RDriZgFCFMUIiHHA3AaEqQwztwgHbERCqFBna++NGNuF4KxxwPwGhalsO7Z/W6/Wpc6rgYQSE6t2xj3TJy38QJiA044eQ/C0JBwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwjf8CKOgPWSE7070AAAAASUVORK5CYII=",ref:this.imgRef})}}]),n}(d.a.Component);function jh(){var t=gl("layout","arenaInfos"),e=t.layout,n=t.arenaInfos,a=f.useState(!1),i=Object(u.a)(a,2),r=i[0],o=i[1];if(!e||!n)return null;var s=r?128:10;return Object(h.jsx)(rl,{className:"ArenaMinimaps",children:Object(h.jsxs)(sl,{children:[new Array(Math.min(e.arenas,s)).fill(0).map((function(t,e){return Object(h.jsx)(Sh,{arenaIndex:e,arenaInfo:n[e]},e)})),e.arenas>s&&Object(h.jsx)("span",{children:Object(h.jsxs)("i",{children:["(",e.arenas-s," arenas hidden)"]})}),Object(h.jsxs)(Vu,{flat:!0,onClick:function(){return o(!r)},children:["Show ",r?"less":"more"]})]})})}function Sh(t){var e=t.arenaIndex,n=t.arenaInfo,a=f.useContext(pl),i=gl("renderArena").renderArena;if(!a)return null;var r="Arena #".concat(e,"\nHome gold: ").concat(n.homeGold,"\nAway gold: ").concat(n.awayGold);return Object(h.jsx)(Uu,{shadowPx:0,fill:"rgba(0, 0, 0, 0.5)",borderPx:zu(5),paddingPx:zu(0),strokeWidth:3,stroke:i===e?"#fff":"transparent",children:Object(h.jsxs)("div",{className:"ArenaMinimap",title:r,onClick:function(){a.setData({renderArena:e}),vh(a,e),a.ensureRendered()},children:[[].concat(Object(mt.a)(n.homeUnits),Object(mt.a)(n.awayUnits)).filter((function(t){return t})).map((function(t,e){return Object(h.jsx)("div",{className:"ArenaMinimapUnit",style:{left:Object(y.d)(t.position.x,50,78,0,100)+"%",top:Object(y.d)(t.position.y,50,78,100,0)+"%"},children:Object(h.jsx)(Oh,{unit:t.unit})},e)})),Object(h.jsxs)("div",{className:"ArenaMinimapHpsContainer",children:[Object(h.jsx)("div",{className:"ArenaMinimapHps ArenaMinimapHpsHome",children:n.homeUnits.filter((function(t){return t})).map((function(t,e){return Object(h.jsx)("div",{className:"ArenaMinimapHpBar",children:Object(h.jsx)("div",{className:"ArenaMinimapHp",style:{width:100*t.hitpoints/ja+"%",backgroundColor:Ca}})},e)}))}),Object(h.jsx)("div",{className:"ArenaMinimapHps ArenaMinimapHpsAway",children:n.awayUnits.filter((function(t){return t})).map((function(t,e){return Object(h.jsx)("div",{className:"ArenaMinimapHpBar",children:Object(h.jsx)("div",{className:"ArenaMinimapHp",style:{width:100*t.hitpoints/ja+"%",backgroundColor:xa}})},e)}))})]}),Object(h.jsx)("div",{className:"ArenaMinimapHomeGold",children:Math.round(n.homeGold)}),a.data.teams.away.train&&Object(h.jsx)("div",{className:"ArenaMinimapAwayGold",children:Math.round(n.awayGold)})]})})}n(368);function kh(){var t=gl("teams","homeHealthColor","awayHealthColor"),e=t.teams,n=t.homeHealthColor,a=t.awayHealthColor,i=d.a.useState(""),r=Object(u.a)(i,2),o=r[0],l=r[1],f=null===e||void 0===e?void 0:e.home.battlePoints,m=null===e||void 0===e?void 0:e.away.battlePoints;if(d.a.useEffect((function(){Object(c.a)(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return l("".concat(f," - ").concat(m)),t.next=3,Object(b.H)(1e3);case 3:l("");case 4:case"end":return t.stop()}}),t)})))()}),[f,m]),!o||!e||!n||!a)return null;var p=e.home.battlePoints>e.away.battlePoints?Object(b.z)(Object(b.G)(n)):e.home.battlePoints<e.away.battlePoints?Object(b.z)(Object(b.G)(a)):"rgb(133, 133, 133)";return Object(h.jsx)("div",{className:"BattleScoreChangeFlash",style:{color:p},children:Object(h.jsx)("div",{className:"zoomIn animated",children:o})})}function Ih(){var t=gl("teams","homeHealthColor","awayHealthColor"),e=t.teams,n=t.homeHealthColor,a=t.awayHealthColor;if(!e||!n||!a)return null;var i=e.home.battlePoints>e.away.battlePoints?Object(b.z)(Object(b.G)(n)):e.home.battlePoints<e.away.battlePoints?Object(b.z)(Object(b.G)(a)):"rgb(133, 133, 133)";return Object(h.jsxs)(al,{className:"BattleHUDScore",style:{color:i},children:[e.home.battlePoints,"\xa0-\xa0",e.away.battlePoints]})}n(369),n(370);function Eh(t){var e=t.progress,n=t.color,a=void 0===n?"#757415":n,i=t.className,r=t.title,o=t.children;return Object(h.jsxs)("div",{className:"ProgressBar ".concat(i||""),title:r,children:[Object(h.jsx)("div",{className:"ProgressBarProgress",style:{width:Math.max(0,Math.round(100*e))+"%",background:a}}),Object(h.jsx)("div",{className:"ProgressBarContent",children:o})]})}function Th(t,e){var n=f.useRef();f.useEffect((function(){n.current=t}),[t]),f.useEffect((function(){if(void 0!==e){var t=setInterval((function(){n.current&&n.current()}),e);return function(){return clearInterval(t)}}}),[e])}function Rh(){var t=f.useContext(pl),e=f.useState(0),n=Object(u.a)(e,2),a=n[0],i=n[1];if(Th((function(){t&&i(t.data.stepCounter-t.data.battleStartStep)}),1e3),!t)return null;var r=a/aa,o=new _n(aa-a).toString();return Object(h.jsx)(Eh,{progress:r,color:"#e6e699",className:"RoundClock",children:o})}n(371),n(15),n(28),n(372),n(34);n(373);nc.a.firestore();n(374),n(727),n(548),n(549);var Dh=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){var t;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))).root=null,t}return Object(p.a)(n,[{key:"render",value:function(){var t=this,e=this.props.fader,n=void 0===e||e,a=Object(h.jsx)("div",{className:"PopdownPopup",style:this.popupStyle,onClick:function(t){return t.stopPropagation()},children:this.props.popdown()});n&&(a=Object(h.jsx)("div",{className:"PopdownPopupBackground",onClick:this.props.onClickFader,children:a}));var i=this.props.showPopdown?Zu.createPortal(a,document.getElementById("PopdownsContainer")||document.documentElement):void 0;return Object(h.jsxs)("div",{className:"Popdown"+(this.props.className?" "+this.props.className:""),onMouseOver:this.props.onMouseOver,onMouseOut:this.props.onMouseOut,onClick:this.props.onClick,onContextMenu:this.props.onContextMenu,ref:function(e){return t.root=e},children:[this.props.children,i]})}},{key:"popupStyle",get:function(){if(this.root){var t=this.props.attachment,e=void 0===t?"vertical":t,n=this.root.getBoundingClientRect(),a={};return"vertical"===e?(n.left<window.innerWidth/2?a.left=n.left+"px":a.right=window.innerWidth-n.right+"px",n.bottom<window.innerHeight/2?Object(r.a)(Object(r.a)({},a),{},{top:n.bottom+"px",maxHeight:window.innerHeight-n.bottom-3+"px"}):Object(r.a)(Object(r.a)({},a),{},{bottom:window.innerHeight-n.top+"px",maxHeight:n.top-3+"px"})):(n.left<window.innerWidth/2?(a.left=n.right+"px",a.maxWidth=window.innerWidth-n.left+"px"):(a.right=window.innerWidth-n.left+"px",a.maxWidth=n.left-3+"px"),n.bottom<window.innerHeight/2?Object(r.a)(Object(r.a)({},a),{},{top:n.top+"px"}):Object(r.a)(Object(r.a)({},a),{},{bottom:window.innerHeight-n.bottom+"px"}))}return{}}}]),n}(f.Component);function Ph(t){var e=t.children;return Object(h.jsx)("div",{className:"Menu",children:e})}function Fh(t){var e=t.onClick,n=t.onMouseDown,a=t.title,i=t.checked,r=t.highlighted,o=t.disabled,s=t.className;return Object(h.jsxs)("div",{className:"MenuItem ".concat(e?"MenuItemClickable":""," ").concat(!0===o?"MenuItemDisabled":""," ").concat(!0===r?"MenuItemHighlighted":""," ").concat(null!==s&&void 0!==s?s:""),onClick:function(){!o&&e&&e()},onMouseDown:function(){!o&&n&&n()},children:[void 0!==i&&Object(h.jsxs)("span",{children:[Object(h.jsx)("i",{className:"far fa-".concat(!0===i?"check-":"","square")}),"\xa0"]}),a]})}n(96),n(550);function Bh(t){var e=t.className,n=t.style,a=t.onChange,i=t.readOnly,r=t.value,o=t.children;return Object(h.jsxs)("label",{className:"Checkbox ".concat(e||""," ").concat(r?"CheckboxChecked":""),style:n,onClick:function(t){t.stopPropagation()},children:[!i&&Object(h.jsx)("input",{className:e,type:"checkbox",checked:r,onChange:function(){return a(!r)}}),Object(h.jsx)("i",{className:"fas ".concat(r?"fa-check-square":"fa-square")}),o&&Object(h.jsx)("span",{children:o})]})}var Mh=Bh;var zh,Nh=(zh=function(t){var e=t.className,n=t.onChange,a=t.readOnly,i=void 0!==a&&a,r=t.value,o=t.variants,s=t.searchable,c=f.useState(!1),l=Object(u.a)(c,2),d=l[0],p=l[1],g=f.useState(""),y=Object(u.a)(g,2),b=y[0],w=y[1],C=function(t){return v.isFunction(t)&&(t=t()),Array.isArray(t)?t.map((function(t){return"string"===typeof t?{value:t,displayName:t}:{value:t.value,displayName:t.displayName||t.value,description:t.description,className:t.className}})):Object.keys(t).map((function(e){return{displayName:e,value:t[e]}}))}(o);if(b){var x=b.toLowerCase();C=C.filter((function(t){return-1!==t.displayName.toLowerCase().indexOf(x)}))}var A,O=""+r,j=Object(m.a)(C);try{for(j.s();!(A=j.n()).done;){var S=A.value;v.isEqual(S.value,r)&&(O=S.displayName||S.value)}}catch(Nt){j.e(Nt)}finally{j.f()}return Object(h.jsx)(Dh,{className:e,showPopdown:d,onClickFader:function(){return p(!1)},popdown:function(){return Object(h.jsx)("div",{className:"EnumEditorPopdown",children:Object(h.jsxs)(Ph,{children:[s&&Object(h.jsx)("input",{type:"text",value:b,onChange:function(t){return w(t.target.value)},placeholder:"Filter"}),Object(h.jsx)(cl,{children:C.map((function(t,e){return Object(h.jsx)(Fh,{onClick:function(){p(!1),n(t.value)},title:t.displayName,className:t.className},e)}))})]})})},children:Object(h.jsxs)("div",{className:"EnumEditor",onClick:function(){return!i&&p(!0)},children:[O," ",Object(h.jsx)("i",{className:"material-icons",children:"arrow_drop_down"})]})})},function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){return Object(l.a)(this,n),e.apply(this,arguments)}return Object(p.a)(n,[{key:"render",value:function(){var t=this,e=this.props.defaultValue;return void 0!==e?Object(h.jsxs)("div",{className:"EditorWithDefault ".concat(void 0===this.props.value?"IsDefault":""),children:[Object(h.jsx)("div",{className:"EditorWithDefaultValue",children:Object(h.jsx)(zh,Object(r.a)(Object(r.a)({},this.props),{},{value:void 0!==this.props.value?this.props.value:e}))}),Object(h.jsx)(Vu,{className:"ResetToDefault EditorActionButton",onClick:function(){return t.props.onChange(void 0)},disabled:void 0===this.props.value,purpose:"ResetToDefault",children:Object(h.jsx)("i",{className:"material-icons",children:"settings_backup_restore"})})]}):Object(h.jsx)(zh,Object(r.a)({},this.props))}}]),n}(f.Component));function Gh(t){var e=t.isLast,n=t.isFirst,a=t.action,i=t.item;return Object(h.jsxs)("div",{className:"LineListLayoutItem",children:[Object(h.jsx)("div",{className:"LineListLayoutItemVerticalLine ".concat(e?"LineListLast":n?"LineListFirst":"")}),Object(h.jsx)("div",{className:"LineListLayoutItemLine"}),a,a&&i&&Object(h.jsx)("div",{className:"LineListLayoutItemLine"}),i&&Object(h.jsx)("div",{className:"LineListLayoutItemValue",children:i})]})}function Hh(t){var e=t.className,n=t.children;return Object(h.jsx)("div",{className:"LineListLayout "+(e||""),children:n})}n(551);var Lh={copy:!1},Uh=f.createContext({}),Vh=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){var t;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))).state={over:!1,queuedUpdates:[]},t.queuedInsert=void 0,t.queuedRemove=void 0,t.performChange=v.debounce((function(){var e,n=t.props.keyFromItem,a=Object(mt.a)(t.props.value),i=Object(m.a)(t.state.queuedUpdates);try{var r=function(){var i=e.value,r=n?t.props.value.findIndex((function(t){return n(t)===i.key})):i.key;a.splice(r,1,i.item)};for(i.s();!(e=i.n()).done;)r()}catch(Nt){i.e(Nt)}finally{i.f()}var o=t.queuedRemove,s=t.queuedInsert;if(o&&s&&o.key===s.key);else{if(o){var c=n?a.findIndex((function(t){return n(t)===o.key})):o.key;a.splice(c,1),t.props.onItemRemoved&&t.props.onItemRemoved(c)}if(s){var u=0;s.key?(u=n?a.findIndex((function(t){return n(t)===s.key})):s.key,"bottom"===s.mode&&u++,!n&&t.queuedRemove&&t.queuedRemove.key<u&&u--):"bottom"===s.mode&&(u=a.length),a.splice(u,0,s.item),t.props.onItemInserted&&t.props.onItemInserted(u)}}t.queuedInsert=void 0,t.queuedRemove=void 0,t.props.onChange(a),t.setState({queuedUpdates:[]})}),50),t}return Object(p.a)(n,[{key:"render",value:function(){var t=this,e=this.props,n=e.value,a=e.itemRenderer,i=e.keyFromItem,r=e.filter;return Object(h.jsx)(qh,{className:"DragAndDropList",onDrop:function(e,n){t.queuedInsert={mode:e,item:n},t.performChange()},acceptItem:this.props.acceptItem,children:n.map((function(e,n){if(r&&!r(e))return null;var o,s=i?i(e):n,c=e,u=Object(m.a)(t.state.queuedUpdates);try{for(u.s();!(o=u.n()).done;){var l=o.value;l.key===s&&(c=l.item)}}catch(Nt){u.e(Nt)}finally{u.f()}return Object(h.jsx)(Wh,{item:c,onDrop:function(e,n){t.queuedInsert={key:s,mode:e,item:n},t.performChange()},onDragRemove:function(){t.queuedRemove={key:s},t.performChange()},acceptItem:t.props.acceptItem,children:a(c,(function(e){t.setState((function(t){return{queuedUpdates:[].concat(Object(mt.a)(t.queuedUpdates),[{key:s,item:e}])}})),t.performChange()}),n)},n)}))})}}]),n}(f.Component);function Qh(t){return t.altKey||t.ctrlKey||t.metaKey}var qh=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){var t;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))).state={over:"none"},t.handleDragEnter=function(e){e.stopPropagation(),e.dataTransfer.dropEffect=Qh(e)?"copy":"move",t.setState({over:"top"})},t.handleDragOver=function(e){if(e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect=Qh(e)?"copy":"move",t.div){var n=t.div.getBoundingClientRect();e.clientY<=n.top+n.height/2?t.setState({over:"top"}):t.setState({over:"bottom"})}},t.handleDrop=function(e){if(e.preventDefault(),e.stopPropagation(),Lh.copy=Qh(e),"none"!==t.state.over){var n;try{n=JSON.parse(e.dataTransfer.getData("text/plain"))}catch(a){return void alert("Invalid JSON data!")}t.props.acceptItem&&!t.props.acceptItem(n)||t.props.onDrop(t.state.over,n),t.setState({over:"none"})}},t.div=null,t}return Object(p.a)(n,[{key:"render",value:function(){var t=this,e=["DragAndDropArea","top"===this.state.over?"DragAndDropAreaOverTop":"","bottom"===this.state.over?"DragAndDropAreaOverBottom":"",this.props.className||""].join(" ");return Object(h.jsx)("div",{ref:function(e){return t.div=e},className:e,onDragEnter:this.handleDragEnter,onDragLeave:function(){return t.setState({over:"none"})},onDragOver:this.handleDragOver,onDrop:this.handleDrop,children:this.props.children})}}]),n}(f.Component),Wh=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){var t;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))).state={dragging:!1},t}return Object(p.a)(n,[{key:"render",value:function(){var t=this,e=["DragAndDropItem",this.state.dragging?"DragAndDropItemDragging":""].join(" ");return Object(h.jsx)(qh,{className:e,onDrop:this.props.onDrop,acceptItem:this.props.acceptItem,children:Object(h.jsx)(Uh.Provider,{value:{item:this.props.item,onDragRemove:this.props.onDragRemove,onDragChange:function(e){return t.setState({dragging:e})}},children:this.props.children})})}}]),n}(f.Component);f.Component;function Yh(t){var e=t.value,n=void 0===e?[]:e,a=t.onChange,i=t.selected,o=t.onSelect,s=Object(Pu.a)(t,["value","onChange","selected","onSelect"]);return Object(h.jsx)(Xh,Object(r.a)({value:Object(mt.a)(n).reverse(),onChange:function(t){return a(void 0!==t?t.reverse():void 0)},selected:void 0!==i?n.length-1-i:void 0,onSelect:o&&function(t,e){return o(void 0!==t?e-1-t:void 0,e)}},s))}var Xh=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){var t;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))).handleItemRemoved=function(e){var n=t.props,a=n.onSelect,i=n.selected,r=n.value,o=void 0===r?[]:r;i&&a&&(i===e?a(void 0,o.length-1):i>e&&a(i-1,o.length-1))},t.handleItemInserted=function(e){var n=t.props,a=n.onSelect,i=n.selected,r=n.value;i&&a&&i>=e&&a(i+1,(void 0===r?[]:r).length+1)},t}return Object(p.a)(n,[{key:"render",value:function(){var t=this,e=this.props,n=e.onChange,a=e.readOnly,i=e.selected,o=e.renderReverse,u=e.showInsertTop,l=void 0!==u&&u,f=e.showInsertBottom,d=void 0===f||f;if(o){var m=this.props,p=(m.renderReverse,Object(Pu.a)(m,["renderReverse"]));return Object(h.jsx)(Yh,Object(r.a)({},p))}var v=this.props.value||[];return Object(h.jsxs)(Hh,{className:this.props.className,children:[!a&&l&&Object(h.jsx)(Gh,{isFirst:!0,action:Object(h.jsx)("button",{className:"EditorActionButton ListEditorItemAction",onClick:function(){var e=Object(c.a)(s.a.mark((function e(n){var a;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.preventDefault(),e.next=3,t.props.itemFactory();case 3:if(a=e.sent){e.next=6;break}return e.abrupt("return");case 6:t.insertItems(0,!0,a);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),children:Object(h.jsx)("i",{className:"material-icons",children:"add"})})}),Object(h.jsx)(Vh,{value:this.props.value||[],onChange:n,keyFromItem:this.props.keyFromItem,onItemRemoved:this.handleItemRemoved,onItemInserted:this.handleItemInserted,acceptItem:this.props.acceptItemDrop,filter:this.props.filter,itemRenderer:function(e,n,r){return Object(h.jsx)(Gh,{isFirst:!(!a&&l)&&0===r,isLast:!(!a&&d)&&r===v.length-1,action:null,item:t.props.itemRenderer({readOnly:a,value:e,onChange:n,selected:i===r})})}}),!a&&d&&Object(h.jsx)(Gh,{isLast:!0,action:Object(h.jsx)("button",{className:"EditorActionButton ListEditorItemAction",onClick:function(){var e=Object(c.a)(s.a.mark((function e(n){var a;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.preventDefault(),e.next=3,t.props.itemFactory();case 3:if(a=e.sent){e.next=6;break}return e.abrupt("return");case 6:t.insertItems(-1,!0,a);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),children:Object(h.jsx)("i",{className:"material-icons",children:"add"})})})]})}},{key:"insertItems",value:function(t,e){for(var n=arguments.length,a=new Array(n>2?n-2:0),i=2;i<n;i++)a[i-2]=arguments[i];if(0!==a.length){var r=this.props.value||[];t<0&&(t=r.length);var o=[].concat(Object(mt.a)(r.slice(0,t)),a,Object(mt.a)(r.slice(t)));this.props.onChange(o),this.props.onSelect&&(e?this.props.onSelect(t,o.length):this.handleItemInserted(t))}}}]),n}(f.Component),Kh=[Xh,Jh];function Jh(t){var e,n=t.className,a=t.onChange,i=t.properties,o=t.readOnly,s=t.typedefResolver,c=t.value,u=t.layout;return e=(e=Array.isArray(i)?i:Object.keys(i).filter((function(t){return i[t]})).map((function(t){return{name:t,type:i[t]}}))).map((function(t){return Object(r.a)(Object(r.a)({},t),{},{editor:yf({typedef:t.type,readOnly:o,value:c&&c[t.name],onChange:function(e){return a({property:t.name,value:e})},typedefResolver:s})})})),"table"===u?Object(h.jsx)("table",{className:"StructEditor",children:Object(h.jsx)("tbody",{children:e.map((function(t,e){var n=t.name,a=t.label,i=t.title,r=t.editor;return!1!==t.visible&&Object(h.jsxs)("tr",{children:[Object(h.jsx)("td",{title:i,className:"StructEditorKey",children:void 0!==a?a:n}),Object(h.jsx)("td",{className:"StructEditorValue",children:r})]},e)}))})}):Object(h.jsx)(Hh,{className:n,children:e.map((function(t,n){var a=t.name,i=t.label,r=t.title,o=t.editor;return!1!==t.visible&&Object(h.jsx)(Gh,{isFirst:0===n,isLast:n===e.length-1,item:Object(h.jsxs)("div",{className:"StructEditorProperty"+(-1===Kh.indexOf(o.type)?" Inline":""),children:[Object(h.jsxs)("div",{className:"StructEditorKey",title:r,children:[void 0!==i?i:a,":\xa0"]}),Object(h.jsx)("div",{className:"StructEditorValue",children:o})]},a)},n)}))})}function Zh(t){var e=t.className,n=t.onChange,a=t.readOnly,i=t.value,o=t.variants,s=Object.keys(o).map((function(t){return{value:t,displayName:o[t].displayName||t,description:o[t].description}}));return Object(h.jsxs)("div",{className:"EnumStructEditor "+(e||""),children:[Object(h.jsx)(Nh,{variants:s,readOnly:a,value:i?i.type:void 0,onChange:function(t){if(t){var e=o[t].default(t);n(Object(r.a)(Object(r.a)(Object(r.a)({},e),i),{},{type:t}))}else n(null)}}),Object(h.jsx)("div",{className:"EnumStructEditorProperties",children:i&&i.type&&o[i.type]&&Object(h.jsx)(Jh,{properties:o[i.type].properties,readOnly:a,value:i,onChange:function(t){n(Object(r.a)(Object(r.a)({},i),{},Object(G.a)({},t.property,t.value)))}})})]})}function _h(t){var e=t.className,n=t.onChange,a=t.readOnly,i=t.typedefResolver,r=t.value,o=t.variants,s=r?Object.keys(r)[0]:void 0;return Object(h.jsxs)("div",{className:"ObnumEditor "+(e||""),children:[Object(h.jsx)(Nh,{readOnly:a,value:s,variants:Object.keys(o),onChange:function(t){return n(Object(G.a)({},t,o[t].default))}}),r&&s&&o[s]&&Object(h.jsx)(yf,{readOnly:a,value:r[s],onChange:function(t){return n(Object(G.a)({},s,t))},typedef:o[s].itemType,typedefResolver:i})]})}var $h=function(t){var e=t.className,n=t.onChange,a=t.itemTypes,i=t.readOnly,r=t.value,o=t.typedefResolver,s=r||[];return Object(h.jsx)("div",{className:"TupleEditor "+(e||""),children:a.map((function(t,e){return Object(h.jsx)("div",{className:"TupleEditorItem",children:Object(h.jsx)(yf,{readOnly:i,value:s[e],onChange:function(t){var a=Object(mt.a)(s);a[e]=t,n(a)},typedef:a[e],typedefResolver:o})},e)}))})};function tf(t,e){var n=document.createElement("span");n.className=e||"",n.innerHTML=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),document.body.appendChild(n);var a=n.getBoundingClientRect();return document.body.removeChild(n),a}function ef(t){var e=t.validationError,n=t.children;return Object(h.jsx)(Dh,{showPopdown:!!e,popdown:function(){return Object(h.jsx)("div",{className:"StringEditorValidationError",children:e})},fader:!1,children:n})}function nf(t){var e,n=t.className,a=void 0===n?"":n,i=t.multiline,o=t.readOnly,s=t.rows,c=void 0===s?1:s,l=t.value,d=t.widthMode,m=t.onChange,p=t.validate,v=t.placeholder,g=t.spellCheck,y=function(t,e,n){var a=f.useState(""),i=Object(u.a)(a,2),r=i[0],o=i[1],s=f.useState(),c=Object(u.a)(s,2),l=c[0],h=c[1],d=f.useState(!0),m=Object(u.a)(d,2),p=m[0],v=m[1];f.useEffect((function(){p&&(o(t||""),v(!0),h(e?e(t||""):void 0))}),[t,e,p]);var g=function(){void 0!==l||p||(n(r),v(!0))};return{props:{value:r||"",onChange:function(t){o(t.target.value),v(!1),h(e?e(t.target.value):void 0)},onKeyDown:function(n){"Enter"===n.key?g():"Escape"===n.key&&(o(t||""),v(!0),h(e?e(t||""):void 0))},onBlur:function(){g()},className:"".concat(l?"InvalidInput":""," ").concat(p?"":"StringEditorUncommited")},validationError:l,editValue:r,setEditValue:function(t){o(t),v(!1),h(e?e(t||""):void 0)}}}(l,p,m),b=y.props,w=y.validationError,C=y.editValue,x="StringEditor ".concat(b.className," ").concat(a);return e=i?Object(h.jsx)("textarea",Object(r.a)(Object(r.a)({},b),{},{className:x,rows:c,spellCheck:g})):Object(h.jsx)("input",Object(r.a)(Object(r.a)({},b),{},{className:x,type:"text",style:{width:"fill"===d?"100%":"fit-content"===d?tf(C||v||"",a).width+20:"120px"},readOnly:o,placeholder:v,spellCheck:g})),Object(h.jsx)(ef,{validationError:w,children:e})}function af(t){var e=t.children,n=t.stack,a=t.className;return Object(h.jsx)("div",{className:"KeyValueLayout ".concat(n?"KeyValueLayoutStack":""," ").concat(a||""),children:e})}function rf(t){var e=t.children,n=t.className,a=t.keyName,i=t.keyElement;return Object(h.jsxs)("div",{className:"KeyValueLayoutRow ".concat(n||""),children:[Object(h.jsx)("div",{className:"KeyValueLayoutKey",title:a,children:i}),Object(h.jsx)("div",{className:"KeyValueLayoutValue",children:e})]})}function of(t){var e=t.className,n=t.onChange,a=t.readOnly,i=t.stack,o=t.typedefResolver,s=t.value,c=t.valueType,u=t.valueDefault;s=s||{};var l=Object.keys(s);return-1===l.indexOf("")&&l.push(""),Object(h.jsx)(af,{className:"KeyValueEditor "+(e||""),stack:i,children:l.map((function(t,e){return Object(h.jsx)(rf,{keyName:t||"",keyElement:Object(h.jsx)(nf,{readOnly:a,value:t,onChange:function(e){e=void 0===e?"":e;var a=void 0!==s[t]?s[t]:u,i=Object(r.a)(Object(r.a)({},s),{},Object(G.a)({},e,a));delete i[t],n(i,{oldKey:t,key:e,entryValue:a})},multiline:!1,widthMode:"fit-content"}),children:Object(h.jsx)(yf,{typedef:c,value:s[t],onChange:function(e){return n(Object(r.a)(Object(r.a)({},s),{},Object(G.a)({},t,e)),{oldKey:t,key:t,entryValue:e})},typedefResolver:o})},e)}))})}var sf=n(552),cf=n(195),uf=n.n(cf),lf=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){var t;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))).state={showColorEditor:!1},t}return Object(p.a)(n,[{key:"render",value:function(){var t=this,e=this.props.title,n=this.props.value?uf()({r:this.props.value.r,g:this.props.value.g,b:this.props.value.b}).toString():void 0;return Object(h.jsx)(Dh,{className:"ColorEditor",showPopdown:this.state.showColorEditor,onClickFader:function(){return setTimeout((function(){return t.setState({showColorEditor:!1})}),10)},popdown:function(){return Object(h.jsx)(sf.SketchPicker,{color:t.props.value,onChangeComplete:function(e){t.props.onChange(e.rgb)}})},children:Object(h.jsx)(Vu,{className:this.props.className,fill:n,onClick:function(){return!t.props.readOnly&&t.setState({showColorEditor:!0})},purpose:"OpenColorEditor",children:void 0!==e?e:"color"})})}}]),n}(f.Component);var hf,ff=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){return Object(l.a)(this,n),e.apply(this,arguments)}return Object(p.a)(n,[{key:"render",value:function(){var t=this;return Object(h.jsx)("input",{type:"file",onChange:function(e){return t.props.onChange(e.target.files[0])}})}}]),n}(f.Component),df=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){return Object(l.a)(this,n),e.apply(this,arguments)}return Object(p.a)(n,[{key:"render",value:function(){var t=this.props,e=t.value,n=void 0===e?[]:e,a=t.onChange,i=t.itemProperties,o=t.itemPropertiesLabels,s=t.newItem;return Object(h.jsx)("table",{className:"TableEditor",children:Object(h.jsxs)("tbody",{children:[Object(h.jsx)("tr",{children:Object.keys(i).map((function(t,e){return Object(h.jsx)("th",{children:o&&o[t]?o[t]:t},e)}))}),n.map((function(t,e){return Object(h.jsxs)("tr",{children:[Object.keys(i).map((function(o,s){return Object(h.jsx)("td",{children:Object(h.jsx)(yf,{typedef:i[o],value:t[o],onChange:function(i){return a(Object(b.h)(n,e,Object(r.a)(Object(r.a)({},t),{},Object(G.a)({},o,i))))}})},s)})),Object(h.jsx)("td",{children:Object(h.jsx)(Qu,{flat:!0,icon:"delete",purpose:"Delete",onClick:function(){return a(Object(b.g)(n,e))}})})]},e)})),Object(h.jsx)("tr",{children:Object(h.jsx)("td",{children:Object(h.jsx)(Qu,{flat:!0,icon:"add",purpose:"Add",onClick:function(){return a([].concat(Object(mt.a)(n),[s()]))}})})})]})})}}]),n}(f.Component);!function(t){t[t.INT=0]="INT",t[t.FLOAT=1]="FLOAT"}(hf||(hf={}));var mf=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(t){var a;return Object(l.a)(this,n),(a=e.call(this,t)).handleRef=function(t){a.inputRef=t,t&&document.activeElement===t&&a.setState({editValue:a.stringify(),focused:!0})},a.inputRef=null,a.handleFocus=function(){a.setState({editValue:a.stringify(),focused:!0})},a.handleBlur=function(){a.tryCommit(),a.setState({editValue:void 0,focused:!1,error:!1,committed:!0}),a.props.onBlur&&a.props.onBlur()},a.getValue=function(){if(!a.inputRef||a.inputRef.validity.badInput)return Nt(!0);var t=a.parse(a.inputRef.value)/a.factor;return void 0!==a.props.min&&!1!==a.props.clamp&&(t=Math.max(a.props.min,t)),void 0!==a.props.max&&!1!==a.props.clamp&&(t=Math.min(a.props.max,t)),isNaN(t)?Nt(!0):Mt(t)},a.handleChange=function(t){a.setState({editValue:t.target.value,committed:!1});var e=a.getValue();Gt(e)!==a.state.error&&a.props.onErrorChange&&a.props.onErrorChange(Gt(e)),a.setState({error:Gt(e)})},a.handleKeyDown=function(t){"Enter"===t.key?a.tryCommit():"Escape"===t.key&&a.setState({editValue:a.stringify(),committed:!0,error:!1})},a.handleSlider=function(t){a.props.onChange(t.target.valueAsNumber),a.setState({editValue:a.stringify(),committed:!0,error:!1})},a.state={error:!1,editValue:a.stringify(),focused:!1,committed:!0},a}return Object(p.a)(n,[{key:"parse",value:function(t){return this.props.type===hf.INT?parseInt(t,10):parseFloat(t)}},{key:"stringify",value:function(){if(void 0===this.props.value)return"";var t=this.props.value*this.factor;return this.props.formatter?this.props.formatter(t):""+t}},{key:"tryCommit",value:function(){var t=this.getValue();Gt(t)||(this.props.onChange(t.value),this.setState({committed:!0}))}},{key:"render",value:function(){var t=this.props,e=t.className,n=t.slider,a=this.state.focused?this.state.editValue:this.stringify(),i=this.props.slider?80:this.state.error?void 0:tf(a||"",void 0).width+30,r=Object(h.jsx)("input",{className:"".concat(e&&!n?e:""," ").concat(this.state.error?" InvalidInput":""," ").concat(this.state.committed?"":"NumberEditorUncommitted"),type:"number",min:!1!==this.props.clamp?this.props.min:void 0,max:!1!==this.props.clamp?this.props.max:void 0,step:this.props.step,value:a,onChange:this.handleChange,onKeyDown:this.handleKeyDown,style:{width:i},readOnly:this.props.readOnly,onFocus:this.handleFocus,onBlur:this.handleBlur,ref:this.handleRef});return n?Object(h.jsxs)("div",{className:"NumberRangeEditor "+(e||""),children:[r,this.props.suffix,Object(h.jsx)("input",{type:"range",min:this.props.min,max:this.props.max,step:this.props.step,value:a,onChange:this.handleSlider,readOnly:this.props.readOnly})]}):Object(h.jsxs)("span",{children:[r,this.props.suffix]})}},{key:"factor",get:function(){return void 0!==this.props.factor?this.props.factor:1}}]),n}(f.Component);function pf(t){return Object(h.jsx)(mf,Object(r.a)({factor:100,suffix:"%"},t))}function vf(t){var e=t.value,n=t.onChange,a=t.min,i=t.max,r=t.step,o=t.suffix;return Object(h.jsxs)("span",{children:[Object(h.jsx)("input",{type:"range",min:a,max:i,step:r,value:e,onChange:function(t){return n(parseFloat(t.target.value))}}),o]})}function gf(t){var e,n=t.value,a=t.onChange;return n=n||{value:1,unit:Yn.Days},Object(h.jsxs)("span",{children:[Object(h.jsx)(mf,{value:n.value,onChange:function(t){return a({value:t,unit:n.unit})}}),Object(h.jsx)(Nh,{value:n.unit,onChange:function(t){return a({value:n.value,unit:t})},variants:(e=Yn,Object(b.q)(e).map((function(t){return{value:e[t],displayName:t}})))})]})}function yf(t){var e=t.className,n=t.onChange,a=t.readOnly,i=t.typedef,o=t.typedefResolver,s=t.value;switch((i=function(t,e){if("string"===typeof t){if(!e)throw new Error("Cannot resolve type reference without typedefResolver");var n=e(t);if(!n)throw new Error("Unrecognized type: "+t);return n}return"function"===typeof t?t():t}(i,o)).metatype){case"boolean":return i.asDropDown?Object(h.jsx)(Nh,{className:e,value:s,readOnly:a,variants:[{value:!0,displayName:i.asDropDown.true},{value:!1,displayName:i.asDropDown.false}],onChange:n}):Object(h.jsx)(Mh,{className:e,readOnly:a,value:s||!1,onChange:n});case"float":return Object(h.jsx)(mf,Object(r.a)({className:e,readOnly:a,value:s,onChange:n,type:hf.FLOAT},i));case"int":return Object(h.jsx)(mf,Object(r.a)({className:e,readOnly:a,value:s,onChange:n,type:hf.INT},i));case"slider":return Object(h.jsx)(vf,Object(r.a)({className:e,readOnly:a,value:s,onChange:n},i));case"percentage":return Object(h.jsx)(pf,{className:e,readOnly:a,value:s,onChange:n,type:hf.FLOAT,min:i.min,max:i.max,step:i.step,slider:i.slider});case"string":return Object(h.jsx)(nf,{className:e,readOnly:a||i.readOnly,value:s,onChange:n,multiline:!!i.multiline,widthMode:"fit-content"});case"enum":return Object(h.jsx)(Nh,{className:e,readOnly:a,value:s,onChange:n,defaultValue:i.default,variants:i.variants});case"enumstruct":return Object(h.jsx)(Zh,{className:e,readOnly:a,value:s,variants:i.variants,onChange:n,typedefResolver:o});case"obnum":return Object(h.jsx)(_h,{className:e,readOnly:a,value:s,onChange:n,variants:i.variants,typedefResolver:o});case"struct":return Object(h.jsx)(Jh,{className:e,readOnly:a,value:s,properties:i.properties,onChange:function(t){return n(Object(r.a)(Object(r.a)({},s),{},Object(G.a)({},t.property,t.value)))},typedefResolver:o,layout:i.layout});case"list":var c=i.itemType;return Object(h.jsx)(Xh,{className:e,readOnly:a||i.readOnly,value:s,onChange:n,itemFactory:i.newItem,keyFromItem:i.keyFromItem,acceptItemDrop:i.acceptItemDrop,itemRenderer:function(t){return Object(h.jsx)(yf,Object(r.a)(Object(r.a)({},t),{},{readOnly:a,typedef:c,typedefResolver:o}))}});case"table":return Object(h.jsx)(df,{value:s,onChange:n,itemProperties:i.itemProperties,itemPropertiesLabels:i.itemPropertiesLabels,newItem:i.newItem});case"tuple":return Object(h.jsx)($h,{className:e,readOnly:a,value:s,onChange:n,itemTypes:i.itemTypes,typedefResolver:o});case"keyvalue":return Object(h.jsx)(of,{className:e,readOnly:a,value:s,onChange:n,valueType:i.valueType,valueDefault:i.valueDefault,typedefResolver:o});case"select":var u=i.propertyKey;return Object(h.jsx)(yf,{className:e,readOnly:a,typedef:i.propertyType,value:void 0!==s?s[u]:void 0,onChange:function(t){return n(Object(r.a)(Object(r.a)({},s),{},Object(G.a)({},u,t)))}});case"map":return Object(h.jsx)(yf,{className:e,readOnly:a,typedef:i.mappedType,value:i.map(s),onChange:n});case"color":return Object(h.jsx)(lf,{className:e,readOnly:a,value:s,onChange:n});case"file":return Object(h.jsx)(ff,{onChange:n});case"pixlingTimespanDef":return Object(h.jsx)(gf,{value:s,onChange:n});default:return Object(h.jsx)("i",{children:"Unrecognized meta type"})}}n(633);var bf;new Date("2019-11-12");!function(t){t[t._7Day=0]="_7Day",t[t._28Day=1]="_28Day",t[t.Daily=2]="Daily",t[t.Weekly=3]="Weekly",t[t.Monthly=4]="Monthly"}(bf||(bf={}));Object(b.q)(bf).map((function(t){return{value:bf[t],displayName:t}}));var wf,Cf;f.Component;!function(t){t.StartWinEndWin="StartWinEndWin",t.RoundsEndWin="RoundsEndWin"}(wf||(wf={})),function(t){t.Any="Any",t.Solo="Solo",t.Duo="Duo",t.Trio="Trio"}(Cf||(Cf={}));n.p;var xf=n(271),Af=n.n(xf);n.p,n.p,n.p,n(707),n(708);n(709),n(710),n(711),f.Component;var Of=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){return Object(l.a)(this,n),e.apply(this,arguments)}return Object(p.a)(n,[{key:"render",value:function(){var t=this,e=this.props.titleComponent,n=this.props.bodyComponent,a=void 0!==this.props.tab?this.props.tab:0;return Object(h.jsxs)("div",{className:"Tabs Tabs".concat(Object(b.j)(this.props.orientation||"top")," ").concat(this.props.className||""),style:this.props.style,children:[!1!==this.props.showTabBar&&Object(h.jsx)("div",{className:"TabsBar",children:f.Children.map(this.props.children,(function(n,a){return n?Object(h.jsx)(e,{title:n.props.title,isActive:a===t.props.tab,onClick:function(){t.props.onTabChange&&t.props.onTabChange(a)}}):null}))}),Object(h.jsx)(n,{isActive:!0,children:this.props.children[a]},a)]})}}]),n}(f.Component);function jf(t){t.isActive;var e=t.children;return Object(h.jsx)("div",{className:"TabBody",children:e})}Of.defaultProps={titleComponent:function(t){var e=t.isActive,n=t.onClick,a=t.title;return Object(h.jsx)(Vu,{className:"TabTitle",flat:!0,toggled:e,onClick:n,purpose:"SwitchTab",children:a})},bodyComponent:jf,orientation:"top"},(function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(t){var a;return Object(l.a)(this,n),(a=e.call(this,t)).state={expandedIndex:void 0!==t.tab?t.tab:-1},a}return Object(p.a)(n,[{key:"handleClickTitle",value:function(t){this.state.expandedIndex===t?this.setState({expandedIndex:-1}):this.setState({expandedIndex:t})}},{key:"render",value:function(){var t=this,e=f.Children.toArray(this.props.children),n=0,a=e.reduce((function(t,e){var a=e.props.group||"";return t[a]=t[a]||[],t[a].push({tab:e,i:n++}),t}),{}),i=this.props.titleComponent,r=this.props.bodyComponent;return Object(h.jsx)("div",{className:"Accordion",children:Object.keys(a).map((function(e){return Object(h.jsxs)("div",{className:"AccordionGroup",children:[e&&Object(h.jsx)("div",{className:"AccordionGroupName",children:e}),a[e].map((function(e){var n=e.tab,a=e.i;return Object(h.jsxs)("div",{className:"AccordionTab",children:[Object(h.jsx)(i,{title:n.props.title,isActive:a===t.state.expandedIndex,onClick:function(){return t.handleClickTitle(a)}}),a===t.state.expandedIndex&&Object(h.jsx)(r,{isActive:!0,children:n.props.children})]},a)}))]},e)}))})}}]),n}(f.Component)).defaultProps={titleComponent:function(t){var e=t.isActive,n=t.onClick,a=t.title;return Object(h.jsxs)("div",{className:"AccordionTabTitle",onClick:n,children:[a," ",e?Object(h.jsx)("i",{className:"Chevron fa fa-chevron-up","aria-hidden":"true"}):Object(h.jsx)("i",{className:"Chevron fa fa-chevron-down","aria-hidden":"true"})]})},bodyComponent:jf};f.Component,n(712),n(713);n(714);n(715);var Sf=function t(){Object(l.a)(this,t),this.loggedInUserId=void 0,this.userSettings={status:"loading"},this.draggingUrl="",this.hideUI=!1,this.creatures={status:"loading"},this.items={status:"loading"},this.gameInstance={type:"none"},this.scheduledTrainingIndex=-1,this.scheduledEnd=-1,this.changelog=[]};new fl(new Sf);n.p;n.p;var kf=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){var t;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))).state={text:""},t}return Object(p.a)(n,[{key:"componentDidMount",value:function(){var t=Object(c.a)(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=this,t.next=3,this.loadSource();case 3:t.t1=t.sent,t.t2={text:t.t1},t.t0.setState.call(t.t0,t.t2);case 6:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"loadSource",value:function(){if(n.sources[this.props.path])return n.sources[this.props.path];var t=fetch(this.props.path).then((function(t){return t.text()}));return n.sources[this.props.path]=t}},{key:"render",value:function(){return Object(h.jsx)(Af.a,{source:this.state.text,linkTarget:"_blank"})}}]),n}(f.Component);kf.sources={};n(716),n(717),n.p;new b.b((function(){return g.a.throttle(Kr.playSoundEffect.bind(Kr),300,{leading:!0})}));n.p,n(718);n(719);n(720),n(721);n(722);new Bl;f.Component;var If=function(){function t(e){Object(l.a)(this,t),this.user=e,this.id=Object(b.i)(),this.doc=nc.a.firestore().collection(na.Db.sessions).doc(this.id),this.clicksLastMinute=0,e&&this.doc.set(Object(na.full)({id:this.id,season:na.CurrentSeason,userId:e.uid,started:nc.a.firestore.Timestamp.now(),lastActive:nc.a.firestore.Timestamp.now(),minutesInteracting:0,appVersion:Wu.a.build,browser:Object(b.m)(),screenSize:{width:window.screen.width,height:window.screen.height},isMobile:Object(b.o)(),battles:0,trainings:0}))}return Object(p.a)(t,[{key:"onDocumentClick",value:function(){this.clicksLastMinute++}},{key:"onMinuteTicker",value:function(){this.clicksLastMinute>0&&this.doc.update({lastActive:nc.a.firestore.Timestamp.now(),minutesInteracting:nc.a.firestore.FieldValue.increment(1)}),this.clicksLastMinute=0}},{key:"onClickTrain",value:function(){this.doc.update({trainings:nc.a.firestore.FieldValue.increment(1)})}},{key:"onClickBattle",value:function(){this.doc.update({battles:nc.a.firestore.FieldValue.increment(1)})}}],[{key:"init",value:function(){Wu.a.isDevelopment||nc.a.auth().onAuthStateChanged((function(e){t.Current=e?new t(e):void 0})),document.addEventListener("click",(function(){var e;return null===(e=t.Current)||void 0===e?void 0:e.onDocumentClick()})),window.setInterval((function(){var e;return null===(e=t.Current)||void 0===e?void 0:e.onMinuteTicker()}),6e4)}}]),t}();If.Current=void 0,w.d.fromPolarCoordinates=function(t,e){return w.d.fromValues(Math.cos(t)*e,Math.sin(t)*e)},w.e.fromPolarCoordinates=function(t,e){return w.e.fromValues(Math.cos(t)*e,Math.sin(t)*e,0)},w.e.fromSphericalCoordinates=function(t,e,n){return w.e.fromValues(Math.sin(t)*Math.cos(e)*n,Math.sin(t)*Math.sin(e)*n,Math.cos(t)*n)},w.e.mix=function(t,e,n,a){return w.e.add(t,w.e.scale(w.e.create(),e,1-a),w.e.scale(w.e.create(),n,a))};var Ef=document.cookie.split(";").reduce((function(t,e){var n=e.trim().split("="),a=Object(u.a)(n,2),i=a[0],o=a[1];return Object(r.a)(Object(r.a)({},t),{},Object(G.a)({},i,o))}),{}),Tf=!!(Ef.electronInfo?JSON.parse(Ef.electronInfo):void 0);Tf&&nc.a.auth().setPersistence(nc.a.auth.Auth.Persistence.SESSION);Pl({properties:{sound:{metatype:"boolean"},volume:{metatype:"float",suffix:"%"},musicVolume:{metatype:"float",suffix:"%"},environmentVolume:{metatype:"float",suffix:"%"},soundEffectsVolume:{metatype:"float",suffix:"%"},mouseWheelSensitivity:{metatype:"float"},advancedTrainingSettings:{metatype:"boolean"}}});n(723);var Rf=na.Seasons[na.CurrentSeason].end;Rf&&new Date;n(724),n(725);n.p,nc.a.firestore();f.Component;function Df(){return{season:na.CurrentSeason,created:nc.a.firestore.Timestamp.now(),deleted:!1,ownerId:"",generation:0,tags:[],bounties:{},primaryColor:Object(b.v)(),secondaryColor:Object(b.v)(),ears:1+Math.floor(4*Math.random()),eyes:1+Math.floor(5*Math.random()),backSpikes:1+Math.floor(7*Math.random())}}function Pf(t){return{primaryColor:Object(b.z)(t.primaryColor),secondaryColor:Object(b.z)(t.secondaryColor),ears:t.ears,eyes:t.eyes,backSpikes:t.backSpikes}}var Ff,Bf=n(726),Mf=n.n(Bf),zf=new Blob(["\n  let socket;\n\n  self.onmessage = (e) => {\n    console.log('webworker', e);\n    switch (e.data.type) {\n      case 'init': {\n        socket = new WebSocket(e.data.host);\n        socket.binaryType = 'arraybuffer';\n        socket.addEventListener('open', () => {\n          postMessage({ type: 'open' })\n        });\n        socket.addEventListener('close', () => {\n          postMessage({ type: 'close' })\n        });\n        socket.addEventListener('message', (msg) => {\n          if (msg.data instanceof ArrayBuffer) {\n            postMessage({ type: 'message', data: msg.data }, [msg.data]);\n          } else {\n            postMessage({ type: 'message', data: msg.data });\n          }\n        });\n        break;\n      };\n      case 'send': {\n        socket.send(e.data.data);\n        break;\n      }\n      case 'close': {\n        socket.close();\n        break;\n      }\n    }\n  }\n"],{type:"application/javascript"}),Nf=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(t){var a;return Object(l.a)(this,n),(a=e.call(this)).readyState=WebSocket.CONNECTING,a.worker=new Worker(URL.createObjectURL(zf)),a.worker.addEventListener("message",(function(t){switch(t.data.type){case"open":return a.readyState=WebSocket.OPEN,void a.dispatchEvent(new Event("open"));case"close":return a.readyState=WebSocket.CLOSED,void a.dispatchEvent(new CloseEvent("close"));case"message":return void a.dispatchEvent(new MessageEvent("message",{data:t.data.data}))}})),a.worker.postMessage({type:"init",host:t}),a}return Object(p.a)(n,[{key:"send",value:function(t){t instanceof ArrayBuffer?this.worker.postMessage({type:"send",data:t},[t]):this.worker.postMessage({type:"send",data:t})}},{key:"close",value:function(){this.worker.postMessage({type:"close"})}},{key:"binaryType",set:function(t){if("arraybuffer"!==t)throw new Error("Only arraybuffer supported")}}]),n}(Object(Bt.a)(EventTarget)),Gf=Object.keys(Vs);!function(t){t[t.Reward=0]="Reward",t[t.OpponentReward=1]="OpponentReward",t[t.Hitpoints=2]="Hitpoints",t[t.AliveTime=3]="AliveTime",t[t.CumulativeHitpoints=4]="CumulativeHitpoints"}(Ff||(Ff={}));var Hf=function(t){Object(Pt.a)(n,t);var e=Object(Ft.a)(n);function n(){return Object(l.a)(this,n),e.apply(this,arguments)}return n}(Object(Bt.a)(Error)),Lf=function(){function t(e,n,a,i){var r=this;Object(l.a)(this,t),this.host=e,this.regions=n,this.totalNArenas=a,this.runInWebWorker=i,this.agentRects=void 0,this.teamRects=void 0,this.nTeams=void 0,this.socket=this.runInWebWorker?new Nf(this.host):new WebSocket(this.host),this.connected=new Promise((function(t){r.socket.addEventListener("open",(function e(){t(),r.socket.removeEventListener("open",e)}))})),this.error=new Promise((function(t){r.socket.addEventListener("error",(function e(){t(),r.socket.removeEventListener("error",e)}))})),this.messageQueue=[],this.waiting=void 0,this.teamRects=n.map((function(t){var e=t.sides,n=t.start_arena,i=t.n_arenas;return{x:null!==n&&void 0!==n?n:0,y:"away"===e?1:0,width:void 0!==i&&i>=0?i:a,height:"both"===e?2:1}})),this.agentRects=this.teamRects.map((function(t){return{x:3*t.x,y:t.y,width:3*t.width,height:t.height}})),this.nTeams=this.teamRects.reduce((function(t,e){return t+e.width*e.height}),0),this.socket.binaryType="arraybuffer",this.socket.addEventListener("message",(function(t){r.waiting?(r.waiting.resolve(t.data),r.waiting=void 0):r.messageQueue.push(t.data)})),this.socket.addEventListener("close",(function(){r.waiting&&(r.waiting.reject(new Hf),r.waiting=void 0)}))}return Object(p.a)(t,[{key:"send",value:function(t){if(this.socket.readyState===WebSocket.CLOSED||this.socket.readyState===WebSocket.CLOSING)throw new Hf;this.socket.send(t)}},{key:"close",value:function(){this.socket.close()}},{key:"message",value:function(){var t=Object(c.a)(s.a.mark((function t(){var e=this;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.socket.readyState!==WebSocket.CLOSED&&this.socket.readyState!==WebSocket.CLOSING){t.next=2;break}throw new Hf;case 2:if(!(this.messageQueue.length>0)){t.next=6;break}return t.abrupt("return",this.messageQueue.shift());case 6:return t.next=8,new Promise((function(t,n){e.waiting={resolve:t,reject:n}}));case 8:return t.abrupt("return",t.sent);case 9:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()}]),t}();function Uf(t,e){var n,a=new Float32Array(e.reduce((function(e,n){return e+n.width*n.height*t.size.depth*t.channels}),0)),i=0,r=Object(m.a)(e);try{for(r.s();!(n=r.n()).done;){var o=n.value,s=o.width*o.height*t.size.depth*t.channels;t.select(o).toArray(a.subarray(i,i+s)),i+=s}}catch(Nt){r.e(Nt)}finally{r.f()}return a}function Vf(t,e){for(t=Object(mt.a)(t);t.length%4!==0;)t.push(e+t.length);return t}var Qf,qf=[].concat(Object(mt.a)(Vf(Object(b.q)(qo),"UnusedSense")),Object(mt.a)(Vf(Object(b.q)(Wo),"UnusedExtraSense"))),Wf=function t(e){Object(l.a)(this,t),this.gls=e,this.readRewards=new _f(this.gls),this.readSenses=new Zf(this.gls),this.readTeamStats=new $f(this.gls),this.writeActions=new td(this.gls)};!function(t){t[t.Connected=0]="Connected",t[t.Error=1]="Error"}(Qf||(Qf={}));var Yf=function(){function t(e,n,a,i){var o,s,c,u,h,f,d,m,p,v,g=this;Object(l.a)(this,t),this.program=e,this.appState=n,this.tools=a,this.config=void 0,this.destroyedResolve=void 0,this.destroyed=new Promise((function(t){g.destroyedResolve=t})),this.state=void 0,this.lastReward=void 0,this.pendingStep=void 0,this.creaturesTexture=void 0,this.teamStatsTexture=void 0,this.actionsTexture=void 0,this.profiler=new b.e,this.remoteHosts=[];var y=Object(r.a)(Object(r.a)({},{killEnemyStatue:4,killEnemyUnit:1,timeScaling:1}),i.rewardFunction);this.config={agentHosts:i.agentHosts,home:i.home,away:i.away,rewardFunction:y,nArenas:null!==(o=i.nArenas)&&void 0!==o?o:1,substeps:null!==(s=i.substeps)&&void 0!==s?s:8,randomSeed:null!==(c=i.randomSeed)&&void 0!==c?c:Object(b.i)(),turboMode:null!==(u=i.turboMode)&&void 0!==u&&u,interleaved:null===(h=i.interleaved)||void 0===h||h,debugNoObservations:null!==(f=i.debugNoObservations)&&void 0!==f&&f,debugNoActionsWrite:null!==(d=i.debugNoActionsWrite)&&void 0!==d&&d,webWorkerSocket:null!==(m=i.webWorkerSocket)&&void 0!==m&&m,aiCrowdLogo:null!==(p=i.aiCrowdLogo)&&void 0!==p&&p,gameState:null!==(v=i.gameState)&&void 0!==v&&v},this.creaturesTexture=this.creaturesTexture=ut.create(this.program.gls,$t.RG32I,{width:3*this.config.nArenas,height:2}).init(),this.teamStatsTexture=ut.create(this.program.gls,$t.R32F,{width:this.config.nArenas,height:2},Object(b.q)(Ff).length).init(),console.log("[DerkSession] Created with config:",this.config)}return Object(p.a)(t,[{key:"destroy",value:function(){var t;this.disconnectAllRemotes(),this.destroyWorldState(),this.creaturesTexture.destroy(),this.teamStatsTexture.destroy(),null===(t=this.actionsTexture)||void 0===t||t.destroy(),this.destroyedResolve()}},{key:"disconnectAllRemotes",value:function(){var t,e=Object(m.a)(this.remoteHosts);try{for(e.s();!(t=e.n()).done;){t.value.close()}}catch(Nt){e.e(Nt)}finally{e.f()}this.remoteHosts=[]}},{key:"destroyWorldState",value:function(){var t,e,n;null===(t=this.state)||void 0===t||null===(e=t.gameLoop)||void 0===e||e.destroy(),null===(n=this.state)||void 0===n||n.destroy()}},{key:"setRewardFunction",value:function(t){this.config.rewardFunction=Object(r.a)(Object(r.a)({},{killEnemyStatue:4,killEnemyUnit:1,timeScaling:1}),t)}},{key:"connectToAgentHosts",value:function(){var t=Object(c.a)(s.a.mark((function t(){var e,n=this;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[DerkSession.connectToAgentHosts] Connecting to ".concat(this.config.agentHosts.length," hosts")),t.next=3,Promise.all(this.config.agentHosts.map(function(){var t=Object(c.a)(s.a.mark((function t(e,a){var i,r,o,c;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=e.uri,r=e.regions,!n.remoteHosts[a]){t.next=6;break}return console.log("[DerkSession.connectToAgentHosts] ".concat(i," already connected")),t.abrupt("return",Qf.Connected);case 6:return console.log("[DerkSession.connectToAgentHosts] Connecting to ".concat(i)),o=new Lf(i,r,n.config.nArenas,n.config.webWorkerSocket),t.next=10,Promise.race([o.connected.then((function(){return Qf.Connected})),o.error.then((function(){return Qf.Error}))]);case 10:return c=t.sent,console.log("[DerkSession.connectToAgentHosts] ".concat(i," connection:"),Qf[c]),c===Qf.Connected&&(console.log("[DerkSession.connectToAgentHosts] Sending config to ".concat(i)),o.send(JSON.stringify({nTeams:o.nTeams})),n.remoteHosts[a]=o),t.abrupt("return",c);case 14:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}()));case 3:return e=t.sent,console.log("[DerkSession.connectToAgentHosts] Done"),t.abrupt("return",e.reduce((function(t,e){return t&&e===Qf.Connected}),!0));case 6:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"reset",value:function(){var t=Object(c.a)(s.a.mark((function t(){var e,n,a,i,r,o,c,l;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.profiler.enter("reset"),t.next=3,Object(b.H)(0);case 3:if(!this.pendingStep){t.next=7;break}return t.next=6,this.pendingStep;case 6:this.pendingStep=void 0;case 7:return t.next=9,this.createNewWorldState(this.config);case 9:return this.actionsTexture&&this.actionsTexture.destroy(),this.actionsTexture=ut.create(this.program.gls,$t.R32F,{width:3*this.config.nArenas*Gf.length,height:2},1).init(),this.profiler.enter("resetForNextRound"),this.program.resetForNextRound(this.state,!0),this.profiler.exit(),e=this.state.data.round+1,this.state.setData({simulationEnded:!1,battleStartStep:this.state.data.stepCounter,round:e}),this.profiler.enter("getRewardAndObservations"),t.next=19,Promise.all([this.readTotalReward(this.creaturesTexture),this.getObservations(this.creaturesTexture)]);case 19:n=t.sent,a=Object(u.a)(n,2),i=a[0],r=a[1],this.profiler.exit(),this.lastReward=i,o=Object(m.a)(this.remoteHosts);try{for(o.s();!(c=o.n()).done;)l=c.value,console.log("[reset] Sending observations to ".concat(l.host)),l.send(Uf(r,l.agentRects).buffer)}catch(Nt){o.e(Nt)}finally{o.f()}this.config.interleaved&&(this.pendingStep=this.stepInternal()),this.profiler.exit();case 29:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"normalizeUnit",value:function(t){var e=Df();return Object(r.a)(Object(r.a)({type:"creature",slots:id()},Pf(e)),{},{bounties:t.rewardFunction},t)}},{key:"createNewWorldState",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a,i,r,o,c,u,l,h,f,d,m,p,v,y,w,C,x,A,O,j,S,k,I;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.profiler.enter("createNewWorldState"),this.destroyWorldState(),t.next=4,Yl.createWithMap(this.program.gls,{arenaCount:e.nArenas});case 4:return this.state=t.sent,this.state.setData({renderGazes:!0,battleground:na.DbBattleground.Team,gameInstance:{type:"gym"},simulationPaused:!1,aiCrowdLogo:e.aiCrowdLogo}),this.state.random=new b.c(e.randomSeed),this.state.setData({randomSeed:this.state.random.random()}),Es(this.state),i=null!==(n=e.home)&&void 0!==n?n:[],r=null!==(a=e.away)&&void 0!==a?a:[],o=4,c=4,this.state.updateTeam("home",{unitCount:o,battleUnitsAlive:o-1,maxPossiblePoints:da+(c>1?fa:0)}),this.state.updateTeam("away",{unitCount:c,battleUnitsAlive:c-1,maxPossiblePoints:da+(o>1?fa:0)}),t.next=17,Object(b.H)(0);case 17:for(u={},l=0;l<e.nArenas;l++)for(h=0;h<o;h++)d=[3*l+h-1,0],m=0===h?{type:"statue"}:this.normalizeUnit(null!==(f=i[d[0]%i.length])&&void 0!==f?f:{}),u[m.type]||(u[m.type]=[]),u[m.type].push({unit:m,gymIndex:d,team:ta.HomeTeam,arenaIndex:l,arenaMemberIndex:h});for(p=0;p<e.nArenas;p++)for(v=0;v<c;v++)w=[3*p+v-1,1],C=0===v?{type:"statue"}:this.normalizeUnit(null!==(y=r[w[0]%r.length])&&void 0!==y?y:{}),u[C.type]||(u[C.type]=[]),u[C.type].push({unit:C,gymIndex:w,team:ta.AwayTeam,arenaIndex:p,arenaMemberIndex:la+v});this.profiler.enter("createUnits"),x=[],A=0,O=Object.keys(u);case 23:if(!(A<O.length)){t.next=32;break}return S=O[A],t.next=27,nh(this.state,u[S],{createAbilities:!0,createBrain:!1,profiler:this.profiler,bounties:null===(j=this.config)||void 0===j?void 0:j.rewardFunction});case 27:for(k=t.sent,I=0;I<k.count;I++)"statue"!==u[S][I].unit.type&&x.push(k.getIndex(I));case 29:A++,t.next=23;break;case 32:return this.profiler.exit(),this.creaturesTexture.sliceAll().upload(new Int32Array(g.a.flatMap(x,(function(t){return[t.x,t.y]})))),this.profiler.enter("createModels"),t.next=37,Object(b.H)(0);case 37:vh(this.state,this.state.data.renderArena),this.profiler.exit(),this.appState.update({worldState:this.state}),this.profiler.exit();case 41:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"playPromise",value:function(){var t=this;return new Promise((function(e){var n;null===(n=t.state)||void 0===n||n.events.dataChanged.attach((function n(a){var i;a.after.simulationPaused||(null===(i=t.state)||void 0===i||i.events.dataChanged.detach(n),e())}))}))}},{key:"step",value:function(){var t=Object(c.a)(s.a.mark((function t(){var e,n,a,i,r,o,c=this;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(null===(e=this.state)||void 0===e?void 0:e.data.simulationPaused)){t.next=3;break}return t.next=3,this.playPromise();case 3:if(!this.config.interleaved){t.next=17;break}return console.log("[step] Running interleaved"),n=this.pendingStep,t.next=8,this.readStepActions();case 8:return a=t.sent,this.pendingStep=n.then((function(t){return t||c.stepInternal(a)})),t.next=12,n;case 12:return i=t.sent,console.log("[step] Done interleaved"),t.abrupt("return",i);case 17:return console.log("[step] Running"),t.next=20,this.readStepActions();case 20:return r=t.sent,t.next=23,this.stepInternal(r);case 23:return o=t.sent,console.log("[step] Done"),t.abrupt("return",o);case 26:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"readStepActions",value:function(){var t=Object(c.a)(s.a.mark((function t(){var e,n;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[readStepActions] Waiting for away actions from ".concat(this.remoteHosts.length," hosts")),t.next=3,Promise.all(this.remoteHosts.map(function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.message();case 2:return n=t.sent,a=new Float32Array(n),t.abrupt("return",{actions:a,rects:e.agentRects});case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 3:return n=t.sent,(null===(e=this.config)||void 0===e?void 0:e.debugNoActionsWrite)||this.tools.writeActions.writeActionsToTexture(n,this.actionsTexture.sliceAll()),console.log("[readStepActions] Got actions ".concat(n.length)),t.abrupt("return",this.actionsTexture);case 7:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"stepInternal",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a,i,r,o,c,l,h,f,d,p,v,g=this;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e&&(console.log("[stepInternal] Write actions"),this.tools.writeActions.write(this.state,e)),n=Kf(),a=0;case 3:if(!(a<this.config.substeps)){t.next=14;break}if(!(a>0)||(null===(i=this.config)||void 0===i?void 0:i.turboMode)){t.next=9;break}return t.next=7,n;case 7:n=Kf(),this.program.render(this.state);case 9:return t.next=11,this.program.step(this.state);case 11:a++,t.next=3;break;case 14:return this.program.render(this.state),t.next=17,Promise.all([this.readTotalReward(this.creaturesTexture),this.getObservations(this.creaturesTexture)]);case 17:if(r=t.sent,o=Object(u.a)(r,2),c=o[0],l=o[1],h=c.map((function(t,e){return t-g.lastReward.read(e.x,e.y,e.z,e.w)})),this.lastReward=c,!this.state.data.simulationEnded){t.next=28;break}return this.tools.readTeamStats.run(this.state,this.teamStatsTexture.sliceAll()),t.next=27,this.teamStatsTexture.readAsync();case 27:f=t.sent;case 28:d=Object(m.a)(this.remoteHosts);try{for(d.s();!(p=d.n()).done;)(v=p.value).send(Uf(l,v.agentRects).buffer),v.send(Uf(h,v.agentRects).buffer),v.send(JSON.stringify({done:[this.state.data.simulationEnded],info:{gameState:this.config.gameState?this.state.ecs.dumpJSON(this.state):void 0}})),f&&v.send(Uf(f,v.teamRects).buffer)}catch(Nt){d.e(Nt)}finally{d.f()}return t.abrupt("return",this.state.data.simulationEnded);case 31:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"readTotalReward",value:function(t){return this.tools.readRewards.run(this.state,t)}},{key:"readTeamStatsBase64",value:function(){var t=Object(c.a)(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=b.f,t.next=3,this.teamStatsTexture.readAsync();case 3:return t.t1=t.sent.data.buffer,t.abrupt("return",(0,t.t0)(t.t1));case 5:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"getObservations",value:function(){var t=Object(c.a)(s.a.mark((function t(e){var n,a;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.program.updateNeuralNetwork.senses.run(this.state),this.program.updateNeuralNetwork.gymExtraSenses.run(this.state),t.next=4,this.tools.readSenses.run(this.state,e);case 4:return a=t.sent,(null===(n=this.config)||void 0===n?void 0:n.debugNoObservations)&&(a=et.zeroesF32({width:0,height:0,depth:0},1)),console.log("[getObservations] Returning observations (".concat(a.data.length,") ").concat(Array.from(a.data.slice(0,5)),"...")),t.abrupt("return",a);case 8:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()}]),t}(),Xf=function(){function t(e,n){Object(l.a)(this,t),this.program=e,this.appState=n,this.tools=new Wf(this.program.gls),this.session=void 0,this.getLatestVersion()}return Object(p.a)(t,[{key:"getLatestVersion",value:function(){var t=Object(c.a)(s.a.mark((function t(){var e,n;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,fetch("http://pypi.org/pypi/gym_derk/json");case 2:return t.next=4,t.sent.json();case 4:e=t.sent,n=e.info.version,console.log("Got gym_derk latest version: ".concat(n)),Mf.a.gt(n,Wu.a.version)&&(console.warn("New gym_derk version available: ".concat(n)),this.appState.update({newVersion:n}));case 8:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"createSession",value:function(){var t=Object(c.a)(s.a.mark((function t(e){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.session&&this.session.destroy(),this.session=new Yf(this.program,this.appState,this.tools,e);case 2:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getEnums",value:function(){return{observationKeys:qf,teamStatsKeys:Object(b.q)(Ff)}}},{key:"getWebGLRenderer",value:function(){var t=this.program.gls.gl,e=t.getExtension("WEBGL_debug_renderer_info");if(e){var n=t.getParameter(e.UNMASKED_RENDERER_WEBGL),a=t.getParameter(e.UNMASKED_VENDOR_WEBGL);return"Renderer=".concat(n," Vendor=").concat(a)}return"Failed to get extension WEBGL_debug_renderer_info"}}]),t}();function Kf(){return new Promise((function(t){requestAnimationFrame(t)}))}var Jf=function(){function t(e,n,a){var i=this;Object(l.a)(this,t),this.gls=e,this.component=n,this.outSlices=a,this.shader=new jt(At([this.component.sm],{entities:pt("isampler2D"),outValues:yt("".concat(this.component.component.format,"[").concat(this.outSlices,"]")),main:Ct("void",[],"\n      ivec2 entity = texelFetch(Self.entities, ivec2(gl_FragCoord), 0).xy;\n      ".concat(new Array(this.outSlices).fill(0).map((function(t,e){return"\n          outValues[".concat(e,"] = ").concat(void 0!==i.component.component.depth?"".concat(i.component.sm.value,"(entity, ").concat(e,")"):"".concat(i.component.sm.value,"(entity)"),";\n        ")})).join("\n"),"\n    "))})),this.program=new Xt(this.gls,this.shader.source),this.renderTarget=new at(this.gls)}return Object(p.a)(t,[{key:"run",value:function(t,e,n){this.shader.updateUniformValues(t),this.program.prepare(),this.shader.writeUniforms(this.program),this.program.setUniform("entities","isampler2D",e),this.renderTarget.set(n),this.gls.prepareForComputation(n.rect),this.gls.drawQuad(this.program)}}]),t}(),Zf=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.senses=new Jf(this.gls,vs,ss),this.gymExtraSenses=new Jf(this.gls,ys,gs)}return Object(p.a)(t,[{key:"run",value:function(t,e){var n=this.gls.getTmpTextureSlice($t.RGBA32F,e.size,ss+gs);return this.senses.run(t,e,n.sliceRange(0,ss)),this.gymExtraSenses.run(t,e,n.sliceRange(ss,gs)),n.readAsync()}}]),t}(),_f=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.gold=new Jf(this.gls,Ja,1)}return Object(p.a)(t,[{key:"run",value:function(t,e){var n=this.gls.getTmpTextureSlice($t.R32F,e.size,1);return this.gold.run(t,e,n),n.readAsync()}}]),t}(),$f=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.shader=new jt(At([gr],{outValues:yt("float[".concat(Object(b.q)(Ff).length,"]")),main:Ct("void",[],"\n      ivec2 cell = ivec2(gl_FragCoord.xy);\n      TeamStats_Stats selfStats = ".concat(gr.stats,"(cell.x, cell.y == 0 ? ").concat(ta.HomeTeam," : ").concat(ta.AwayTeam,");\n      TeamStats_Stats opponentStats = ").concat(gr.stats,"(cell.x, cell.y == 0 ? ").concat(ta.AwayTeam," : ").concat(ta.HomeTeam,");\n      outValues[").concat(Ff.Reward,"] = float(selfStats.gold);\n      outValues[").concat(Ff.OpponentReward,"] = float(opponentStats.gold);\n      outValues[").concat(Ff.Hitpoints,"] = selfStats.hitpoints;\n      outValues[").concat(Ff.AliveTime,"] = selfStats.aliveTime;\n      outValues[").concat(Ff.CumulativeHitpoints,"] = selfStats.cumulativeHitpoints;\n    "))})),this.program=new Xt(this.gls,this.shader.source),this.renderTarget=new at(this.gls)}return Object(p.a)(t,[{key:"run",value:function(t,e){this.shader.updateUniformValues(t),this.program.prepare(),this.shader.writeUniforms(this.program),this.renderTarget.set(e),this.gls.prepareForComputation(e.rect),this.gls.drawQuad(this.program)}}]),t}(),td=function(){function t(e){Object(l.a)(this,t),this.gls=e,this.query=new Re([za.component]).updateGpu(this.gls,Qs.map((function(t){return t.component})),At([].concat(Object(mt.a)(Qs.map((function(t){return t.writer}))),[Ra.sm]),{actions:pt("sampler2DArray"),update:Ct("void",[["ivec2","entityCell"]],"\n          ivec2 index = ".concat(Ra.sm.value,"(entityCell) * ivec2(").concat(Qs.length,", 1);\n          ").concat(Vs.MoveX.writer.write,"(          texelFetch(actions, ivec3(index + ivec2(0, 0), 0), 0).x);\n          ").concat(Vs.Rotate.writer.write,"(         texelFetch(actions, ivec3(index + ivec2(1, 0), 0), 0).x);\n          ").concat(Vs.ChaseFocus.writer.write,"(     texelFetch(actions, ivec3(index + ivec2(2, 0), 0), 0).x);\n          ").concat(Vs.CastingSlot.writer.write,"(int(texelFetch(actions, ivec3(index + ivec2(3, 0), 0), 0).x));\n          ").concat(Vs.ChangeFocus.writer.write,"(int(texelFetch(actions, ivec3(index + ivec2(4, 0), 0), 0).x));\n        "))}))}return Object(p.a)(t,[{key:"writeActionsToTexture",value:function(t,e){e.clear();var n,a=Object(m.a)(t);try{for(a.s();!(n=a.n()).done;){var i,r=n.value,o=0,s=Object(m.a)(r.rects);try{for(s.s();!(i=s.n()).done;){var c=i.value,u=c.width*Gf.length*c.height;e.selectAbsolute({x:c.x*Gf.length,y:c.y,width:c.width*Gf.length,height:c.height}).upload(r.actions.subarray(o,o+u)),o+=u}}catch(Nt){s.e(Nt)}finally{s.f()}}}catch(Nt){a.e(Nt)}finally{a.f()}}},{key:"write",value:function(t,e){this.query.run(t,[{name:"actions",type:"sampler2DArray",value:e}])}}]),t}(),ed=na.ItemKeys.filter((function(t){var e=na.Items[t];return"attachment"===(null===e||void 0===e?void 0:e.type)&&"arms"===e.slot})),nd=na.ItemKeys.filter((function(t){var e=na.Items[t];return"attachment"===(null===e||void 0===e?void 0:e.type)&&"tail"===e.slot})),ad=na.ItemKeys.filter((function(t){var e=na.Items[t];return"attachment"===(null===e||void 0===e?void 0:e.type)&&"misc"===e.slot}));function id(){var t=[];return Math.random()>.7&&(t[0]=ed[Math.floor(Math.random()*ed.length)]),Math.random()>.7&&(t[1]=nd[Math.floor(Math.random()*nd.length)]),Math.random()>.7&&(t[2]=ad[Math.floor(Math.random()*ad.length)]),t}var rd=function t(){Object(l.a)(this,t),this.worldState=void 0,this.status="Initializing...",this.newVersion=void 0},od=f.createContext(new fl(new rd));function sd(t){return dl(od,t)}function cd(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return ml.apply(void 0,[od].concat(e))}function ud(){var t=ml(od,"status").status;return Object(h.jsx)("div",{children:t})}function ld(){var t=f.useState(!1),e=Object(u.a)(t,2),n=e[0],a=e[1],i=ml(od,"newVersion","worldState"),r=i.newVersion,o=i.worldState,s=gl("simulationPaused").simulationPaused;return Object(h.jsxs)("div",{className:"GymUI",children:[Object(h.jsxs)(nl,{children:[Object(h.jsxs)(ol,{className:"GymActionBar",children:[Object(h.jsx)(qu,{icon:"play",title:"Play",flat:!0,disabled:!s,onClick:function(){return null===o||void 0===o?void 0:o.setData({simulationPaused:!1})}}),Object(h.jsx)(qu,{icon:"pause",title:"Pause",flat:!0,disabled:s,onClick:function(){return null===o||void 0===o?void 0:o.setData({simulationPaused:!0})}}),Object(h.jsx)(qu,{icon:"eye",title:"ECS inspector",flat:!0,onClick:function(){return a(!n)}})]}),Object(h.jsx)(ud,{}),r&&Object(h.jsxs)("div",{children:["New version available: ",r]})]}),Object(h.jsx)(jh,{}),Object(h.jsxs)(sl,{className:"GymUIBottom",children:[Object(h.jsx)(Ih,{}),Object(h.jsx)(Rh,{})]}),n&&Object(h.jsx)(yl,{}),Object(h.jsx)(kh,{})]})}function hd(){var t,e,n=f.useRef(null),a=f.useState(),i=Object(u.a)(a,2),o=i[0],l=i[1],d=f.useContext(od),m=cd("worldState").worldState,p=f.useState(!1),v=Object(u.a)(p,2),g=v[0],y=v[1];return f.useEffect((function(){Object(c.a)(s.a.mark((function t(){var e,a,i,r;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Object(b.H)(100);case 2:if(!n.current){t.next=15;break}if(e=n.current.getBoundingClientRect(),n.current.width=e.width,n.current.height=e.height,a=n.current.getContext("webgl2",{desynchronized:!0})){t.next=10;break}return console.log("Failed to create WebGL2 context"),t.abrupt("return");case 10:i=new _t(n.current,a),r=new Du(i),l(r),window.derk=new Xf(r,d),y(!0);case 15:case"end":return t.stop()}}),t)})))()}),[d]),Object(h.jsx)(hl.Provider,{value:o,children:Object(h.jsxs)(pl.Provider,{value:m,children:[Object(h.jsx)(Rl,{conf:Object(r.a)(Object(r.a)({},Tl()),{},{fovy:35/360*Math.PI*2})}),Object(h.jsxs)("div",{className:"Gym",children:[Object(h.jsx)("canvas",{ref:n}),Object(h.jsx)(ld,{}),g&&Object(h.jsx)("div",{className:"GymLoaded"})]}),(null!==(t=null===o||void 0===o?void 0:o.gls.shaderCache.errors.length)&&void 0!==t?t:0)>0&&Object(h.jsx)(ul,{shaderErrors:null!==(e=null===o||void 0===o?void 0:o.gls.shaderCache.errors)&&void 0!==e?e:[]})]})})}function fd(){var t=f.useState(new fl(new rd)),e=Object(u.a)(t,1)[0];return Object(h.jsx)(od.Provider,{value:e,children:Object(h.jsx)(hd,{})})}},707:function(t,e,n){},708:function(t,e,n){},709:function(t,e,n){},710:function(t,e,n){},711:function(t,e,n){},712:function(t,e,n){},713:function(t,e,n){},714:function(t,e,n){},715:function(t,e,n){},716:function(t,e,n){},717:function(t,e,n){},718:function(t,e,n){},719:function(t,e,n){},720:function(t,e,n){},721:function(t,e,n){},722:function(t,e,n){},723:function(t,e,n){},724:function(t,e,n){},725:function(t,e,n){},74:function(t,e,n){"use strict";(function(t){n.d(e,"i",(function(){return b})),n.d(e,"C",(function(){return C})),n.d(e,"B",(function(){return x})),n.d(e,"h",(function(){return A})),n.d(e,"g",(function(){return O})),n.d(e,"u",(function(){return j})),n.d(e,"l",(function(){return S})),n.d(e,"F",(function(){return k})),n.d(e,"r",(function(){return I})),n.d(e,"D",(function(){return E})),n.d(e,"k",(function(){return T})),n.d(e,"E",(function(){return R})),n.d(e,"n",(function(){return D})),n.d(e,"A",(function(){return P})),n.d(e,"x",(function(){return F})),n.d(e,"w",(function(){return B})),n.d(e,"G",(function(){return M})),n.d(e,"z",(function(){return z})),n.d(e,"y",(function(){return N})),n.d(e,"v",(function(){return G})),n.d(e,"a",(function(){return H})),n.d(e,"q",(function(){return L})),n.d(e,"c",(function(){return U})),n.d(e,"d",(function(){return V})),n.d(e,"H",(function(){return Q})),n.d(e,"j",(function(){return q})),n.d(e,"b",(function(){return W})),n.d(e,"m",(function(){return Y})),n.d(e,"o",(function(){return X})),n.d(e,"p",(function(){return K})),n.d(e,"t",(function(){return J})),n.d(e,"s",(function(){return Z})),n.d(e,"f",(function(){return _})),n.d(e,"e",(function(){return $}));n(84);var a,i,r,o=n(70),s=n(22),c=n(23),u=n(69),l=(n(72),n(79)),h=n(318),f=n.n(h),d=n(321),m=n.n(d),p=n(195),v=n.n(p),g=(n(85),n(330)),y=(n(78),m()("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"));function b(){return y.encode(f()(null,new t(16)))}function w(t){for(var e=0,n=0;n<t.length;n++)e=Math.imul(31,e)+t.charCodeAt(n)|0;return e}function C(t){return"#"+function(t){var e=(16777215&t).toString(16).toUpperCase();return"00000".substring(0,6-e.length)+e}(w(t))}function x(t,e,n){return"hsl(".concat(w(t)%360,", ").concat(100*e,"%, ").concat(100*n,"%)")}function A(t,e,n){var a=Object(l.a)(t);return a[e]=n,a}function O(t,e){return[].concat(Object(l.a)(t.slice(0,e)),Object(l.a)(t.slice(e+1)))}function j(t,e){for(var n=!1,a=0,i=Object.keys(e);a<i.length;a++){var r=i[a];t[r]!==e[r]&&(n=!0)}return n?Object(u.a)(Object(u.a)({},t),e):t}function S(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(0===t||isNaN(t)||!isFinite(t))return""+t;var a=Math.sign(t);t=Math.abs(t);var i=Math.ceil(Math.log10(t)),r=Math.pow(10,i-e),o=a*Math.floor(t/r)*r;return(o!==t?"~":"")+(n&&o>0?"+":"")+o.toLocaleString("en-EN")}function k(t){return a.kg}function I(t,e){switch(e){case a.kg:return t;case a.g:return t*Math.pow(10,3);case a.mg:return t*Math.pow(10,6)}}function E(t){return i.MJ}function T(t,e){switch(e){case i.MJ:return t;case i.kJ:return t*Math.pow(10,3);case i.J:return t*Math.pow(10,6)}}function R(t){return r.HP}function D(t,e){switch(e){case r.kHP:return t*Math.pow(10,-3);case r.HP:return t;case r.mHP:return t*Math.pow(10,3);case r.nHP:return t*Math.pow(10,6)}}!function(t){t.kg="kg",t.g="g",t.mg="mg"}(a||(a={})),function(t){t.MJ="MJ",t.kJ="kJ",t.J="J"}(i||(i={})),function(t){t.kHP="kHP",t.HP="HP",t.mHP="mHP",t.nHP="nHP"}(r||(r={}));function P(t){return{x:t.r/255,y:t.g/255,z:t.b/255,w:t.a}}function F(t){return{x:t.r/255,y:t.g/255,z:t.b/255,w:1}}function B(t){return{x:t.r/255,y:t.g/255,z:t.b/255}}function M(t){return{r:255*t.x,g:255*t.y,b:255*t.z,a:1}}function z(t){var e=t.r,n=t.g,a=t.b;return v()({r:e,g:n,b:a}).toString()}function N(t){return v()(t).rgb().object()}function G(){return{r:255*Math.random(),g:255*Math.random(),b:255*Math.random()}}var H=function(){function t(){Object(s.a)(this,t),this.listeners=[]}return Object(c.a)(t,[{key:"dispatch",value:function(){var t,e=Object(o.a)(this.listeners);try{for(e.s();!(t=e.n()).done;){var n=t.value;n.apply(void 0,arguments)}}catch(a){e.e(a)}finally{e.f()}}},{key:"attach",value:function(t){this.listeners.push(t)}},{key:"detach",value:function(t){this.listeners.splice(this.listeners.indexOf(t),1)}},{key:"transform",value:function(e){var n=new t;return this.attach((function(){return n.dispatch.apply(n,Object(l.a)(e.apply(void 0,arguments)))})),n}}]),t}();function L(t){return Object.keys(t).filter((function(t){return isNaN(parseInt(t,10))}))}var U=function(){function t(e){Object(s.a)(this,t),this.generator=void 0,this.generator=g(e)}return Object(c.a)(t,[{key:"random",value:function(){return this.generator()}}]),t}(),V=new(function(){function t(){Object(s.a)(this,t),this.cached={}}return Object(c.a)(t,[{key:"get",value:function(t){return void 0!==this.cached[t]?this.cached[t]:this.cached[t]=new U(t).random()}}]),t}());function Q(t){return new Promise((function(e){return setTimeout(e,t)}))}function q(t){return t.charAt(0).toUpperCase()+t.slice(1)}var W=function(){function t(e){Object(s.a)(this,t),this.get=e,this.cached=void 0}return Object(c.a)(t,[{key:"value",get:function(){return void 0===this.cached&&(this.cached={value:this.get()}),this.cached.value}}]),t}();function Y(){return navigator.userAgent.indexOf("Firefox")>-1?"Firefox":navigator.userAgent.indexOf("SamsungBrowser")>-1?"SamsungInternet":navigator.userAgent.indexOf("Opera")>-1||navigator.userAgent.indexOf("OPR")>-1?"Opera":navigator.userAgent.indexOf("Trident")>-1?"InternetExplorer":navigator.userAgent.indexOf("Edge")>-1?"Edge":navigator.userAgent.indexOf("Chrome")>-1?"Chrome":navigator.userAgent.indexOf("Safari")>-1?"Safari":"Unknown"}function X(){var t,e=!1;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e}function K(t){return void 0===t||null===t}function J(t){return void 0!==t&&null!==t}function Z(t){return!!t}function _(t){for(var e="",n=new Uint8Array(t),a=n.byteLength,i=0;i<a;i++)e+=String.fromCharCode(n[i]);return window.btoa(e)}var $=function(){function t(){Object(s.a)(this,t),this.stack=[]}return Object(c.a)(t,[{key:"enter",value:function(t){this.stack.push({start:window.performance.now(),title:t,childrenTime:0}),console.log("\u23f1 "+this.stack.map((function(t){return t.title})).join("/")+"...")}},{key:"exit",value:function(){var t=window.performance.now(),e=this.stack.map((function(t){return t.title})).join("/"),n=this.stack.pop(),a=t-n.start;this.stack.length>0&&(this.stack[this.stack.length-1].childrenTime+=a);var i="";0!==n.childrenTime&&(i="".concat(Math.round(1e4*n.childrenTime/a)/100,"% in children")),console.log("\u23f1 ".concat(e," ").concat(this.msToString(a),"ms ").concat(i))}},{key:"msToString",value:function(t){return(Math.round(100*t)/100).toLocaleString("en")}}]),t}()}).call(this,n(194).Buffer)},78:function(t,e,n){"use strict";n.d(e,"g",(function(){return r})),n.d(e,"l",(function(){return o})),n.d(e,"j",(function(){return s})),n.d(e,"a",(function(){return c})),n.d(e,"f",(function(){return u})),n.d(e,"d",(function(){return l})),n.d(e,"e",(function(){return h})),n.d(e,"c",(function(){return f})),n.d(e,"i",(function(){return m})),n.d(e,"h",(function(){return p})),n.d(e,"k",(function(){return v})),n.d(e,"m",(function(){return g})),n.d(e,"b",(function(){return y}));var a=n(69),i=n(98);n(93);function r(t,e){return(t%e+e)%e}function o(t){return{x:t.width,y:t.height}}function s(t){var e,n=(e=Math.max(t.width,t.height),Math.pow(2,Math.ceil(Math.log2(e))));return{width:n,height:n}}function c(t,e,n){return Math.min(Math.max(t,e),n)}function u(t,e,n){return t*(1-n)+e*n}function l(t,e,n,a,i){return a+(t-e)/(n-e)*(i-a)}function h(t,e,n,a,i){return a+c((t-e)/(n-e),0,1)*(i-a)}function f(t){for(var e=[],n=1/(2*Math.PI*t*t),a=-1;a<=1;a++)for(var i=-1;i<=1;i++)e.push(n*Math.exp(-(i*i+a*a)/(2*t*t)));var r=e.reduce((function(t,e){return t+e}),0);return e.map((function(t){return t/r}))}Math.sqrt(2*Math.PI);function d(t,e,n){return function(t,e){return i.transform(e,t)}(t,{x:2*(n.x-e.x)/e.width-1,y:-(2*(n.y-e.y)/e.height-1),z:n.z})}function m(t,e,n){var r=d(t,e,Object(a.a)(Object(a.a)({},n),{},{z:1})),o=d(t,e,Object(a.a)(Object(a.a)({},n),{},{z:-1}));return{origin:o,direction:i.normalize(i.sub(r,o))}}function p(t,e){var n=i.dot(t.direction,e.normal);if(0!==n){var a=-(i.dot(t.origin,e.normal)+e.distance)/n;return a<0?null:i.add(t.origin,i.mul(t.direction,a))}return i.dot(e.normal,t.origin)+e.distance===0?t.origin:null}function v(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return e-Math.abs(r(t,2*e)-e)}function g(t){return Number.isNaN(t)||!Number.isFinite(t)?0:t}function y(t){return t-Math.floor(t)}},96:function(t,e,n){},98:function(t,e,n){"use strict";n.r(e),n.d(e,"Vector3Typedef",(function(){return o})),n.d(e,"create",(function(){return s})),n.d(e,"xy",(function(){return c})),n.d(e,"zero",(function(){return u})),n.d(e,"random",(function(){return l})),n.d(e,"fromSphericalCoordinates",(function(){return h})),n.d(e,"toSphericalCoordinates",(function(){return f})),n.d(e,"length2",(function(){return d})),n.d(e,"length",(function(){return m})),n.d(e,"distance",(function(){return p})),n.d(e,"normalize",(function(){return v})),n.d(e,"invert",(function(){return g})),n.d(e,"add",(function(){return y})),n.d(e,"sub",(function(){return b})),n.d(e,"abs",(function(){return w})),n.d(e,"fract",(function(){return C})),n.d(e,"mul",(function(){return x})),n.d(e,"div",(function(){return A})),n.d(e,"floor",(function(){return O})),n.d(e,"toGlVec3",(function(){return j})),n.d(e,"fromGlVec3",(function(){return S})),n.d(e,"transform",(function(){return k})),n.d(e,"transformQuat",(function(){return I})),n.d(e,"dot",(function(){return E})),n.d(e,"cross",(function(){return T})),n.d(e,"clamp",(function(){return R})),n.d(e,"mix",(function(){return D})),n.d(e,"interpolate",(function(){return P})),n.d(e,"interpolateClamped",(function(){return F})),n.d(e,"isNaNorInf",(function(){return B})),n.d(e,"isEqual",(function(){return M})),n.d(e,"boxVolume",(function(){return z})),n.d(e,"boxSurfaceArea",(function(){return N})),n.d(e,"triangleWave",(function(){return G}));var a=n(69),i=n(93),r=n(78),o={metatype:"struct",properties:{x:{metatype:"float"},y:{metatype:"float"},z:{metatype:"float"}}};function s(){return 1===arguments.length?"number"===typeof(arguments.length<=0?void 0:arguments[0])?{x:arguments.length<=0?void 0:arguments[0],y:arguments.length<=0?void 0:arguments[0],z:arguments.length<=0?void 0:arguments[0]}:Object(a.a)({},arguments.length<=0?void 0:arguments[0]):2===arguments.length?Object(a.a)(Object(a.a)({},arguments.length<=0?void 0:arguments[0]),{},{z:arguments.length<=1?void 0:arguments[1]}):{x:arguments.length<=0?void 0:arguments[0],y:arguments.length<=1?void 0:arguments[1],z:arguments.length<=2?void 0:arguments[2]}}function c(t){return{x:t.x,y:t.y}}function u(){return{x:0,y:0,z:0}}function l(t){return{x:t.random(),y:t.random(),z:t.random()}}function h(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("object"===typeof e[0])return h(e[0].theta,e[0].phi,e[0].radius);var a=e[0],i=e[1],r=e[2];return{x:Math.sin(a)*Math.cos(i)*r,y:Math.sin(a)*Math.sin(i)*r,z:Math.cos(a)*r}}function f(t){var e=t.x,n=t.y,a=t.z,i=Math.sqrt(e*e+n*n+a*a);return{radius:i,theta:Math.acos(a/i),phi:Math.atan2(n,e)}}function d(t){return t.x*t.x+t.y*t.y+t.z*t.z}function m(t){return Math.sqrt(d(t))}function p(t,e){return m(b(t,e))}function v(t){var e=m(t);return{x:t.x/e,y:t.y/e,z:t.z/e}}function g(t){return{x:-t.x,y:-t.y,z:-t.z}}function y(t,e){return"number"===typeof e?{x:t.x+e,y:t.y+e,z:t.z+e}:{x:t.x+e.x,y:t.y+e.y,z:t.z+e.z}}function b(t,e){return{x:t.x-e.x,y:t.y-e.y,z:t.z-e.z}}function w(t){return{x:Math.abs(t.x),y:Math.abs(t.y),z:Math.abs(t.z)}}function C(t){return{x:r.b(t.x),y:r.b(t.y),z:r.b(t.z)}}function x(t,e){return"number"===typeof e?{x:t.x*e,y:t.y*e,z:t.z*e}:{x:t.x*e.x,y:t.y*e.y,z:t.z*e.z}}function A(t,e){return"number"===typeof e?x(t,1/e):{x:t.x/e.x,y:t.y/e.y,z:t.z/e.z}}function O(t){return{x:Math.floor(t.x),y:Math.floor(t.y),z:Math.floor(t.z)}}function j(t){var e=t.x,n=t.y,a=t.z;return i.e.fromValues(e,n,a)}function S(t){return{x:t[0],y:t[1],z:t[2]}}function k(t,e){return S(i.e.transformMat4(i.e.create(),j(t),e))}function I(t,e){return S(i.e.transformQuat(i.e.create(),j(t),e))}function E(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function T(t,e){return{x:t.y*e.z-t.z*e.y,y:t.z*e.x-t.x*e.z,z:t.x*e.y-t.y*e.x}}function R(t,e,n){var a=t.x,i=t.y,o=t.z;return{x:r.a(a,e,n),y:r.a(i,e,n),z:r.a(o,e,n)}}function D(t,e,n){return"number"===typeof n?{x:r.f(t.x,e.x,n),y:r.f(t.y,e.y,n),z:r.f(t.z,e.z,n)}:{x:r.f(t.x,e.x,n.x),y:r.f(t.y,e.y,n.y),z:r.f(t.z,e.z,n.z)}}function P(t,e,n,a,i){return"number"===typeof t?D(a,i,(t-e)/(n-e)):"number"===typeof e?{x:r.d(t.x,e,n,a,i),y:r.d(t.y,e,n,a,i),z:r.d(t.z,e,n,a,i)}:D(a,i,A(b(t,e),b(n,e)))}function F(t,e,n,a,i){return D(a,i,"number"===typeof t?r.a((t-e)/(n-e),0,1):R(A(b(t,e),b(n,e)),0,1))}function B(t){var e=t.x,n=t.y,a=t.z;return isNaN(e)||isNaN(n)||isNaN(a)||!isFinite(e)||!isFinite(n)||!isFinite(a)}function M(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z}function z(t){return t.x*t.y*t.z}function N(t){return 2*t.x*t.y+2*t.y*t.z+2*t.z*t.x}function G(t){return{x:r.k(t.x),y:r.k(t.y),z:r.k(t.z)}}}}]);
//# sourceMappingURL=3.f86b0217.chunk.js.map